@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="tradingview-chart-wrapper">
    <div id="@ContainerId" class="tradingview-chart-container"></div>
</div>

<style>
    .tradingview-chart-wrapper {
        width: 100%;
        height: @(Height)px;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tradingview-chart-container {
        width: 100%;
        height: 100%;
    }
</style>

@code {
    [Parameter] public string Symbol { get; set; } = "BTCUSDT";
    [Parameter] public int Height { get; set; } = 600;
    [Parameter] public string Interval { get; set; } = "60"; // TradingView uses minutes: 1, 5, 15, 60, 240, D, W, M
    [Parameter] public string Theme { get; set; } = "dark";
    [Parameter] public EventCallback<string> OnSymbolChanged { get; set; }

    private string ContainerId = $"tradingview_{Guid.NewGuid():N}";
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(500); // Wait for TradingView script to load
            await InitializeWidget();
            isInitialized = true;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (isInitialized)
        {
            await UpdateWidget();
        }
    }

    private async Task InitializeWidget()
    {
        try
        {
            var intervalCode = ConvertIntervalToTradingView(Interval);
            await JS.InvokeVoidAsync("TradingViewWidget.createWidget", 
                ContainerId, 
                Symbol, 
                intervalCode, 
                Theme);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing TradingView widget: {ex.Message}");
        }
    }

    private async Task UpdateWidget()
    {
        try
        {
            await JS.InvokeVoidAsync("TradingViewWidget.changeSymbol", ContainerId, Symbol);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating widget: {ex.Message}");
        }
    }

    private string ConvertIntervalToTradingView(string interval)
    {
        return interval switch
        {
            "1m" => "1",
            "5m" => "5",
            "15m" => "15",
            "30m" => "30",
            "1h" => "60",
            "4h" => "240",
            "1d" => "D",
            "1w" => "W",
            "1M" => "M",
            _ => "60"
        };
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (isInitialized)
            {
                await JS.InvokeVoidAsync("TradingViewWidget.destroyWidget", ContainerId);
            }
        }
        catch { }
    }
}
