@page "/chart"
@page "/chart/{symbol}"
@using AntDesign
@using TradingBot.Web.Components.Shared
@using TradingBot.Web.Models
@using TradingBot.Web.Services
@inject BinanceApiClientWrapper BinanceApi
@inject ITradingApiClient TradingApi
@rendermode InteractiveServer

<PageTitle>Advanced Chart - @CurrentSymbol</PageTitle>

<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                        üìà Advanced Trading Chart
                    </h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        Powered by TradingView - Professional charting with 100+ indicators
                    </p>
                </div>
                <div class="flex items-center space-x-3">
                    <Input @bind-Value="symbolInput" Placeholder="Enter symbol (e.g., BTCUSDT)" 
                           Style="width: 250px" Size="@InputSize.Large" 
                           OnPressEnter="LoadSymbol"/>
                    <Button Type="@ButtonType.Primary" Size="@ButtonSize.Large" OnClick="LoadSymbol" Icon="@IconType.Outline.Search">
                        Load
                    </Button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Controls Bar -->
        <div class="mb-4 flex items-center justify-between bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
            <div class="flex items-center space-x-4">
                <div>
                    <Text Strong class="text-gray-700 dark:text-gray-300">Current Symbol:</Text>
                    <Text class="text-lg font-bold text-blue-600 ml-2">@CurrentSymbol</Text>
                </div>
                @if (tickerData != null)
                {
                    <Divider Type="DirectionVHType.Vertical" Style="height: 40px"/>
                    <div>
                        <Text class="text-sm text-gray-500">Price:</Text>
                        <Text class="text-xl font-bold ml-2" Style="@($"color: {(tickerData.PriceChange >= 0 ? "#26a69a" : "#ef5350")}")">
                            $@tickerData.LastPrice.ToString("N2")
                            <span class="text-sm ml-2">
                                @(tickerData.PriceChange >= 0 ? "‚ñ≤" : "‚ñº") 
                                @tickerData.PriceChangePercent.ToString("F2")%
                            </span>
                        </Text>
                    </div>
                }
            </div>
            <div class="flex items-center space-x-3">
                <Select @bind-Value="selectedInterval" Style="width: 120px" Size="@SelectSize.Large" OnSelectedItemChanged="OnIntervalChanged">
                    <SelectOptions>
                        <SelectOption Value="1m" Label="1 Minute"/>
                        <SelectOption Value="5m" Label="5 Minutes"/>
                        <SelectOption Value="15m" Label="15 Minutes"/>
                        <SelectOption Value="1h" Label="1 Hour"/>
                        <SelectOption Value="4h" Label="4 Hours"/>
                        <SelectOption Value="1d" Label="1 Day"/>
                    </SelectOptions>
                </Select>
                <Button Type="@ButtonType.Default" Icon="@IconType.Outline.Reload" OnClick="RefreshChart" Size="@ButtonSize.Large">
                    Refresh
                </Button>
                <Button Type="@ButtonType.Default" Icon="@IconType.Outline.LineChart" OnClick="GenerateSignalForChart" Size="@ButtonSize.Large">
                    Generate Signal
                </Button>
            </div>
        </div>

        <!-- TradingView Chart -->
        <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden">
            <TradingViewChart Symbol="@CurrentSymbol" Height="650" Interval="@selectedInterval" Theme="dark" />
        </div>

        <!-- Market Statistics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            @if (tickerData != null)
            {
                <Card>
                    <div class="text-center">
                        <Statistic Title="24h High" 
                                   Value="@tickerData.HighPrice" 
                                   Precision="2"
                                   Prefix="$"
                                   ValueStyle="color: #26a69a; font-size: 24px"/>
                    </div>
                </Card>

                <Card>
                    <div class="text-center">
                        <Statistic Title="24h Low" 
                                   Value="@tickerData.LowPrice" 
                                   Precision="2"
                                   Prefix="$"
                                   ValueStyle="color: #ef5350; font-size: 24px"/>
                    </div>
                </Card>

                <Card>
                    <div class="text-center">
                        <Statistic Title="24h Volume" 
                                   Value="@tickerData.Volume" 
                                   Precision="0"
                                   ValueStyle="color: #2962FF; font-size: 24px"/>
                    </div>
                </Card>

                <Card>
                    <div class="text-center">
                        <Statistic Title="24h Change" 
                                   Value="@tickerData.PriceChangePercent" 
                                   Precision="2"
                                   Suffix="%"
                                   ValueStyle="@($"color: {(tickerData.PriceChangePercent >= 0 ? "#26a69a" : "#ef5350")}; font-size: 24px")"/>
                    </div>
                </Card>
            }
            else
            {
                @for (int i = 0; i < 4; i++)
                {
                    <Card Loading="true">
                        <div style="height: 80px"></div>
                    </Card>
                }
            }
        </div>

        <!-- Quick Symbol Selection -->
        <Card Title="Quick Symbol Selection" Size="small">
            <div class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-12 gap-2">
                @foreach (var symbol in popularSymbols)
                {
                    <Button Type="@(CurrentSymbol == symbol ? ButtonType.Primary : ButtonType.Default)" 
                            OnClick="() => SelectSymbol(symbol)"
                            Block>
                        @symbol.Replace("USDT", "")
                    </Button>
                }
            </div>
        </Card>

        <!-- AI Signal Alert -->
        @if (currentSignal != null)
        {
            <div class="mt-6">
                <Alert Type="@GetAlertType(currentSignal.Type)"
                       Message="@($"AI Signal: {currentSignal.Type}")"
                       Description="@currentSignal.Reason"
                       ShowIcon="true"
                       Closable="true"
                       OnClose="() => currentSignal = null"/>
            </div>
        }

        <!-- Chart Features Info -->
        <Card Title="üéØ TradingView Features" Class="mt-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <h4 class="font-bold text-blue-900 dark:text-blue-300 mb-2">üìä 100+ Technical Indicators</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        RSI, MACD, Moving Averages, Bollinger Bands, Fibonacci, Ichimoku, and many more
                    </p>
                </div>
                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <h4 class="font-bold text-green-900 dark:text-green-300 mb-2">üìè Drawing Tools</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Trend lines, channels, Fibonacci retracements, support/resistance levels
                    </p>
                </div>
                <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                    <h4 class="font-bold text-purple-900 dark:text-purple-300 mb-2">‚ö° Real-time Data</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Live price updates from Binance with minimal latency
                    </p>
                </div>
            </div>
        </Card>
    </div>
</div>

@code {
    [Parameter] public string? Symbol { get; set; }

    private string CurrentSymbol = "BTCUSDT";
    private string symbolInput = "BTCUSDT";
    private string selectedInterval = "1h";
    private BinanceTickerData? tickerData = null;
    private TradingSignal? currentSignal = null;

    private string[] popularSymbols = new[]
    {
        "BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT", "ADAUSDT",
        "DOGEUSDT", "MATICUSDT", "DOTUSDT", "AVAXUSDT", "LINKUSDT", "ATOMUSDT"
    };

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Symbol))
        {
            CurrentSymbol = Symbol.ToUpper();
            symbolInput = CurrentSymbol;
        }
        await LoadTickerData();
    }

    private async Task LoadSymbol()
    {
        if (!string.IsNullOrEmpty(symbolInput))
        {
            CurrentSymbol = symbolInput.ToUpper();
            await LoadTickerData();
            StateHasChanged();
        }
    }

    private async Task SelectSymbol(string symbol)
    {
        CurrentSymbol = symbol;
        symbolInput = symbol;
        await LoadTickerData();
        StateHasChanged();
    }

    private async Task OnIntervalChanged(object value)
    {
        selectedInterval = value?.ToString() ?? "1h";
        StateHasChanged();
    }

    private async Task RefreshChart()
    {
        await LoadTickerData();
        StateHasChanged();
    }

    private async Task GenerateSignalForChart()
    {
        try
        {
            var request = new GenerateSignalRequest(
                CurrentSymbol, 
                "Combined Multi-Indicator", 
                selectedInterval);
            currentSignal = await TradingApi.GenerateSignalAsync(request);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating signal: {ex.Message}");
        }
    }

    private async Task LoadTickerData()
    {
        try
        {
            tickerData = await BinanceApi.GetTickerAsync(CurrentSymbol);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading ticker: {ex.Message}");
        }
    }

    private string GetAlertType(string signalType)
    {
        return signalType switch
        {
            "StrongBuy" => "success",
            "Buy" => "info",
            "Hold" => "warning",
            "Sell" => "warning",
            "StrongSell" => "error",
            _ => "info"
        };
    }
}
