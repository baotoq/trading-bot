---
phase: 17-domain-event-dispatch
plan: 03
type: execute
wave: 3
depends_on:
  - 17-02
files_modified:
  - TradingBot.ApiService/Application/Services/DcaExecutionService.cs
  - TradingBot.ApiService/Application/Handlers/PurchaseSkippedHandler.cs
  - TradingBot.ApiService/Program.cs
autonomous: true
requirements:
  - DE-04

must_haves:
  truths:
    - "DcaExecutionService no longer manually dispatches domain events via MediatR IPublisher -- interceptor handles it"
    - "PurchaseSkippedEvent published via IDomainEventPublisher.PublishDirectAsync (not MediatR publisher.Publish)"
    - "All domain events subscribed in PubSubRegistry for Dapr delivery"
    - "Existing MediatR handlers still receive events via MapPubSub -> mediator.Publish path"
  artifacts:
    - path: "TradingBot.ApiService/Application/Services/DcaExecutionService.cs"
      provides: "Cleaned up service without manual event dispatch"
    - path: "TradingBot.ApiService/Program.cs"
      provides: "Domain event subscriptions registered in PubSubRegistry"
      contains: "Subscribe<PurchaseCompletedEvent>"
  key_links:
    - from: "TradingBot.ApiService/Program.cs"
      to: "TradingBot.ApiService/Application/Events/PurchaseCompletedEvent.cs"
      via: "PubSubRegistry.Subscribe<PurchaseCompletedEvent>()"
      pattern: "Subscribe<PurchaseCompletedEvent>"
    - from: "TradingBot.ApiService/Application/Services/DcaExecutionService.cs"
      to: "TradingBot.ApiService/BuildingBlocks/Pubsub/Outbox/IDomainEventPublisher.cs"
      via: "PublishDirectAsync for PurchaseSkippedEvent"
      pattern: "domainEventPublisher.PublishDirectAsync"
---

<objective>
Subscribe domain events in PubSubRegistry, remove manual event dispatch from DcaExecutionService, and replace MediatR in-process publishing of PurchaseSkippedEvent with the outbox-based IDomainEventPublisher.

Purpose: Completes the single dispatch path -- ALL domain events flow through outbox/Dapr. Manual MediatR dispatch eliminated. Existing handlers continue working because MapPubSub dispatches via mediator.Publish internally.

Output: Clean DcaExecutionService without manual event dispatch, PurchaseSkippedEvent via outbox, all domain events subscribed in PubSubRegistry
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-domain-event-dispatch/17-RESEARCH.md
@.planning/phases/17-domain-event-dispatch/17-01-SUMMARY.md
@.planning/phases/17-domain-event-dispatch/17-02-SUMMARY.md

@TradingBot.ApiService/Application/Services/DcaExecutionService.cs
@TradingBot.ApiService/Application/Handlers/PurchaseCompletedHandler.cs
@TradingBot.ApiService/Application/Handlers/PurchaseFailedHandler.cs
@TradingBot.ApiService/Application/Handlers/PurchaseSkippedHandler.cs
@TradingBot.ApiService/Application/Events/PurchaseCompletedEvent.cs
@TradingBot.ApiService/Application/Events/PurchaseFailedEvent.cs
@TradingBot.ApiService/Application/Events/PurchaseSkippedEvent.cs
@TradingBot.ApiService/Application/Events/PurchaseCreatedEvent.cs
@TradingBot.ApiService/Application/Events/DcaConfigurationCreatedEvent.cs
@TradingBot.ApiService/Application/Events/DcaConfigurationUpdatedEvent.cs
@TradingBot.ApiService/BuildingBlocks/Pubsub/Outbox/IDomainEventPublisher.cs
@TradingBot.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Subscribe domain events in PubSubRegistry and remove manual dispatch from DcaExecutionService</name>
  <files>
    TradingBot.ApiService/Program.cs
    TradingBot.ApiService/Application/Services/DcaExecutionService.cs
  </files>
  <action>
    1. **Register domain event subscriptions** in Program.cs after `AddDaprPubSub()`:
       ```csharp
       var pubSubRegistry = builder.Services.AddDaprPubSub();
       pubSubRegistry
           .Subscribe<PurchaseCreatedEvent>()
           .Subscribe<PurchaseCompletedEvent>()
           .Subscribe<PurchaseFailedEvent>()
           .Subscribe<PurchaseSkippedEvent>()
           .Subscribe<DcaConfigurationCreatedEvent>()
           .Subscribe<DcaConfigurationUpdatedEvent>();
       ```
       Add required `using` statements for `TradingBot.ApiService.Application.Events`.

    2. **Remove manual event dispatch from DcaExecutionService** (Steps 8-9 in `ExecuteDailyPurchaseAsync`):
       - DELETE these lines (approximately lines 219-227):
         ```csharp
         // Step 8: Dispatch domain events accumulated by aggregate behavior methods
         var eventsToDispatch = purchase.DomainEvents.ToList();
         foreach (var domainEvent in eventsToDispatch)
         {
             await publisher.Publish(domainEvent, ct);
         }
         purchase.ClearDomainEvents();
         logger.LogInformation("Dispatched {Count} domain events for {PurchaseId}", eventsToDispatch.Count, purchase.Id);
         ```
       - The interceptor from Plan 01 now handles this automatically during `dbContext.SaveChangesAsync(ct)` on line 215.
       - Update the comment on SaveChangesAsync to reflect the new behavior:
         ```csharp
         // Step 7: Persist purchase record (interceptor auto-dispatches domain events to outbox)
         dbContext.Purchases.Add(purchase);
         await dbContext.SaveChangesAsync(ct);
         logger.LogInformation("Purchase persisted: {PurchaseId} with status {Status}", purchase.Id, purchase.Status);
         ```

    3. **Remove MediatR IPublisher dependency** from DcaExecutionService constructor:
       - Remove `IPublisher publisher` from the primary constructor parameters
       - Remove `using MediatR;` if no longer needed
       - This is possible ONLY after PurchaseSkippedEvent is also migrated (done in Task 2 below). So: do NOT remove `IPublisher` yet in this task -- it will be removed in Task 2 when PurchaseSkippedEvent calls are replaced.
       - Actually, since both tasks are in the same plan and execute sequentially: remove `IPublisher` in Task 2 after all usages are replaced.
  </action>
  <verify>
    Run `dotnet build TradingBot.sln` -- may have compilation errors if IPublisher is still used for PurchaseSkippedEvent (Task 2 will fix).
    Verify the manual dispatch block (Steps 8-9) is removed from DcaExecutionService.
    Verify domain event subscriptions are registered in Program.cs.
  </verify>
  <done>
    Domain events subscribed in PubSubRegistry. Manual event dispatch block removed from DcaExecutionService. SaveChangesAsync comment updated to reflect interceptor-based dispatch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace PurchaseSkippedEvent MediatR publish with IDomainEventPublisher and remove IPublisher dependency</name>
  <files>
    TradingBot.ApiService/Application/Services/DcaExecutionService.cs
    TradingBot.ApiService/Application/Handlers/PurchaseSkippedHandler.cs
  </files>
  <action>
    1. **Replace all `publisher.Publish(new PurchaseSkippedEvent(...))` calls** in DcaExecutionService with `domainEventPublisher.PublishDirectAsync(...)`:
       - There are 3 skip scenarios in DcaExecutionService:
         a. "Already purchased today" (around line 68)
         b. "Insufficient balance" (around line 89)
         c. "Amount below minimum order value" (around line 112)
       - Each currently calls `await publisher.Publish(new PurchaseSkippedEvent(...), ct);`
       - Replace with `await domainEventPublisher.PublishDirectAsync(new PurchaseSkippedEvent(...), ct);`
       - NOTE: `PublishDirectAsync` (from Plan 02) calls `dbContext.SaveChangesAsync(ct)` internally to persist the OutboxMessage. No additional save needed.

    2. **Update DcaExecutionService constructor** to inject `IDomainEventPublisher` instead of `IPublisher`:
       - Replace `IPublisher publisher` with `IDomainEventPublisher domainEventPublisher` in the primary constructor
       - Remove `using MediatR;` import (if no other MediatR usage remains)
       - Add `using TradingBot.ApiService.BuildingBlocks.Pubsub.Outbox;` for the `IDomainEventPublisher` namespace

    3. **Update PurchaseSkippedHandler** if PurchaseSkippedEvent was modified (OccurredAt rename from Plan 01):
       - If `SkippedAt` was renamed to `OccurredAt` in Plan 01, update all references in PurchaseSkippedHandler from `notification.SkippedAt` to `notification.OccurredAt`
       - The handler stays as `INotificationHandler<PurchaseSkippedEvent>` -- it continues to work because MapPubSub calls `mediator.Publish(message)` which dispatches to registered INotificationHandlers

    4. **Verify the complete dispatch path** (mental walkthrough):
       - **Aggregate events (PurchaseCompleted, PurchaseFailed, PurchaseCreated, DcaConfigurationUpdated):**
         Service → aggregate.AddDomainEvent() → dbContext.SaveChangesAsync() → SavingChangesAsync interceptor → OutboxMessage inserted in same transaction → OutboxMessageBackgroundService polls → OutboxMessageProcessor publishes via DaprMessageBroker → Dapr delivers to subscriber endpoint → MapPubSub handler → MediatR mediator.Publish() → INotificationHandler<T>
       - **Non-aggregate events (PurchaseSkippedEvent):**
         Service → domainEventPublisher.PublishDirectAsync() → OutboxMessage created + SaveChangesAsync → same outbox pipeline as above
  </action>
  <verify>
    Run `dotnet build TradingBot.sln` -- should compile without errors.
    Run `dotnet test` -- all 53 existing tests should pass.
    Verify DcaExecutionService no longer imports or uses MediatR `IPublisher`.
    Verify DcaExecutionService constructor has `IDomainEventPublisher domainEventPublisher` parameter.
    Verify all 3 PurchaseSkippedEvent calls use `domainEventPublisher.PublishDirectAsync`.
    Grep for `publisher.Publish` in DcaExecutionService -- should return zero matches.
  </verify>
  <done>
    All PurchaseSkippedEvent publishing routed through IDomainEventPublisher.PublishDirectAsync (outbox path). MediatR IPublisher dependency removed from DcaExecutionService. PurchaseSkippedHandler updated for any event field renames. Complete single dispatch path: ALL domain events (aggregate and non-aggregate) flow through outbox/Dapr. Existing handlers work unchanged via MapPubSub mediator dispatch. Solution builds and all tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` compiles without errors
2. `dotnet test` -- all existing tests pass (no behavioral regression)
3. DcaExecutionService has NO manual event dispatch (no `purchase.DomainEvents.ToList()`, no `publisher.Publish`, no `purchase.ClearDomainEvents()`)
4. DcaExecutionService uses `IDomainEventPublisher` (not `IPublisher`) for PurchaseSkippedEvent
5. All 6 domain event types subscribed in PubSubRegistry in Program.cs
6. `grep -r "publisher.Publish" TradingBot.ApiService/Application/Services/DcaExecutionService.cs` returns nothing
7. Event dispatch path verified: aggregate events via interceptor → outbox → Dapr → MapPubSub → MediatR → handlers
</verification>

<success_criteria>
- Solution builds without errors, all tests pass
- Single dispatch path achieved: ALL domain events go through outbox/Dapr ONLY
- No manual MediatR event dispatch in DcaExecutionService
- PurchaseSkippedEvent uses IDomainEventPublisher.PublishDirectAsync
- All 6 domain event types registered as Dapr subscriptions
- Existing MediatR handlers (PurchaseCompletedHandler, PurchaseFailedHandler, PurchaseSkippedHandler) work without modification via MapPubSub → mediator.Publish
</success_criteria>

<output>
After completion, create `.planning/phases/17-domain-event-dispatch/17-03-SUMMARY.md`
</output>
