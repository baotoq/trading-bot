---
milestone: v2.0
audited: 2026-02-20T10:00:00Z
status: tech_debt
scores:
  requirements: 18/18
  phases: 6/6
  integration: 17/18
  flows: 7/8
gaps:
  requirements: []
  integration:
    - id: "INT-01"
      description: "Price.From(0) throws VogenInvalidValueException in dashboard endpoints when DB is empty or Hyperliquid unreachable"
      affected_requirements: ["TS-04"]
      severity: "non-critical"
      files:
        - "TradingBot.ApiService/Endpoints/DashboardEndpoints.cs"
        - "TradingBot.ApiService/Endpoints/DashboardDtos.cs"
      fix: "Change PortfolioResponse.AverageCostBasis, CurrentPrice, PriceChartResponse.AverageCostBasis to Price? (nullable)"
  flows:
    - id: "FLOW-01"
      description: "Dashboard portfolio/chart endpoints crash (500) on empty DB or when Hyperliquid is unreachable"
      break_point: "PortfolioResponse DTO construction with Price.From(0)"
      affected_requirements: ["TS-04"]
      severity: "non-critical"
tech_debt:
  - phase: 13-strongly-typed-ids
    items:
      - "Pre-existing TODO: Phase 4 will track actual BTC balance (DcaExecutionService.cs:240)"
  - phase: 15-rich-aggregate-roots
    items:
      - "Pre-existing TODO: Phase 4 will track actual BTC balance (PurchaseCompletedHandler.cs:52)"
  - phase: 17-domain-event-dispatch
    items:
      - "Pre-existing CS8618 warning: DaprEvent.Data should be required string or string? (WebApplicationExtensions.cs:36)"
      - "3 domain events have no MediatR handlers: PurchaseCreatedEvent, DcaConfigurationCreatedEvent, DcaConfigurationUpdatedEvent (extensibility point, not a bug)"
  - phase: 18-specification-pattern
    items:
      - "REQUIREMENTS.md QP-02 and QP-03 checkboxes still show [ ] Pending (documentation gap — implementation is complete)"
      - "Human verification needed: Run integration tests with TestContainers against live Docker to confirm all 62 tests pass"
---

# v2.0 DDD Foundation — Milestone Audit Report

**Audited:** 2026-02-20T10:00:00Z
**Status:** tech_debt (all requirements met, no critical blockers, accumulated tech debt)

## Executive Summary

All 18 requirements are satisfied. All 6 phases passed verification. Cross-phase integration is wired correctly at 17/18 connection points. One runtime edge case bug was found by integration checking (not caught by individual phase verification): `Price.From(0)` throws in dashboard endpoints when the database is empty or Hyperliquid is unreachable.

## Phase Verification Summary

| Phase | Name | Status | Score | Key Findings |
|-------|------|--------|-------|--------------|
| 13 | Strongly-Typed IDs | PASSED | 10/10 | All typed IDs applied, EF Core converters wired |
| 14 | Value Objects | PASSED | 13/13 | All 6 value objects with validation, config binding works |
| 15 | Rich Aggregate Roots | PASSED | 11/11 | Factory methods, private setters, behavior methods enforced |
| 16 | Result Pattern | PASSED | 7/7 | ErrorOr propagation from aggregate to endpoint confirmed |
| 17 | Domain Event Dispatch | PASSED | 4/4 | Interceptor-based outbox bridge, all handlers continue working |
| 18 | Specification Pattern | PASSED | 10/10 | 7 composable specs, TestContainers integration tests created |

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | Phase | VERIFICATION | SUMMARY | REQUIREMENTS.md | Final Status |
|--------|-------------|-------|-------------|---------|-----------------|--------------|
| TS-01 | Strongly-typed ID wrappers | 13 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| TS-02 | Value objects with validation | 14 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| TS-03 | EF Core converters via ConfigureConventions | 14 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| TS-04 | JSON serialize/deserialize in API endpoints | 14 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DM-01 | AggregateRoot base class | 15 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DM-02 | Purchase aggregate invariants via factory | 15 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DM-03 | DcaConfiguration aggregate invariants | 15 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DM-04 | Private setters, domain methods only | 15 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| EH-01 | ErrorOr<T> for domain operations | 16 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| EH-02 | Endpoints map ErrorOr to HTTP status | 16 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| EH-03 | Application services use Result pattern | 16 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DE-01 | Aggregates raise domain events | 17 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DE-02 | Events dispatch after SaveChanges via interceptor | 17 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DE-03 | Domain events bridge to integration events | 17 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| DE-04 | Existing MediatR handlers continue working | 17 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| QP-01 | Specification classes for queries | 18 | SATISFIED | provides listed | [x] Complete | **satisfied** |
| QP-02 | Specs translate to server-side SQL | 18 | SATISFIED | provides listed | [ ] Pending | **satisfied** (checkbox needs update) |
| QP-03 | Dashboard queries use specifications | 18 | SATISFIED | provides listed | [ ] Pending | **satisfied** (checkbox needs update) |

**Orphaned requirements:** None. All 18 REQ-IDs from the traceability table appear in at least one VERIFICATION.md.

**Score:** 18/18 requirements satisfied

## Cross-Phase Integration

| # | Connection | From → To | Status |
|---|-----------|-----------|--------|
| 1 | Vogen infrastructure reuse | Phase 13 → 14 | WIRED |
| 2 | VogenGlobalConfig applies to all 9 types | Phase 13 → 14 | WIRED |
| 3 | ConfigureConventions registers all 9 converters | Phase 13+14 → EF Core | WIRED |
| 4 | Value objects as aggregate properties | Phase 14 → 15 | WIRED |
| 5 | Typed IDs + value objects = aggregate constructor params | Phase 13+14 → 15 | WIRED |
| 6 | Behavior methods return ErrorOr | Phase 15 → 16 | WIRED |
| 7 | ErrorOr propagation: aggregate → service → endpoint | Phase 15+16 → endpoints | WIRED |
| 8 | AggregateRoot implements IAggregateRoot | Phase 15 → 17 | WIRED |
| 9 | DomainEventOutboxInterceptor queries IAggregateRoot | Phase 15 → 17 | WIRED |
| 10 | Domain events raised in behavior methods → interceptor dispatches | Phase 15 → 17 | WIRED |
| 11 | OutboxMessage → Dapr → MediatR handlers | Phase 17 → existing handlers | WIRED |
| 12 | IDomainEventPublisher for non-aggregate events | Phase 17 (PurchaseSkippedEvent) | WIRED |
| 13 | 6 domain event types subscribed in PubSubRegistry | Phase 17 → Program.cs | WIRED |
| 14 | Specifications use Symbol.Btc value object | Phase 14 → 18 | WIRED |
| 15 | WithSpecification chains on typed entities | Phase 13+14 → 18 | WIRED |
| 16 | Dashboard endpoints use specs | Phase 18 → DashboardEndpoints | WIRED |
| 17 | Background services use specs | Phase 18 → WeeklySummary/MissedPurchase | WIRED |
| 18 | Non-nullable Price in DTO receives 0 on empty DB | Phase 14 ↔ DashboardEndpoints | **RUNTIME BUG** |

**Score:** 17/18 connections verified (1 runtime bug)

## E2E Flow Verification

| # | Flow | Status | Details |
|---|------|--------|---------|
| 1 | DCA Execution: schedule → MultiplierCalculator → Purchase.Create() → SaveChanges → interceptor → outbox → Dapr → Telegram | COMPLETE | Full chain uses typed IDs, value objects, aggregate factory, domain events |
| 2 | Configuration Update: PUT /api/config → ConfigurationService → DcaConfiguration.Update*() → ErrorOr → ToHttpResult | COMPLETE | ErrorOr propagation confirmed end-to-end |
| 3 | Dashboard Portfolio: GET /api/dashboard/portfolio → specs → typed DTOs → JSON | **BREAKS** on empty DB | Price.From(0) throws VogenInvalidValueException |
| 4 | Dashboard Purchases: GET /api/dashboard/purchases → specs + cursor pagination → typed DTOs | COMPLETE | WithSpecification chaining works correctly |
| 5 | Dashboard Chart: GET /api/dashboard/chart → DailyPriceByDateRangeSpec → typed DTOs | **BREAKS** on empty purchases | Same Price.From(0) issue for AverageCostBasis |
| 6 | Backtest: POST /api/backtest → BacktestSimulator → MultiplierCalculator with value objects | COMPLETE | Value objects wrap at API boundary |
| 7 | Data Ingestion: POST /api/backtest/data/ingest → IngestionJobId typed throughout queue → service | COMPLETE | Typed ID flows through Channel<IngestionJobId> |
| 8 | Domain Event Bridge: aggregate AddDomainEvent → interceptor → OutboxMessage → processor → DaprMessageBroker → MapPubSub → MediatR | COMPLETE | Full pipeline verified with dead-letter fallback |

**Score:** 7/8 flows complete (1 flow has runtime breaks in edge case)

## Tech Debt by Phase

### Phase 13: Strongly-Typed IDs
- Pre-existing TODO: `Phase 4 will track actual BTC balance` (DcaExecutionService.cs:240)

### Phase 15: Rich Aggregate Roots
- Pre-existing TODO: `Phase 4 will track actual BTC balance` (PurchaseCompletedHandler.cs:52)

### Phase 17: Domain Event Dispatch
- Pre-existing CS8618 warning: `DaprEvent.Data` should be `required string` or `string?` (WebApplicationExtensions.cs:36)
- 3 domain events have no MediatR handlers: `PurchaseCreatedEvent`, `DcaConfigurationCreatedEvent`, `DcaConfigurationUpdatedEvent` (extensibility point — events flow through outbox correctly, handlers are optional)

### Phase 18: Specification Pattern
- REQUIREMENTS.md QP-02 and QP-03 checkboxes still show `[ ] Pending` — documentation gap, implementation is verified complete
- Human verification pending: Run `dotnet test` with Docker to confirm all 62 tests pass (TestContainers requires live Docker)

### Cross-Phase (Integration)
- `DashboardEndpoints.cs` + `DashboardDtos.cs`: `PortfolioResponse.AverageCostBasis`, `CurrentPrice`, and `PriceChartResponse.AverageCostBasis` are non-nullable `Price` but receive `0` when DB is empty or Hyperliquid unreachable → `VogenInvalidValueException` (500). Fix: change to `Price?` nullable.

**Total: 7 items across 5 areas (0 critical blockers, 7 non-critical)**

## Build & Test Evidence

All phases report:
- `dotnet build TradingBot.slnx`: 0 errors (5-9 pre-existing warnings)
- `dotnet test`: 53 tests pass (pre-Phase 18), 62 tests after Phase 18 (9 new spec integration tests)
- Git history: clean commits across all 6 phases

---

*Audited: 2026-02-20T10:00:00Z*
*Auditor: Claude (gsd-audit-milestone)*
