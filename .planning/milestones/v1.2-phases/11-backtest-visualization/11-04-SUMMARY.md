---
phase: 11-backtest-visualization
plan: 04
subsystem: dashboard
tags: [comparison, session-storage, vue, ui]
completed: 2026-02-14

dependency_graph:
  requires:
    - 11-02-PLAN.md (backtest chart with tier markers)
    - 11-03-PLAN.md (parameter sweep UI)
  provides:
    - Backtest comparison with up to 3 overlaid configurations
    - Session storage persistence for comparison state
  affects:
    - TradingBot.Dashboard/app/pages/backtest.vue
    - TradingBot.Dashboard/app/composables/useBacktestComparison.ts (new)
    - TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue (new)

tech_stack:
  added:
    - "@vueuse/core useSessionStorage for comparison state persistence"
    - "In-memory cache for purchaseLog to avoid session storage quota"
  patterns:
    - "Session storage for summary data only (config, metrics)"
    - "In-memory Map for large data (purchaseLog) to avoid QuotaExceededError"
    - "Duplicate config detection via value comparison"
    - "Best value highlighting in metrics table"

key_files:
  created:
    - TradingBot.Dashboard/app/composables/useBacktestComparison.ts (149 lines)
    - TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue (419 lines)
  modified:
    - TradingBot.Dashboard/app/pages/backtest.vue (+112 lines)

decisions:
  - title: "Session storage for summary only, memory cache for purchaseLog"
    rationale: "purchaseLog can be 50KB+ per backtest, would hit 5MB session storage quota quickly"
    impact: "Chart unavailable after refresh (shows 're-run to view chart' message), but metrics table persists"
    alternatives: "IndexedDB (overkill), localStorage (same quota), no persistence (poor UX)"
  - title: "Color palette: blue, green, purple"
    rationale: "Distinct colors for 3 comparison entries, avoid tier colors (gray, green, blue, purple, red)"
    impact: "Clear visual distinction between compared configurations"
  - title: "Best value highlighting in metrics table"
    rationale: "Quick visual identification of superior configuration per metric"
    impact: "Bold green text for best total BTC, lowest cost basis, highest return, highest efficiency, lowest drawdown"

metrics:
  duration_minutes: 2
  tasks_completed: 2
  files_created: 2
  files_modified: 1
  lines_added: 680
  commits: 2
---

# Phase 11 Plan 04: Backtest Comparison Panel

Backtest comparison panel with session storage persistence, overlaid equity curves for up to 3 configurations, and side-by-side metrics table with best value highlighting.

## What Was Built

### useBacktestComparison Composable

**Purpose:** Manage comparison state with session storage persistence and in-memory cache for large data.

**Key Features:**
- useSessionStorage for summary data (config, metrics, comparison)
- In-memory Map for purchaseLog to avoid session storage quota (5MB limit)
- Maximum 3 comparison entries enforced
- Color assignment from palette (blue, green, purple)
- Duplicate config detection via value comparison
- Functions: addToComparison, removeFromComparison, clearComparison, canAdd, hasChartData

**Storage Strategy:**
```typescript
// Session storage (persists across refresh)
comparedBacktests = useSessionStorage<ComparisonEntrySummary[]>([...])

// In-memory cache (NOT persisted, cleared on tab close)
purchaseLogCache = ref<Map<string, PurchaseLogEntry[]>>(new Map())
```

**Why split storage?** Each purchaseLog is ~50KB. 3 backtests = 150KB just for chart data. Adding full configs/metrics could exceed 5MB quota quickly. By storing only summary in session storage, we get ~99% of value (metrics comparison) with minimal storage footprint.

**Trade-off:** After page refresh, comparison panel shows metrics table but displays "Re-run backtests to view comparison chart" message instead of chart. Chart only available in active session. This is acceptable because:
1. Metrics table is the primary value (side-by-side comparison)
2. Charts can be regenerated by re-running backtests
3. Avoids QuotaExceededError in production

### BacktestComparison Component

**Purpose:** Display overlaid equity curves and side-by-side metrics table for up to 3 configurations.

**Structure:**
1. **Header:** "Comparison (N/3)" count + "Clear All" button
2. **Empty state:** "Run backtests and add to comparison to see side-by-side results"
3. **Overlaid equity curve chart:**
   - vue-chartjs Line chart with multiple datasets (one per entry)
   - Each entry's curve rendered in assigned color
   - BTC price as secondary y-axis reference (from first entry)
   - Y-axis: portfolio value (USD) — single axis, no toggle needed for comparison
   - If no purchaseLog cached: "Re-run backtests to view comparison chart" message
4. **Metrics comparison table:**
   - HTML table with rows: Total BTC, Avg Cost Basis, Return %, Efficiency Ratio, Max Drawdown, Total Invested
   - Columns: Metric label | Entry 1 | Entry 2 | Entry 3 (dynamic)
   - Column headers colored with entry color
   - Remove button (X) per column header
   - Best value per row highlighted (bold green text)
5. **Config details:** Collapsible UAccordion per entry showing base amount, lookback, bear MA, bear boost, max cap, tiers

**Best Value Logic:**
- Total BTC: highest is best
- Avg Cost Basis: lowest is best
- Return %: highest is best
- Efficiency Ratio: highest is best
- Max Drawdown: lowest absolute value is best
- Total Invested: no highlighting (neutral metric)

### Backtest Page Integration

**Add to Compare Button:**
- Single backtest tab: Button appears below header when result exists
- Sweep tab: Button appears in detail panel when config selected
- Disabled when 3 entries in comparison (shows "Max 3 Comparisons")
- Toast notifications on add/error

**Auto-Label Generation:**
- Single backtest: "Base $10, 30d lookback"
- Sweep detail: "Sweep #5: Base $15"

**Comparison Panel Placement:**
- Rendered below UTabs, separated by horizontal border
- Only visible when comparedBacktests.length > 0
- Shared across both tabs (comparison is cross-tab state)

## Task Breakdown

### Task 1: Create useBacktestComparison composable and BacktestComparison component
**Status:** Complete
**Commit:** d5c493d

**Deliverables:**
- useBacktestComparison.ts with session storage + memory cache pattern
- BacktestComparison.vue with overlaid chart and metrics table
- Color palette assignment and duplicate detection
- Best value highlighting logic

**Verification:**
- Composable exports all required functions
- Component renders empty state and comparison content
- Chart displays up to 3 overlaid curves
- Metrics table highlights best values per row
- Config details collapsible per entry

### Task 2: Wire comparison into backtest page with Add to Compare button
**Status:** Complete
**Commit:** f7a2552

**Deliverables:**
- "Add to Compare" buttons in single and sweep tabs
- Toast notifications for success/error feedback
- Comparison panel at page bottom (below tabs)
- Session storage state persistence
- Duplicate prevention and 3-entry maximum enforcement

**Verification:**
- Buttons appear when results exist
- Buttons disabled when comparison full
- Toast shows on add/error
- Comparison panel appears/hides based on entry count
- State persists across page refresh (metrics table visible, chart shows message)

## Deviations from Plan

None — plan executed exactly as written.

## Testing Notes

**Manual Testing Checklist:**
1. Run a backtest in Single tab → "Add to Compare" button appears
2. Click "Add to Compare" → comparison panel appears with 1 entry, toast shows success
3. Modify parameters and run another backtest → click "Add to Compare" → 2 entries in comparison
4. Run a third → add to comparison → 3 entries, button now shows "Max 3 Comparisons" (disabled)
5. Comparison chart shows 3 overlaid curves in blue, green, purple
6. Metrics table shows side-by-side values with best highlighted in bold green
7. Click X button on one entry → comparison updates to 2 entries, "Add to Compare" re-enabled
8. "Clear All" removes all entries → comparison panel hides
9. Refresh page → comparison panel shows metrics table, chart shows "Re-run backtests to view comparison chart"
10. Switch to Sweep tab, run sweep, click a row, click "Add to Compare" → adds to same comparison panel
11. Try adding same config twice → toast shows "Already in comparison"
12. Try adding 4th entry when 3 exist → toast shows "Maximum 3 comparisons"

**Edge Cases Handled:**
- Duplicate config detection (compare by values, not reference)
- Session storage persistence (summary only)
- Chart unavailable after refresh (graceful degradation)
- Maximum 3 entries enforced with visual feedback
- Remove individual entries or clear all

## Integration Points

**Depends On:**
- 11-02-PLAN.md: BacktestChart component with tier markers (reused chart structure)
- 11-03-PLAN.md: Parameter sweep UI (sweep results available for comparison)

**Used By:**
- Future: Could add export comparison as PDF/CSV
- Future: Could add walk-forward comparison across multiple test periods

## Performance Considerations

**Session Storage Usage:**
- Summary data only: ~2KB per entry × 3 = ~6KB total (well below 5MB quota)
- purchaseLog excluded: saves ~50KB per entry × 3 = 150KB
- Trade-off: Chart unavailable after refresh, but acceptable given metrics table is primary value

**Chart Rendering:**
- Up to 3 datasets + BTC price = 4 lines total
- No purchase markers in comparison chart (would be too cluttered)
- 400px height vs 500px in single chart (more compact for comparison view)

## Self-Check

Verifying created files exist:

```bash
[ -f "TradingBot.Dashboard/app/composables/useBacktestComparison.ts" ] && echo "FOUND" || echo "MISSING"
[ -f "TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue" ] && echo "FOUND" || echo "MISSING"
```

Verifying commits exist:

```bash
git log --oneline --all | grep -q "d5c493d" && echo "FOUND: d5c493d" || echo "MISSING: d5c493d"
git log --oneline --all | grep -q "f7a2552" && echo "FOUND: f7a2552" || echo "MISSING: f7a2552"
```

Running checks...

## Self-Check: PASSED

All files verified:
- FOUND: useBacktestComparison.ts
- FOUND: BacktestComparison.vue

All commits verified:
- FOUND: d5c493d (Task 1: Create comparison composable and component)
- FOUND: f7a2552 (Task 2: Wire comparison into backtest page)
