---
phase: 11-backtest-visualization
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - TradingBot.Dashboard/app/components/backtest/SweepResultsTable.vue
  - TradingBot.Dashboard/app/components/backtest/SweepForm.vue
  - TradingBot.Dashboard/app/pages/backtest.vue
autonomous: true

must_haves:
  truths:
    - "User can run parameter sweep and view ranked results sorted by efficiency or return"
    - "Sweep rows are clickable — clicking loads the full backtest detail (chart + metrics) below the table"
    - "Parameter sweep results in a sortable table — click column headers to sort"
    - "Efficiency ratio is sortable and default sort column"
  artifacts:
    - path: "TradingBot.Dashboard/app/components/backtest/SweepResultsTable.vue"
      provides: "Sortable TanStack Table for sweep results with clickable rows"
      min_lines: 80
    - path: "TradingBot.Dashboard/app/components/backtest/SweepForm.vue"
      provides: "Sweep parameter range form"
      min_lines: 60
    - path: "TradingBot.Dashboard/app/pages/backtest.vue"
      provides: "Backtest page with tabs for Single and Sweep modes"
  key_links:
    - from: "TradingBot.Dashboard/app/components/backtest/SweepResultsTable.vue"
      to: "BacktestChart + BacktestMetrics"
      via: "row click emits selectConfig, page loads detail below table"
      pattern: "emit.*selectConfig"
    - from: "TradingBot.Dashboard/app/pages/backtest.vue"
      to: "SweepResultsTable"
      via: "UTabs with Single/Sweep tabs"
      pattern: "UTabs|SweepResultsTable"
---

<objective>
Build the parameter sweep flow: sweep parameter form, sortable results table with clickable rows, and tabbed page layout.

Purpose: Enable users to run parameter sweeps, view ranked results in a sortable table, and click any row to see its full backtest detail (reusing chart + metrics components from Plan 02).
Output: Working sweep tab with form, results table, and detail expansion — integrated into the existing backtest page via tabs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backtest-visualization/11-RESEARCH.md
@.planning/phases/11-backtest-visualization/11-02-SUMMARY.md

@TradingBot.Dashboard/app/pages/backtest.vue
@TradingBot.Dashboard/app/components/backtest/BacktestForm.vue
@TradingBot.Dashboard/app/components/backtest/BacktestChart.vue
@TradingBot.Dashboard/app/components/backtest/BacktestMetrics.vue
@TradingBot.Dashboard/app/types/backtest.ts
@TradingBot.Dashboard/app/composables/useBacktest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SweepForm and SweepResultsTable components</name>
  <files>
    TradingBot.Dashboard/app/components/backtest/SweepForm.vue
    TradingBot.Dashboard/app/components/backtest/SweepResultsTable.vue
  </files>
  <action>
    **SweepForm.vue:**

    Create a parameter sweep configuration form. Unlike BacktestForm (single values), sweep takes ranges/lists of values.

    Form fields:
    - Date range: Same preset buttons (1Y, 2Y, 3Y, Max) + custom picker (reuse pattern from BacktestForm)
    - Base Amounts: Comma-separated input (e.g., "5, 10, 15, 20") — parse to number array
    - High Lookback Days: Comma-separated input (e.g., "14, 30, 60")
    - Bear Market MA Periods: Comma-separated input (e.g., "100, 200")
    - Bear Boost Factors: Comma-separated input (e.g., "1.0, 1.25, 1.5")
    - Max Multiplier Caps: Comma-separated input (e.g., "3.0, 4.5, 6.0")
    - Rank By: USelect with options ['efficiency', 'return', 'btc', 'drawdown']
    - Walk-Forward Validation: UCheckbox toggle
    - Max Combinations: UInput type="number" (default 1000)
    - Pre-fill default single values from config prop (e.g., baseAmounts defaults to just the live config value)

    Progress bar: UProgress shown while sweep is running

    Submit: "Run Sweep" button with loading state, block width

    Props: `config` (DcaConfigResponse | null)
    Emits: `sweepComplete` with SweepResponse payload

    API call: POST `/api/backtest/sweep` with SweepRequest body. Parse comma-separated strings into arrays of numbers.

    **SweepResultsTable.vue:**

    Create sortable results table using Nuxt UI UTable component (TanStack Table powered).

    Per locked decisions:
    - Sortable columns — click column headers to sort by efficiency, return, etc.
    - Sweep rows are clickable — clicking loads the full backtest detail

    Props: `results` (SweepResultEntry[])
    Emits: `selectConfig` with the clicked row's BacktestConfig + full SweepResultEntry

    Columns:
    1. Rank (width: 60px, centered)
    2. Efficiency Ratio (comparison.efficiencyRatio) — formatted to 2 decimals, bold primary color (hero metric per locked decision)
    3. Return % (smartDca.returnPercent) — green if positive, red if negative, with +/- sign
    4. Total BTC (smartDca.totalBtc) — formatted to 4 decimals
    5. Avg Cost Basis (smartDca.avgCostBasis) — formatted as USD
    6. Max Drawdown (smartDca.maxDrawdown) — formatted as percentage
    7. Base Amount (config.baseDailyAmount) — formatted as USD
    8. Overfit (walkForward.overfitWarning) — show "Warning" in amber or "OK" in gray-400, show "—" if no walk-forward

    Default sort: efficiency ratio descending

    Use `h()` render function for cell formatting (following Nuxt UI Table patterns from research).

    Row click handler: emit `selectConfig` with the row's original data.

    Enable virtualization when results.length > 100: `:virtualize="results.length > 100"`.

    Empty state: "No sweep results. Run a parameter sweep to see ranked configurations."

    Styling: cursor-pointer class, hover:bg-gray-50 for rows.
  </action>
  <verify>
    - SweepForm.vue exists with comma-separated parameter inputs and preset date buttons
    - SweepResultsTable.vue exists with 8 sortable columns
    - Table default sorts by efficiency ratio descending
    - Clicking a row emits selectConfig event
    - Virtualization enabled for large result sets
  </verify>
  <done>
    SweepForm accepts parameter ranges (comma-separated), runs sweep with progress bar, and emits results. SweepResultsTable renders sortable ranked results with efficiency as hero column, clickable rows emitting config selection, and virtualization for large datasets.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tabbed layout to backtest page with Single and Sweep modes</name>
  <files>
    TradingBot.Dashboard/app/pages/backtest.vue
  </files>
  <action>
    Update the existing `app/pages/backtest.vue` to add tabbed navigation between Single backtest and Sweep modes.

    **Tab structure using UTabs:**
    - Tab 1: "Single Backtest" (icon: i-lucide-play)
    - Tab 2: "Parameter Sweep" (icon: i-lucide-layers)

    **Single Backtest tab (existing content from Plan 02):**
    - BacktestForm on left, results (BacktestMetrics + BacktestChart) on right
    - No changes to existing functionality

    **Parameter Sweep tab:**
    - SweepForm at top
    - On sweep completion: SweepResultsTable displays below form
    - Below table: detail panel for selected sweep row
    - When user clicks a sweep row:
      1. Store the selected SweepResultEntry
      2. If the clicked entry is in `topResults` (has purchaseLog), display BacktestChart and BacktestMetrics directly from the topResult data
      3. If the clicked entry is in `results` only (no purchaseLog), run a single backtest with that config to get full result, then display
      4. Show loading indicator while fetching full result
    - Detail panel: BacktestMetrics + BacktestChart, same as single backtest view

    **State management updates:**
    - Add: sweepResults ref (SweepResponse | null)
    - Add: selectedSweepEntry ref (SweepResultEntry | null)
    - Add: selectedSweepDetail ref (BacktestResult | null) — full result for chart
    - Add: loadingSweepDetail ref (boolean)
    - Handler for selectConfig: check if entry rank is in topResults (top 5 have full purchaseLog), otherwise fetch via single backtest API

    **Page header update:**
    - Keep the "Back to Dashboard" link
    - Move the y-axis toggle (USD/BTC) to work across both tabs (shared state)

    **Layout:**
    - Full width for sweep tab (table needs horizontal space)
    - Detail panel below table, separated by a divider or within a UCard
  </action>
  <verify>
    - UTabs with "Single Backtest" and "Parameter Sweep" tabs render on /backtest page
    - Sweep tab shows SweepForm, and after sweep completion shows SweepResultsTable
    - Clicking a sweep row loads full backtest detail below the table
    - Top 5 results load instantly (have purchaseLog), others trigger single backtest fetch
    - Y-axis toggle works across both tabs
  </verify>
  <done>
    Backtest page has tabbed layout with Single and Sweep modes. Sweep tab shows parameter form, sortable results table, and clickable rows that load full backtest detail (chart + metrics) below the table. Top 5 results load instantly from sweep topResults; others fetch on demand.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /backtest — tabs appear (Single Backtest, Parameter Sweep)
2. Switch to Sweep tab — sweep form renders with comma-separated parameter inputs
3. Fill sweep parameters and click "Run Sweep" — progress bar advances, results table appears
4. Table columns are sortable — click "Efficiency" header sorts by efficiency
5. Click a sweep result row — detail panel appears below with chart + metrics
6. Top-ranked results (1-5) load instantly, lower-ranked results show loading then display
7. Switch between tabs — state persists within each tab
8. Y-axis toggle (USD/BTC) works in both single and sweep detail views
</verification>

<success_criteria>
- Tabbed layout separates single backtest and parameter sweep flows
- Sweep form accepts parameter ranges and runs sweep with progress indicator
- Results table is sortable by all metric columns with efficiency as default sort
- Clicking any sweep row loads full backtest detail (chart + metrics) below table
- Top 5 results have instant detail loading (pre-fetched purchaseLog)
</success_criteria>

<output>
After completion, create `.planning/phases/11-backtest-visualization/11-03-SUMMARY.md`
</output>
