---
phase: 32-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/CoinGeckoPriceProviderTests.cs
  - tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/VNDirectPriceProviderTests.cs
  - tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/OpenErApiProviderTests.cs
  - TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
autonomous: true
requirements: []

must_haves:
  truths:
    - "CoinGeckoPriceProvider unit tests cover fresh cache hit, stale cache fallback, API failure with stale cache, and cache miss scenarios"
    - "VNDirectPriceProvider unit tests cover fresh cache, stale-while-revalidate fire-and-forget refresh, and API failure scenarios"
    - "OpenErApiProvider unit tests cover fresh cache, stale fallback on API failure, and cache empty fetch scenarios"
    - "Exchange rate failure in portfolio summary returns last cached value (not 0) for VND conversions"
  artifacts:
    - path: "tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/CoinGeckoPriceProviderTests.cs"
      provides: "Unit tests for CoinGeckoPriceProvider"
      min_lines: 100
    - path: "tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/VNDirectPriceProviderTests.cs"
      provides: "Unit tests for VNDirectPriceProvider"
      min_lines: 80
    - path: "tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/OpenErApiProviderTests.cs"
      provides: "Unit tests for OpenErApiProvider"
      min_lines: 80
  key_links:
    - from: "tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/CoinGeckoPriceProviderTests.cs"
      to: "TradingBot.ApiService/Infrastructure/PriceFeeds/Crypto/CoinGeckoPriceProvider.cs"
      via: "NSubstitute mocks for HttpClient, IDistributedCache, IOptionsMonitor"
      pattern: "CoinGeckoPriceProvider"
    - from: "TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs"
      to: "TradingBot.ApiService/Infrastructure/PriceFeeds/ExchangeRate/IExchangeRateProvider.cs"
      via: "exchange rate fallback from 0 to cached value"
      pattern: "exchangeRate.*Price.*0"
---

<objective>
Add unit tests for all three price feed providers (CoinGecko, VNDirect, OpenErApi) and fix the exchange rate graceful degradation so portfolio summary returns the last cached exchange rate instead of 0 when the API fails.

Purpose: Closes 3 of the 5 Phase 32 success criteria — unit tests for all price providers and exchange rate graceful degradation.
Output: 3 new test files with comprehensive coverage, updated PortfolioEndpoints.cs with cached rate fallback.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@TradingBot.ApiService/Infrastructure/PriceFeeds/Crypto/CoinGeckoPriceProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/Crypto/ICryptoPriceProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/Etf/VNDirectPriceProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/Etf/IEtfPriceProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/Etf/VNDirectDchartResponse.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/ExchangeRate/OpenErApiProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/ExchangeRate/IExchangeRateProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/ExchangeRate/OpenErApiResponse.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/PriceFeedEntry.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/PriceFeedResult.cs
@TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
@tests/TradingBot.ApiService.Tests/TradingBot.ApiService.Tests.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit tests for all three price feed providers</name>
  <files>
    tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/CoinGeckoPriceProviderTests.cs
    tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/VNDirectPriceProviderTests.cs
    tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/OpenErApiProviderTests.cs
  </files>
  <action>
    Create unit tests for each of the three price feed providers. All providers share the same testing strategy: mock IDistributedCache (for Redis), mock HttpClient via a custom HttpMessageHandler, and mock ILogger. Use NSubstitute for mocks and FluentAssertions for assertions. Follow existing test naming convention: `MethodName_Scenario_ShouldBehavior`.

    **CoinGeckoPriceProviderTests** (test the `GetPriceAsync` method):
    1. `GetPriceAsync_FreshCacheHit_ReturnsFreshResult` — Set up IDistributedCache.GetAsync to return a MessagePack-serialized PriceFeedEntry with FetchedAtUnixSeconds within 5 minutes. Assert result.IsStale is false and no HTTP call made.
    2. `GetPriceAsync_StaleCacheAndApiSuccess_ReturnsFreshResult` — Cache entry is >5 minutes old. Mock HTTP handler returns valid CoinGecko JSON `{"bitcoin":{"usd":95000,"last_updated_at":123}}`. Assert result.IsStale is false and price matches API response.
    3. `GetPriceAsync_StaleCacheAndApiFailure_ReturnsStaleResult` — Cache entry is >5 minutes old. HTTP handler throws HttpRequestException. Assert result.IsStale is true and price matches stale cached value.
    4. `GetPriceAsync_EmptyCacheAndApiSuccess_ReturnsFreshResult` — Cache returns null. HTTP handler returns valid response. Assert fresh result with correct price.
    5. `GetPriceAsync_EmptyCacheAndApiFailure_ThrowsException` — Cache returns null. HTTP handler throws. Assert InvalidOperationException or HttpRequestException is thrown.

    To mock HttpClient: Create a `MockHttpMessageHandler` helper class that takes a Func<HttpRequestMessage, HttpResponseMessage> delegate. Create the HttpClient with `new HttpClient(handler) { BaseAddress = ... }`. For IOptionsMonitor<CoinGeckoOptions>, use NSubstitute: `var optionsMonitor = Substitute.For<IOptionsMonitor<CoinGeckoOptions>>(); optionsMonitor.CurrentValue.Returns(new CoinGeckoOptions { ApiKey = "test" });`.

    For cache mocking: MessagePack serialize a PriceFeedEntry and set up `cache.GetAsync(Arg.Any<string>(), Arg.Any<CancellationToken>()).Returns(bytes)`. For cache writes, use `cache.SetAsync(...)`.

    **VNDirectPriceProviderTests** (test the `GetPriceAsync` method):
    1. `GetPriceAsync_FreshCacheHit_ReturnsFreshResult` — Cache entry within 48h. Assert no HTTP call.
    2. `GetPriceAsync_StaleCacheHit_ReturnsStaleAndTriggersBackgroundRefresh` — Cache entry >48h old. Assert result is stale (returned immediately). The fire-and-forget refresh happens in the background — verify by checking that the HTTP call is made eventually (use a small delay or verify handler was called).
    3. `GetPriceAsync_EmptyCacheAndApiSuccess_ReturnsFreshResult` — Mock HTTP response with valid VNDirect dchart JSON: `{"t":[1234],"c":[20.29],"o":[20.1],"h":[20.5],"l":[20.0],"v":[1000],"s":"ok"}`. Assert price is 20290 VND (20.29 * 1000).
    4. `GetPriceAsync_EmptyCacheAndApiFailure_Throws` — HTTP handler returns error response. Assert exception.

    **OpenErApiProviderTests** (test the `GetUsdToVndRateAsync` method):
    1. `GetUsdToVndRateAsync_FreshCacheHit_ReturnsFreshResult` — Cache entry within 12h.
    2. `GetUsdToVndRateAsync_StaleCacheAndApiSuccess_ReturnsFreshResult` — Cache >12h, API returns `{"result":"success","rates":{"VND":25380}}`. Assert fresh result with rate 25380.
    3. `GetUsdToVndRateAsync_StaleCacheAndApiFailure_ReturnsStaleResult` — Cache >12h, HTTP throws. Assert stale result with cached rate.
    4. `GetUsdToVndRateAsync_EmptyCacheAndApiSuccess_ReturnsFreshResult` — No cache, API succeeds.
    5. `GetUsdToVndRateAsync_EmptyCacheAndApiFailure_Throws` — No cache, API throws.

    Put the MockHttpMessageHandler helper class in a shared file at `tests/TradingBot.ApiService.Tests/Infrastructure/PriceFeeds/MockHttpMessageHandler.cs` or as a nested class in each test. Using a shared helper is preferred.

    Note: CoinGeckoPriceProvider constructor injects `HttpClient` (not IHttpClientFactory), so pass the mocked HttpClient directly. Same for VNDirectPriceProvider and OpenErApiProvider.

    Important: CoinGeckoPriceProvider also adds the API key header per-request in FetchFromApiAsync (line 158), in addition to the DI-level default header. The test should verify the header is present on the request.
  </action>
  <verify>
    Run `dotnet test tests/TradingBot.ApiService.Tests/ --filter "FullyQualifiedName~PriceProviderTests|FullyQualifiedName~PriceProvider"` — all tests pass.
    Run `dotnet test` — full test suite passes (no regressions).
  </verify>
  <done>
    At least 14 unit tests across 3 test files covering all cache/API scenarios for CoinGeckoPriceProvider, VNDirectPriceProvider, and OpenErApiProvider. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix exchange rate graceful degradation in portfolio endpoints</name>
  <files>
    TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
  </files>
  <action>
    **Current bug:** In `GetSummaryAsync` and `GetAssetsAsync`, when `exchangeRateProvider.GetUsdToVndRateAsync(ct)` throws, the code catches the exception and sets `rate = exchangeRate?.Price ?? 0m` which results in `rate = 0`. This causes all VND conversion values to be 0.

    **Fix approach:** Inject `IDistributedCache` into both `GetSummaryAsync` and `GetAssetsAsync`. Before calling the exchange rate provider, read the cached exchange rate directly from Redis using the same cache key `"price:exchangerate:usd-vnd"` and MessagePack deserialize. If the provider call fails, fall back to this cached value instead of 0.

    Alternatively (simpler approach — preferred): Change the catch block to call the cache directly. But since OpenErApiProvider already handles stale fallback internally (it catches HttpRequestException and InvalidOperationException and returns stale), the real gap is when the cache is ALSO empty (first run with no cache). In that case, 0 is unavoidable.

    Actually, re-reading OpenErApiProvider: it already returns stale cached values when the API fails AND cache has data. The issue is only when the exception is NOT HttpRequestException or InvalidOperationException (e.g., TaskCanceledException, TimeoutRejectedException from resilience pipeline). The portfolio endpoint catch block catches ALL exceptions, so even if OpenErApiProvider properly returns stale for known exceptions, the resilience pipeline might throw OperationCanceledException.

    **Correct fix:** In both `GetSummaryAsync` and `GetAssetsAsync`:
    1. Add `IDistributedCache cache` parameter to the method signature (minimal API auto-injects from DI).
    2. In the catch block, attempt to read the cached rate directly:
       ```csharp
       catch (Exception ex)
       {
           logger.LogWarning(ex, "Failed to fetch USD/VND exchange rate...");
           // Fall back to last cached rate
           var cachedBytes = await cache.GetAsync("price:exchangerate:usd-vnd", ct);
           if (cachedBytes is not null)
           {
               var cached = MessagePackSerializer.Deserialize<PriceFeedEntry>(cachedBytes, MessagePackSerializerOptions.Standard);
               exchangeRate = PriceFeedResult.Stale(cached.Price, cached.FetchedAt, "VND");
           }
       }
       ```
    3. Add `using MessagePack;` and `using TradingBot.ApiService.Infrastructure.PriceFeeds;` to the usings if not already present.

    This ensures that even if the exchange rate provider throws any exception type, the portfolio endpoints still have the last cached rate available.
  </action>
  <verify>
    Run `dotnet build TradingBot.slnx` — compiles without errors.
    Run `dotnet test` — all tests pass (no regressions).
    Manually verify the code: in both GetSummaryAsync and GetAssetsAsync, the catch block now reads from cache instead of leaving rate as 0.
  </verify>
  <done>
    Exchange rate failure in portfolio summary and assets endpoints returns last cached value (not 0) for VND conversions. Code compiles and all tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet test` — all tests pass including new price feed provider tests
2. `dotnet build TradingBot.slnx` — solution compiles without errors
3. Verify CoinGeckoPriceProviderTests.cs exists with at least 5 test methods
4. Verify VNDirectPriceProviderTests.cs exists with at least 4 test methods
5. Verify OpenErApiProviderTests.cs exists with at least 5 test methods
6. Verify PortfolioEndpoints.cs catch blocks read cached exchange rate instead of defaulting to 0
</verification>

<success_criteria>
- 14+ unit tests across 3 test files for CoinGeckoPriceProvider, VNDirectPriceProvider, and OpenErApiProvider
- All tests pass with `dotnet test`
- PortfolioEndpoints exchange rate catch blocks fall back to cached rate, not 0
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/32-tech-debt-cleanup/32-01-SUMMARY.md`
</output>
