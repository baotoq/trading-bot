---
phase: 29-flutter-portfolio-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
  - TradingBot.Mobile/pubspec.yaml
  - TradingBot.Mobile/lib/main.dart
  - TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart
  - TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_asset_response.dart
  - TradingBot.Mobile/lib/features/portfolio/data/models/transaction_response.dart
  - TradingBot.Mobile/lib/features/portfolio/data/models/fixed_deposit_response.dart
  - TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart
  - TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart
  - TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.g.dart
  - TradingBot.Mobile/lib/features/portfolio/data/currency_provider.dart
  - TradingBot.Mobile/lib/features/portfolio/data/currency_provider.g.dart
autonomous: true
requirements:
  - DISP-01
  - DISP-06

must_haves:
  truths:
    - "VND/USD currency toggle persists across app restarts via SharedPreferences"
    - "Portfolio data (summary, assets, fixed deposits) can be fetched in parallel from the backend"
    - "Transaction history for any asset can be fetched from the backend with optional type/date filters"
  artifacts:
    - path: "TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs"
      provides: "GET /api/portfolio/assets/{id}/transactions endpoint"
      contains: "GetTransactionsAsync"
    - path: "TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart"
      provides: "HTTP calls to all portfolio endpoints"
      contains: "fetchSummary"
    - path: "TradingBot.Mobile/lib/features/portfolio/data/currency_provider.dart"
      provides: "Global VND/USD toggle with SharedPreferences persistence"
      contains: "CurrencyPreference"
    - path: "TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart"
      provides: "Riverpod providers for portfolio data"
      contains: "portfolioPageData"
  key_links:
    - from: "TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart"
      to: "/api/portfolio/*"
      via: "Dio HTTP client"
      pattern: "dio\\.get.*api/portfolio"
    - from: "TradingBot.Mobile/lib/features/portfolio/data/currency_provider.dart"
      to: "SharedPreferences"
      via: "Provider override in main.dart"
      pattern: "SharedPreferences\\.getInstance"
---

<objective>
Backend gap fix (transaction list endpoint) + complete Flutter data layer for the portfolio feature, including all Dart models, repository, Riverpod providers, and VND/USD currency toggle with SharedPreferences persistence.

Purpose: All Flutter UI screens in subsequent plans need data models and providers to exist first. The backend transaction listing endpoint must exist before the history screen can fetch data. The currency toggle must be a global Riverpod provider so all screens can `ref.watch` it.

Output: Working data layer ready for UI consumption, plus backend endpoint for DISP-06.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-flutter-portfolio-ui/29-RESEARCH.md
@.planning/phases/29-flutter-portfolio-ui/29-CONTEXT.md
@TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
@TradingBot.ApiService/Endpoints/PortfolioDtos.cs
@TradingBot.ApiService/Endpoints/FixedDepositDtos.cs
@TradingBot.ApiService/Endpoints/FixedDepositEndpoints.cs
@TradingBot.Mobile/lib/main.dart
@TradingBot.Mobile/lib/features/home/data/home_repository.dart
@TradingBot.Mobile/lib/features/home/data/home_providers.dart
@TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart
@TradingBot.Mobile/pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET transactions endpoint + shared_preferences + currency toggle provider</name>
  <files>
    TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
    TradingBot.Mobile/pubspec.yaml
    TradingBot.Mobile/lib/main.dart
    TradingBot.Mobile/lib/features/portfolio/data/currency_provider.dart
    TradingBot.Mobile/lib/features/portfolio/data/currency_provider.g.dart
  </files>
  <action>
**Backend (PortfolioEndpoints.cs):**
Add `GET /api/portfolio/assets/{id}/transactions` endpoint to PortfolioEndpoints:
- Register route: `group.MapGet("/assets/{id}/transactions", GetTransactionsAsync);`
- Method signature: `private static async Task<IResult> GetTransactionsAsync(TradingBotDbContext db, Guid id, string? type, DateOnly? startDate, DateOnly? endDate, CancellationToken ct)`
- Validate `id` resolves to a real PortfolioAsset (return 404 if not found)
- Query `db.AssetTransactions.Where(t => t.PortfolioAssetId == PortfolioAssetId.From(id))`
- Apply optional filters: if `type` provided, parse to `TransactionType` and filter; if `startDate`/`endDate` provided, filter by `t.Date >= startDate` and `t.Date <= endDate`
- Order by `Date DESC` then by `CreatedAt DESC`
- Map to `List<TransactionResponse>` using same mapping pattern as CreateTransactionAsync
- Return `Results.Ok(result)`

**Flutter (pubspec.yaml):**
Add `shared_preferences: ^2.5.0` to dependencies section (after `intl: any`).
Run `cd TradingBot.Mobile && flutter pub get`.

**Flutter (main.dart):**
- Import `package:shared_preferences/shared_preferences.dart`
- Import the currency provider file
- In `main()`, after `WidgetsFlutterBinding.ensureInitialized()` and `Firebase.initializeApp()`, add: `final prefs = await SharedPreferences.getInstance();`
- Pass `prefs` as a `ProviderScope` override: `ProviderScope(overrides: [sharedPreferencesProvider.overrideWithValue(prefs)], child: const TradingBotApp())`

**Flutter (currency_provider.dart):**
Create `lib/features/portfolio/data/currency_provider.dart`:
- Import `package:riverpod_annotation/riverpod_annotation.dart`, `package:shared_preferences/shared_preferences.dart`
- Add `part 'currency_provider.g.dart';`
- Create a simple `@Riverpod(keepAlive: true)` provider for SharedPreferences instance:
  ```dart
  @Riverpod(keepAlive: true)
  SharedPreferences sharedPreferences(Ref ref) {
    throw UnimplementedError('Must be overridden in ProviderScope');
  }
  ```
- Create `@riverpod` class `CurrencyPreference extends _$CurrencyPreference`:
  - Static const `_key = 'currency_vnd'` (true = VND, false = USD)
  - `build()` returns `bool`: reads `ref.watch(sharedPreferencesProvider).getBool(_key) ?? true` (synchronous since prefs is pre-loaded)
  - `toggle()` method: flips current value, writes to SharedPreferences via `ref.read(sharedPreferencesProvider).setBool(_key, next)`, updates state to `next`

Run `cd TradingBot.Mobile && dart run build_runner build --delete-conflicting-outputs` to generate `.g.dart`.
  </action>
  <verify>
- `dotnet build TradingBot.slnx` compiles without errors
- `cd TradingBot.Mobile && flutter analyze` has no errors
- currency_provider.g.dart exists and contains `sharedPreferencesProvider` and `currencyPreferenceProvider`
  </verify>
  <done>
- GET /api/portfolio/assets/{id}/transactions endpoint exists with optional type, startDate, endDate query params
- shared_preferences is in pubspec.yaml and SharedPreferences pre-loaded in main.dart
- CurrencyPreference Riverpod notifier reads/writes VND/USD preference synchronously
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Dart models, portfolio repository, and data providers</name>
  <files>
    TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart
    TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_asset_response.dart
    TradingBot.Mobile/lib/features/portfolio/data/models/transaction_response.dart
    TradingBot.Mobile/lib/features/portfolio/data/models/fixed_deposit_response.dart
    TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart
    TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart
    TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.g.dart
  </files>
  <action>
**Dart Models (manual fromJson, no codegen â€” per v3.0 convention):**

`portfolio_summary_response.dart`:
```dart
class AllocationDto {
  final String assetType;
  final double valueUsd;
  final double percentage;
  AllocationDto({required this.assetType, required this.valueUsd, required this.percentage});
  factory AllocationDto.fromJson(Map<String, dynamic> json) => AllocationDto(
    assetType: json['assetType'] as String,
    valueUsd: (json['valueUsd'] as num).toDouble(),
    percentage: (json['percentage'] as num).toDouble(),
  );
}

class PortfolioSummaryResponse {
  final double totalValueUsd;
  final double totalValueVnd;
  final double totalCostUsd;
  final double totalCostVnd;
  final double unrealizedPnlUsd;
  final double unrealizedPnlVnd;
  final double? unrealizedPnlPercent;
  final List<AllocationDto> allocations;
  final DateTime? exchangeRateUpdatedAt;
  // Constructor + fromJson
}
```
Map all fields from JSON. `exchangeRateUpdatedAt` parses from ISO 8601 string with null check.

`portfolio_asset_response.dart`:
```dart
class PortfolioAssetResponse {
  final String id;
  final String name;
  final String ticker;
  final String assetType;
  final String nativeCurrency;
  final double quantity;
  final double averageCost;
  final double currentPrice;
  final double currentValueUsd;
  final double currentValueVnd;
  final double unrealizedPnlUsd;
  final double? unrealizedPnlPercent;
  final DateTime? priceUpdatedAt;
  final bool isPriceStale;
  // Constructor + fromJson
}
```

`transaction_response.dart`:
```dart
class TransactionResponse {
  final String id;
  final String date; // Keep as string "yyyy-MM-dd", parse when needed
  final double quantity;
  final double pricePerUnit;
  final String currency;
  final String type;
  final double? fee;
  final String source;
  // Constructor + fromJson
}
```

`fixed_deposit_response.dart`:
```dart
class FixedDepositResponse {
  final String id;
  final String bankName;
  final double principalVnd;
  final double annualInterestRate;
  final String startDate;
  final String maturityDate;
  final String compoundingFrequency;
  final String status;
  final double accruedValueVnd;
  final double projectedMaturityValueVnd;
  final int daysToMaturity;
  final DateTime createdAt;
  // Constructor + fromJson
}
```

**Repository (portfolio_repository.dart):**
```dart
class PortfolioRepository {
  PortfolioRepository(this._dio);
  final Dio _dio;

  Future<PortfolioSummaryResponse> fetchSummary() async {
    final response = await _dio.get('/api/portfolio/summary');
    return PortfolioSummaryResponse.fromJson(response.data as Map<String, dynamic>);
  }

  Future<List<PortfolioAssetResponse>> fetchAssets() async {
    final response = await _dio.get('/api/portfolio/assets');
    return (response.data as List).map((e) => PortfolioAssetResponse.fromJson(e as Map<String, dynamic>)).toList();
  }

  Future<List<FixedDepositResponse>> fetchFixedDeposits() async {
    final response = await _dio.get('/api/portfolio/fixed-deposits/');
    return (response.data as List).map((e) => FixedDepositResponse.fromJson(e as Map<String, dynamic>)).toList();
  }

  Future<List<TransactionResponse>> fetchTransactions(String assetId, {String? type, String? startDate, String? endDate}) async {
    final queryParams = <String, dynamic>{};
    if (type != null) queryParams['type'] = type;
    if (startDate != null) queryParams['startDate'] = startDate;
    if (endDate != null) queryParams['endDate'] = endDate;
    final response = await _dio.get('/api/portfolio/assets/$assetId/transactions', queryParameters: queryParams);
    return (response.data as List).map((e) => TransactionResponse.fromJson(e as Map<String, dynamic>)).toList();
  }

  Future<TransactionResponse> createTransaction(String assetId, Map<String, dynamic> body) async {
    final response = await _dio.post('/api/portfolio/assets/$assetId/transactions', data: body);
    return TransactionResponse.fromJson(response.data as Map<String, dynamic>);
  }

  Future<FixedDepositResponse> createFixedDeposit(Map<String, dynamic> body) async {
    final response = await _dio.post('/api/portfolio/fixed-deposits/', data: body);
    return FixedDepositResponse.fromJson(response.data as Map<String, dynamic>);
  }
}
```

**Providers (portfolio_providers.dart):**
```dart
part 'portfolio_providers.g.dart';

class PortfolioPageData {
  final PortfolioSummaryResponse summary;
  final List<PortfolioAssetResponse> assets;
  final List<FixedDepositResponse> fixedDeposits;
  PortfolioPageData({required this.summary, required this.assets, required this.fixedDeposits});
}

@riverpod
PortfolioRepository portfolioRepository(Ref ref) {
  return PortfolioRepository(ref.watch(dioProvider));
}

@riverpod
Future<PortfolioPageData> portfolioPageData(Ref ref) async {
  final repo = ref.watch(portfolioRepositoryProvider);
  final results = await Future.wait([
    repo.fetchSummary(),
    repo.fetchAssets(),
    repo.fetchFixedDeposits(),
  ]);
  return PortfolioPageData(
    summary: results[0] as PortfolioSummaryResponse,
    assets: results[1] as List<PortfolioAssetResponse>,
    fixedDeposits: results[2] as List<FixedDepositResponse>,
  );
}
```

Run `cd TradingBot.Mobile && dart run build_runner build --delete-conflicting-outputs` to generate `.g.dart`.
  </action>
  <verify>
- `cd TradingBot.Mobile && flutter analyze` has no errors
- portfolio_providers.g.dart exists and contains `portfolioRepositoryProvider` and `portfolioPageDataProvider`
- All 4 model files have working `fromJson` factory constructors
  </verify>
  <done>
- All 4 Dart model classes mirror backend DTOs with manual fromJson
- PortfolioRepository has methods for all 6 portfolio API endpoints (summary, assets, fixed-deposits, transactions, createTransaction, createFixedDeposit)
- portfolioPageDataProvider fetches summary + assets + fixed deposits in parallel via Future.wait
- portfolioRepositoryProvider wired to Dio via dioProvider
  </done>
</task>

</tasks>

<verification>
- `dotnet build TradingBot.slnx` compiles
- `cd TradingBot.Mobile && flutter analyze` passes with no errors
- `cd TradingBot.Mobile && flutter pub get` resolves all dependencies including shared_preferences
- Generated .g.dart files exist for both provider files
</verification>

<success_criteria>
1. GET /api/portfolio/assets/{id}/transactions returns transaction list with optional filters
2. shared_preferences installed and SharedPreferences pre-loaded in main.dart before runApp
3. CurrencyPreference provider provides synchronous VND/USD toggle that persists to SharedPreferences
4. All Dart models match backend DTO shapes exactly
5. PortfolioRepository covers all portfolio API surface (summary, assets, fixed-deposits list, transactions list, create transaction, create fixed deposit)
6. portfolioPageDataProvider fetches all three data sources in parallel
</success_criteria>

<output>
After completion, create `.planning/phases/29-flutter-portfolio-ui/29-01-SUMMARY.md`
</output>
