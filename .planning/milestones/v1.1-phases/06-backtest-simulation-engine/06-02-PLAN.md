---
phase: 06-backtest-simulation-engine
plan: 02
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - TradingBot.ApiService/Application/Services/BacktestSimulator.cs
  - tests/TradingBot.ApiService.Tests/Application/Services/BacktestSimulatorTests.cs
autonomous: true

must_haves:
  truths:
    - "Max drawdown measures worst unrealized loss from peak PnL relative to total invested"
    - "Match-total fixed DCA total invested equals smart DCA total invested (within rounding)"
    - "Tier breakdown shows trigger count + extra USD spent + extra BTC acquired per tier"
    - "Comparison metrics show cost basis delta and extra BTC % for BOTH baselines (same-base and match-total)"
    - "Efficiency ratio > 1.0 means smart DCA outperformed fixed DCA on return %"
    - "Edge cases handled: single day, all same prices, extreme drops, prices near zero"
    - "Golden snapshot captures full BacktestResult for regression detection"
  artifacts:
    - path: "TradingBot.ApiService/Application/Services/BacktestSimulator.cs"
      provides: "Complete simulation engine with all metrics"
      contains: "CalculateMaxDrawdown"
    - path: "tests/TradingBot.ApiService.Tests/Application/Services/BacktestSimulatorTests.cs"
      provides: "Comprehensive test coverage including metrics and edge cases"
      contains: "MaxDrawdown"
    - path: "tests/TradingBot.ApiService.Tests/Application/Services/_snapshots/BacktestSimulatorTests_Run_GoldenScenario_MatchSnapshot.json"
      provides: "Snapshot baseline for regression detection"
  key_links:
    - from: "BacktestSimulator.cs"
      to: "BacktestResult.cs"
      via: "MaxDrawdown field populated with real calculation"
      pattern: "MaxDrawdown.*="
    - from: "BacktestSimulatorTests.cs"
      to: "BacktestSimulator.cs"
      via: "Tests verify metrics, tier breakdown, drawdown, and edge cases"
      pattern: "MaxDrawdown|TierBreakdown|Comparison|EfficiencyRatio"
---

<objective>
Add max drawdown calculation, verify tier breakdown and comparison metrics, test edge cases, and establish a golden snapshot baseline for the BacktestSimulator.

Purpose: Complete the simulation engine with all metrics specified in the phase success criteria, ensure robustness with edge case handling, and establish a regression baseline via snapshot testing.

Output: Fully complete BacktestSimulator with comprehensive test coverage (25+ tests total) and golden snapshot. Phase 6 complete.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backtest-simulation-engine/06-RESEARCH.md
@.planning/phases/06-backtest-simulation-engine/06-CONTEXT.md
@.planning/phases/06-backtest-simulation-engine/06-01-SUMMARY.md
@TradingBot.ApiService/Application/Services/BacktestSimulator.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestResult.cs
@tests/TradingBot.ApiService.Tests/Application/Services/BacktestSimulatorTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for max drawdown, tier breakdown accuracy, comparison metrics, and edge cases</name>
  <files>
    tests/TradingBot.ApiService.Tests/Application/Services/BacktestSimulatorTests.cs
  </files>
  <action>
    **Add failing tests to BacktestSimulatorTests.cs:**

    **Max Drawdown tests:**

    a. **Run_MaxDrawdown_MeasuresWorstUnrealizedLoss** - Create price data that rises then crashes then recovers:
       - Days 1-10: price rises from 50000 to 60000 (building profit)
       - Days 11-20: price crashes to 30000 (unrealized loss from peak)
       - Days 21-30: price recovers to 55000
       - Verify SmartDca.MaxDrawdown > 0 (positive percentage representing worst loss)
       - Verify MaxDrawdown is the peak-to-trough unrealized PnL drawdown relative to total invested

    b. **Run_MaxDrawdown_ZeroForMonotonicallyRisingPrices** - Prices only go up (50000, 51000, 52000...) -> MaxDrawdown should be 0 (never had unrealized loss after having profit)

    c. **Run_MaxDrawdown_CalculatedForAllThreeStrategies** - Verify SmartDca, FixedDcaSameBase, and FixedDcaMatchTotal all have MaxDrawdown populated

    **Tier Breakdown tests:**

    d. **Run_TierBreakdown_CountsTriggersPerTier** - Create price data where:
       - 10 days at 5% below high (should trigger >= 5% tier with 1.5x)
       - 5 days at 15% below high (should trigger >= 10% tier with 2.0x)
       - 3 days at 25% below high (should trigger >= 20% tier with 3.0x)
       - Verify tier breakdown has correct trigger counts per tier

    e. **Run_TierBreakdown_ExtraUsdSpent** - For days where 5% tier triggers at base=10: extra = 10*1.5 - 10 = 5 per day. Sum across all tier-triggering days.

    f. **Run_TierBreakdown_ExtraBtcAcquired** - Verify ExtraBtcAcquired > 0 for each triggered tier (the extra BTC bought because of the multiplier vs base amount)

    g. **Run_TierBreakdown_NoTriggeredTiers_ReturnsEmptyOrAllZeros** - Flat prices -> no tiers trigger, breakdown has zero trigger counts

    **Comparison Metrics tests:**

    h. **Run_Comparison_CostBasisDeltaNegativeWhenSmartIsCheaper** - When price drops significantly, smart DCA buys more at lower prices -> lower avg cost basis -> CostBasisDeltaSameBase < 0

    i. **Run_Comparison_ExtraBtcPercentPositiveWhenSmartBuysMore** - Same-base comparison: smart DCA spends more total but at better prices -> ExtraBtcPercentSameBase > 0

    j. **Run_Comparison_MatchTotalSameSpend** - Verify FixedDcaMatchTotal.TotalInvested is approximately equal to SmartDca.TotalInvested (within 0.01m tolerance for rounding)

    k. **Run_Comparison_EfficiencyRatioAboveOneWhenSmartOutperforms** - When smart DCA has higher return % than fixed -> EfficiencyRatio > 1.0

    **Edge Case tests:**

    l. **Run_SingleDay_ProducesValidResult** - 1 day of price data -> PurchaseLog has 1 entry, metrics computed without division-by-zero

    m. **Run_AllSamePrices_SmartAndFixedIdentical** - All days same price, no tiers triggered -> SmartDca metrics should equal FixedDcaSameBase metrics exactly (multiplier always 1.0)

    n. **Run_NullConfig_ThrowsArgumentNullException** - null config -> ArgumentNullException
    o. **Run_NullPriceData_ThrowsArgumentNullException** - null priceData -> ArgumentNullException

    Run `dotnet test --filter "FullyQualifiedName~BacktestSimulatorTests"` -- new tests should FAIL (MaxDrawdown returns 0 placeholder from Plan 01, or assertions on tier breakdown/comparison don't match).

    Note: Some tests may already pass if Plan 01 implemented tier breakdown and comparison correctly. The purpose of RED here is to verify and catch gaps. If all tests pass, that's acceptable -- it means Plan 01 was thorough. Focus then shifts to adding the golden snapshot.

    Commit: `test(06-02): add tests for max drawdown, tier breakdown, comparison metrics, and edge cases`
  </action>
  <verify>
    `dotnet build TradingBot.sln` succeeds with 0 errors.
    `dotnet test --filter "FullyQualifiedName~BacktestSimulatorTests"` -- at minimum the MaxDrawdown tests fail (Plan 01 left MaxDrawdown as 0m placeholder).
  </verify>
  <done>15+ new tests exist. MaxDrawdown tests fail (confirming gap). Tier breakdown and comparison tests verify Plan 01 implementation or expose gaps.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement max drawdown calculation and fix any failing tests</name>
  <files>
    TradingBot.ApiService/Application/Services/BacktestSimulator.cs
    tests/TradingBot.ApiService.Tests/Application/Services/BacktestSimulatorTests.cs
  </files>
  <action>
    **Implement max drawdown calculation in BacktestSimulator:**

    Add a private static method `CalculateMaxDrawdown`:
    ```csharp
    private static decimal CalculateMaxDrawdown(
        IReadOnlyList<PurchaseLogEntry> purchaseLog,
        IReadOnlyList<DailyPriceData> priceData,
        Func<PurchaseLogEntry, decimal> getCumulativeBtc,
        Func<PurchaseLogEntry, decimal> getCumulativeUsd)
    {
        decimal maxDrawdown = 0m;
        decimal peakUnrealizedPnL = 0m;

        for (int i = 0; i < purchaseLog.Count; i++)
        {
            var cumulativeBtc = getCumulativeBtc(purchaseLog[i]);
            var cumulativeUsd = getCumulativeUsd(purchaseLog[i]);
            var portfolioValue = cumulativeBtc * priceData[i].Close;
            var unrealizedPnL = portfolioValue - cumulativeUsd;

            if (unrealizedPnL > peakUnrealizedPnL)
                peakUnrealizedPnL = unrealizedPnL;

            if (peakUnrealizedPnL > 0 && cumulativeUsd > 0)
            {
                var drawdown = (unrealizedPnL - peakUnrealizedPnL) / cumulativeUsd * 100m;
                if (drawdown < maxDrawdown)
                    maxDrawdown = drawdown;
            }
        }

        return Math.Abs(maxDrawdown); // Return as positive percentage
    }
    ```

    The method takes selector functions so it can compute drawdown for smart DCA, same-base, and match-total using the same logic:
    - Smart: `getCumulativeBtc = e => e.SmartCumulativeBtc`, `getCumulativeUsd = e => e.SmartCumulativeUsd`
    - SameBase: `getCumulativeBtc = e => e.FixedSameBaseCumulativeBtc`, `getCumulativeUsd = e => e.FixedSameBaseCumulativeUsd`
    - MatchTotal: `getCumulativeBtc = e => e.FixedMatchTotalCumulativeBtc`, `getCumulativeUsd = e => e.FixedMatchTotalCumulativeUsd`

    **Update metrics assembly** to call CalculateMaxDrawdown for each strategy and populate the MaxDrawdown field in DcaMetrics (replace the 0m placeholder from Plan 01).

    **Fix any other failing tests** from Task 1 (tier breakdown, comparison metrics, edge cases). If any calculations were incorrect in Plan 01, fix them now.

    **Add golden snapshot test:**

    ```csharp
    [Fact]
    public void Run_GoldenScenario_MatchSnapshot()
    {
        // Arrange: 60 days of realistic price movement
        // Start at 60000, dip to 50000 (bear + 10% tier), recover to 65000
        var config = CreateDefaultConfig();
        var priceData = CreateRealisticPriceData(); // Helper that generates 60 days of varied prices

        // Act
        var result = BacktestSimulator.Run(config, priceData);

        // Assert: snapshot captures full result structure
        result.ShouldMatchSnapshot();
    }
    ```

    Create `CreateRealisticPriceData()` helper that generates 60 days:
    - Days 1-15: 60000 -> 58000 (slight decline, minor tier triggers)
    - Days 16-30: 58000 -> 48000 (bear market, crosses below MA200 if available, 20%+ tier triggers)
    - Days 31-45: 48000 -> 52000 (recovery)
    - Days 46-60: 52000 -> 65000 (bull run)

    This exercises all multiplier tiers, bear market detection, drawdown, and recovery.

    Run `dotnet test` -- all tests pass including golden snapshot (generated on first run).

    Commit: `feat(06-02): implement max drawdown and add golden snapshot baseline`

    **REFACTOR (if needed):**
    - Extract any repeated code into helper methods
    - Ensure all decimal calculations use `m` suffix
    - Verify no float/double leaks
    - Run tests to confirm no regressions

    If refactored, commit: `refactor(06-02): clean up BacktestSimulator`
  </action>
  <verify>
    `dotnet build TradingBot.sln` succeeds with 0 errors.
    `dotnet test` -- ALL tests pass (Phase 5 + Phase 6 Plan 01 + Plan 02), zero regressions.
    `dotnet test --filter "FullyQualifiedName~BacktestSimulatorTests"` -- 25+ tests pass.
    Snapshot file exists at `tests/TradingBot.ApiService.Tests/Application/Services/_snapshots/BacktestSimulatorTests_Run_GoldenScenario_MatchSnapshot.json`.
  </verify>
  <done>
    Max drawdown computed for all three strategies. Tier breakdown verified with trigger counts, extra USD, and extra BTC. Comparison metrics verified for both baselines. Edge cases handled. Golden snapshot baseline established. All 25+ tests pass with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` -- zero errors
2. `dotnet test` -- all tests pass (Phase 5 + Phase 6), zero regressions
3. `dotnet test --filter "FullyQualifiedName~BacktestSimulatorTests"` -- 25+ tests pass
4. MaxDrawdown correctly measures peak-to-trough unrealized loss for all strategies
5. MaxDrawdown is 0 for monotonically rising prices
6. Tier breakdown trigger counts match expected tier activations
7. Tier breakdown ExtraBtcAcquired > 0 for triggered tiers
8. MatchTotal.TotalInvested == SmartDca.TotalInvested (within rounding)
9. EfficiencyRatio > 1.0 when smart DCA has higher return %
10. Edge cases (single day, same prices, null inputs) handled correctly
11. Golden snapshot file exists and captures complete result structure
</verification>

<success_criteria>
- Max drawdown implemented for smart, same-base, and match-total strategies
- All comparison metrics (cost basis delta, extra BTC %, efficiency ratio) verified
- Tier breakdown shows concrete BTC impact per tier
- Edge cases don't crash (single day, flat prices, null inputs)
- Golden snapshot baseline prevents regressions
- 25+ total tests for BacktestSimulator
- Zero regressions in Phase 5 tests
- Phase 6 success criteria fully met
</success_criteria>

<output>
After completion, create `.planning/phases/06-backtest-simulation-engine/06-02-SUMMARY.md`
</output>
