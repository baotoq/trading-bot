---
phase: 21-portfolio-status-screens
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/portfolio_stats_section.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/health_badge.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/countdown_text.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/last_buy_card.dart
autonomous: true
requirements: [PORT-01, PORT-02, PORT-03, PORT-04, PORT-05]

must_haves:
  truths:
    - "User can see total BTC accumulated, total cost in USD, and unrealized P&L (green/red) on the home screen"
    - "Live BTC price refreshes automatically every 30 seconds without user interaction"
    - "Bot health status badge (healthy/warning/down) is always visible in the app bar area"
    - "A countdown timer shows approximate time remaining until next buy in human-readable text"
    - "Last buy detail card shows date, price, BTC amount, colored multiplier badge, and color-coded drop percentage"
    - "P&L shows both dollar amount and percentage with +/- sign, green for profit and red for loss"
    - "Pull-to-refresh re-fetches data; error states show snackbar with cached data still visible"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      provides: "Complete home screen with portfolio stats, health badge, countdown, last buy card"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/portfolio_stats_section.dart"
      provides: "Portfolio stats cards (total cost, total BTC, current price, P&L)"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/health_badge.dart"
      provides: "Health status badge with colored dot and text label"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/countdown_text.dart"
      provides: "Human-readable countdown to next buy"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/last_buy_card.dart"
      provides: "Last purchase detail card with multiplier badge and drop percentage"
  key_links:
    - from: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      to: "TradingBot.Mobile/lib/features/home/data/home_providers.dart"
      via: "ref.watch(homeDataProvider)"
      pattern: "ref\\.watch\\(homeDataProvider\\)"
    - from: "TradingBot.Mobile/lib/features/home/presentation/widgets/portfolio_stats_section.dart"
      to: "TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart"
      via: "PortfolioResponse parameter"
      pattern: "PortfolioResponse"
    - from: "TradingBot.Mobile/lib/features/home/presentation/widgets/last_buy_card.dart"
      to: "TradingBot.Mobile/lib/features/home/data/models/status_response.dart"
      via: "StatusResponse fields"
      pattern: "StatusResponse"
---

<objective>
Build the complete home screen UI with portfolio stats cards, live price display, health status badge, countdown to next buy, and last purchase detail card — all bound to the Riverpod providers created in Plan 01.

Purpose: This is the primary screen users see when opening the app. It answers the three key questions: "How is my portfolio doing?", "Is the bot alive?", and "When does it buy next?".
Output: Fully functional HomeScreen with extracted widget components, real data binding, and all PORT-01 through PORT-05 requirements satisfied.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-portfolio-status-screens/21-CONTEXT.md
@.planning/phases/21-portfolio-status-screens/21-01-SUMMARY.md

Key files to reference:
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/features/home/data/home_providers.dart
@TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart
@TradingBot.Mobile/lib/features/home/data/models/status_response.dart
@TradingBot.Mobile/lib/core/widgets/error_snackbar.dart
@TradingBot.Mobile/lib/core/widgets/retry_widget.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extracted widget components (stats section, health badge, countdown, last buy card)</name>
  <files>
    TradingBot.Mobile/lib/features/home/presentation/widgets/portfolio_stats_section.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/health_badge.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/countdown_text.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/last_buy_card.dart
  </files>
  <action>
All widgets are stateless/const-optimized. They receive data as constructor parameters — no provider access inside child widgets. Use `AppTheme.profitGreen`, `AppTheme.lossRed`, and `AppTheme.bitcoinOrange` from theme.dart.

**1. `portfolio_stats_section.dart` — PortfolioStatsSection**

A StatelessWidget that takes `PortfolioResponse` as parameter and renders portfolio stats:

- **Layout approach (Claude's discretion per CONTEXT.md):** Hero number at top showing total portfolio value in USD (currentPrice * totalBtc, or totalCost if no price) large and prominent. Below: 2x2 grid of stat cards.
- **Stat cards:** Total BTC (e.g. "0.04521 BTC"), Total Cost (e.g. "$4,521.30"), Current Price (e.g. "$97,432"), Average Cost (e.g. "$93,150")
- **P&L treatment (locked decisions):**
  - Show both dollar and percentage: "+$312.50 (+7.4%)" or "-$150.20 (-3.2%)"
  - Green text (`AppTheme.profitGreen`) for positive, red text (`AppTheme.lossRed`) for negative
  - Zero P&L uses default text color (neutral/white)
  - No arrow or icon — just colored number with +/- sign
  - Card backgrounds stay neutral (dark theme surface colors)
- **USD is primary unit** — lead with dollar values, BTC secondary
- **Null handling:** When `currentPrice` is null, show "--" for price and P&L fields. When `totalPurchaseCount` is 0, show zeros gracefully.
- **Number formatting:** Use `NumberFormat` from `intl` package (already a transitive dependency of Flutter) for currency formatting ($X,XXX.XX) and BTC formatting (up to 8 decimal places).
  - Import `package:intl/intl.dart`
  - `NumberFormat.currency(symbol: '\$', decimalDigits: 2)` for USD
  - `NumberFormat('0.########')` for BTC

Each stat card: `Card` widget with `Column` containing a label `Text` (body small, grey) and value `Text` (title medium or large, white). Keep cards simple and clean — no icons in cards.

**2. `health_badge.dart` — HealthBadge**

A StatelessWidget that takes `String healthStatus` and `String? healthMessage`:

- Three states per locked decision:
  - "Healthy" → green dot (Container 8x8 with `AppTheme.profitGreen` + BoxDecoration circle) + "Healthy" text
  - "Warning" → yellow dot (`Colors.amber`) + "Warning" text
  - "Down"/"Error" → red dot (`AppTheme.lossRed`) + "Down" text
- Layout: `Row` with `[dot, SizedBox(width:6), Text(label)]`
- Compact — designed to sit in the app bar or at the top of the screen
- Use `const` constructor

**3. `countdown_text.dart` — CountdownText**

A StatelessWidget that takes `String? nextBuyTimeIso`:

- Parse the ISO 8601 string to `DateTime`
- Calculate difference from `DateTime.now().toUtc()`
- Display approximate human-readable text per locked decision: "Next buy in ~4 hours", "Next buy in ~23 minutes", "Next buy in ~1 day"
  - If difference > 24h: "~X days"
  - If difference > 1h: "~X hours"
  - If difference < 1h: "~X minutes"
  - If nextBuyTime is null or in the past: "Buying soon..."
- Style: `bodyMedium` with `Colors.grey[400]` — subtle, not prominent
- No HH:MM:SS countdown — approximate text only (locked decision)

**4. `last_buy_card.dart` — LastBuyCard**

A StatelessWidget that takes `StatusResponse` as parameter:

- Renders as a `Card` with padding
- **Title row:** "Last Buy" label + relative time (use `timeago` package: `timeago.format(DateTime.parse(lastPurchaseTime))` producing "2 hours ago", "Yesterday")
- **Price (most prominent per locked decision):** Large text showing purchase price, e.g. "$95,432" — use `headlineSmall` or `titleLarge`
- **Details row:** BTC amount (e.g. "0.00052 BTC") and multiplier badge side by side
- **Multiplier badge (locked decision — visually distinct):**
  - Chip/badge showing e.g. "2.5x"
  - Background color: `AppTheme.bitcoinOrange` for multipliers > 1.0, neutral grey for 1.0x (base)
  - Small rounded container with text
- **Drop percentage (locked decision — color-coded by severity):**
  - Text showing e.g. "-12.5%"
  - Color intensity by severity: < 5% use grey, 5-10% use `Colors.amber`, 10-20% use `Colors.orange`, > 20% use `AppTheme.lossRed`
  - Display below or alongside the details row
- **Empty state:** If `lastPurchaseTime` is null, show "No purchases yet" centered in the card
- Import `package:timeago/timeago.dart` as `timeago`
  </action>
  <verify>
    `cd TradingBot.Mobile && dart analyze lib/features/home/presentation/widgets/` reports "No issues found!"
    All 4 widget files exist and are importable.
  </verify>
  <done>
    PortfolioStatsSection renders total BTC, total cost, current price, average cost, and P&L with green/red coloring.
    HealthBadge shows colored dot + text for Healthy/Warning/Down states.
    CountdownText shows "Next buy in ~X hours" human-readable approximate countdown.
    LastBuyCard shows price prominently, multiplier as colored badge, drop % color-coded by severity, and relative time.
    All widgets use const constructors where possible, take data as parameters, and have no direct provider access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Assemble HomeScreen with all widgets, error handling, and pull-to-refresh</name>
  <files>
    TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
  </files>
  <action>
Replace the HomeScreen content from Plan 01 (which has a minimal placeholder wired to homeDataProvider) with the full layout:

**HomeScreen layout (top to bottom):**

1. **SliverAppBar or AppBar area:** Title "Portfolio" with HealthBadge in the `actions` slot (always visible per locked decision). The health badge sits in the top-right area of the screen.

2. **Body wrapped in RefreshIndicator → CustomScrollView:**

   Use the existing pattern from Phase 20: `RefreshIndicator` wrapping `CustomScrollView` with slivers. But instead of `SliverFillRemaining`, use `SliverList` or `SliverPadding` with a column to allow scrolling if content overflows.

   **AsyncValue switch pattern (from 20-02 SUMMARY):**
   ```dart
   final homeData = ref.watch(homeDataProvider);
   final cachedValue = homeData.value;

   // ref.listen for snackbar side effects
   ref.listen(homeDataProvider, (previous, next) {
     if (next.hasError && !next.isLoading) {
       if (next.error is AuthenticationException) {
         showAuthErrorSnackbar(context);
       } else {
         showErrorSnackbar(context, 'Could not load portfolio data');
       }
     }
   });

   // switch on AsyncValue
   switch (homeData) {
     AsyncData(:final value) => _buildContent(value),
     AsyncError() when cachedValue != null => _buildContent(cachedValue),
     AsyncError() => RetryWidget(onRetry: () => ref.invalidate(homeDataProvider)),
     _ => Center(child: CircularProgressIndicator()),
   }
   ```

3. **_buildContent(HomeData data) layout:**
   - `Padding` with horizontal 16px
   - `PortfolioStatsSection(portfolio: data.portfolio)` — hero value + stat cards
   - `SizedBox(height: 12)`
   - `CountdownText(nextBuyTimeIso: data.status.nextBuyTime)` — subtle text
   - `SizedBox(height: 16)`
   - `LastBuyCard(status: data.status)` — full-width card

4. **Pull-to-refresh:** `onRefresh: () => ref.refresh(homeDataProvider.future)` — same pattern as Phase 20

5. **Loading state:** `CircularProgressIndicator()` centered (only on cold start, not on 30s refresh — the 30s timer uses `ref.invalidateSelf()` which keeps stale data visible during re-fetch)

6. **Error with cached data:** Shows the cached data with snackbar notification — the user sees stale data + error snackbar (per APP-06 requirement, already satisfied in Phase 20)

**Keep the HookConsumerWidget base class** from Phase 20 (the home_screen.dart already uses it). If hooks are not needed in this screen, ConsumerWidget is also fine — use whichever was established.

**Remove the old homeData provider** from home_screen.dart if it wasn't already removed in Plan 01 Task 2.

**Remove `part 'home_screen.g.dart'`** since the provider is now in home_providers.dart, not in this file.

Run `dart analyze lib/` on the full lib directory to verify no issues.
  </action>
  <verify>
    `cd TradingBot.Mobile && dart analyze lib/` reports "No issues found!"
    HomeScreen imports and uses PortfolioStatsSection, HealthBadge, CountdownText, and LastBuyCard.
    HomeScreen uses homeDataProvider from home_providers.dart.
    RefreshIndicator and error handling follow the Phase 20 pattern.
  </verify>
  <done>
    HomeScreen displays portfolio stats (total BTC, cost, price, P&L with green/red) at the top.
    Health badge (colored dot + text) is visible in the app bar area.
    Countdown to next buy shows approximate human-readable time.
    Last buy card shows price, BTC amount, multiplier badge, drop %, and relative time.
    Pull-to-refresh re-fetches data; 30s auto-refresh happens silently.
    Error states show snackbar with cached data visible; cold-start failure shows RetryWidget.
    dart analyze passes cleanly on full lib/.
  </done>
</task>

</tasks>

<verification>
1. `cd TradingBot.Mobile && dart analyze lib/` — zero issues across entire project
2. HomeScreen renders PortfolioStatsSection with real data binding
3. HealthBadge shows green/yellow/red states based on healthStatus string
4. CountdownText displays approximate time until next buy
5. LastBuyCard shows price (most prominent), multiplier badge (colored), drop % (severity-coded)
6. P&L text is green for positive, red for negative, neutral for zero
7. Pull-to-refresh calls ref.refresh(homeDataProvider.future)
8. 30s auto-refresh updates numbers silently (no animation or flash)
</verification>

<success_criteria>
- All 5 PORT requirements visibly addressed:
  - PORT-01: Total BTC, total cost, unrealized P&L visible on home screen
  - PORT-02: Live price refreshes every 30 seconds (via homeDataProvider auto-refresh from Plan 01)
  - PORT-03: Health badge with colored dot always visible in app bar
  - PORT-04: Countdown timer in human-readable approximate text
  - PORT-05: Last buy card with date, price, BTC, multiplier badge, drop %
- 4 extracted widget files + 1 updated HomeScreen
- dart analyze passes with zero issues
- Error handling follows Phase 20 established pattern (ref.listen + snackbar + RetryWidget)
</success_criteria>

<output>
After completion, create `.planning/phases/21-portfolio-status-screens/21-02-SUMMARY.md`
</output>
