---
phase: 23-configuration-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/lib/features/config/data/models/config_response.dart
  - TradingBot.Mobile/lib/features/config/data/config_repository.dart
  - TradingBot.Mobile/lib/features/config/data/config_providers.dart
  - TradingBot.Mobile/lib/features/config/data/config_providers.g.dart
  - TradingBot.Mobile/lib/features/config/presentation/config_screen.dart
  - TradingBot.Mobile/lib/features/config/presentation/widgets/config_view_section.dart
  - TradingBot.Mobile/lib/features/config/presentation/widgets/config_edit_form.dart
  - TradingBot.Mobile/lib/features/config/presentation/widgets/tier_list_editor.dart
autonomous: true
requirements:
  - CONF-01
  - CONF-02
  - CONF-03
  - CONF-04

must_haves:
  truths:
    - "User can view all DCA configuration parameters (base amount, schedule, tiers, bear market settings) on the config screen"
    - "User can tap Edit and modify any numeric parameter using a numeric keyboard"
    - "User can change the daily buy time via a time picker"
    - "User can add, remove, and reorder multiplier tier entries within the edit form before saving"
    - "When the server rejects a config change, validation errors appear inline next to the relevant field"
    - "User can pull-to-refresh to reload the config from the server"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/config/data/models/config_response.dart"
      provides: "ConfigResponse and MultiplierTierDto Dart model classes"
      contains: "class ConfigResponse"
    - path: "TradingBot.Mobile/lib/features/config/data/config_repository.dart"
      provides: "GET /api/config and PUT /api/config HTTP calls"
      contains: "class ConfigRepository"
    - path: "TradingBot.Mobile/lib/features/config/data/config_providers.dart"
      provides: "Riverpod providers for config data and repository"
      contains: "configData"
    - path: "TradingBot.Mobile/lib/features/config/presentation/config_screen.dart"
      provides: "Config screen with view/edit mode toggle"
      contains: "class ConfigScreen"
    - path: "TradingBot.Mobile/lib/features/config/presentation/widgets/config_edit_form.dart"
      provides: "Edit form with numeric fields, time picker, save/cancel"
      contains: "class ConfigEditForm"
    - path: "TradingBot.Mobile/lib/features/config/presentation/widgets/tier_list_editor.dart"
      provides: "Multiplier tier list with add/remove/reorder"
      contains: "class TierListEditor"
  key_links:
    - from: "TradingBot.Mobile/lib/features/config/data/config_repository.dart"
      to: "/api/config"
      via: "Dio GET and PUT requests"
      pattern: "_dio\\.(get|put).*api/config"
    - from: "TradingBot.Mobile/lib/features/config/presentation/config_screen.dart"
      to: "TradingBot.Mobile/lib/features/config/data/config_providers.dart"
      via: "ref.watch(configDataProvider)"
      pattern: "ref\\.watch\\(configDataProvider\\)"
    - from: "TradingBot.Mobile/lib/features/config/presentation/widgets/config_edit_form.dart"
      to: "TradingBot.Mobile/lib/features/config/data/config_repository.dart"
      via: "PUT /api/config call on save"
      pattern: "updateConfig"
---

<objective>
Build the configuration screen with full view/edit capability for all DCA parameters including multiplier tiers, with inline server validation error display.

Purpose: Users need to view and modify their DCA bot configuration (base amount, schedule, multiplier tiers, bear market settings) directly from the mobile app, with the server validating all changes and returning inline errors for invalid input.

Output: Complete config feature with data layer (models, repository, providers) and presentation layer (read-only view, edit form with numeric keyboards, time picker, tier list CRUD, inline server validation errors).
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@TradingBot.ApiService/Endpoints/ConfigurationEndpoints.cs
@TradingBot.ApiService/Endpoints/DashboardDtos.cs (lines 65-92 for ConfigResponse/UpdateConfigRequest/MultiplierTierDto)
@TradingBot.ApiService/Models/DcaConfigurationErrors.cs (7 server error codes)
@TradingBot.ApiService/BuildingBlocks/ErrorOrExtensions.cs (RFC 7807 Problem Details format)
@TradingBot.ApiService/Configuration/DcaOptions.cs
@TradingBot.Mobile/lib/features/home/data/home_repository.dart (repository pattern)
@TradingBot.Mobile/lib/features/home/data/home_providers.dart (provider pattern)
@TradingBot.Mobile/lib/features/home/presentation/home_screen.dart (AsyncValue pattern, error snackbar)
@TradingBot.Mobile/lib/features/config/presentation/config_screen.dart (current placeholder)
@TradingBot.Mobile/lib/core/api/api_client.dart (dioProvider, ApiKeyInterceptor)
@TradingBot.Mobile/lib/core/api/api_exception.dart (ApiException hierarchy)
@TradingBot.Mobile/lib/core/widgets/error_snackbar.dart (showErrorSnackbar)
@TradingBot.Mobile/lib/core/widgets/retry_widget.dart
@TradingBot.Mobile/lib/app/theme.dart (AppTheme colors)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config data layer — model, repository, and Riverpod providers</name>
  <files>
    TradingBot.Mobile/lib/features/config/data/models/config_response.dart
    TradingBot.Mobile/lib/features/config/data/config_repository.dart
    TradingBot.Mobile/lib/features/config/data/config_providers.dart
  </files>
  <action>
Create the config data layer following existing feature patterns (see home_repository.dart, home_providers.dart, chart_repository.dart).

**1. ConfigResponse model** (`config_response.dart`):

Create `MultiplierTierDto` class with:
- `double dropPercentage` — maps to Vogen Percentage (serialized as raw number)
- `double multiplier` — maps to Vogen Multiplier (serialized as raw number)
- `factory MultiplierTierDto.fromJson(Map<String, dynamic> json)` — use `(json['dropPercentage'] as num).toDouble()` pattern
- `Map<String, dynamic> toJson()` — for PUT request body serialization

Create `ConfigResponse` class with fields matching the .NET `ConfigResponse` DTO:
- `double baseDailyAmount` — Vogen UsdAmount serializes as raw number
- `int dailyBuyHour`
- `int dailyBuyMinute`
- `int highLookbackDays`
- `bool dryRun`
- `int bearMarketMaPeriod`
- `double bearBoostFactor` — Vogen Multiplier serializes as raw number
- `double maxMultiplierCap` — Vogen Multiplier serializes as raw number
- `List<MultiplierTierDto> tiers`
- `factory ConfigResponse.fromJson(Map<String, dynamic> json)` — manual deserialization per project convention (no json_serializable)
- `Map<String, dynamic> toJson()` — manual serialization for PUT request body. Serialize tiers as list of maps.

**2. ConfigRepository** (`config_repository.dart`):

Create `ConfigRepository` class taking `Dio _dio` in constructor (same pattern as HomeRepository, ChartRepository):
- `Future<ConfigResponse> fetchConfig()` — `GET /api/config`, parse response.data
- `Future<void> updateConfig(ConfigResponse config)` — `PUT /api/config`, send `config.toJson()` as body. This method must NOT catch DioException — let it propagate so the caller can inspect `response.data` for RFC 7807 Problem Details with validation errors.

**3. Riverpod providers** (`config_providers.dart`):

Use `@riverpod` code generation (part directive with .g.dart):
- `configRepository` provider — returns `ConfigRepository(ref.watch(dioProvider))`
- `configData` provider — `Future<ConfigResponse>` that calls `ref.watch(configRepositoryProvider).fetchConfig()`. No auto-refresh timer needed (config is static, user manually refreshes).

After creating files, run `dart run build_runner build --delete-conflicting-outputs` from TradingBot.Mobile to generate the `.g.dart` file.
  </action>
  <verify>
    Run `dart run build_runner build --delete-conflicting-outputs` from TradingBot.Mobile — must complete with no errors.
    Run `dart analyze lib/features/config/data/` — must have zero errors.
  </verify>
  <done>
    ConfigResponse model correctly round-trips all 9 fields from the .NET ConfigResponse DTO JSON.
    ConfigRepository has fetchConfig() calling GET /api/config and updateConfig() calling PUT /api/config.
    configDataProvider and configRepositoryProvider are generated and importable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Config screen with view/edit mode, tier CRUD, and inline server validation</name>
  <files>
    TradingBot.Mobile/lib/features/config/presentation/config_screen.dart
    TradingBot.Mobile/lib/features/config/presentation/widgets/config_view_section.dart
    TradingBot.Mobile/lib/features/config/presentation/widgets/config_edit_form.dart
    TradingBot.Mobile/lib/features/config/presentation/widgets/tier_list_editor.dart
  </files>
  <action>
Replace the placeholder ConfigScreen and create presentation widgets. Use HookConsumerWidget with flutter_hooks for local edit state management.

**1. ConfigViewSection** (`config_view_section.dart`):

A StatelessWidget that takes a `ConfigResponse` and renders a read-only view of all config parameters in grouped Card sections:

- **DCA Settings** card:
  - Base daily amount: e.g. "$25.00"
  - Daily buy time: e.g. "12:30 UTC"
  - Dry run: "Yes" / "No" with a colored badge (green=No/live, amber=Yes/dry-run)

- **Market Analysis** card:
  - High lookback days: e.g. "30 days"
  - Bear market MA period: e.g. "200 days"
  - Bear boost factor: e.g. "1.5x"
  - Max multiplier cap: e.g. "4.5x"

- **Multiplier Tiers** card:
  - Table/list showing each tier: "Drop ≥ X% → Yx multiplier"
  - If empty: show "No multiplier tiers (base-only DCA)"

Style: Use Card widgets with ListTile rows. Leading icons optional. Use `Theme.of(context).textTheme` for consistent typography. Use `AppTheme.bitcoinOrange` for accent values.

**2. TierListEditor** (`tier_list_editor.dart`):

A StatelessWidget that renders the editable tier list within the edit form. Takes:
- `List<MultiplierTierDto> tiers` — current tier list (mutable copy)
- `ValueChanged<List<MultiplierTierDto>> onChanged` — callback when tiers change
- `Map<String, String> tierErrors` — map of error codes to messages for tier-related fields (e.g., "TiersNotAscending" → message)

Features:
- Each tier row: two TextFormField widgets side-by-side (drop % and multiplier), both with `TextInputType.numberWithOptions(decimal: true)` keyboard, plus a delete IconButton (CupertinoIcons.minus_circle, red)
- "Add Tier" button at bottom (CupertinoIcons.plus_circle) — appends a new MultiplierTierDto(dropPercentage: 0, multiplier: 1) and calls onChanged
- Remove tier: removes from list, calls onChanged
- Reorder: use ReorderableListView.builder so user can drag to reorder tiers — calls onChanged with reordered list
- If `tierErrors` is non-empty, show error text below the tier list in `Theme.of(context).colorScheme.error` color. Display messages for keys: "TiersNotAscending", "TierMultiplierOutOfRange", "TierDropPercentageDuplicate"

**3. ConfigEditForm** (`config_edit_form.dart`):

A StatefulWidget (or HookWidget) that takes `ConfigResponse initialConfig`, `VoidCallback onCancel`, `Future<void> Function(ConfigResponse) onSave`. Manages local form state for editing.

Form fields organized in same card groups as view mode:

- **DCA Settings**:
  - baseDailyAmount: TextFormField with `TextInputType.numberWithOptions(decimal: true)`, prefixText "\$"
  - Daily buy time: a row showing current time as "HH:MM UTC" with an edit IconButton that opens `showTimePicker()` dialog. Store hour/minute separately in local state.
  - dryRun: Switch widget

- **Market Analysis**:
  - highLookbackDays: TextFormField with `TextInputType.number`, suffixText "days"
  - bearMarketMaPeriod: TextFormField with `TextInputType.number`, suffixText "days"
  - bearBoostFactor: TextFormField with `TextInputType.numberWithOptions(decimal: true)`, suffixText "x"
  - maxMultiplierCap: TextFormField with `TextInputType.numberWithOptions(decimal: true)`, suffixText "x"

- **Multiplier Tiers**:
  - Use TierListEditor widget, passing current tiers and onChanged callback

- Bottom actions: two buttons — "Cancel" (outlined, calls onCancel) and "Save" (filled, Bitcoin orange). Save button shows CircularProgressIndicator while saving.

**Server validation error handling (CONF-04 — critical):**

When the user taps Save:
1. Build a `ConfigResponse` from the form field values
2. Call `onSave(configResponse)` which the parent passes as `configRepository.updateConfig`
3. If the PUT call throws `DioException` with `response?.statusCode == 400`:
   - Parse `response.data` as RFC 7807 Problem Details JSON
   - Extract `extensions.errors` array: `[{code: "InvalidScheduleHour", message: "..."}, ...]`
   - Map error codes to field-level error messages using a `Map<String, String>`:
     - "InvalidScheduleHour" → show error under time picker
     - "InvalidScheduleMinute" → show error under time picker
     - "TiersNotAscending" → pass to TierListEditor tierErrors
     - "TierMultiplierOutOfRange" → pass to TierListEditor tierErrors
     - "TierDropPercentageDuplicate" → pass to TierListEditor tierErrors
     - "InvalidMaPeriod" → show error under bearMarketMaPeriod field
     - "InvalidHighLookbackDays" → show error under highLookbackDays field
   - Set these errors in local state so TextFormField `decoration.errorText` shows them inline
   - For tier errors, pass the map to TierListEditor's `tierErrors` parameter
4. If non-400 DioException: show generic error snackbar via `showErrorSnackbar(context, 'Failed to save configuration')`
5. On success: call onCancel (exits edit mode) and show success snackbar "Configuration saved"

**4. ConfigScreen** (`config_screen.dart`):

Replace the placeholder. Use `HookConsumerWidget` pattern:
- Watch `configDataProvider` for async config data
- Use `useState<bool>(false)` for `isEditing` toggle
- AppBar title: "Configuration", with an Edit/Done action button (CupertinoIcons.pencil) that toggles isEditing. Hide edit button while loading/error.
- Pull-to-refresh via RefreshIndicator + `ref.refresh(configDataProvider.future)`
- Error handling: same AsyncValue switch pattern as HomeScreen — show RetryWidget on cold error, snackbar on stale cache error
- When `isEditing == false`: render ConfigViewSection(config: value)
- When `isEditing == true`: render ConfigEditForm(
    initialConfig: value,
    onCancel: () => isEditing.value = false,
    onSave: (updatedConfig) async {
      await ref.read(configRepositoryProvider).updateConfig(updatedConfig);
      ref.invalidate(configDataProvider); // reload fresh from server
      isEditing.value = false;
    },
  )
- Handle save errors inside ConfigEditForm (catches DioException, parses 400 errors inline). The onSave callback in ConfigScreen just does the happy path. ConfigEditForm wraps the call in try/catch internally.

Actually, better approach for error handling ownership: ConfigEditForm calls the repository directly. Pass `ConfigRepository` to ConfigEditForm (via ref.read(configRepositoryProvider) from parent). ConfigEditForm handles all error cases internally (400 parsing, non-400 snackbar). On success, ConfigEditForm calls a `VoidCallback onSaved` that the parent uses to exit edit mode and invalidate the provider.

Revised ConfigEditForm constructor:
- `ConfigResponse initialConfig`
- `ConfigRepository repository`
- `VoidCallback onSaved` — called after successful save
- `VoidCallback onCancel`
  </action>
  <verify>
    Run `dart analyze lib/features/config/` from TradingBot.Mobile — must have zero errors.
    Run `flutter build ios --no-codesign --dart-define=API_BASE_URL=http://localhost:5000 --dart-define=API_KEY=test` — must succeed.
  </verify>
  <done>
    ConfigScreen shows all DCA config parameters in read-only Card sections when not editing.
    Tapping Edit switches to ConfigEditForm with numeric keyboards for all numeric fields and a time picker for daily buy time.
    TierListEditor allows adding new tiers, removing existing tiers, reordering via drag, and editing drop%/multiplier values.
    When PUT /api/config returns 400 with RFC 7807 Problem Details, validation errors appear inline next to the relevant field (schedule errors near time picker, tier errors below tier list, MA/lookback errors near respective fields).
    Successful save shows "Configuration saved" snackbar, exits edit mode, and reloads config from server.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/features/config/` — zero errors
2. `flutter build ios --no-codesign` — builds successfully
3. Config screen loads and displays all config parameters from GET /api/config
4. Edit mode shows numeric keyboards for amount/factor fields
5. Time picker dialog opens for daily buy time
6. Tiers can be added, removed, and reordered
7. Server 400 validation errors display inline next to relevant fields
8. Successful save exits edit mode and refreshes data
</verification>

<success_criteria>
All four CONF requirements satisfied:
- CONF-01: User can view all DCA configuration parameters on a readable config screen
- CONF-02: User can edit any numeric parameter with numeric keyboard and change buy time via time picker
- CONF-03: User can add, remove, and reorder multiplier tier entries before saving
- CONF-04: Server validation errors appear inline next to relevant fields
</success_criteria>

<output>
After completion, create `.planning/phases/23-configuration-screen/23-01-SUMMARY.md`
</output>
