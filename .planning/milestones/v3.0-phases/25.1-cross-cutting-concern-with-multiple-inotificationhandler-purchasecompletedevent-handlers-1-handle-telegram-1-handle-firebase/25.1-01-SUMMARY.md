# Phase 25.1, Plan 01: Summary

**Completed:** 2026-02-20

## What Changed

Split monolithic PurchaseCompletedHandler and PurchaseFailedHandler into separate per-channel INotificationHandler implementations (Telegram and FCM), and enriched PurchaseCompletedEvent with pre-computed running totals so notification handlers no longer need database access for aggregate stats.

## Files Modified

| File | Change |
|------|--------|
| `TradingBot.ApiService/Application/Events/PurchaseCompletedEvent.cs` | Added Multiplier, IsDryRun, TotalBtc, TotalCost, PurchaseCount fields to the record |
| `TradingBot.ApiService/Models/Purchase.cs` | Updated RecordFill and RecordDryRunFill to accept and forward running total parameters |
| `TradingBot.ApiService/Application/Services/DcaExecutionService.cs` | Computes running totals from DB before calling RecordFill/RecordDryRunFill; adds current purchase values for non-dry-run fills |
| `TradingBot.ApiService/Application/Handlers/PurchaseCompletedHandler.cs` | Replaced monolithic PurchaseCompletedHandler with TelegramPurchaseCompletedEventHandler + FcmPurchaseCompletedEventHandler |
| `TradingBot.ApiService/Application/Handlers/PurchaseFailedHandler.cs` | Replaced monolithic PurchaseFailedHandler with TelegramPurchaseFailedEventHandler + FcmPurchaseFailedEventHandler |
| `TradingBot.ApiService/Infrastructure/Telegram/ServiceCollectionExtensions.cs` | Updated MediatR assembly reference from deleted PurchaseCompletedHandler to TelegramPurchaseCompletedEventHandler |
| `tests/.../PurchaseSpecsTests.cs` | Updated RecordFill/RecordDryRunFill call sites with running total parameters |

## Architecture After

```
PurchaseCompletedEvent (enriched with running totals + Multiplier + IsDryRun)
  -> TelegramPurchaseCompletedEventHandler  (DB + HyperliquidClient for verbose message)
  -> FcmPurchaseCompletedEventHandler       (event data only, no DB access)

PurchaseFailedEvent (unchanged)
  -> TelegramPurchaseFailedEventHandler     (DB for verbose message)
  -> FcmPurchaseFailedEventHandler          (event data only, no DB access)

PurchaseSkippedEvent (unchanged, out of scope)
  -> PurchaseSkippedHandler                 (Telegram-only, unchanged)
```

## Key Decisions

- **Option A chosen for FCM handler data:** Added Multiplier and IsDryRun to PurchaseCompletedEvent so FcmPurchaseCompletedEventHandler needs zero DB access
- **Running totals computed in DcaExecutionService:** Queried from DB before aggregate method calls; for non-dry-run fills, current purchase values are added to DB totals since the purchase is not yet committed
- **Dry-run totals convention preserved:** Dry-run purchases pass through DB-only totals (not adding themselves) since they are excluded from running totals by convention
- **BuildMultiplierReasoning stays as private static method** on TelegramPurchaseCompletedEventHandler -- only Telegram needs it
- **Independent error isolation:** Each handler has its own try-catch; Telegram failure never blocks FCM and vice versa

## Verification

- Build: 0 errors
- Tests: 62 passed, 0 failed
- Old class names (PurchaseCompletedHandler, PurchaseFailedHandler): confirmed deleted
- New class names: 4 handlers confirmed (1 definition each)
- PurchaseSkippedHandler: unchanged
