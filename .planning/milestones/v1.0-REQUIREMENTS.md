# Requirements Archive: v1.0 Daily BTC Smart DCA on Hyperliquid

**Archived:** 2026-02-12
**Status:** SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

**Version:** v1.0
**Created:** 2026-02-12
**Source:** PROJECT.md + research synthesis

## Functional Requirements

### FR-1: Hyperliquid Spot API Integration
**Priority:** Must Have | **Phase:** 1 | **Status:** Complete
**Description:** Build a thin HTTP client for Hyperliquid's REST API with EIP-712 authentication using Nethereum.Signer. Must support: fetching spot prices, getting account balances, placing spot buy orders, and checking order status.
**Acceptance Criteria:**
- [x] Can authenticate with Hyperliquid using ETH private key (EIP-712 signing)
- [x] Can fetch current BTC spot price from Hyperliquid
- [x] Can query USDC balance for the configured wallet
- [x] Can place a spot market buy order on testnet
- [x] Can poll order status and detect fills/partial fills
- [x] Private key never appears in logs

### FR-2: Domain Models and Persistence
**Priority:** Must Have | **Phase:** 1 | **Status:** Complete
**Description:** Create domain entities for purchase history, daily price tracking, and DCA configuration. Set up EF Core migrations for PostgreSQL.
**Acceptance Criteria:**
- [x] Purchase entity: timestamp, price, quantity, cost, multiplier, status
- [x] DailyPrice entity: date, open, high, low, close for MA/high calculations
- [x] DcaConfiguration entity or options pattern for all configurable values
- [x] EF Core DbContext with migrations
- [x] Repository/store abstractions following existing codebase patterns

### FR-3: Fix Distributed Lock
**Priority:** Must Have | **Phase:** 1 | **Status:** Complete
**Description:** The existing distributed lock implementation is stubbed out (returns success without acquiring). Fix it to use real Dapr/Redis-backed locking before any order execution code is written.
**Acceptance Criteria:**
- [x] Distributed lock acquires real Redis-backed lock via Dapr
- [x] Lock prevents concurrent DCA executions
- [x] Lock has configurable timeout and TTL
- [x] Existing lock interface/abstraction preserved
**Outcome:** Used PostgreSQL advisory locks via Medallion.Threading instead of Dapr/Redis

### FR-4: Daily Recurring Buy Schedule
**Priority:** Must Have | **Phase:** 2 | **Status:** Complete
**Description:** Background service that triggers BTC purchase at a configurable time daily, using the existing TimeBackgroundService base class.
**Acceptance Criteria:**
- [x] Extends TimeBackgroundService with configurable interval
- [x] Executes at user-configured time of day (e.g., 08:00 UTC)
- [x] Acquires distributed lock before execution
- [x] Checks if today's purchase already completed (idempotency)
- [x] Gracefully handles app restarts (resumes schedule, doesn't duplicate)
- [x] Logs each trigger with timestamp and decision

### FR-5: Core DCA Execution
**Priority:** Must Have | **Phase:** 2 | **Status:** Complete
**Description:** Execute a fixed-amount BTC spot purchase on Hyperliquid. Check balance, place order, handle fills, persist result.
**Acceptance Criteria:**
- [x] Checks USDC balance before placing order
- [x] Skips buy with alert if insufficient balance
- [x] Places IOC (immediate or cancel) spot buy order
- [x] Handles partial fills (stores actual filled quantity)
- [x] Persists purchase record to database
- [x] Publishes domain event on success/failure
- [x] Retries up to 3 times on transient failures

### FR-6: Basic Telegram Notifications
**Priority:** Must Have | **Phase:** 2 | **Status:** Complete
**Description:** Send Telegram messages on purchase success, failure, and daily summary. Use existing Telegram infrastructure.
**Acceptance Criteria:**
- [x] Notification on successful buy: price, quantity, cost
- [x] Notification on failed buy: error reason, retry count
- [x] Notification on insufficient balance
- [x] Uses existing TelegramNotificationService pattern
- [x] Triggered via MediatR domain event handlers

### FR-7: 30-Day High Tracking
**Priority:** Must Have | **Phase:** 3 | **Status:** Complete
**Description:** Track BTC 30-day rolling high price for drop-from-high multiplier calculation.
**Acceptance Criteria:**
- [x] Fetches daily candle data from Hyperliquid
- [x] Calculates rolling 30-day high from daily high prices
- [x] Caches in Redis with daily refresh
- [x] Falls back to database if Redis unavailable
- [x] Validates data freshness before use (reject if >24h stale)
**Outcome:** Stale data policy overridden â€” use last known values even if >24h old (better than falling back to 1x)

### FR-8: Dip Multiplier Tiers
**Priority:** Must Have | **Phase:** 3 | **Status:** Complete
**Description:** Calculate buy amount multiplier based on % drop from 30-day high. Default tiers: 0-5% = 1x, 5-10% = 1.5x, 10-20% = 2x, 20%+ = 3x.
**Acceptance Criteria:**
- [x] Calculates % drop: (30d_high - current_price) / 30d_high * 100
- [x] Applies correct multiplier based on drop tier
- [x] Tier boundaries and multiplier values are configurable
- [x] Final buy amount = base_amount * multiplier
- [x] Multiplier value stored with each purchase record
- [x] Decision logged: current price, 30d high, % drop, tier, multiplier

### FR-9: 200-Day MA Bear Market Boost
**Priority:** Must Have | **Phase:** 3 | **Status:** Complete
**Description:** Apply additional 1.5x multiplier when BTC price is below its 200-day simple moving average.
**Acceptance Criteria:**
- [x] Calculates 200-day SMA from daily close prices
- [x] Applies 1.5x boost when current price < 200-day MA
- [x] Boost stacks with dip tier multiplier (e.g., 2x dip * 1.5x bear = 3x total)
- [x] Bear boost factor is configurable
- [x] Handles insufficient history gracefully (skip boost, log warning)
- [x] MA value stored with each purchase for audit

### FR-10: Configuration Management
**Priority:** Must Have | **Phase:** 1 | **Status:** Complete
**Description:** All strategy parameters configurable via appsettings.json / environment variables without code changes.
**Acceptance Criteria:**
- [x] Base daily buy amount (USD)
- [x] Buy schedule (time of day, UTC)
- [x] Multiplier tier boundaries (% drop thresholds)
- [x] Multiplier values per tier
- [x] Bear market boost factor
- [x] Bear market MA period (default: 200)
- [x] 30-day high lookback period
- [x] Hyperliquid API settings (URL, testnet toggle)
- [x] Dry-run mode toggle
- [x] All values validated at startup with clear error messages

### FR-11: Rich Telegram Notifications
**Priority:** Should Have | **Phase:** 4 | **Status:** Complete
**Description:** Enhanced notifications showing multiplier reasoning, running totals, and daily/weekly summaries.
**Acceptance Criteria:**
- [x] Buy notification includes: multiplier used, tier explanation, 30d high, current drop %, MA status
- [x] Running totals: total BTC accumulated, total USD spent, average cost basis
- [x] Weekly summary with: buys this week, total spent, average price, best/worst buy
- [x] Formatted with markdown for readability

### FR-12: Health Check and Daily Verification
**Priority:** Should Have | **Phase:** 4 | **Status:** Complete
**Description:** Health endpoint and daily verification service to detect silent failures.
**Acceptance Criteria:**
- [x] Health check endpoint reports DCA service status
- [x] Daily verification checks if today's purchase succeeded
- [x] Sends alert if no purchase recorded by end of scheduled window
- [x] Reports service uptime and last successful purchase timestamp

### FR-13: Dry-Run Mode
**Priority:** Should Have | **Phase:** 4 | **Status:** Complete
**Description:** Execute all logic except actual order placement. Log and notify what would have happened.
**Acceptance Criteria:**
- [x] Toggle via configuration (DryRun: true/false)
- [x] Runs full calculation pipeline (price fetch, multiplier calc)
- [x] Skips order placement, logs simulated result
- [x] Telegram notification clearly marked as "[DRY RUN]"
- [x] Stores simulated purchases separately for analysis

## Non-Functional Requirements

### NFR-1: Reliability
- [x] Bot must not miss scheduled buys due to transient failures (retry logic)
- [x] Silent failure detection within 1 hour of missed buy window
- [x] Idempotent execution (same day = same result, no duplicates)

### NFR-2: Security
- [x] ETH private key stored in .NET User Secrets or environment variables only
- [x] Private key never logged, serialized, or exposed in any output
- [x] Testnet/mainnet configuration clearly separated

### NFR-3: Observability
- [x] Structured logging (Serilog) for all decisions and executions
- [x] Every buy/skip decision logged with full context
- [ ] OpenTelemetry traces for API calls to Hyperliquid (deferred)

### NFR-4: Maintainability
- [x] Follow existing codebase conventions (PascalCase, file-scoped namespaces, primary constructors)
- [x] Use existing BuildingBlocks patterns (domain events, outbox, background services)
- [x] Interface-based design for testability (IExchangeClient, IPriceDataService, etc.)

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| FR-1: Hyperliquid API | 1 | Complete |
| FR-2: Domain Models | 1 | Complete |
| FR-3: Fix Distributed Lock | 1 | Complete |
| FR-10: Configuration | 1 | Complete |
| FR-4: Daily Schedule | 2 | Complete |
| FR-5: Core DCA Execution | 2 | Complete |
| FR-6: Basic Notifications | 2 | Complete |
| FR-7: 30-Day High Tracking | 3 | Complete |
| FR-8: Dip Multiplier Tiers | 3 | Complete |
| FR-9: 200-Day MA Boost | 3 | Complete |
| FR-11: Rich Notifications | 4 | Complete |
| FR-12: Health Check | 4 | Complete |
| FR-13: Dry-Run Mode | 4 | Complete |

---

## Milestone Summary

**Shipped:** 13 of 13 functional requirements
**Adjusted:**
- FR-3: Used PostgreSQL advisory locks instead of Dapr/Redis (better reliability)
- FR-7: Stale data policy changed from "reject if >24h" to "use last known values"

**Dropped:** None

**Deferred NFR:**
- NFR-3 (partial): OpenTelemetry traces not implemented

---
*Archived: 2026-02-12 as part of v1.0 milestone completion*
