---
phase: 30-critical-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart
  - TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart
  - TradingBot.ApiService/Endpoints/PortfolioDtos.cs
  - TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
  - TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart
autonomous: true
requirements:
  - PORT-01
  - PORT-03
  - DISP-03
  - DISP-05

must_haves:
  truths:
    - "Flutter sends 'Simple' (not 'None') for simple-interest fixed deposits and POST /api/portfolio/fixed-deposits returns 201"
    - "AllocationDonutChart tooltip displays values in VND when VND mode is active and USD when USD mode is active"
    - "POST /api/portfolio/assets endpoint exists and accepts name, ticker, assetType, nativeCurrency; returns 201 with created asset"
    - "Flutter has a UI to create a new portfolio asset with name, ticker, asset type, and currency fields"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart"
      provides: "Fixed deposit form with 'Simple' default and asset creation UI"
      contains: "Simple"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart"
      provides: "Currency-aware tooltip formatting"
      contains: "valueVnd"
    - path: "TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs"
      provides: "POST /api/portfolio/assets endpoint"
      contains: "CreateAssetAsync"
    - path: "TradingBot.ApiService/Endpoints/PortfolioDtos.cs"
      provides: "CreateAssetRequest and CreateAssetResponse DTOs"
      contains: "CreateAssetRequest"
    - path: "TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart"
      provides: "AllocationDto with valueVnd field"
      contains: "valueVnd"
  key_links:
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart"
      to: "/api/portfolio/fixed-deposits"
      via: "compoundingFrequency: 'Simple' in request body"
      pattern: "Simple"
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart"
      to: "AllocationDto"
      via: "isVnd ? allocation.valueVnd : allocation.valueUsd"
      pattern: "valueVnd.*valueUsd"
    - from: "TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart"
      to: "/api/portfolio/assets"
      via: "POST request with createAsset method"
      pattern: "createAsset"
---

<objective>
Fix all 3 code bugs identified in the v4.0 milestone audit: CompoundingFrequency enum mismatch (Flutter sends 'None' instead of 'Simple'), donut chart tooltip showing wrong currency format, and missing asset creation endpoint + Flutter UI.

Purpose: Close 3 integration gaps and 2 broken E2E flows so the v4.0 milestone can be verified as complete.
Output: All 3 bugs fixed in-place, no new screens needed (asset creation added to existing add-transaction form).
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v4.0-MILESTONE-AUDIT.md

# Existing files to modify
@TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart
@TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart
@TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart
@TradingBot.ApiService/Endpoints/PortfolioDtos.cs
@TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
@TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CompoundingFrequency enum mismatch and donut chart tooltip currency bug</name>
  <files>
    TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart
    TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart
    TradingBot.ApiService/Endpoints/PortfolioDtos.cs
    TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
  </files>
  <action>
    **Bug 1: CompoundingFrequency enum mismatch (PORT-03, DISP-05)**

    In `add_transaction_screen.dart`:
    - Change `final compoundingFreq = useState('None');` to `final compoundingFreq = useState('Simple');`
    - Change the dropdown items: replace `DropdownMenuItem(value: 'None', child: Text('None'))` with `DropdownMenuItem(value: 'Simple', child: Text('Simple (No Compounding)'))`

    The backend `CompoundingFrequency` enum has values: `Simple, Monthly, Quarterly, SemiAnnual, Annual`. Flutter was sending `'None'` which does not match any backend enum value, causing `Enum.TryParse` to fail and return 400.

    **Bug 2: AllocationDonutChart tooltip currency (DISP-03)**

    The `AllocationDto` currently only contains `valueUsd`. The tooltip calls `_formatValue(allocation.valueUsd)` which formats as VND when `isVnd` is true, but the value is always USD -- producing nonsensical numbers.

    Fix requires changes at 3 layers:

    1. **Backend DTO** (`PortfolioDtos.cs`): Add `ValueVnd` field to `AllocationDto`:
       ```csharp
       public record AllocationDto(string AssetType, decimal ValueUsd, decimal ValueVnd, decimal Percentage);
       ```

    2. **Backend endpoint** (`PortfolioEndpoints.cs`): In `GetSummaryAsync`, maintain a parallel `allocationsByTypeVnd` dictionary alongside `allocationsByType` (which is USD). Track VND values for each asset type. For crypto/ETF assets: if native currency is USD, `assetValueVnd = rate > 0 ? currentValue * rate : 0m`; if VND, `assetValueVnd = currentValue`. For fixed deposits, add `fdTotalVnd` to `allocationsByTypeVnd["FixedDeposit"]`. When building the `AllocationDto` list, join the two dictionaries:
       ```csharp
       var allocations = allocationsByType
           .Select(kvp => new AllocationDto(
               kvp.Key,
               Math.Round(kvp.Value, 2),
               Math.Round(allocationsByTypeVnd.GetValueOrDefault(kvp.Key), 0),
               totalValueUsd > 0 ? Math.Round(kvp.Value / totalValueUsd * 100, 2) : 0))
           .OrderByDescending(a => a.Percentage)
           .ToList();
       ```

    3. **Flutter model** (`portfolio_summary_response.dart`): Add `valueVnd` field to `AllocationDto`:
       ```dart
       final double valueVnd;
       ```
       Update `fromJson` to parse `valueVnd: (json['valueVnd'] as num).toDouble()`.

    4. **Flutter widget** (`allocation_donut_chart.dart`): In `_buildTooltip`, change the value formatting:
       ```dart
       '${_labelForType(allocation.assetType)}: ${allocation.percentage.toStringAsFixed(1)}% - ${_formatValue(widget.isVnd ? allocation.valueVnd : allocation.valueUsd)}'
       ```
       This uses VND value when in VND mode and USD value when in USD mode -- matching the formatter selected by `_formatValue`.
  </action>
  <verify>
    - `dotnet build TradingBot.slnx` succeeds
    - `grep -n "useState('Simple')" TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart` shows the corrected default
    - `grep -n "valueVnd" TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart` shows the new field
    - `grep -n "ValueVnd" TradingBot.ApiService/Endpoints/PortfolioDtos.cs` shows the new DTO field
    - `grep -n "allocationsByTypeVnd" TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs` shows the VND tracking dictionary
    - `grep -n "allocation.valueVnd" TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart` shows the currency-aware tooltip
  </verify>
  <done>
    1. Flutter fixed deposit form defaults to 'Simple' and dropdown shows 'Simple (No Compounding)' instead of 'None'
    2. AllocationDto carries both valueUsd and valueVnd from backend
    3. Donut chart tooltip displays correct currency value based on VND/USD mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Add POST /api/portfolio/assets endpoint and Flutter asset creation UI</name>
  <files>
    TradingBot.ApiService/Endpoints/PortfolioDtos.cs
    TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
    TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart
  </files>
  <action>
    **Backend: POST /api/portfolio/assets endpoint (PORT-01)**

    1. In `PortfolioDtos.cs`, add request and response DTOs:
       ```csharp
       public record CreateAssetRequest(string Name, string Ticker, string AssetType, string NativeCurrency);

       public record CreateAssetResponse(Guid Id, string Name, string Ticker, string AssetType, string NativeCurrency);
       ```

    2. In `PortfolioEndpoints.cs`:
       - Add route mapping in `MapPortfolioEndpoints`: `group.MapPost("/assets", CreateAssetAsync);`
       - Add the handler method:
         ```csharp
         private static async Task<IResult> CreateAssetAsync(
             TradingBotDbContext db,
             CreateAssetRequest request,
             ILogger<Program> logger,
             CancellationToken ct)
         {
             if (!Enum.TryParse<AssetType>(request.AssetType, ignoreCase: true, out var assetType))
                 return Results.BadRequest("Invalid asset type. Valid values: Crypto, ETF");

             if (!Enum.TryParse<Currency>(request.NativeCurrency, ignoreCase: true, out var currency))
                 return Results.BadRequest("Invalid currency. Valid values: USD, VND");

             if (string.IsNullOrWhiteSpace(request.Name))
                 return Results.BadRequest("Name is required");

             if (string.IsNullOrWhiteSpace(request.Ticker))
                 return Results.BadRequest("Ticker is required");

             // Check for duplicate ticker
             var exists = await db.PortfolioAssets.AnyAsync(a => a.Ticker == request.Ticker.Trim().ToUpper(), ct);
             if (exists)
                 return Results.Conflict($"Asset with ticker '{request.Ticker.Trim().ToUpper()}' already exists");

             var asset = PortfolioAsset.Create(
                 request.Name.Trim(),
                 request.Ticker.Trim().ToUpper(),
                 assetType,
                 currency);

             db.PortfolioAssets.Add(asset);
             await db.SaveChangesAsync(ct);

             return Results.Created($"/api/portfolio/assets/{asset.Id.Value}",
                 new CreateAssetResponse(asset.Id.Value, asset.Name, asset.Ticker, asset.AssetType.ToString(), asset.NativeCurrency.ToString()));
         }
         ```

    **Flutter: Repository method + UI**

    3. In `portfolio_repository.dart`, add `createAsset` method:
       ```dart
       Future<PortfolioAssetResponse> createAsset(Map<String, dynamic> body) async {
         final response = await _dio.post('/api/portfolio/assets', data: body);
         return PortfolioAssetResponse.fromJson(response.data as Map<String, dynamic>);
       }
       ```

    4. In `add_transaction_screen.dart`, add a third `FormMode` value and third segment:
       - Add `FormMode.asset` to the enum: `enum FormMode { transaction, fixedDeposit, asset }`
       - Add a third segment to the `SegmentedButton<FormMode>`:
         ```dart
         ButtonSegment(value: FormMode.asset, label: Text('New Asset')),
         ```
       - Add state variables for asset creation:
         ```dart
         final assetNameController = useTextEditingController();
         final assetTickerController = useTextEditingController();
         final assetType = useState('Crypto');
         final assetCurrency = useState('USD');
         ```
       - Add the asset form fields in the `else` branch (after the fixed deposit form fields), showing when `mode.value == FormMode.asset`:
         - TextField for asset name (labelText: 'Asset name')
         - TextField for ticker (labelText: 'Ticker symbol')
         - DropdownButtonFormField for asset type (items: Crypto, ETF)
         - DropdownButtonFormField for native currency (items: USD, VND)
       - Add `submitAsset()` function:
         ```dart
         Future<void> submitAsset() async {
           if (assetNameController.text.isEmpty || assetTickerController.text.isEmpty) {
             ScaffoldMessenger.of(context).showSnackBar(
               const SnackBar(content: Text('Please fill in all required fields')),
             );
             return;
           }
           isSaving.value = true;
           try {
             final body = {
               'name': assetNameController.text,
               'ticker': assetTickerController.text,
               'assetType': assetType.value,
               'nativeCurrency': assetCurrency.value,
             };
             await ref.read(portfolioRepositoryProvider).createAsset(body);
             if (context.mounted) {
               ScaffoldMessenger.of(context).showSnackBar(
                 const SnackBar(content: Text('Asset created')),
               );
               context.pop();
               ref.invalidate(portfolioPageDataProvider);
             }
           } on DioException catch (e) {
             if (context.mounted) {
               final msg = e.response?.data?.toString() ?? 'Failed to create asset';
               ScaffoldMessenger.of(context).showSnackBar(
                 SnackBar(content: Text(msg)),
               );
             }
           } finally {
             isSaving.value = false;
           }
         }
         ```
       - Update the save button's onPressed to call `submitAsset()` when `mode.value == FormMode.asset`

    Note: The existing `else ...[]` block for fixed deposit needs to become `else if (mode.value == FormMode.fixedDeposit) ...[...]` and add a new `else ...[...]` for the asset form. Restructure the conditional rendering to handle all three modes.
  </action>
  <verify>
    - `dotnet build TradingBot.slnx` succeeds
    - `dotnet test` passes (existing tests should not be affected)
    - `grep -n "MapPost.*assets.*CreateAssetAsync" TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs` shows the new route
    - `grep -n "CreateAssetRequest" TradingBot.ApiService/Endpoints/PortfolioDtos.cs` shows the new DTO
    - `grep -n "createAsset" TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart` shows the new repo method
    - `grep -n "FormMode.asset" TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart` shows the new form mode
  </verify>
  <done>
    1. POST /api/portfolio/assets endpoint validates inputs, checks for duplicate ticker, creates asset via PortfolioAsset.Create(), returns 201 with created asset
    2. Flutter has a "New Asset" tab in the add entry form with name, ticker, type, and currency fields
    3. Flutter repository has createAsset() method calling the new endpoint
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.slnx` compiles without errors
2. `dotnet test` passes (no existing tests should break -- InterestCalculator and BacktestSimulator tests are unchanged)
3. CompoundingFrequency fix: Flutter form defaults to 'Simple', dropdown shows 'Simple (No Compounding)', fixed deposit creation succeeds on backend
4. Donut chart fix: AllocationDto has valueVnd, tooltip shows correct currency value
5. Asset creation: POST /api/portfolio/assets returns 201, Flutter has "New Asset" form mode
</verification>

<success_criteria>
- POST /api/portfolio/fixed-deposits with CompoundingFrequency='Simple' returns 201 (not 400)
- AllocationDonutChart tooltip displays VND-formatted value when in VND mode and USD-formatted value when in USD mode
- POST /api/portfolio/assets accepts {name, ticker, assetType, nativeCurrency} and returns 201 with the created asset
- Flutter "Add Entry" screen has three modes: Buy/Sell, Fixed Deposit, and New Asset
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/30-critical-bug-fixes/30-01-SUMMARY.md`
</output>
