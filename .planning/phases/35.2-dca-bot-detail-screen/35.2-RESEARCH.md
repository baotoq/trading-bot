# Phase 35.2: DCA Bot Detail Screen - Research

**Researched:** 2026-02-22
**Domain:** Flutter detail screen for DCA bot — tabs, glass info cards, PnL area chart, event history list, action buttons
**Confidence:** HIGH

## Summary

Phase 35.2 builds a dedicated DCA Bot Detail Screen for the Flutter mobile app. The reference screenshot shows a "Details" screen reached via back navigation from the portfolio or home tab. It has three tabs: Overview, History, and Parameters. The Overview tab (primary focus) shows a bot identity header, six stat fields in two rows, action buttons (More/Share), a PnL area chart labeled "Profit change", a "Bot info" card with Bot ID (copyable) and creation time, and a partially visible "Event history" section.

This is a **new screen** — no existing `DcaBotDetailScreen` exists in the codebase. It is also a **new navigation destination** in `router.dart`. The data comes entirely from existing API endpoints: `/api/dashboard/status` (StatusResponse: bot health, next buy time, last purchase), `/api/dashboard/portfolio` (PortfolioResponse: invested amount, unrealized PnL, average cost, purchase count, first purchase date), and `/api/dashboard/chart` (ChartResponse: price time series for the PnL chart shape). No new backend endpoints are needed for the MVP content.

The architecture follows the same HookConsumerWidget + GlassCard + fl_chart patterns established in Phases 33–35.1. The PnL area chart (red fill below zero line, labeled by percentage values on y-axis and dates on x-axis) reuses the `PriceLineChart` pattern with a different data set — PnL-over-time derived from portfolio progress. The bot identity header (BTC circular icon + "BTC Recurring buy" name + "Ongoing for XD Xh Xm" uptime) is new domain logic. The Parameters tab maps exactly to the existing `ConfigResponse` model.

**Primary recommendation:** Create `DcaBotDetailScreen` as a `HookConsumerWidget` using a `DefaultTabController`+`TabBarView` (3 tabs), backed by data from `homeDataProvider`+`portfolioPageDataProvider`+`configDataProvider`. Reuse `GlassCard` (stationary for info cards), `GlassCard.scrollItem` for event history rows, `fl_chart` LineChart for the PnL chart, and `PressableScale` for action buttons. Add a new route `/home/bot-detail` under the home branch. No new API endpoints needed.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| hooks_riverpod | ^3.2.1 (installed) | State management — watch homeDataProvider, portfolioPageDataProvider, configDataProvider | Project standard, all screens use it |
| flutter_hooks | any (installed) | useState for selected tab, useRef for hasAnimated guard | Project pattern for all local state |
| fl_chart | ^1.1.1 (installed) | PnL area chart on Overview tab | Same library used in ChartScreen; gradient fill pattern already established |
| GlassCard | project (Phase 33/34) | Info cards (stationary), event history rows (scrollItem) | All v5.0 screens use this |
| PressableScale | project (Phase 34) | More / Share action buttons | Press micro-interaction standard |
| AppShimmer | project (Phase 34) | Loading skeleton | Project standard |
| intl | any (installed) | NumberFormat for monetary values, DateFormat for timestamps | Used across all features |
| go_router | ^17.1.0 (installed) | New route under /home/bot-detail | Project router |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| flutter/services.dart | SDK | Clipboard.setData for "Copy Bot ID" action | When user taps the copy icon next to Bot ID |
| timeago | ^3.7.0 (installed) | "Ongoing for 45D 0h 48m" elapsed-time display | Elapsed since first purchase |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| DefaultTabController | useState<int> tab index + IndexedStack | DefaultTabController is the Flutter standard for TabBarView; useState is simpler but doesn't animate tab transitions. DefaultTabController integrates cleanly with TabBarView and respects flutter_hooks lifecycle via useTabController hook if needed |
| fl_chart LineChart for PnL chart | Custom CustomPainter | fl_chart already installed and proven; custom painter adds zero value |
| Derived PnL data from existing endpoints | New backend /pnl-history endpoint | v5.0 constraint: "no backend changes". Derive PnL approximation from existing purchase history data |

**Installation:** No new packages required.

## Architecture Patterns

### Recommended Project Structure

```
TradingBot.Mobile/lib/features/
├── home/
│   ├── data/
│   │   └── home_providers.dart         # EXISTING — homeDataProvider (status + portfolio)
│   └── presentation/
│       ├── home_screen.dart            # EXISTING — no changes
│       └── dca_bot_detail_screen.dart  # NEW — main detail screen
│           └── widgets/
│               ├── bot_identity_header.dart     # NEW: BTC icon, name, uptime
│               ├── bot_stats_grid.dart          # NEW: 6-field stat grid (2 rows of 3)
│               ├── bot_action_buttons.dart      # NEW: More + Share PressableScale buttons
│               ├── pnl_chart_card.dart          # NEW: fl_chart area chart in GlassCard
│               ├── bot_info_card.dart           # NEW: Bot ID + creation time GlassCard
│               └── bot_event_history.dart       # NEW: event history list (Phase 35.2 scope TBD)
└── config/
    └── data/
        └── config_providers.dart       # EXISTING — configDataProvider (for Parameters tab)
```

Note: The detail screen lives under `features/home/` because its primary data source is `homeDataProvider` (StatusResponse + PortfolioResponse). It is navigated to from the home tab context.

### Pattern 1: HookConsumerWidget with DefaultTabController

**What:** Three-tab detail screen using Flutter's built-in `DefaultTabController` with `TabBarView`. The tab controller manages tab animation automatically. The screen watches multiple providers simultaneously.

**When to use:** Multi-tab screens where tab transitions should animate smoothly between content areas.

**Example:**
```dart
// lib/features/home/presentation/dca_bot_detail_screen.dart
class DcaBotDetailScreen extends HookConsumerWidget {
  const DcaBotDetailScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final homeData = ref.watch(homeDataProvider);
    final portfolioData = ref.watch(portfolioPageDataProvider);
    final configData = ref.watch(configDataProvider);

    return DefaultTabController(
      length: 3,
      child: Scaffold(
        // No backgroundColor — global transparent from AppTheme.dark applies
        appBar: AppBar(
          title: const Text('Details'),
          backgroundColor: Colors.transparent,
          elevation: 0,
          leading: const BackButton(),
          actions: [
            IconButton(
              icon: const Icon(Icons.share_outlined),
              onPressed: () { /* share action */ },
            ),
          ],
          bottom: const TabBar(
            tabs: [
              Tab(text: 'Overview'),
              Tab(text: 'History'),
              Tab(text: 'Parameters'),
            ],
            indicatorColor: AppTheme.bitcoinOrange,
            labelColor: Colors.white,
            unselectedLabelColor: Colors.white54,
          ),
        ),
        body: TabBarView(
          children: [
            _OverviewTab(homeData: homeData, portfolioData: portfolioData),
            _HistoryTab(homeData: homeData),
            _ParametersTab(configData: configData),
          ],
        ),
      ),
    );
  }
}
```

### Pattern 2: Bot Identity Header

**What:** A Row at the top of the Overview tab (not in AppBar) showing a circular BTC icon, bot name, and uptime ("Ongoing for 45D 0h 48m"). The BTC icon is a CircleAvatar with AppTheme.bitcoinOrange background. The uptime is computed as Duration since `firstPurchaseDate`.

**When to use:** Detail screens showing bot identity at a glance before stats.

**Example:**
```dart
// bot_identity_header.dart
class BotIdentityHeader extends StatelessWidget {
  const BotIdentityHeader({required this.firstPurchaseDate, super.key});

  final String? firstPurchaseDate; // ISO 8601 from PortfolioResponse

  String _formatUptime(String? isoDate) {
    if (isoDate == null) return 'Not started';
    final start = DateTime.parse(isoDate);
    final duration = DateTime.now().difference(start);
    final days = duration.inDays;
    final hours = duration.inHours % 24;
    final minutes = duration.inMinutes % 60;
    return 'Ongoing for ${days}D ${hours}h ${minutes}m';
  }

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(16, 16, 16, 8),
      child: Row(
        children: [
          CircleAvatar(
            radius: 24,
            backgroundColor: AppTheme.bitcoinOrange,
            child: const Icon(Icons.currency_bitcoin, color: Colors.white, size: 28),
          ),
          const SizedBox(width: 12),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('BTC Recurring buy',
                style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
              Text(_formatUptime(firstPurchaseDate),
                style: const TextStyle(color: Colors.white54, fontSize: 13)),
            ],
          ),
        ],
      ),
    );
  }
}
```

### Pattern 3: Two-Row Stats Grid

**What:** A 2-row, 3-column grid of stat cells. Reference image shows:
- Row 1: "Invested amount (USDT)" = 479.99 | "Total PnL (USDT)" = -73.8714 (-15.40%)
- Row 2: "Frequency/Triggered" = Every 12 hours/48 | "Amount per period (USDT)" = 10 | "Average price (USDT)" = BTC 79,277.1
- Row 3 (single row): "Next purchase at" = 02/21/2026, 07:00 (UTC+7)

The stats are laid out in a `GlassCard` (stationary) — not scrollItem, since it does not scroll. Use `Column` + `Row` nesting rather than `GridView` for precise control.

**Data mapping:**
| UI Label | Data Source | Field |
|----------|-------------|-------|
| Invested amount (USDT) | PortfolioResponse | `totalCost` |
| Total PnL (USDT) | PortfolioResponse | `unrealizedPnl` + `unrealizedPnlPercent` |
| Frequency/Triggered | ConfigResponse + PortfolioResponse | `DailyBuyHour`:`DailyBuyMinute` schedule + `totalPurchaseCount` |
| Amount per period (USDT) | ConfigResponse | `baseDailyAmount` |
| Average price (USDT) | PortfolioResponse | `averageCostBasis` |
| Next purchase at | StatusResponse | `nextBuyTime` |

**Example:**
```dart
// bot_stats_grid.dart inside GlassCard(stationary)
GlassCard(
  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
  padding: const EdgeInsets.all(16),
  child: Column(
    children: [
      // Row 1: Invested + Total PnL
      Row(
        children: [
          _StatCell(label: 'Invested amount\n(USDT)', value: investedFormatted),
          const SizedBox(width: 16),
          _StatCell(
            label: 'Total PnL (USDT)',
            value: pnlFormatted,
            valueColor: pnlColor,
            subtitle: pnlPercentFormatted,
            subtitleColor: pnlColor,
          ),
        ],
      ),
      const SizedBox(height: 12),
      const Divider(color: Colors.white12),
      const SizedBox(height: 12),
      // Row 2: Frequency + Amount + Avg Price
      Row(
        children: [
          _StatCell(label: 'Frequency/Triggered', value: 'Every 12 hours/$triggerCount'),
          _StatCell(label: 'Amount per period\n(USDT)', value: amountPerPeriod),
          _StatCell(label: 'Average price\n(USDT)', value: 'BTC $avgPrice'),
        ],
      ),
      const SizedBox(height: 12),
      const Divider(color: Colors.white12),
      const SizedBox(height: 12),
      // Next purchase time (full width)
      Row(
        children: [
          const Text('Next purchase at', style: TextStyle(color: Colors.white54, fontSize: 12)),
          const SizedBox(width: 8),
          Text(nextPurchaseFormatted, style: AppTheme.moneyStyle.copyWith(fontSize: 13)),
        ],
      ),
    ],
  ),
)
```

### Pattern 4: PnL Area Chart (Profit Change)

**What:** An `fl_chart` LineChart showing PnL percentage over time. The reference image shows:
- Y-axis: percentage values (12.63%, 3.63%, -5.36%, -14.36%, -23.36%, -32.36%) — negative values dominate
- X-axis: date labels (01/18, 01/29, 02/09, 02/21)
- Filled area below the line in lossRed color (because PnL is negative)
- No purchase markers needed (this is PnL%, not price)

**Data derivation:** Since no PnL-history endpoint exists, approximate PnL change from chart price data: for each price point in `ChartResponse.prices`, compute `((price - avgCostBasis) / avgCostBasis) * 100`. This gives daily PnL% relative to average cost, which approximates the "Profit change" chart.

**Color logic:** If portfolio is in profit, use `profitGreen` for chart line and fill. If in loss, use `lossRed`. Dynamic based on `unrealizedPnlPercent` sign.

**Example:**
```dart
// pnl_chart_card.dart — reuses PriceLineChart pattern
GlassCard(
  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
  padding: const EdgeInsets.all(16),
  child: Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      Text('Profit change', style: Theme.of(context).textTheme.titleSmall),
      Text(
        totalPnlFormatted,
        style: TextStyle(
          color: pnlColor,
          fontSize: 20,
          fontWeight: FontWeight.bold,
        ).merge(AppTheme.moneyStyle),
      ),
      const SizedBox(height: 8),
      SizedBox(
        height: 160,
        child: LineChart(
          LineChartData(
            lineBarsData: [
              LineChartBarData(
                spots: pnlSpots,
                isCurved: true,
                color: pnlColor,
                barWidth: 1.5,
                dotData: const FlDotData(show: false),
                belowBarData: BarAreaData(
                  show: true,
                  gradient: LinearGradient(
                    colors: [pnlColor.withAlpha(77), Colors.transparent],
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                  ),
                ),
              ),
            ],
            // Y-axis: percentage format
            titlesData: FlTitlesData(
              leftTitles: AxisTitles(
                sideTitles: SideTitles(
                  showTitles: true,
                  reservedSize: 50,
                  getTitlesWidget: (value, meta) => Text(
                    '${value.toStringAsFixed(2)}%',
                    style: const TextStyle(color: Colors.white54, fontSize: 9),
                  ),
                ),
              ),
              // bottom titles: date labels
              ...
            ),
            gridData: FlGridData(show: true, drawVerticalLine: false),
            borderData: FlBorderData(show: false),
          ),
        ),
      ),
    ],
  ),
)
```

### Pattern 5: Bot Info Card

**What:** A `GlassCard` (stationary) containing:
- "Bot ID" label + ID value (truncated or full) + copy icon button
- "Creation time" label + formatted date

The Bot ID in the reference is `31948768747774179840` — this is the `PurchaseId` of the first purchase (UUIDv7). However, `PortfolioResponse` does not expose a bot ID. Options:
1. Use a computed ID: derive from app start time or `firstPurchaseDate` formatted as a numeric timestamp.
2. Use the `firstPurchaseDate` ISO string as the "bot creation time" (directly available in PortfolioResponse).
3. Show a static display ID derived from hashing the wallet address or `firstPurchaseDate`.

**Recommendation:** Use the `firstPurchaseDate` timestamp in milliseconds as a display-only "Bot ID" (consistent, unique, reproducible without new API). Show creation time from `firstPurchaseDate`.

**Copy behavior:** `Clipboard.setData(ClipboardData(text: botId))` + `ScaffoldMessenger.of(context).showSnackBar(...)`.

**Example:**
```dart
// bot_info_card.dart
GlassCard(
  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
  padding: const EdgeInsets.all(16),
  child: Column(
    children: [
      _InfoRow(
        label: 'Bot ID',
        value: botId,
        trailing: IconButton(
          icon: const Icon(Icons.copy, size: 16, color: Colors.white54),
          onPressed: () {
            Clipboard.setData(ClipboardData(text: botId));
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('Bot ID copied')),
            );
          },
        ),
      ),
      const Divider(color: Colors.white12),
      _InfoRow(label: 'Creation time', value: creationTimeFormatted),
    ],
  ),
)
```

### Pattern 6: Route Setup

**What:** New GoRoute under the home branch. The detail screen navigates to using `context.push('/home/bot-detail')` — from the HomeScreen (e.g., tapping a "BTC Bot" card or a new CTA). Uses `parentNavigatorKey: rootNavigatorKey` for full-screen push (not nested under home tab).

**Example:**
```dart
// router.dart addition under /home branch
GoRoute(
  path: 'bot-detail',
  parentNavigatorKey: rootNavigatorKey,
  builder: (_, __) => const DcaBotDetailScreen(),
),
```

### Pattern 7: History Tab (Event History)

**What:** A list of purchase events. This maps directly to `PurchaseHistoryResponse` from `/api/dashboard/purchases`. Each row shows purchase date, price, BTC amount, cost, and tier badge — the same data as the existing `HistoryScreen`. The History tab within the detail screen can reuse `PurchaseListItem` widget directly, wrapping it in a `ListView.builder`.

**Data:** The existing `historyDataProvider` can be watched in the History tab. Since the detail screen is inside `rootNavigatorKey` (not inside the history branch), the provider will be shared but independent.

**Note:** For the detail screen History tab, use `purchaseHistoryProvider` from `history_providers.dart` — the existing provider is already set up with pagination via `HistoryNotifier`.

### Pattern 8: Parameters Tab

**What:** Display all DCA config values from `configDataProvider`. Show each setting in a labeled row inside `GlassCard` sections:
- Section 1: "Schedule" — daily buy hour/minute, base amount
- Section 2: "Strategy" — high lookback days, bear market MA, bear boost, max multiplier cap
- Section 3: "Tiers" — list of drop% + multiplier pairs

This tab is read-only — no editing (that's `ConfigScreen`'s job).

### Anti-Patterns to Avoid

- **BackdropFilter in event history list rows:** The History tab list items MUST use a non-blur surface or the existing `PurchaseListItem` (which already uses a Container, not GlassCard). Do NOT add GlassVariant.stationary to list items inside ListView.
- **Scaffold backgroundColor:** Must NOT set a solid backgroundColor — global transparent from AppTheme.dark must apply.
- **withOpacity instead of withAlpha:** Project decision requires withAlpha(int). All color alpha operations: `withOpacity(0.3)` → `withAlpha(77)`.
- **useAnimationController outside HookConsumerWidget:** If any animation is added (chart draw-in, etc.), must use `useAnimationController` hook.
- **_hasAnimated missing:** If chart draw-in animation is added, use `useRef<bool>(false)` guard to prevent re-animation on tab revisit.
- **New API endpoints:** v5.0 constraint: "New API endpoints or data model changes" is out of scope. All data must come from existing endpoints.
- **DailyBuyHour as "Every 12 hours":** ConfigResponse has `dailyBuyHour` and `dailyBuyMinute` for a once-daily schedule, not "every 12 hours". The reference screenshot says "Every 12 hours/48" which may be a Bybit-specific concept. For this app, the correct label is "Daily at HH:MM" based on DcaOptions.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Shimmer loading state | Custom animated gradient | `AppShimmer` + `Bone` widgets | Project standard; GlassTheme colors wired |
| Glass info card surface | Custom Container + Border | `GlassCard` (stationary variant) | Phase 33 decision; tokens consistent |
| Event history rows | New widget from scratch | `PurchaseListItem` from HistoryScreen | Already implemented with correct tier colors and formatting |
| PnL chart fill gradient | Custom CustomPainter | `fl_chart` BarAreaData + LinearGradient | Same pattern as `PriceLineChart` |
| Clipboard copy | Custom platform channel | `flutter/services.dart Clipboard.setData` | Built-in Flutter API |
| Tab switching state | useState<int> + IndexedStack | `DefaultTabController` + `TabBarView` | Built-in Flutter; smooth animation, correct semantics |
| P&L color | Hardcoded red/green | `AppTheme.profitGreen` / `AppTheme.lossRed` | Project semantic constants, non-negotiable |
| Currency formatting | Manual string format | `NumberFormat.currency(...)` from `intl` | Already used in 5+ files |

**Key insight:** The entire detail screen is an assembly of already-built primitives (GlassCard, AppShimmer, PressableScale, fl_chart, PurchaseListItem). No fundamentally new widget patterns are needed.

## Common Pitfalls

### Pitfall 1: "Every 12 hours" Frequency Label Is Wrong for This App
**What goes wrong:** The reference screenshot is from a different app (Bybit/3Commas DCA bot) that supports custom recurrence intervals. This app only supports once-daily DCA. Copying the label verbatim produces a misleading "Every 12 hours" that contradicts the actual config.
**Why it happens:** Reference screenshot is a design inspiration, not a spec for this app's exact data model.
**How to avoid:** Use "Daily at HH:MM" format for the frequency field. Triggered count = `totalPurchaseCount` from PortfolioResponse.
**Warning signs:** User sees "Every 12 hours" but config says `dailyBuyHour: 14, dailyBuyMinute: 0`.

### Pitfall 2: No PnL History Endpoint — Chart Must Be Derived
**What goes wrong:** Developer tries to fetch `/api/portfolio/pnl-history` which does not exist, causing 404 errors.
**Why it happens:** The reference shows a PnL area chart over time, suggesting a dedicated endpoint. There is none.
**How to avoid:** Derive PnL% for each price point using `((price - averageCostBasis) / averageCostBasis) * 100`. Watch `chartDataProvider(timeframe: '1M')` and `portfolioPageDataProvider`. When `averageCostBasis` is null, show an empty chart skeleton.
**Warning signs:** Attempting to call a non-existent endpoint. `averageCostBasis` is null when no purchases exist — handle gracefully.

### Pitfall 3: Bot ID Has No Backend Source
**What goes wrong:** Displaying "Bot ID" field but no API returns a stable bot identifier.
**Why it happens:** This app is a single-bot system; there is no bot entity with an ID in the backend. The reference screenshot's Bot ID is a Bybit-specific concept.
**How to avoid:** Derive a display-only Bot ID from `firstPurchaseDate` as a Unix timestamp in milliseconds, or use a static hardcoded display string like "BTC-DCA-001". The recommended approach: convert `firstPurchaseDate` to milliseconds since epoch as the "Bot ID" string. This is stable, reproducible, and plausible.
**Warning signs:** Attempting to fetch a bot ID from any API endpoint.

### Pitfall 4: Scaffold backgroundColor Overriding AmbientBackground
**What goes wrong:** AmbientBackground navy orbs disappear behind the detail screen.
**Why it happens:** The `DcaBotDetailScreen` sets a solid `backgroundColor` on the `Scaffold`.
**How to avoid:** Do NOT set `backgroundColor` on the Scaffold. The global `scaffoldBackgroundColor: Colors.transparent` from `AppTheme.dark` applies automatically.
**Warning signs:** Navy orbs are not visible on the detail screen.

### Pitfall 5: TabBarView Children Are Expensive to Build
**What goes wrong:** All three tab contents are built simultaneously even when only one tab is visible, causing slow initial render and wasted API calls.
**Why it happens:** `TabBarView` in Flutter builds all children on first render.
**How to avoid:** For the History and Parameters tabs, use lazy loading: watch providers only when the tab is active using a local `isActive` flag, or accept the trade-off since all three providers are lightweight and already cached.
**Warning signs:** Three API calls firing simultaneously on screen entry (acceptable if all data is cached).

### Pitfall 6: Navigation Route Conflict
**What goes wrong:** The bot-detail route is added as a nested route under `/home` but tries to render the NavigationBar, breaking the full-screen push behavior.
**Why it happens:** Using the wrong navigator key in GoRoute definition. Detail screens should use `parentNavigatorKey: rootNavigatorKey` to escape the tab shell.
**How to avoid:** Define the route with `parentNavigatorKey: rootNavigatorKey` so it pushes full-screen above the navigation shell, matching the pattern used by `AddTransactionScreen`, `TransactionHistoryScreen`, and `FixedDepositDetailScreen`.
**Warning signs:** Bottom navigation bar appears on the detail screen.

### Pitfall 7: Event History Tab Conflicts with Existing History Tab Provider
**What goes wrong:** The detail screen's History tab uses `purchaseHistoryProvider` which is also used by the main HistoryScreen. Navigating to the detail screen resets the main history tab's scroll position or pagination state.
**Why it happens:** `purchaseHistoryProvider` is a singleton `AsyncNotifier` — all watchers share state.
**How to avoid:** This is acceptable behavior. The detail screen History tab shares the same provider as the main History tab. If isolation is needed, create a separate `dcaBotHistoryProvider` that calls the same API independently. For Phase 35.2 scope, reuse the existing provider.
**Warning signs:** Main History tab loses filters or scroll position after visiting the detail screen.

## Code Examples

Verified patterns from project sources:

### Route Registration (following fixed-deposit-detail pattern)
```dart
// router.dart — add inside _homeNavKey branch
GoRoute(
  path: 'bot-detail',
  parentNavigatorKey: rootNavigatorKey,
  builder: (_, __) => const DcaBotDetailScreen(),
),
```

### Uptime Calculation
```dart
// Compute "Ongoing for 45D 0h 48m" from firstPurchaseDate
String _formatUptime(String? isoDate) {
  if (isoDate == null) return 'Not started';
  final start = DateTime.parse(isoDate);
  final duration = DateTime.now().difference(start);
  final days = duration.inDays;
  final hours = duration.inHours % 24;
  final minutes = duration.inMinutes % 60;
  return 'Ongoing for ${days}D ${hours}h ${minutes}m';
}
```

### PnL Chart Data Derivation
```dart
// Derive PnL% spots from price data + averageCostBasis
// Source: PortfolioResponse.averageCostBasis + ChartResponse.prices
List<FlSpot> _buildPnlSpots(List<PricePointDto> prices, double avgCost) {
  return prices.asMap().entries.map((e) {
    final pnlPct = ((e.value.price - avgCost) / avgCost) * 100;
    return FlSpot(e.key.toDouble(), pnlPct);
  }).toList();
}
```

### Copy to Clipboard with SnackBar
```dart
// Source: flutter/services.dart Clipboard API
// Following existing snackbar patterns in error_snackbar.dart
void _copyBotId(BuildContext context, String botId) {
  Clipboard.setData(ClipboardData(text: botId));
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(
      content: Text('Bot ID copied to clipboard'),
      behavior: SnackBarBehavior.floating,
    ),
  );
}
```

### Deriving Display Bot ID
```dart
// Stable display ID from firstPurchaseDate milliseconds since epoch
// PortfolioResponse.firstPurchaseDate is ISO 8601 string
String _deriveBotId(String? firstPurchaseDate) {
  if (firstPurchaseDate == null) return '—';
  final dt = DateTime.tryParse(firstPurchaseDate);
  if (dt == null) return '—';
  return dt.millisecondsSinceEpoch.toString();
}
```

### PnL Color from AppTheme (project convention)
```dart
// Source: lib/app/theme.dart
// STATE.md: "profitGreen and lossRed are non-negotiable semantic constants"
Color _pnlColor(double? pnl) {
  if (pnl == null) return Colors.white54;
  if (pnl > 0) return AppTheme.profitGreen;
  if (pnl < 0) return AppTheme.lossRed;
  return Colors.white54;
}
```

### Frequency Display Logic
```dart
// Map ConfigResponse schedule to human-readable string
// ConfigResponse.dailyBuyHour / dailyBuyMinute → "Daily at 14:00"
// totalPurchaseCount from PortfolioResponse → "/48 triggered"
String _formatFrequency(ConfigResponse config, int purchaseCount) {
  final hour = config.dailyBuyHour.toString().padLeft(2, '0');
  final minute = config.dailyBuyMinute.toString().padLeft(2, '0');
  return 'Daily at $hour:$minute / $purchaseCount triggered';
}
```

## Data Model Analysis

### Available Data for Each Reference Screen Section

| UI Section | Data Source | API Endpoint | Fields Used | Available? |
|------------|-------------|--------------|-------------|------------|
| BTC icon + bot name | Static | — | Hardcoded "BTC Recurring buy" | YES (static) |
| Uptime "Ongoing for XD Xh Xm" | PortfolioResponse | /api/dashboard/portfolio | `firstPurchaseDate` | YES |
| Invested amount (USDT) | PortfolioResponse | /api/dashboard/portfolio | `totalCost` | YES |
| Total PnL (USDT) + % | PortfolioResponse | /api/dashboard/portfolio | `unrealizedPnl`, `unrealizedPnlPercent` | YES (nullable) |
| Frequency/Triggered | ConfigResponse + PortfolioResponse | /api/dashboard/config + /api/dashboard/portfolio | `dailyBuyHour`, `dailyBuyMinute` + `totalPurchaseCount` | YES |
| Amount per period (USDT) | ConfigResponse | /api/dashboard/config | `baseDailyAmount` | YES |
| Average price (USDT) | PortfolioResponse | /api/dashboard/portfolio | `averageCostBasis` | YES (nullable) |
| Next purchase at | StatusResponse | /api/dashboard/status | `nextBuyTime` | YES (ISO string) |
| More button | UI action | — | Placeholder / bottom sheet | YES (static) |
| Share button | UI action | — | Clipboard/share sheet | YES (Clipboard.setData) |
| Profit change chart | ChartResponse + PortfolioResponse | /api/dashboard/chart + /api/dashboard/portfolio | `prices`, `averageCostBasis` | YES (derived) |
| Chart total PnL% label | PortfolioResponse | /api/dashboard/portfolio | `unrealizedPnlPercent` | YES (nullable) |
| Bot ID | Derived | — | Computed from `firstPurchaseDate` ms | YES (derived) |
| Creation time | PortfolioResponse | /api/dashboard/portfolio | `firstPurchaseDate` | YES |
| Event history | PurchaseHistoryResponse | /api/dashboard/purchases | `items[]` | YES |
| History tab | PurchaseHistoryResponse | /api/dashboard/purchases | All PurchaseDto fields | YES |
| Parameters tab | ConfigResponse | /api/dashboard/config | All config fields | YES |

**Zero data gaps for MVP scope.** All reference image fields can be populated from existing endpoints.

### Provider Dependencies Per Tab

| Tab | Providers Watched |
|-----|------------------|
| Overview | `homeDataProvider` (status + portfolio), `portfolioPageDataProvider`, `chartDataProvider(timeframe: '1M')`, `configDataProvider` |
| History | `purchaseHistoryProvider` |
| Parameters | `configDataProvider` |

**Recommendation:** Load `homeDataProvider` and `configDataProvider` at the screen level (shared across tabs). Load `chartDataProvider` lazily only when Overview tab is first rendered. Load `purchaseHistoryProvider` lazily only when History tab is first rendered. This avoids over-fetching on initial screen entry.

## Screen Architecture Decision

### Overview Tab Layout (top to bottom)

```
DcaBotDetailScreen (HookConsumerWidget)
└── DefaultTabController (length: 3)
    └── Scaffold (backgroundColor: transparent)
        ├── AppBar
        │   ├── BackButton (auto by GoRouter)
        │   ├── title: "Details"
        │   ├── action: Share IconButton
        │   └── bottom: TabBar [Overview | History | Parameters]
        └── TabBarView
            └── Overview Tab: SingleChildScrollView
                ├── BotIdentityHeader (BTC icon + name + uptime)
                ├── GlassCard (stationary) — Stats grid
                │   ├── Row: Invested | Total PnL
                │   ├── Divider
                │   ├── Row: Frequency | Amount/period | Avg price
                │   ├── Divider
                │   └── Row: Next purchase at (full width)
                ├── PressableScale buttons row: [More] [Share]
                ├── GlassCard (stationary) — Profit change chart
                │   ├── "Profit change" label + total PnL% value
                │   └── fl_chart LineChart (160px height)
                ├── GlassCard (stationary) — Bot info
                │   ├── Bot ID + copy icon
                │   └── Creation time
                ├── "Event history" section header
                └── 3-5 event history rows (PurchaseListItem, non-blur)
```

### Plan Breakdown Recommendation

This phase is suitable for 2 plans:

**Plan 01 (Wave 1):** Create `DcaBotDetailScreen` structural shell, route, Overview tab layout with identity header, stats grid, and action buttons. No chart yet.

**Plan 02 (Wave 2):** Add the PnL chart card, Bot info card, event history section to Overview tab. Wire History tab with `PurchaseListItem`. Add Parameters tab with config display. Update loading skeleton.

## Open Questions

1. **"More" button action**
   - What we know: Reference shows a "More" button with a grid/apps icon. No action is specified.
   - What's unclear: What "More" should do — show a bottom sheet? Show settings? Navigate somewhere?
   - Recommendation: Implement as a no-op `PressableScale` button initially with a `// TODO: More actions TBD` comment. It should at least render correctly with a glass-styled button appearance.

2. **PnL chart timeframe**
   - What we know: The reference shows ~1 month of PnL data (01/18 to 02/21). `chartDataProvider` supports '7D', '1M', '3M', '6M', '1Y', 'All'.
   - What's unclear: Should the detail screen chart have a timeframe selector?
   - Recommendation: Default to '1M' timeframe without a selector for Phase 35.2. Keep it simple.

3. **Event history in Overview tab vs. History tab**
   - What we know: Reference shows "Event history" partially visible at the bottom of the Overview tab AND a separate "History" tab.
   - What's unclear: Whether the Overview tab event history is just the most recent 3-5 purchases, or the full paginated list.
   - Recommendation: Show the most recent 3-5 purchases from `purchaseHistoryProvider` in the Overview tab as a preview (no pagination), with a "View all" link that switches to the History tab. The History tab gets the full paginated list.

4. **BotIdentityHeader BTC icon source**
   - What we know: The reference shows a circular orange BTC icon. No crypto icon library is installed.
   - What's unclear: Whether to use an `Icon` widget, `Text('₿')`, or `CupertinoIcons.bitcoin`.
   - Recommendation: Use `Icons.currency_bitcoin` (Material icon, available in Flutter SDK) inside a CircleAvatar with `AppTheme.bitcoinOrange` background. No new dependency needed.

## Sources

### Primary (HIGH confidence)
- Project source: `lib/features/home/data/models/status_response.dart` — `nextBuyTime`, health fields
- Project source: `lib/features/home/data/models/portfolio_response.dart` — `totalCost`, `unrealizedPnl`, `averageCostBasis`, `totalPurchaseCount`, `firstPurchaseDate`, `lastPurchaseDate`
- Project source: `lib/features/config/data/models/config_response.dart` — `baseDailyAmount`, `dailyBuyHour`, `dailyBuyMinute`, all config fields
- Project source: `lib/features/chart/data/models/chart_response.dart` — `prices[]` for PnL derivation
- Project source: `lib/features/history/data/models/purchase_history_response.dart` — `PurchaseDto` for event history
- Project source: `lib/features/history/presentation/widgets/purchase_list_item.dart` — reusable for History tab
- Project source: `lib/core/widgets/glass_card.dart` — GlassCard, GlassVariant, stationary for info cards
- Project source: `lib/core/widgets/pressable_scale.dart` — PressableScale for action buttons
- Project source: `lib/core/widgets/shimmer_loading.dart` — AppShimmer pattern for skeleton
- Project source: `lib/app/router.dart` — GoRoute pattern for new detail screen route
- Project source: `lib/features/chart/presentation/widgets/price_line_chart.dart` — fl_chart LineChart with gradient fill (PnL chart basis)
- Project source: `lib/features/portfolio/presentation/widgets/portfolio_asset_list_item.dart` — _tickerColor, _pnlColor helper patterns to reuse
- Project source: `lib/features/portfolio/presentation/portfolio_screen.dart` — HookConsumerWidget pattern with multiple providers
- Project STATE.md — all v5.0 decisions (scrollItem, withAlpha, HookConsumerWidget, _hasAnimated, transparent Scaffold, AmbientBackground)
- Project REQUIREMENTS.md — "no backend changes in v5.0", SCRN-01 through SCRN-05 context
- Reference image `.planning/phases/35.2-dca-bot-detail-screen/reference.png` — analyzed visually

### Secondary (MEDIUM confidence)
- Flutter `DefaultTabController` + `TabBarView` — built-in Flutter SDK, well-documented
- Flutter `Clipboard.setData` — built-in services API for copy functionality
- `fl_chart` LineChart pattern — derived from existing `PriceLineChart` implementation in codebase

### Tertiary (LOW confidence)
- "Event history" at bottom of Overview tab — partially visible in reference; exact content inferred from context
- "More" button action — undefined in reference; placeholder recommended

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all packages installed, all primitives built in Phases 33–35.1
- Architecture patterns: HIGH — derived from existing codebase; HookConsumerWidget, GlassCard, fl_chart all confirmed
- Data model analysis: HIGH — all source fields inspected; no gaps for MVP scope
- PnL chart derivation: MEDIUM — derivation formula is mathematically correct but visual output not yet validated against reference
- "More" button: LOW — action undefined; placeholder approach is safe
- Event history in Overview tab: MEDIUM — inferred from partial reference visibility

**Research date:** 2026-02-22
**Valid until:** 2026-03-22 (stable libraries; project primitives won't change between phases)
