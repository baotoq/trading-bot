---
phase: 35.2-dca-bot-detail-screen
plan: 02
type: execute
wave: 2
depends_on: [35.2-01]
files_modified:
  - TradingBot.Mobile/lib/features/home/presentation/dca_bot_detail_screen.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/pnl_chart_card.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/bot_info_card.dart
autonomous: true
requirements: [DCA-UI-04, DCA-UI-05, DCA-UI-06, DCA-UI-07]

must_haves:
  truths:
    - "Overview tab shows a PnL area chart with gradient fill colored by profit/loss direction"
    - "Overview tab shows a Bot info card with Bot ID (copyable) and creation time"
    - "Overview tab shows the 5 most recent purchase events at the bottom"
    - "History tab shows the full paginated purchase history list reusing PurchaseListItem"
    - "Parameters tab shows all DCA config values organized in GlassCard sections"
    - "Tapping copy icon next to Bot ID copies the ID to clipboard with a SnackBar confirmation"
    - "Loading skeleton matches the Overview tab layout structure"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/pnl_chart_card.dart"
      provides: "PnL area chart with fl_chart inside GlassCard"
      contains: "LineChart"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/bot_info_card.dart"
      provides: "Bot ID and creation time card with copy functionality"
      contains: "Clipboard"
    - path: "TradingBot.Mobile/lib/features/home/presentation/dca_bot_detail_screen.dart"
      provides: "Complete 3-tab detail screen with all content wired"
      contains: "PurchaseListItem"
  key_links:
    - from: "TradingBot.Mobile/lib/features/home/presentation/widgets/pnl_chart_card.dart"
      to: "chartDataProvider"
      via: "Price data for PnL derivation"
      pattern: "chartDataProvider"
    - from: "TradingBot.Mobile/lib/features/home/presentation/dca_bot_detail_screen.dart"
      to: "purchaseHistoryProvider"
      via: "History tab watching purchase list"
      pattern: "purchaseHistoryProvider"
    - from: "TradingBot.Mobile/lib/features/home/presentation/dca_bot_detail_screen.dart"
      to: "configDataProvider"
      via: "Parameters tab watching config"
      pattern: "configDataProvider"
---

<objective>
Complete the DCA Bot Detail screen with PnL chart, Bot info card, event history, History tab, Parameters tab, and loading skeleton.

Purpose: Fills in the remaining Overview tab content (chart, bot info, event history preview) and implements the two remaining tabs (History with full purchase list, Parameters with read-only config display), making the detail screen feature-complete.

Output: pnl_chart_card.dart, bot_info_card.dart, updated dca_bot_detail_screen.dart with all 3 tabs fully implemented.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35.2-dca-bot-detail-screen/35.2-RESEARCH.md
@.planning/phases/35.2-dca-bot-detail-screen/reference.png
@.planning/phases/35.2-dca-bot-detail-screen/35.2-01-SUMMARY.md
@TradingBot.Mobile/lib/features/home/presentation/dca_bot_detail_screen.dart
@TradingBot.Mobile/lib/features/chart/data/chart_providers.dart
@TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
@TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
@TradingBot.Mobile/lib/features/history/data/history_providers.dart
@TradingBot.Mobile/lib/features/history/presentation/widgets/purchase_list_item.dart
@TradingBot.Mobile/lib/features/config/data/models/config_response.dart
@TradingBot.Mobile/lib/core/widgets/glass_card.dart
@TradingBot.Mobile/lib/core/widgets/shimmer_loading.dart
@TradingBot.Mobile/lib/app/theme.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PnL chart card and Bot info card widgets</name>
  <files>
    TradingBot.Mobile/lib/features/home/presentation/widgets/pnl_chart_card.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/bot_info_card.dart
  </files>
  <action>
Create two new widget files under `lib/features/home/presentation/widgets/`:

**pnl_chart_card.dart** — `PnlChartCard` StatelessWidget:
- Takes: `List<PricePointDto> prices`, `double? averageCostBasis`, `double? unrealizedPnlPercent`.
- Outer wrapper: GlassCard (stationary) with margin EdgeInsets.symmetric(horizontal: 16, vertical: 8), padding EdgeInsets.all(16).
- Layout as Column(crossAxisAlignment: start):
  1. Text('Profit change', style: Theme.of(context).textTheme.titleSmall)
  2. SizedBox(height: 4)
  3. Text for total PnL%: if unrealizedPnlPercent != null, show `'${pnl >= 0 ? '+' : ''}${pnl.toStringAsFixed(2)}%'` with fontSize 20, fontWeight bold, color from _pnlColor, merged with AppTheme.moneyStyle. If null, show '--' in Colors.white54.
  4. SizedBox(height: 12)
  5. SizedBox(height: 160) containing the LineChart (or empty Container if prices.isEmpty or averageCostBasis is null)

**LineChart configuration** (fl_chart):
- Derive PnL spots: `_buildPnlSpots(prices, avgCost)` maps each price point to FlSpot(index.toDouble(), ((price - avgCost) / avgCost) * 100).
- Chart color logic: if unrealizedPnlPercent != null && unrealizedPnlPercent >= 0, use AppTheme.profitGreen; else use AppTheme.lossRed. Fallback Colors.white54.
- LineChartBarData:
  - spots: pnlSpots
  - isCurved: true, curveSmoothness: 0.3
  - color: chartColor
  - barWidth: 1.5
  - dotData: FlDotData(show: false)
  - belowBarData: BarAreaData(show: true, gradient: LinearGradient(colors: [chartColor.withAlpha(77), Colors.transparent], begin: Alignment.topCenter, end: Alignment.bottomCenter))
- Extra horizontal line at y=0 (zero line): ExtraLinesData(horizontalLines: [HorizontalLine(y: 0, color: Colors.white24, strokeWidth: 0.5, dashArray: [4, 4])])
- titlesData:
  - leftTitles: SideTitles(showTitles: true, reservedSize: 50, getTitlesWidget: format as '${value.toStringAsFixed(2)}%', style: TextStyle(color: Colors.white54, fontSize: 9))
  - bottomTitles: SideTitles(showTitles: true, reservedSize: 20, interval: compute as (prices.length / 4).round() to show ~4 date labels, getTitlesWidget: extract date from prices list, format as 'MM/dd' using substring of the date string, style: TextStyle(color: Colors.white54, fontSize: 9))
  - topTitles/rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false))
- gridData: FlGridData(show: true, drawVerticalLine: false, getDrawingHorizontalLine: (value) => FlLine(color: Colors.white12, strokeWidth: 0.5))
- borderData: FlBorderData(show: false)
- lineTouchData: LineTouchData(enabled: false) — no tooltip on this chart (keep it simple, chart tooltip is Phase 35 scope for the main chart)

**Helpers:**
- `_pnlColor(double? pnl)`: same pattern — profitGreen, lossRed, or white54.
- `_buildPnlSpots(List<PricePointDto> prices, double avgCost)`: returns List<FlSpot>.

**bot_info_card.dart** — `BotInfoCard` StatelessWidget:
- Takes: `String? firstPurchaseDate` (ISO 8601).
- Outer wrapper: GlassCard (stationary) with margin EdgeInsets.symmetric(horizontal: 16, vertical: 8), padding EdgeInsets.all(16).
- Column header: Text('Bot info', style: titleSmall, color: Colors.white) + SizedBox(height: 12).
- Layout as Column:
  1. _InfoRow(label: 'Bot ID', value: _deriveBotId(firstPurchaseDate), trailing: IconButton(icon: Icon(Icons.copy, size: 16, color: Colors.white54), onPressed: _copyBotId))
  2. Divider(color: Colors.white12, height: 24)
  3. _InfoRow(label: 'Creation time', value: _formatCreationTime(firstPurchaseDate))

- Private `_InfoRow` widget: Row(mainAxisAlignment: spaceBetween) with Text(label, fontSize: 13, color: Colors.white54) on left and Row(children: [Text(value, fontSize: 13, color: Colors.white), if trailing != null: trailing]) on right. Value text merged with AppTheme.moneyStyle.

- `_deriveBotId(String? firstPurchaseDate)`: if null return '—'. Parse DateTime, return millisecondsSinceEpoch.toString().

- `_formatCreationTime(String? firstPurchaseDate)`: if null return '—'. Parse DateTime, format with DateFormat('MM/dd/yyyy, HH:mm:ss').format(dt.toLocal()).

- `_copyBotId(BuildContext context, String botId)`: Clipboard.setData(ClipboardData(text: botId)) then ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Bot ID copied to clipboard'), behavior: SnackBarBehavior.floating)).
- Import flutter/services.dart for Clipboard.

**Conventions for both files:**
- Use Color.withAlpha(int) NOT withOpacity(float).
- All monetary/numeric display values use AppTheme.moneyStyle merge.
- Import fl_chart for pnl_chart_card.dart.
  </action>
  <verify>
Run `dart analyze TradingBot.Mobile` — no errors in the two new widget files.
  </verify>
  <done>
PnlChartCard renders an fl_chart LineChart with gradient fill area colored by PnL direction (green for profit, red for loss), derived from price data + average cost basis. BotInfoCard shows Bot ID (copyable to clipboard with SnackBar) and creation time in a GlassCard. Both use AppTheme.moneyStyle and withAlpha conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Complete all 3 tabs and add loading skeleton</name>
  <files>
    TradingBot.Mobile/lib/features/home/presentation/dca_bot_detail_screen.dart
  </files>
  <action>
Update dca_bot_detail_screen.dart to fill in all tab content and add proper loading state:

**Overview tab (_OverviewTab) — complete the content:**
Replace the placeholder items from Plan 01 with full content. The SingleChildScrollView Column should now contain:
1. BotIdentityHeader(firstPurchaseDate: portfolio.firstPurchaseDate)
2. BotStatsGrid(portfolio: portfolio, status: status, config: config)
3. BotActionButtons(portfolio: portfolio)
4. PnlChartCard — watch `chartDataProvider(timeframe: '1M')` for price data. When chart data loads, pass `chartData.prices`, `chartData.averageCostBasis`, and `portfolio.unrealizedPnlPercent`. When chart is loading/error, show a GlassCard placeholder with a SizedBox(height: 200) and centered CircularProgressIndicator or Text('Chart unavailable').
5. BotInfoCard(firstPurchaseDate: portfolio.firstPurchaseDate)
6. Event history preview section:
   - Padding(horizontal: 16, vertical: 8): Text('Event history', style: titleSmall)
   - Watch `purchaseHistoryProvider` for purchase list. When loaded, show the first 5 items using `PurchaseListItem(purchase: item)` inside a Column. If empty, show Text('No purchases yet', Colors.white54).
   - When loading/error, show SizedBox.shrink() (the main loading skeleton handles initial state).
7. SizedBox(height: 80) — bottom padding

**History tab (_HistoryTab) — full purchase list:**
- Private HookConsumerWidget.
- Watch `purchaseHistoryProvider` for the paginated list.
- Build: AsyncValue switch:
  - AsyncData: If empty, Center(Text('No purchase history', Colors.white54)). Otherwise, ListView.builder with itemCount = purchases.length + (hasMore ? 1 : 0). Each item: PurchaseListItem(purchase: purchases[index]). Last item (if hasMore): Center(CircularProgressIndicator()). Attach ScrollController with listener that calls loadNextPage() when `scrollController.position.pixels >= scrollController.position.maxScrollExtent - 200`.
  - AsyncError: Center(Text('Failed to load history'))
  - Loading: Center(CircularProgressIndicator())
- Import PurchaseListItem from history feature.
- Use `useScrollController()` hook for scroll pagination.
- Access `ref.read(purchaseHistoryProvider.notifier)` for loadNextPage() and hasMore.

**Parameters tab (_ParametersTab) — read-only config display:**
- Private HookConsumerWidget.
- Watch `configDataProvider`.
- Build: AsyncValue switch:
  - AsyncData: SingleChildScrollView with Column:
    1. GlassCard (stationary), margin horizontal: 16 vertical: 8, padding all: 16. Column header Text('Schedule', titleSmall). Then:
       - _ParamRow('Daily buy time', '${_padTwo(config.dailyBuyHour)}:${_padTwo(config.dailyBuyMinute)}')
       - _ParamRow('Base amount (USDT)', config.baseDailyAmount.toStringAsFixed(2))
       - _ParamRow('Dry run', config.dryRun ? 'Yes' : 'No')
    2. GlassCard (stationary), same margin/padding. Column header Text('Strategy', titleSmall). Then:
       - _ParamRow('High lookback days', config.highLookbackDays.toString())
       - _ParamRow('Bear market MA period', config.bearMarketMaPeriod.toString())
       - _ParamRow('Bear boost factor', '${config.bearBoostFactor}x')
       - _ParamRow('Max multiplier cap', '${config.maxMultiplierCap}x')
    3. GlassCard (stationary), same margin/padding. Column header Text('Multiplier Tiers', titleSmall). Then:
       - If tiers empty: Text('No tiers configured', Colors.white54)
       - Else: Column of _ParamRow per tier: label = 'Drop ${(tier.dropPercentage * 100).toStringAsFixed(1)}%', value = '${tier.multiplier}x'
    4. SizedBox(height: 80)
  - Loading/Error: Center(CircularProgressIndicator()) / Center(Text('Failed to load config'))
- Private `_ParamRow` widget: Padding(vertical: 6) wrapping Row(spaceBetween): Text(label, fontSize: 13, Colors.white54) + Text(value, fontSize: 13, Colors.white) merged with AppTheme.moneyStyle.
- `_padTwo(int n)`: n.toString().padLeft(2, '0').

**Loading skeleton for Overview tab:**
Add a `_buildLoadingSkeleton()` method returning AppShimmer wrapping Column:
- GlassCard-shaped Bone for identity header area (height ~60, margin 16)
- GlassCard(stationary) with Bone rows mimicking stats grid (3 rows of Bone.text)
- Row of two Bone containers mimicking action buttons
- GlassCard(stationary) with Bone for chart area (height ~200)
- GlassCard(stationary) with two Bone.text rows for bot info
- Column of 3 Bone containers mimicking event history rows

Use this skeleton when homeData or configData is in loading state (before the stale cache branch).

**Imports to add:**
- pnl_chart_card.dart
- bot_info_card.dart
- chart_providers.dart for chartDataProvider
- history_providers.dart for purchaseHistoryProvider
- purchase_list_item.dart for PurchaseListItem
- purchase_history_response.dart for PurchaseDto type
- shimmer_loading.dart for AppShimmer and Bone
- glass_card.dart for GlassCard (if not already imported)
  </action>
  <verify>
Run `dart analyze TradingBot.Mobile` — no errors. All imports resolve. No unused import warnings.
  </verify>
  <done>
All three tabs are fully implemented: Overview shows identity header + stats grid + action buttons + PnL chart + bot info + event history preview. History tab shows full paginated purchase list with PurchaseListItem and scroll-to-load-more. Parameters tab shows read-only config in 3 GlassCard sections (Schedule, Strategy, Tiers). Loading skeleton matches the Overview tab structure. No BackdropFilter in scrollable list items.
  </done>
</task>

</tasks>

<verification>
1. Run `dart analyze TradingBot.Mobile` — zero errors across all new/modified files
2. Visual check: Overview tab shows PnL area chart with red/green gradient fill based on PnL direction
3. Visual check: Chart shows percentage y-axis labels and date x-axis labels
4. Visual check: Bot info card shows Bot ID with copy icon; tapping copy shows SnackBar
5. Visual check: Event history section shows last 5 purchases at bottom of Overview tab
6. Visual check: History tab shows full purchase list with scroll pagination
7. Visual check: Parameters tab shows Schedule, Strategy, and Tiers sections in GlassCards
8. Visual check: Loading skeleton shows bone placeholders matching the Overview layout
9. Visual check: All GlassCards in Parameters/Bot info tabs use stationary variant (blur)
10. Visual check: No bottom navigation bar visible on the detail screen
</verification>

<success_criteria>
- PnlChartCard derives PnL% from price data + averageCostBasis, colored green/red by direction
- BotInfoCard shows derived Bot ID from firstPurchaseDate milliseconds + creation time
- Clipboard copy works with SnackBar feedback
- History tab reuses PurchaseListItem from history feature with scroll pagination
- Parameters tab shows 3 sections (Schedule, Strategy, Tiers) read-only in GlassCards
- Event history preview in Overview tab shows last 5 purchases
- Loading skeleton uses AppShimmer + Bone matching real layout structure
- No BackdropFilter in list items (PurchaseListItem uses Container, not GlassCard)
- All monetary values use AppTheme.moneyStyle tabular figures
- All alpha values use withAlpha(int), not withOpacity(float)
- Tier dropPercentage displayed as percentage (multiply by 100 if stored as decimal 0-1)
</success_criteria>

<output>
After completion, create `.planning/phases/35.2-dca-bot-detail-screen/35.2-02-SUMMARY.md`
</output>
