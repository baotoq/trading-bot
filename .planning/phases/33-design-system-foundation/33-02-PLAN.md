---
phase: 33-design-system-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 33-01
files_modified:
  - TradingBot.Mobile/lib/core/widgets/glass_card.dart
autonomous: false
requirements:
  - DESIGN-01
  - DESIGN-05
  - DESIGN-06

must_haves:
  truths:
    - "A GlassCard widget renders a frosted glass surface (ClipRRect + BackdropFilter + tinted Container) using tokens from GlassTheme — no hardcoded values"
    - "On a device with Reduce Transparency enabled (highContrast), glass cards render as fully opaque dark cards with no BackdropFilter applied"
    - "On a device with Reduce Motion enabled (disableAnimations || reduceMotion), a boolean flag is available for downstream widgets to skip all animations"
  artifacts:
    - path: "TradingBot.Mobile/lib/core/widgets/glass_card.dart"
      provides: "GlassCard widget with frosted glass surface and opaque accessibility fallback"
      contains: "class GlassCard"
      min_lines: 40
  key_links:
    - from: "TradingBot.Mobile/lib/core/widgets/glass_card.dart"
      to: "TradingBot.Mobile/lib/app/theme.dart"
      via: "Theme.of(context).extension<GlassTheme>()!"
      pattern: "extension<GlassTheme>"
    - from: "TradingBot.Mobile/lib/core/widgets/glass_card.dart"
      to: "MediaQuery accessibility"
      via: "MediaQuery.of(context).highContrast for Reduce Transparency"
      pattern: "highContrast"
---

<objective>
Create the GlassCard widget with frosted glass surface rendering and accessibility fallbacks for Reduce Transparency and Reduce Motion.

Purpose: GlassCard is the primary surface widget across all screens in the glassmorphism UI. It reads design tokens from GlassTheme (Plan 01) and automatically degrades to opaque surfaces when iOS Reduce Transparency is active. It also exposes accessibility helpers for Reduce Motion that downstream phases will consume.

Output: GlassCard widget ready for adoption by all screen redesign phases (34-38).
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-design-system-foundation/33-CONTEXT.md
@.planning/phases/33-design-system-foundation/33-RESEARCH.md
@.planning/phases/33-design-system-foundation/33-01-SUMMARY.md
@TradingBot.Mobile/lib/app/theme.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlassCard widget with accessibility-aware glass/opaque rendering</name>
  <files>TradingBot.Mobile/lib/core/widgets/glass_card.dart</files>
  <action>
Create `glass_card.dart` in `lib/core/widgets/`.

**GlassCard class** — `class GlassCard extends StatelessWidget`:

Constructor parameters:
- `required Widget child`
- `EdgeInsets padding` = `const EdgeInsets.all(16)` (default)
- `double? borderRadius` (optional override; defaults to `glass.cardRadius`)
- `EdgeInsets? margin` (optional outer margin)

Build method:
1. Read GlassTheme: `final glass = Theme.of(context).extension<GlassTheme>()!`
2. Read Reduce Transparency flag: `final reduceTransparency = MediaQuery.of(context).highContrast`
   - Per research: Flutter has no direct `reduceTransparency` API. `highContrast` is the closest cross-platform proxy for iOS Reduce Transparency. Document this in a comment.
3. Resolve radius: `final radius = borderRadius ?? glass.cardRadius`

**If reduceTransparency is true** (opaque fallback path):
Return a `Container` with optional `margin`, `BoxDecoration` using:
- `color: glass.opaqueSurface` (the navy+10 lightness opaque surface)
- `borderRadius: BorderRadius.circular(radius)`
- `border: Border.all(color: glass.opaqueBorder, width: glass.borderWidth)`
- Inner `padding` and `child`

**If reduceTransparency is false** (glass surface path):
Return a `Container` with optional `margin`, then inside:
- `ClipRRect(borderRadius: BorderRadius.circular(radius))` — CRITICAL: ClipRRect MUST wrap BackdropFilter to bound blur to card shape (research pitfall #1)
- `BackdropFilter(filter: ImageFilter.blur(sigmaX: glass.blurSigma, sigmaY: glass.blurSigma))`
- `Container` with `BoxDecoration`:
  - `color: glass.tintColor.withAlpha((glass.tintOpacity * 255).round())` — convert opacity fraction to alpha int
  - `borderRadius: BorderRadius.circular(radius)`
  - `border: Border.all(color: glass.borderColor, width: glass.borderWidth)`
- Inner `padding` and `child`

Import `dart:ui` for `ImageFilter`.

**Static helper for Reduce Motion** — add a static method on GlassCard (or as a separate top-level function in the same file):
```dart
/// Whether the platform requests reduced motion.
/// Use this to skip or disable animations throughout the app.
/// Checks both the cross-platform disableAnimations and iOS-specific reduceMotion.
static bool shouldReduceMotion(BuildContext context) {
  final mq = MediaQuery.of(context);
  return mq.disableAnimations || mq.accessibilityFeatures.reduceMotion;
}
```
This satisfies DESIGN-06 by providing a centralized check point. Future phases (34-38) will call `GlassCard.shouldReduceMotion(context)` before running any animations.

**Comments to add:**
- Above the `highContrast` line: `// Flutter lacks a direct 'reduceTransparency' API. highContrast is the closest proxy (maps to iOS "Increase Contrast", not "Reduce Transparency"). See 33-RESEARCH.md Open Question #1.`
- Above the `shouldReduceMotion` method: explain the dual-check pattern (disableAnimations is cross-platform, reduceMotion is iOS-only).

**Anti-patterns to avoid (from research):**
- Do NOT hardcode any blur sigma, opacity, or border values — all must come from GlassTheme tokens
- Do NOT forget ClipRRect before BackdropFilter — blur bleeds without it
- Do NOT use `setState` for accessibility flags — read directly from MediaQuery (rebuilds automatically)
  </action>
  <verify>
Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze` — no errors. Verify `glass_card.dart` exists with GlassCard class and shouldReduceMotion static method.
  </verify>
  <done>
GlassCard widget exists at `lib/core/widgets/glass_card.dart`. It renders frosted glass surface using GlassTheme tokens (no hardcoded values). When highContrast is true, it renders an opaque dark card with no BackdropFilter. A static `shouldReduceMotion(BuildContext)` method is available for all phases to check Reduce Motion preference.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of design system foundation on iOS Simulator</name>
  <files>TradingBot.Mobile/lib/app/theme.dart, TradingBot.Mobile/lib/core/widgets/ambient_background.dart, TradingBot.Mobile/lib/core/widgets/glass_card.dart, TradingBot.Mobile/lib/shared/navigation_shell.dart</files>
  <action>
Visual verification of the complete design system foundation on iOS Simulator. No code changes — human confirms the ambient background, dark navy color, and orb visibility.

Steps for the user:
1. Run the app: `cd /Users/baotoq/Work/trading-bot/TradingBot.AppHost && dotnet run`
2. Open the Flutter app on the iOS Simulator
3. Verify the ambient background:
   - Background should be dark navy (#0D1117), NOT the old flat dark (#121212)
   - Very subtle colored pools/orbs behind the content (barely visible at 10-15% opacity)
   - One warm amber orb (top-left area), one cool blue-violet (bottom-right), one teal (mid-left)
4. Switch between tabs — the ambient background should remain stable (not flicker or reset)
5. To test Reduce Transparency: iOS Simulator > Settings > Accessibility > Display & Text Size > Increase Contrast (ON). Verify no crash.
6. To test Reduce Motion: iOS Simulator > Settings > Accessibility > Motion > Reduce Motion (ON). Verify no crash.
  </action>
  <verify>User confirms visual appearance matches expectations or describes issues to fix.</verify>
  <done>User types "approved" confirming the ambient background, dark navy color, orb visibility, and accessibility settings produce no crashes.</done>
</task>

</tasks>

<verification>
1. `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze` passes with no errors
2. `glass_card.dart` contains `class GlassCard extends StatelessWidget`
3. `glass_card.dart` reads GlassTheme via `Theme.of(context).extension<GlassTheme>()!`
4. `glass_card.dart` checks `MediaQuery.of(context).highContrast` for Reduce Transparency
5. `glass_card.dart` has opaque fallback path (no BackdropFilter when highContrast is true)
6. `glass_card.dart` has `shouldReduceMotion` static method checking both `disableAnimations` and `reduceMotion`
7. `glass_card.dart` uses `ClipRRect` before `BackdropFilter` (never BackdropFilter without ClipRRect)
8. No hardcoded blur/opacity/border values in GlassCard — all from GlassTheme
</verification>

<success_criteria>
- GlassCard renders frosted glass surface using only GlassTheme token values
- GlassCard degrades to opaque surface when MediaQuery.highContrast is true (DESIGN-05)
- GlassCard.shouldReduceMotion() provides centralized Reduce Motion check (DESIGN-06)
- ClipRRect always wraps BackdropFilter to prevent blur bleed
- Human verification confirms visual appearance on iOS Simulator
</success_criteria>

<output>
After completion, create `.planning/phases/33-design-system-foundation/33-02-SUMMARY.md`
</output>
