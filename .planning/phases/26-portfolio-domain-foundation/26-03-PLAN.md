---
phase: 26-portfolio-domain-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 26-01
files_modified:
  - TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
  - tests/TradingBot.ApiService.Tests/Application/Specifications/Portfolio/PortfolioEntityTests.cs
autonomous: true
requirements:
  - PORT-01
  - PORT-02
  - PORT-03

must_haves:
  truths:
    - "PortfolioAsset entity persists to PostgreSQL and round-trips with all fields intact (Name, Ticker, AssetType stored as string, NativeCurrency stored as string)"
    - "AssetTransaction entity persists with FK to PortfolioAsset, Quantity at precision 18,8, PricePerUnit at 18,8, Fee at 18,2, enums stored as strings"
    - "FixedDeposit entity persists with Principal at precision 18,0 (no decimals for VND), AnnualInterestRate at 8,6, enums stored as strings"
    - "Vogen typed IDs (PortfolioAssetId, AssetTransactionId, FixedDepositId) and VndAmount are registered in ConfigureConventions with EfCoreValueConverter + EfCoreValueComparer"
    - "PortfolioAsset cascade deletes its AssetTransactions"
    - "EF migration named AddPortfolioEntities creates the three new tables"
  artifacts:
    - path: "TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs"
      provides: "DbSet declarations, ConfigureConventions registrations, OnModelCreating entity configurations"
      contains: "DbSet<PortfolioAsset>"
    - path: "tests/TradingBot.ApiService.Tests/Application/Specifications/Portfolio/PortfolioEntityTests.cs"
      provides: "Integration tests verifying round-trip persistence for all 3 entity types"
      contains: "class PortfolioEntityTests"
  key_links:
    - from: "TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs"
      to: "TradingBot.ApiService/Models/PortfolioAsset.cs"
      via: "DbSet<PortfolioAsset> + entity configuration in OnModelCreating"
      pattern: "DbSet<PortfolioAsset>"
    - from: "TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs"
      to: "TradingBot.ApiService/Models/FixedDeposit.cs"
      via: "DbSet<FixedDeposit> + entity configuration in OnModelCreating"
      pattern: "DbSet<FixedDeposit>"
    - from: "tests/TradingBot.ApiService.Tests/Application/Specifications/Portfolio/PortfolioEntityTests.cs"
      to: "TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs"
      via: "PostgresFixture creates TradingBotDbContext with migrations applied"
      pattern: "PostgresFixture"
---

<objective>
Configure EF Core persistence for all portfolio entities, generate the migration, and verify everything round-trips correctly through PostgreSQL integration tests.

Purpose: Proves the domain model actually works end-to-end with real PostgreSQL — Vogen converters registered, precision correct, FK relationships working, enums stored as strings.
Output: Updated TradingBotDbContext.cs, one EF migration, and integration test file.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-portfolio-domain-foundation/26-RESEARCH.md
@.planning/phases/26-portfolio-domain-foundation/26-01-SUMMARY.md

# Existing patterns:
@TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
@tests/TradingBot.ApiService.Tests/Application/Specifications/Purchases/PurchaseSpecsTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure EF Core for portfolio entities and generate migration</name>
  <files>
    TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
  </files>
  <action>
    Add to `TradingBotDbContext` following the exact patterns already in the file:

    **DbSet declarations** (after existing DbSets):
    ```csharp
    public DbSet<PortfolioAsset> PortfolioAssets => Set<PortfolioAsset>();
    public DbSet<AssetTransaction> AssetTransactions => Set<AssetTransaction>();
    public DbSet<FixedDeposit> FixedDeposits => Set<FixedDeposit>();
    ```

    **ConfigureConventions** — add after the existing `Properties<Symbol>()` block:
    ```csharp
    // Phase 26 (portfolio typed IDs + value objects)
    configurationBuilder.Properties<PortfolioAssetId>()
        .HaveConversion<PortfolioAssetId.EfCoreValueConverter, PortfolioAssetId.EfCoreValueComparer>();
    configurationBuilder.Properties<AssetTransactionId>()
        .HaveConversion<AssetTransactionId.EfCoreValueConverter, AssetTransactionId.EfCoreValueComparer>();
    configurationBuilder.Properties<FixedDepositId>()
        .HaveConversion<FixedDepositId.EfCoreValueConverter, FixedDepositId.EfCoreValueComparer>();
    configurationBuilder.Properties<VndAmount>()
        .HaveConversion<VndAmount.EfCoreValueConverter, VndAmount.EfCoreValueComparer>();
    ```

    **OnModelCreating** — add entity configurations after the DeadLetterMessage block:

    PortfolioAsset:
    - `HasKey(e => e.Id)`
    - `Property(e => e.Name).HasMaxLength(100).IsRequired()`
    - `Property(e => e.Ticker).HasMaxLength(20).IsRequired()`
    - `Property(e => e.AssetType).HasMaxLength(20).HasConversion<string>()`
    - `Property(e => e.NativeCurrency).HasMaxLength(5).HasConversion<string>()`
    - `HasMany(e => e.Transactions).WithOne().HasForeignKey(t => t.PortfolioAssetId).OnDelete(DeleteBehavior.Cascade)`
    - **IMPORTANT:** Use `.HasMany(e => e.Transactions)` not `.HasMany<AssetTransaction>()` — must match the navigation property for EF to discover the backing field `_transactions`

    AssetTransaction:
    - `HasKey(e => e.Id)`
    - `Property(e => e.Quantity).HasPrecision(18, 8)` — crypto needs 8 decimal places
    - `Property(e => e.PricePerUnit).HasPrecision(18, 8)`
    - `Property(e => e.Fee).HasPrecision(18, 2)` — fees: 2 decimals sufficient
    - `Property(e => e.Currency).HasMaxLength(5).HasConversion<string>()`
    - `Property(e => e.Type).HasMaxLength(10).HasConversion<string>()`
    - `Property(e => e.Source).HasMaxLength(10).HasConversion<string>()`
    - `HasIndex(e => e.PortfolioAssetId)`
    - `HasIndex(e => e.Date)`

    FixedDeposit:
    - `HasKey(e => e.Id)`
    - `Property(e => e.BankName).HasMaxLength(100).IsRequired()`
    - `Property(e => e.Principal).HasPrecision(18, 0)` — VND: no decimals (ISO 4217 exponent 0)
    - `Property(e => e.AnnualInterestRate).HasPrecision(8, 6)` — stores 0.065000
    - `Property(e => e.CompoundingFrequency).HasMaxLength(20).HasConversion<string>()`
    - `Property(e => e.Status).HasMaxLength(10).HasConversion<string>()`
    - `HasIndex(e => e.Status)`

    Add required `using` statements at top: `using TradingBot.ApiService.Models.Values;` (if not already present — VndAmount converter needs it). The existing using for `Models.Ids` and `Models` should already cover the new types.

    **Generate migration** from TradingBot.ApiService directory:
    ```bash
    cd TradingBot.ApiService && dotnet ef migrations add AddPortfolioEntities
    ```

    Verify the generated migration creates 3 new tables (PortfolioAssets, AssetTransactions, FixedDeposits) with correct column types and no shadow FK columns (no `PortfolioAssetId1`).
  </action>
  <verify>
    1. `dotnet build TradingBot.slnx` succeeds
    2. Migration file exists in `Infrastructure/Data/Migrations/` with `AddPortfolioEntities` in the name
    3. Review generated migration: confirm 3 `CreateTable` calls, correct column types (uuid for IDs, text for enums, numeric(18,0) for Principal, numeric(18,8) for Quantity/PricePerUnit), FK from AssetTransactions to PortfolioAssets with cascade delete
    4. No shadow FK columns (no `PortfolioAssetId1`)
  </verify>
  <done>
    DbContext has 3 new DbSets, 4 new converter registrations in ConfigureConventions, 3 entity configurations in OnModelCreating, and one clean migration exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for portfolio entity round-trips</name>
  <files>
    tests/TradingBot.ApiService.Tests/Application/Specifications/Portfolio/PortfolioEntityTests.cs
  </files>
  <action>
    Create `PortfolioEntityTests.cs` following PurchaseSpecsTests.cs pattern exactly:
    - `public class PortfolioEntityTests : IClassFixture<PostgresFixture>`
    - Constructor takes `PostgresFixture fixture`
    - Each test: `_fixture.CreateDbContext()` + `BeginTransactionAsync()` + test + `RollbackAsync()`
    - Use `ClearDomainEvents()` after any aggregate factory call (prevents domain event interceptor issues)

    **Test 1: PortfolioAsset_PersistsAndRoundTrips**
    - Create `PortfolioAsset.Create("Bitcoin", "BTC", AssetType.Crypto, Currency.USD)`
    - ClearDomainEvents, Add to DbSet, SaveChangesAsync
    - Find by Id, assert Name == "Bitcoin", Ticker == "BTC", AssetType == Crypto, NativeCurrency == USD
    - Rollback

    **Test 2: PortfolioAsset_WithTransaction_PersistsAndLoads**
    - Create PortfolioAsset, AddTransaction with Buy, 0.001 BTC at 50000 USD, fee 0.50, Manual source
    - ClearDomainEvents, Add, SaveChangesAsync
    - Reload using `.Include(a => a.Transactions)` to load navigation
    - Assert Transactions.Count == 1, check transaction fields (Date, Quantity, PricePerUnit, Currency, Type, Fee, Source)
    - Rollback

    **Test 3: PortfolioAsset_ETF_WithIntegerQuantity_Persists**
    - Create PortfolioAsset for ETF: `PortfolioAsset.Create("VN30 ETF", "E1VFVN30", AssetType.ETF, Currency.VND)`
    - AddTransaction with Buy, quantity 100 (whole number), price 15000 VND, no fee, Manual source
    - Verify quantity round-trips as 100 (no decimal artifacts)
    - Rollback

    **Test 4: FixedDeposit_PersistsAndRoundTrips**
    - Create `FixedDeposit.Create("BIDV", VndAmount.From(10_000_000m), 0.065m, new DateOnly(2024, 1, 1), new DateOnly(2024, 7, 1), CompoundingFrequency.Simple)`
    - ClearDomainEvents, Add, SaveChangesAsync
    - Find by Id, assert BankName, Principal.Value == 10000000, AnnualInterestRate, StartDate, MaturityDate, CompoundingFrequency == Simple, Status == Active
    - Rollback

    **Test 5: FixedDeposit_StatusLifecycle_ActiveToMatured**
    - Create FixedDeposit, save, call Mature(), update, save again
    - Reload, assert Status == Matured, UpdatedAt is not null
    - Rollback

    **Test 6: AssetTransaction_CascadeDelete_WithPortfolioAsset**
    - Create PortfolioAsset with 2 transactions
    - Save, then remove the PortfolioAsset, save again
    - Query AssetTransactions table directly — should be empty (cascade delete)
    - Rollback

    Use namespace `TradingBot.ApiService.Tests.Application.Specifications.Portfolio` and add required usings for the new entity types, FluentAssertions, Microsoft.EntityFrameworkCore.
  </action>
  <verify>
    `dotnet test --filter PortfolioEntityTests` — all 6 tests pass against real PostgreSQL via Testcontainers.
  </verify>
  <done>
    6 integration tests pass, proving: all 3 entity types persist and round-trip, Vogen typed IDs work through EF, VndAmount stores with no decimals, AssetTransaction FK relationship works, cascade delete works, FixedDeposit status lifecycle works.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.slnx` succeeds
2. `dotnet test` — all existing tests still pass (no regression) + 6 new portfolio tests pass
3. Migration file is clean (3 tables, no shadow properties)
4. DbContext ConfigureConventions has all 4 new Vogen registrations
5. DbContext OnModelCreating has correct precision for all decimal fields
</verification>

<success_criteria>
All portfolio entities persist to and round-trip from PostgreSQL correctly. Vogen typed IDs, VndAmount precision, enum-as-string storage, FK relationships, and cascade delete all verified through integration tests running against real Testcontainers PostgreSQL.
</success_criteria>

<output>
After completion, create `.planning/phases/26-portfolio-domain-foundation/26-03-SUMMARY.md`
</output>
