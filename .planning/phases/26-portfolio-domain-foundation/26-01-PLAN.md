---
phase: 26-portfolio-domain-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/Models/Ids/PortfolioAssetId.cs
  - TradingBot.ApiService/Models/Ids/AssetTransactionId.cs
  - TradingBot.ApiService/Models/Ids/FixedDepositId.cs
  - TradingBot.ApiService/Models/Values/VndAmount.cs
  - TradingBot.ApiService/Models/PortfolioAsset.cs
  - TradingBot.ApiService/Models/AssetTransaction.cs
  - TradingBot.ApiService/Models/FixedDeposit.cs
autonomous: true
requirements:
  - PORT-01
  - PORT-02
  - PORT-03

must_haves:
  truths:
    - "PortfolioAsset entity has Name, Ticker, AssetType (Crypto/ETF), NativeCurrency (USD/VND), and a Transactions collection"
    - "AssetTransaction entity has Date, Quantity, PricePerUnit, Currency, Type (Buy/Sell), Fee (nullable), and Source (Manual/Bot)"
    - "FixedDeposit entity has BankName, Principal (VndAmount), AnnualInterestRate, StartDate, MaturityDate, CompoundingFrequency, and Status (Active/Matured)"
    - "All three typed IDs use Vogen [ValueObject<Guid>] with New() factory method returning UUIDv7"
    - "VndAmount uses Vogen [ValueObject<decimal>] with non-negative validation"
  artifacts:
    - path: "TradingBot.ApiService/Models/Ids/PortfolioAssetId.cs"
      provides: "Typed ID for PortfolioAsset"
      contains: "[ValueObject<Guid>]"
    - path: "TradingBot.ApiService/Models/Ids/AssetTransactionId.cs"
      provides: "Typed ID for AssetTransaction"
      contains: "[ValueObject<Guid>]"
    - path: "TradingBot.ApiService/Models/Ids/FixedDepositId.cs"
      provides: "Typed ID for FixedDeposit"
      contains: "[ValueObject<Guid>]"
    - path: "TradingBot.ApiService/Models/Values/VndAmount.cs"
      provides: "VND currency value object with no-decimal validation"
      contains: "[ValueObject<decimal>]"
    - path: "TradingBot.ApiService/Models/PortfolioAsset.cs"
      provides: "Aggregate root for tradeable assets"
      contains: "class PortfolioAsset : AggregateRoot<PortfolioAssetId>"
    - path: "TradingBot.ApiService/Models/AssetTransaction.cs"
      provides: "Child entity for buy/sell transactions"
      contains: "class AssetTransaction : BaseEntity<AssetTransactionId>"
    - path: "TradingBot.ApiService/Models/FixedDeposit.cs"
      provides: "Aggregate root for fixed deposits"
      contains: "class FixedDeposit : AggregateRoot<FixedDepositId>"
  key_links:
    - from: "TradingBot.ApiService/Models/PortfolioAsset.cs"
      to: "TradingBot.ApiService/Models/AssetTransaction.cs"
      via: "AddTransaction() factory method enforcing aggregate boundary"
      pattern: "AddTransaction.*AssetTransaction"
    - from: "TradingBot.ApiService/Models/AssetTransaction.cs"
      to: "TradingBot.ApiService/Models/PortfolioAsset.cs"
      via: "PortfolioAssetId FK property"
      pattern: "PortfolioAssetId"
---

<objective>
Create all domain model files for the portfolio tracking feature: typed IDs, VndAmount value object, enums, and three entity classes (PortfolioAsset, AssetTransaction, FixedDeposit).

Purpose: Establish the complete domain layer that EF Core configuration, migration, and all subsequent phases will build on.
Output: 7 new files in Models/ directory — 3 typed IDs, 1 value object, 3 entity classes with enums.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-portfolio-domain-foundation/26-CONTEXT.md
@.planning/phases/26-portfolio-domain-foundation/26-RESEARCH.md

# Existing patterns to follow exactly:
@TradingBot.ApiService/Models/Ids/PurchaseId.cs
@TradingBot.ApiService/Models/Values/UsdAmount.cs
@TradingBot.ApiService/Models/Purchase.cs
@TradingBot.ApiService/BuildingBlocks/AggregateRoot.cs
@TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
@TradingBot.ApiService/BuildingBlocks/AuditedEntity.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create typed IDs and VndAmount value object</name>
  <files>
    TradingBot.ApiService/Models/Ids/PortfolioAssetId.cs
    TradingBot.ApiService/Models/Ids/AssetTransactionId.cs
    TradingBot.ApiService/Models/Ids/FixedDepositId.cs
    TradingBot.ApiService/Models/Values/VndAmount.cs
  </files>
  <action>
    Create 3 typed ID files following PurchaseId.cs pattern exactly:
    - `PortfolioAssetId.cs`: `[ValueObject<Guid>] public readonly partial struct PortfolioAssetId` with `New()` returning `From(Guid.CreateVersion7())`
    - `AssetTransactionId.cs`: Same pattern
    - `FixedDepositId.cs`: Same pattern
    All in namespace `TradingBot.ApiService.Models.Ids`.

    Create VndAmount value object following UsdAmount.cs pattern:
    - `[ValueObject<decimal>] public readonly partial struct VndAmount` in namespace `TradingBot.ApiService.Models.Values`
    - Validation: `value >= 0` (non-negative, unlike UsdAmount which is strictly positive — VND zero is valid for zero-fee scenarios)
    - Comparison operators: `<`, `>`, `<=`, `>=`
    - Arithmetic: `VndAmount + VndAmount = VndAmount`
    - No cross-type operators needed (VndAmount doesn't interact with Price/Multiplier)

    VogenGlobalConfig already sets `Conversions.EfCoreValueConverter | Conversions.SystemTextJson | Conversions.TypeConverter` globally — no per-type conversion config needed.
  </action>
  <verify>
    `dotnet build TradingBot.slnx` compiles with no errors. Verify Vogen source generator produces the EfCoreValueConverter and EfCoreValueComparer inner classes by checking the build output has no warnings related to Vogen.
  </verify>
  <done>
    4 new files exist, build succeeds, Vogen generates converters for all 4 types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PortfolioAsset, AssetTransaction, and FixedDeposit entities with enums</name>
  <files>
    TradingBot.ApiService/Models/PortfolioAsset.cs
    TradingBot.ApiService/Models/AssetTransaction.cs
    TradingBot.ApiService/Models/FixedDeposit.cs
  </files>
  <action>
    **PortfolioAsset.cs** — Aggregate root for tradeable assets (Crypto + ETF):
    - `class PortfolioAsset : AggregateRoot<PortfolioAssetId>` in namespace `TradingBot.ApiService.Models`
    - Protected parameterless constructor for EF Core materialization
    - Properties (all `private set`): `Name` (string), `Ticker` (string), `AssetType` (enum), `NativeCurrency` (Currency enum)
    - Collection navigation: `private readonly List<AssetTransaction> _transactions = [];` with `public IReadOnlyList<AssetTransaction> Transactions => _transactions.AsReadOnly();`
    - Static factory: `public static PortfolioAsset Create(string name, string ticker, AssetType assetType, Currency nativeCurrency)` — validates name not empty, ticker not empty, sets Id = PortfolioAssetId.New()
    - Method: `public AssetTransaction AddTransaction(DateOnly date, decimal quantity, decimal pricePerUnit, Currency currency, TransactionType type, decimal? fee, TransactionSource source)` — creates transaction via `AssetTransaction.Create()`, adds to `_transactions`, returns the transaction
    - Define enums at bottom of file: `public enum AssetType { Crypto, ETF }` and `public enum Currency { USD, VND }`

    **AssetTransaction.cs** — Child entity (NOT aggregate root):
    - `class AssetTransaction : BaseEntity<AssetTransactionId>` in namespace `TradingBot.ApiService.Models`
    - Protected parameterless constructor for EF Core
    - Properties (all `private set`): `PortfolioAssetId` (PortfolioAssetId), `Date` (DateOnly), `Quantity` (decimal), `PricePerUnit` (decimal), `Currency` (Currency), `Type` (TransactionType), `Fee` (decimal?, nullable), `Source` (TransactionSource)
    - `internal static` factory: `Create(PortfolioAssetId assetId, DateOnly date, decimal quantity, decimal pricePerUnit, Currency currency, TransactionType type, decimal? fee, TransactionSource source)` — sets Id = AssetTransactionId.New(), validates quantity > 0, pricePerUnit > 0
    - Define enums at bottom: `public enum TransactionType { Buy, Sell }` and `public enum TransactionSource { Manual, Bot }`

    **FixedDeposit.cs** — Separate aggregate root:
    - `class FixedDeposit : AggregateRoot<FixedDepositId>` in namespace `TradingBot.ApiService.Models`
    - Protected parameterless constructor for EF Core
    - Properties (all `private set`): `BankName` (string), `Principal` (VndAmount), `AnnualInterestRate` (decimal), `StartDate` (DateOnly), `MaturityDate` (DateOnly), `CompoundingFrequency` (CompoundingFrequency enum), `Status` (FixedDepositStatus enum)
    - Static factory: `public static FixedDeposit Create(string bankName, VndAmount principal, decimal annualInterestRate, DateOnly startDate, DateOnly maturityDate, CompoundingFrequency compoundingFrequency)` — validates maturityDate > startDate, rate in (0, 1], bankName not empty, sets Id = FixedDepositId.New(), Status = Active
    - Method: `public void Mature()` — sets Status = Matured, UpdatedAt = DateTimeOffset.UtcNow
    - Define enums at bottom: `public enum CompoundingFrequency { Simple, Monthly, Quarterly, SemiAnnual, Annual }` and `public enum FixedDepositStatus { Active, Matured }`

    **Important conventions from codebase:**
    - Use `using TradingBot.ApiService.BuildingBlocks;` for AggregateRoot, BaseEntity
    - Use `using TradingBot.ApiService.Models.Ids;` for typed IDs
    - Use `using TradingBot.ApiService.Models.Values;` for VndAmount
    - Follow Purchase.cs style: private constructor with params for Create factory, protected parameterless for EF
    - No domain events in Phase 26 — domain events added later when needed
  </action>
  <verify>
    `dotnet build TradingBot.slnx` compiles with no errors. Verify:
    1. `PortfolioAsset.Create("Bitcoin", "BTC", AssetType.Crypto, Currency.USD)` compiles
    2. `AssetTransaction.Create` is `internal` (not publicly accessible outside assembly)
    3. `FixedDeposit.Create(...)` compiles with all required parameters
  </verify>
  <done>
    3 entity files exist with correct inheritance (AggregateRoot/BaseEntity), factory methods, proper encapsulation (private setters), and all 6 enums defined. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.slnx` succeeds with no errors
2. All 7 new files exist in Models/ directory
3. PortfolioAsset inherits AggregateRoot<PortfolioAssetId>
4. AssetTransaction inherits BaseEntity<AssetTransactionId> (NOT AggregateRoot)
5. FixedDeposit inherits AggregateRoot<FixedDepositId>
6. AssetTransaction.Create is internal (enforces aggregate boundary)
7. All enums defined: AssetType, Currency, TransactionType, TransactionSource, CompoundingFrequency, FixedDepositStatus
</verification>

<success_criteria>
All domain model files compile, follow established codebase patterns (Vogen IDs, AggregateRoot base class, factory methods, private setters), and enforce proper DDD boundaries (AssetTransaction only creatable through PortfolioAsset).
</success_criteria>

<output>
After completion, create `.planning/phases/26-portfolio-domain-foundation/26-01-SUMMARY.md`
</output>
