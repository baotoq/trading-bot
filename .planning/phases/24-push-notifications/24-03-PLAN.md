---
phase: 24-push-notifications
plan: 03
type: execute
wave: 2
depends_on:
  - 24-01
files_modified:
  - TradingBot.Mobile/pubspec.yaml
  - TradingBot.Mobile/lib/main.dart
  - TradingBot.Mobile/lib/core/services/fcm_service.dart
  - TradingBot.Mobile/lib/core/services/fcm_service.g.dart
  - TradingBot.Mobile/lib/app/router.dart
  - TradingBot.Mobile/ios/Runner/AppDelegate.swift
  - TradingBot.Mobile/ios/Podfile
autonomous: false
requirements:
  - PUSH-04
must_haves:
  truths:
    - "App requests notification permission on first launch and shows iOS permission dialog"
    - "App registers its FCM token with the backend POST /api/devices/register on startup"
    - "App refreshes FCM token on token change and re-registers with backend"
    - "When a push notification arrives while app is in foreground, it displays as a banner notification"
    - "When user taps a push notification, the app navigates to the route specified in the data payload"
    - "When app is launched from a terminated state by tapping a notification, it navigates to the correct screen"
  artifacts:
    - path: "TradingBot.Mobile/lib/core/services/fcm_service.dart"
      provides: "FcmService class handling token registration, foreground display, and deep-link navigation"
      contains: "class FcmService"
    - path: "TradingBot.Mobile/lib/main.dart"
      provides: "Firebase.initializeApp and FcmService initialization in main()"
      contains: "Firebase.initializeApp"
    - path: "TradingBot.Mobile/lib/app/router.dart"
      provides: "GoRouter with navigatorKey accessible for notification tap navigation"
      contains: "_rootNavigatorKey"
  key_links:
    - from: "TradingBot.Mobile/lib/core/services/fcm_service.dart"
      to: "POST /api/devices/register"
      via: "Dio HTTP call to register FCM token"
      pattern: "devices/register"
    - from: "TradingBot.Mobile/lib/core/services/fcm_service.dart"
      to: "TradingBot.Mobile/lib/app/router.dart"
      via: "appRouter.go(route) for deep-link navigation on tap"
      pattern: "appRouter\\.go"
user_setup:
  - service: Firebase iOS
    why: "Firebase Messaging requires GoogleService-Info.plist and Xcode push notification capability"
    dashboard_config:
      - task: "Register iOS app bundle ID in Firebase Console and download GoogleService-Info.plist"
        location: "Firebase Console -> Project Settings -> General -> Your apps -> Add app -> iOS"
      - task: "Place GoogleService-Info.plist in TradingBot.Mobile/ios/Runner/"
        location: "Local filesystem"
      - task: "Enable Push Notifications capability in Xcode"
        location: "Xcode -> Runner target -> Signing & Capabilities -> + Push Notifications"
      - task: "Enable Background Modes -> Remote notifications in Xcode"
        location: "Xcode -> Runner target -> Signing & Capabilities -> Background Modes"
---

<objective>
Flutter FCM integration: firebase_messaging and firebase_core packages, FcmService for token registration, foreground notification display, and deep-link tap handler using go_router.

Purpose: Enables the iOS app to receive push notifications, display them in foreground, and navigate to the relevant screen when tapped.
Output: FcmService class, updated main.dart with Firebase init, updated router for deep-link navigation.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-push-notifications/24-01-SUMMARY.md

@TradingBot.Mobile/lib/main.dart
@TradingBot.Mobile/lib/app/router.dart
@TradingBot.Mobile/pubspec.yaml
@TradingBot.Mobile/lib/core/api/api_client.dart
@TradingBot.Mobile/lib/core/api/config.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firebase dependencies and create FcmService with token registration and deep-link handling</name>
  <files>
    TradingBot.Mobile/pubspec.yaml
    TradingBot.Mobile/lib/core/services/fcm_service.dart
    TradingBot.Mobile/lib/main.dart
    TradingBot.Mobile/lib/app/router.dart
    TradingBot.Mobile/ios/Runner/AppDelegate.swift
  </files>
  <action>
    1. Add dependencies to `pubspec.yaml`:
       ```yaml
       dependencies:
         firebase_core: ^3.12.1
         firebase_messaging: ^15.2.4
       ```
       Run `flutter pub get` in TradingBot.Mobile/.

    2. Update `ios/Runner/AppDelegate.swift` to import Firebase and call configure:
       ```swift
       import UIKit
       import Flutter
       import FirebaseCore
       import FirebaseMessaging

       @main
       @objc class AppDelegate: FlutterAppDelegate {
         override func application(
           _ application: UIApplication,
           didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
         ) -> Bool {
           FirebaseApp.configure()
           // Required for APNs token forwarding to FCM
           UNUserNotificationCenter.current().delegate = self
           application.registerForRemoteNotifications()
           GeneratedPluginRegistrant.register(with: self)
           return super.application(application, didFinishLaunchingWithOptions: launchOptions)
         }
       }
       ```
       Remove `SceneDelegate.swift` reference if present (Firebase push needs AppDelegate lifecycle). Actually, check if SceneDelegate exists. If it does, keep it but ensure the AppDelegate has Firebase init. Flutter's default AppDelegate pattern should work.

    3. Update `ios/Podfile`: ensure the iOS deployment target is at least 13.0 (Firebase requirement). Check the existing `platform :ios` line and update if needed.

    4. Export the `_rootNavigatorKey` from `router.dart` so FcmService can use it:
       - Rename `_rootNavigatorKey` to `rootNavigatorKey` (remove underscore to make it library-public).
       - Update the `GoRouter` constructor reference: `navigatorKey: rootNavigatorKey`.

    5. Create `lib/core/services/fcm_service.dart`:
       ```dart
       import 'package:dio/dio.dart';
       import 'package:firebase_messaging/firebase_messaging.dart';
       import 'package:flutter/foundation.dart';

       import '../../app/router.dart';
       import '../api/api_client.dart';
       import '../api/config.dart';

       /// Top-level background message handler (must be top-level function).
       @pragma('vm:entry-point')
       Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
         debugPrint('FCM background message: ${message.messageId}');
       }

       class FcmService {
         final Dio _dio;

         FcmService(this._dio);

         Future<void> initialize() async {
           // Register background handler
           FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);

           // Request permission (iOS shows native dialog)
           final settings = await FirebaseMessaging.instance.requestPermission(
             alert: true,
             badge: true,
             sound: true,
           );

           if (settings.authorizationStatus != AuthorizationStatus.authorized &&
               settings.authorizationStatus != AuthorizationStatus.provisional) {
             debugPrint('FCM: User denied notification permission');
             return;
           }

           // Get and register FCM token
           final token = await FirebaseMessaging.instance.getToken();
           if (token != null) {
             await _registerToken(token);
           }

           // Listen for token refresh
           FirebaseMessaging.instance.onTokenRefresh.listen(_registerToken);

           // Handle foreground messages â€” show as notification banner
           FirebaseMessaging.onMessage.listen(_handleForegroundMessage);

           // Handle notification tap when app was in background
           FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);

           // Handle notification tap that launched app from terminated state
           final initialMessage = await FirebaseMessaging.instance.getInitialMessage();
           if (initialMessage != null) {
             _handleNotificationTap(initialMessage);
           }
         }

         Future<void> _registerToken(String token) async {
           try {
             await _dio.post(
               '/api/devices/register',
               data: {'token': token, 'platform': 'ios'},
             );
             debugPrint('FCM token registered with backend');
           } catch (e) {
             debugPrint('Failed to register FCM token: $e');
           }
         }

         void _handleForegroundMessage(RemoteMessage message) {
           // On iOS, foreground messages do not show a system notification by default.
           // We use FirebaseMessaging.instance.setForegroundNotificationPresentationOptions
           // to show them as system banners (configured in initialize).
           debugPrint('FCM foreground message: ${message.notification?.title}');
         }

         void _handleNotificationTap(RemoteMessage message) {
           final route = message.data['route'];
           if (route != null && route is String && route.isNotEmpty) {
             // Use go_router to navigate to the deep-link route
             appRouter.go(route);
           }
         }
       }
       ```

    6. Add foreground presentation options inside `initialize()`, right after the permission check:
       ```dart
       // Show notifications as banners even when app is in foreground (iOS 14+)
       await FirebaseMessaging.instance.setForegroundNotificationPresentationOptions(
         alert: true,
         badge: true,
         sound: true,
       );
       ```

    7. Update `lib/main.dart` to initialize Firebase and FcmService:
       ```dart
       import 'package:firebase_core/firebase_core.dart';
       import 'package:flutter/material.dart';
       import 'package:hooks_riverpod/hooks_riverpod.dart';

       import 'app/router.dart';
       import 'app/theme.dart';
       import 'core/services/fcm_service.dart';

       void main() async {
         WidgetsFlutterBinding.ensureInitialized();
         await Firebase.initializeApp();

         runApp(const ProviderScope(child: TradingBotApp()));
       }

       class TradingBotApp extends ConsumerStatefulWidget {
         const TradingBotApp({super.key});

         @override
         ConsumerState<TradingBotApp> createState() => _TradingBotAppState();
       }

       class _TradingBotAppState extends ConsumerState<TradingBotApp> {
         @override
         void initState() {
           super.initState();
           // Initialize FCM after the first frame so Dio provider is available
           WidgetsBinding.instance.addPostFrameCallback((_) {
             final dio = ref.read(dioProvider);
             FcmService(dio).initialize();
           });
         }

         @override
         Widget build(BuildContext context) {
           return MaterialApp.router(
             title: 'Trading Bot',
             theme: AppTheme.dark,
             routerConfig: appRouter,
             debugShowCheckedModeBanner: false,
           );
         }
       }
       ```
       This changes TradingBotApp from StatelessWidget to ConsumerStatefulWidget so we can access ref to get the dioProvider. FCM init happens in initState with addPostFrameCallback to ensure the widget tree is built.

    8. Run `cd TradingBot.Mobile && flutter pub get` then `dart analyze lib/` -- fix any issues.
       Run `cd TradingBot.Mobile && flutter build ios --no-codesign --dart-define=API_BASE_URL=https://test.com --dart-define=API_KEY=test` to verify compilation.

    IMPORTANT: The build will fail if GoogleService-Info.plist is not present. This is expected -- the checkpoint task below will have the user add it. For now, verify `dart analyze` passes.
  </action>
  <verify>
    `dart analyze lib/` in TradingBot.Mobile reports no issues. Pubspec resolves. FcmService class exists with initialize(), _registerToken(), _handleForegroundMessage(), _handleNotificationTap() methods.
  </verify>
  <done>
    firebase_core and firebase_messaging added to pubspec. FcmService handles: permission request, token registration via POST /api/devices/register, token refresh listener, foreground banner display, background tap deep-link via appRouter.go(route), and terminated-state initial message handling. main.dart initializes Firebase and FcmService. AppDelegate.swift calls FirebaseApp.configure(). dart analyze passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify push notification end-to-end on physical iOS device</name>
  <files>TradingBot.Mobile/ios/Runner/GoogleService-Info.plist</files>
  <action>
    Human verification of complete push notification pipeline.

    **What was built:**
    - Backend: DeviceToken entity, POST/DELETE /api/devices endpoints, FcmNotificationService with multicast and stale cleanup
    - Backend: PurchaseCompletedHandler, PurchaseFailedHandler, MissedPurchaseVerificationService all send FCM push alongside Telegram
    - Flutter: firebase_messaging integration, FcmService with token registration, foreground display, deep-link navigation on tap

    **Prerequisites (manual steps before testing):**
    1. Ensure Firebase project is created and iOS app is registered
    2. GoogleService-Info.plist placed in `TradingBot.Mobile/ios/Runner/`
    3. APNs Authentication Key (.p8) uploaded to Firebase Console
    4. Push Notifications capability enabled in Xcode (Runner target -> Signing & Capabilities)
    5. Background Modes -> Remote notifications enabled in Xcode
    6. Firebase service account key JSON set in .NET user secrets:
       `dotnet user-secrets set "Firebase:ServiceAccountKeyJson" '{"type":"service_account",...}'` (paste the full JSON)

    **Test steps:**
    1. Run the .NET backend: `cd TradingBot.AppHost && dotnet run`
    2. Build and run the Flutter app on a **physical iOS device** (not simulator -- APNs does not work on simulator):
       `cd TradingBot.Mobile && flutter run --dart-define=API_BASE_URL=http://YOUR_MAC_IP:PORT --dart-define=API_KEY=YOUR_KEY`
    3. Grant notification permission when the iOS dialog appears
    4. Check the backend logs -- should see "FCM token registered" log entry
    5. Wait for the next scheduled DCA purchase (or trigger one manually) -- you should receive a push notification
    6. Tap the push notification -- the app should navigate to the /history tab
    7. Verify the notification shows: amount, price, and multiplier information
    8. If the app is in the foreground when a notification arrives, verify it appears as a banner

    **Alternative quick test (without waiting for purchase):**
    - Use Firebase Console -> Cloud Messaging -> Send test message to the device token stored in the database
    - Verify the notification appears and tapping it navigates correctly

    Type "approved" if push notifications work end-to-end, or describe any issues.
  </action>
  <verify>User confirms push notification received on physical device, tapping navigates to correct screen.</verify>
  <done>Push notifications work end-to-end: backend sends FCM on purchase events, iOS device receives and displays notification, tapping navigates to relevant screen.</done>
</task>

</tasks>

<verification>
1. `dart analyze lib/` passes with no issues in TradingBot.Mobile
2. Firebase packages resolve in pubspec
3. FcmService registers token with backend on launch
4. Foreground notifications display as banners
5. Tapping notification navigates to the correct screen via go_router
6. App handles notification tap from terminated state
</verification>

<success_criteria>
- Firebase Core and Messaging packages installed and configured
- FcmService initializes on app launch, requests permission, registers token
- Token refresh events re-register with backend
- Foreground messages display as system notification banners
- Notification taps navigate to the route from the data payload (/history, /home)
- Terminated-state notification taps navigate correctly on app launch
- AppDelegate.swift has FirebaseApp.configure() call
</success_criteria>

<output>
After completion, create `.planning/phases/24-push-notifications/24-03-SUMMARY.md`
</output>
