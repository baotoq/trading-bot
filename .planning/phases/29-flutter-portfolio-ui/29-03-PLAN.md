---
phase: 29-flutter-portfolio-ui
plan: 03
type: execute
wave: 3
depends_on: ["29-02"]
files_modified:
  - TradingBot.Mobile/lib/app/router.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/transaction_history_screen.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/fixed_deposit_detail_screen.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
autonomous: true
requirements:
  - DISP-04
  - DISP-05
  - DISP-06
  - DISP-07
  - DISP-08

must_haves:
  truths:
    - "User can add a buy/sell transaction via a full-screen form and see snackbar confirmation"
    - "User can add a fixed deposit via the same full-screen form (tab switch) and see snackbar confirmation"
    - "User can browse transaction history with filters by asset, type, and date range"
    - "Auto-imported DCA bot transactions show a 'Bot' badge and cannot be edited or deleted"
    - "User can see fixed deposit details including accrued value, days to maturity, and projected maturity amount"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart"
      provides: "Full-screen form with Buy/Sell and Fixed Deposit tabs"
      contains: "SegmentedButton"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/transaction_history_screen.dart"
      provides: "Transaction history list with filter bottom sheet"
      contains: "TransactionHistoryScreen"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/fixed_deposit_detail_screen.dart"
      provides: "Fixed deposit detail view"
      contains: "FixedDepositDetailScreen"
  key_links:
    - from: "TradingBot.Mobile/lib/app/router.dart"
      to: "add_transaction_screen.dart"
      via: "GoRoute with parentNavigatorKey: rootNavigatorKey"
      pattern: "parentNavigatorKey.*rootNavigatorKey"
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart"
      to: "portfolioRepository"
      via: "ref.read for form submission"
      pattern: "ref\\.read.*portfolioRepositoryProvider"
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/transaction_history_screen.dart"
      to: "portfolioRepository.fetchTransactions"
      via: "ref.read for loading transactions"
      pattern: "fetchTransactions"
---

<objective>
Build the three sub-screens: unified add transaction/fixed deposit form, transaction history with filters, and fixed deposit detail view. Wire all sub-routes in the GoRouter with `parentNavigatorKey: rootNavigatorKey` so they push full-screen over the bottom nav bar.

Purpose: These screens complete the portfolio write flow (adding transactions and deposits) and the detailed read flow (transaction history with filters, deposit details). Without them, the portfolio is view-only.

Output: Three full-screen sub-screens accessible from the portfolio tab, all wired to the backend via the repository.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-flutter-portfolio-ui/29-RESEARCH.md
@.planning/phases/29-flutter-portfolio-ui/29-CONTEXT.md
@.planning/phases/29-flutter-portfolio-ui/29-01-SUMMARY.md
@.planning/phases/29-flutter-portfolio-ui/29-02-SUMMARY.md
@TradingBot.Mobile/lib/app/router.dart
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/features/portfolio/data/portfolio_repository.dart
@TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart
@TradingBot.Mobile/lib/features/portfolio/data/currency_provider.dart
@TradingBot.Mobile/lib/features/config/presentation/config_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transaction/fixed deposit form + GoRouter sub-routes</name>
  <files>
    TradingBot.Mobile/lib/app/router.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/add_transaction_screen.dart
  </files>
  <action>
**Router (router.dart):**
Add three sub-routes under the portfolio GoRoute's `routes` list. All three MUST have `parentNavigatorKey: rootNavigatorKey` to push full-screen over the bottom nav bar (per user decision: "Full-screen form navigation for adding transactions, not bottom sheet"):

```dart
GoRoute(
  path: '/portfolio',
  builder: (context, state) => const PortfolioScreen(),
  routes: [
    GoRoute(
      path: 'add-transaction',
      parentNavigatorKey: rootNavigatorKey,
      builder: (_, __) => const AddTransactionScreen(),
    ),
    GoRoute(
      path: 'transaction-history',
      parentNavigatorKey: rootNavigatorKey,
      builder: (_, __) => const TransactionHistoryScreen(),
    ),
    GoRoute(
      path: 'fixed-deposit/:id',
      parentNavigatorKey: rootNavigatorKey,
      builder: (context, state) => FixedDepositDetailScreen(
        id: state.pathParameters['id']!,
      ),
    ),
  ],
),
```

Import all three sub-screen files.

**AddTransactionScreen (add_transaction_screen.dart):**
- `HookConsumerWidget` (uses `useTextEditingController` for form fields — follows config_edit_form.dart pattern)
- `Scaffold` with `AppBar` title "Add Entry"
- At top: `SegmentedButton<FormMode>` with two segments: "Buy / Sell" and "Fixed Deposit" (per user decision: "Unified form with tabs at top")
  - `enum FormMode { transaction, fixedDeposit }`
  - Use `useState<FormMode>(FormMode.transaction)` for the selected mode

**Buy/Sell form fields (when FormMode.transaction):**
- Asset picker: `TextField` with `onChanged` filtering. Load assets from `ref.watch(portfolioPageDataProvider)`. Show filtered results in a `ListView` below the field. When asset selected, store ID. Include option "Add new asset" at bottom (out of scope — just show existing assets).
  - Per user decision: "Asset picker uses type-ahead search — filters existing assets, with option to add new asset if not found"
  - Use `useState<PortfolioAssetResponse?>()` for selected asset
- Transaction type: `SegmentedButton<String>` with "Buy" / "Sell"
- Date: `TextField` with `onTap` opening `showDatePicker`. Default to today. Reject future dates (disable future dates in picker).
- Quantity: `TextField` with `keyboardType: TextInputType.numberWithOptions(decimal: true)`, `useTextEditingController`
- Price per unit: `TextField` with numeric keyboard
- Currency: `DropdownButtonFormField<String>` with USD/VND options
- Fee (optional): `TextField` with numeric keyboard

**Fixed Deposit form fields (when FormMode.fixedDeposit):**
- Bank name: `TextField`
- Principal (VND): `TextField` with numeric keyboard
- Annual interest rate: `TextField` with numeric keyboard, hint "e.g., 0.065 for 6.5%"
- Start date: `TextField` with `showDatePicker`
- Maturity date: `TextField` with `showDatePicker`
- Compounding frequency: `DropdownButtonFormField<String>` with options: None, Monthly, Quarterly, SemiAnnual, Annual

**Form submission:**
- Submit button at bottom: `FilledButton.icon` with "Save" label
- Use `useState<bool>(false)` for saving state
- On submit:
  - Validate all required fields are filled (show inline error text below empty fields using form key or manual validation)
  - For transaction: call `ref.read(portfolioRepositoryProvider).createTransaction(assetId, body)` where body is `{'date': date, 'quantity': qty, 'pricePerUnit': price, 'currency': currency, 'type': type, 'fee': fee}`
  - For fixed deposit: call `ref.read(portfolioRepositoryProvider).createFixedDeposit(body)` where body is `{'bankName': name, 'principal': principal, 'annualInterestRate': rate, 'startDate': start, 'maturityDate': maturity, 'compoundingFrequency': freq}`
  - On success: show `SnackBar(content: Text('Transaction added'))` or `'Fixed deposit added'`, then `context.pop()`, then `ref.invalidate(portfolioPageDataProvider)` to refresh portfolio data
  - On DioException: show error message from response in snackbar
  - Per user decision: "After submission: snackbar success message + auto-navigate back to portfolio"
  </action>
  <verify>
- `cd TradingBot.Mobile && flutter analyze` passes
- Router has 3 sub-routes under `/portfolio` all with `parentNavigatorKey: rootNavigatorKey`
- AddTransactionScreen file exists with SegmentedButton for mode switching
  </verify>
  <done>
- Full-screen add transaction form with Buy/Sell and Fixed Deposit mode tabs
- Asset picker with type-ahead search from existing portfolio assets
- All form fields with proper keyboard types and date pickers
- Form submission calls repository and shows snackbar + navigates back on success
- GoRouter sub-routes registered with parentNavigatorKey for full-screen push
  </done>
</task>

<task type="auto">
  <name>Task 2: Build transaction history screen + fixed deposit detail screen</name>
  <files>
    TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/transaction_history_screen.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/sub_screens/fixed_deposit_detail_screen.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
  </files>
  <action>
**TransactionHistoryScreen (transaction_history_screen.dart):**
- `ConsumerStatefulWidget` (needs lifecycle for loading state management)
- Takes no constructor params (loads data from providers)
- `Scaffold` with `AppBar` title "Transaction History" and a filter icon button in actions
- Navigation to this screen: add a text button or icon in the portfolio_screen.dart summary area or via a dedicated route — the user can navigate to `/portfolio/transaction-history` from the portfolio screen. Add a "View History" `TextButton` at the bottom of the portfolio screen (before the SliverPadding in Plan 02).

**Data loading:**
- Load all assets from `ref.watch(portfolioPageDataProvider)` to get asset list
- For each asset, fetch transactions via `ref.read(portfolioRepositoryProvider).fetchTransactions(assetId, type: filterType, startDate: filterStart, endDate: filterEnd)`
- Use `Future.wait` to fetch all asset transactions in parallel (per Research recommendation: "per-asset fetch + client merge")
- Merge all transactions into a single list, sort by date descending
- Store in `setState`: `List<_TransactionWithAsset>` (transaction + asset name/ticker for display)

**Filter bottom sheet:**
- Filter icon button opens `showModalBottomSheet`
- Filters:
  - Asset: dropdown of all portfolio assets (or "All")
  - Type: "All" / "Buy" / "Sell" chips
  - Date range: two date fields (start, end) with `showDatePicker`
- "Apply" button closes sheet and re-fetches with filters
- "Clear" button resets all filters

**Transaction list:**
- `ListView.builder` with `TransactionListTile` for each transaction
- Each tile shows: date, type (Buy/Sell), quantity, price per unit, total value, fee if present
- DISP-08: If `transaction.source == 'Bot'`, show a "Bot" badge:
  ```dart
  Container(
    padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
    decoration: BoxDecoration(
      color: AppTheme.bitcoinOrange.withAlpha(40),
      borderRadius: BorderRadius.circular(4),
      border: Border.all(color: AppTheme.bitcoinOrange.withAlpha(128)),
    ),
    child: Text('Bot', style: TextStyle(color: AppTheme.bitcoinOrange, fontSize: 10, fontWeight: FontWeight.w600)),
  )
  ```
- Bot transactions: no edit/delete buttons; manual transactions: could have delete but omit for now (no delete endpoint for transactions in Phase 28)
- Loading state: show `CircularProgressIndicator` center
- Empty state: "No transactions found" message

**FixedDepositDetailScreen (fixed_deposit_detail_screen.dart):**
- `ConsumerWidget` taking `String id` as constructor param (from route path parameter)
- Fetch fixed deposit detail from `ref.watch(portfolioPageDataProvider)` — find the matching FD in the existing loaded data (no extra API call needed since Plan 01 already fetches all FDs)
- If not found in loaded data, fall back to fetching via a new provider or show "Not found"
- Display in a Card layout:
  - Bank name (title)
  - Status badge (Active/Matured)
  - Principal: formatted as VND
  - Annual interest rate: formatted as percentage (e.g., "6.50%")
  - Start date and maturity date
  - Compounding frequency
  - Days to maturity (or "Matured" if 0)
  - Accrued value: formatted as VND with green coloring
  - Projected maturity value: formatted as VND
  - Progress bar showing `(totalDays - daysToMaturity) / totalDays` as completion percentage
- Currency toggle awareness: if `isVnd` is false and exchange rate available, show USD equivalent with "converted at today's rate" label
  </action>
  <verify>
- `cd TradingBot.Mobile && flutter analyze` passes
- TransactionHistoryScreen shows bot badge for bot-imported transactions
- FixedDepositDetailScreen displays all required fields (accrued, days to maturity, projected)
  </verify>
  <done>
- Transaction history screen loads transactions across all assets in parallel, merges and sorts
- Filter bottom sheet allows filtering by asset, type, and date range
- Bot transactions show "Bot" badge and are visually distinct (no edit/delete)
- Fixed deposit detail screen shows all fields: principal, rate, dates, accrued value, projected maturity, days remaining
- Both screens push full-screen over the bottom nav bar
  </done>
</task>

</tasks>

<verification>
- `cd TradingBot.Mobile && flutter analyze` passes with no errors
- Navigating to `/portfolio/add-transaction` pushes full-screen form (no bottom nav visible)
- Navigating to `/portfolio/transaction-history` shows history with filter capability
- Navigating to `/portfolio/fixed-deposit/{id}` shows deposit details
- Bot badge renders on auto-imported transactions
- Form submission calls correct API endpoints and invalidates portfolio data on success
</verification>

<success_criteria>
1. Add transaction form has Buy/Sell and Fixed Deposit modes switchable via SegmentedButton
2. Asset picker filters existing assets with type-ahead search
3. Form submission creates transaction/deposit via API, shows snackbar, and navigates back
4. Transaction history loads from all assets, merges client-side, and supports filters
5. Bot-imported transactions display "Bot" badge and lack edit/delete controls
6. Fixed deposit detail shows accrued value, days to maturity, projected maturity amount, and completion progress
7. All three sub-routes push full-screen over the bottom nav bar (parentNavigatorKey: rootNavigatorKey)
</success_criteria>

<output>
After completion, create `.planning/phases/29-flutter-portfolio-ui/29-03-SUMMARY.md`
</output>
