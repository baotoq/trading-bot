---
phase: 29-flutter-portfolio-ui
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - TradingBot.Mobile/lib/app/router.dart
  - TradingBot.Mobile/lib/shared/navigation_shell.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_summary_card.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/asset_type_section.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/asset_row.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/fixed_deposit_row.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/currency_toggle.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/staleness_label.dart
autonomous: true
requirements:
  - DISP-02
  - DISP-03
  - DISP-07
  - DISP-09
  - DISP-10

must_haves:
  truths:
    - "Portfolio tab appears as 5th tab in NavigationBar and shows the portfolio screen"
    - "Summary card displays total portfolio value and unrealized P&L in the selected currency"
    - "Donut chart shows allocation by asset type with total value in center; tap highlights segment"
    - "Assets are grouped into expandable sections by type (Crypto, ETF, Fixed Deposit) with subtotals"
    - "Each asset row shows current value, absolute P&L, and percentage P&L with green/red coloring"
    - "Fixed deposit rows show accrued value and days to maturity"
    - "VN asset prices show staleness indicator when using cached data"
    - "Cross-currency values show 'converted at today's rate' label"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      provides: "Main portfolio tab screen assembling all widgets"
      contains: "PortfolioScreen"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart"
      provides: "fl_chart PieChart donut with center value and touch interaction"
      contains: "PieChart"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/asset_type_section.dart"
      provides: "ExpansionTile sections grouping assets by type"
      contains: "ExpansionTile"
    - path: "TradingBot.Mobile/lib/app/router.dart"
      provides: "5th StatefulShellBranch for portfolio tab"
      contains: "_portfolioNavKey"
  key_links:
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      to: "portfolioPageDataProvider"
      via: "ref.watch in HookConsumerWidget"
      pattern: "ref\\.watch.*portfolioPageDataProvider"
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      to: "currencyPreferenceProvider"
      via: "ref.watch for currency toggle"
      pattern: "ref\\.watch.*currencyPreferenceProvider"
    - from: "TradingBot.Mobile/lib/app/router.dart"
      to: "portfolio_screen.dart"
      via: "GoRoute builder"
      pattern: "PortfolioScreen"
---

<objective>
Build the complete portfolio main screen with navigation integration, summary card, donut allocation chart, expandable asset type sections, staleness indicators, and currency toggle button.

Purpose: This is the core visual surface users interact with — the portfolio overview showing total value, P&L, allocation breakdown, and per-asset holdings. Without this, users have no way to see their multi-asset portfolio.

Output: Fully functional portfolio tab with real data from providers, VND/USD toggle, and all visual indicators.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-flutter-portfolio-ui/29-RESEARCH.md
@.planning/phases/29-flutter-portfolio-ui/29-CONTEXT.md
@.planning/phases/29-flutter-portfolio-ui/29-01-SUMMARY.md
@TradingBot.Mobile/lib/app/router.dart
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/shared/navigation_shell.dart
@TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
@TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart
@TradingBot.Mobile/lib/features/portfolio/data/currency_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add portfolio navigation tab + currency toggle + staleness label widgets</name>
  <files>
    TradingBot.Mobile/lib/app/router.dart
    TradingBot.Mobile/lib/shared/navigation_shell.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/currency_toggle.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/staleness_label.dart
  </files>
  <action>
**Router (router.dart):**
- Add `final GlobalKey<NavigatorState> _portfolioNavKey = GlobalKey<NavigatorState>(debugLabel: 'portfolio');`
- Add a 5th `StatefulShellBranch` AFTER the config branch:
  ```dart
  StatefulShellBranch(
    navigatorKey: _portfolioNavKey,
    routes: [
      GoRoute(
        path: '/portfolio',
        builder: (context, state) => const PortfolioScreen(),
        routes: [
          // Sub-routes added in Plan 03
        ],
      ),
    ],
  ),
  ```
- Import `portfolio_screen.dart`

**NavigationShell (navigation_shell.dart):**
- Add 5th `NavigationDestination` for Portfolio:
  ```dart
  NavigationDestination(
    icon: Icon(CupertinoIcons.briefcase),
    selectedIcon: Icon(CupertinoIcons.briefcase_fill),
    label: 'Portfolio',
  ),
  ```

**CurrencyToggle widget (currency_toggle.dart):**
- `ConsumerWidget` that watches `currencyPreferenceProvider`
- Renders an `IconButton` or `TextButton` in the AppBar showing "VND" or "USD" text
- On tap, calls `ref.read(currencyPreferenceProvider.notifier).toggle()`
- Style: use a compact `TextButton` or `Chip` with the currency label — visually distinct, fits in SliverAppBar actions
- Show the CURRENTLY ACTIVE currency (e.g., "VND" means values are shown in VND)

**StalenessLabel widget (staleness_label.dart):**
- `StatelessWidget` taking `DateTime? priceUpdatedAt` and `bool isPriceStale` parameters
- If `isPriceStale && priceUpdatedAt != null`: show `Text('price as of ${DateFormat('MMM d').format(priceUpdatedAt.toLocal())}')` using intl DateFormat
- Style: `TextStyle(color: Colors.white38, fontSize: 10)`
- Also add a static helper `crossCurrencyLabel()` that returns `Text('converted at today\'s rate', style: TextStyle(color: Colors.white38, fontSize: 10))`
  </action>
  <verify>
- `cd TradingBot.Mobile && flutter analyze` passes
- Router has 5 branches; NavigationShell has 5 destinations
  </verify>
  <done>
- Portfolio appears as 5th tab in bottom navigation bar
- CurrencyToggle widget toggles VND/USD and persists via provider
- StalenessLabel widget renders "price as of [date]" for stale prices and "converted at today's rate" for cross-currency
  </done>
</task>

<task type="auto">
  <name>Task 2: Build portfolio screen with summary card, donut chart, and expandable sections</name>
  <files>
    TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_summary_card.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/asset_type_section.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/asset_row.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/fixed_deposit_row.dart
  </files>
  <action>
**PortfolioScreen (portfolio_screen.dart):**
- `HookConsumerWidget` (follows existing pattern for read-heavy screens)
- `ref.watch(portfolioPageDataProvider)` for data, `ref.watch(currencyPreferenceProvider)` for currency toggle
- AsyncValue switch pattern (same as HomeScreen): loading shows `CircularProgressIndicator`, error shows `RetryWidget`, data shows content
- Stale cache pattern: extract `portfolioData.value` before switch; in `AsyncError` when `cachedValue != null`, show stale UI + error snackbar (same as home_screen.dart)
- Layout: `RefreshIndicator` wrapping `CustomScrollView` with:
  1. `SliverAppBar` (floating + snap) with title "Portfolio" and `CurrencyToggle` in `actions`
  2. `SliverToBoxAdapter` for `PortfolioSummaryCard`
  3. `SliverToBoxAdapter` for `AllocationDonutChart`
  4. `SliverToBoxAdapter` for Crypto `AssetTypeSection` (if crypto assets exist)
  5. `SliverToBoxAdapter` for ETF `AssetTypeSection` (if ETF assets exist)
  6. `SliverToBoxAdapter` for Fixed Deposit `AssetTypeSection` (from fixed deposits list)
  7. `SliverPadding` at bottom for spacing
- Group assets: `assets.where((a) => a.assetType == 'Crypto')` for crypto, `'ETF'` for ETF
- Pass `isVnd` bool to all child widgets
- Add a FAB: `FloatingActionButton` with `CupertinoIcons.add` icon, `AppTheme.bitcoinOrange` background, `onPressed: () => context.push('/portfolio/add-transaction')` — route added in Plan 03
- Pull-to-refresh: `ref.refresh(portfolioPageDataProvider.future)`

**PortfolioSummaryCard (portfolio_summary_card.dart):**
- `StatelessWidget` taking `PortfolioSummaryResponse summary` and `bool isVnd`
- Card with `Padding` containing:
  - Total portfolio value in selected currency (VND: `NumberFormat.currency(symbol: '₫', decimalDigits: 0, locale: 'vi_VN')`, USD: `NumberFormat.currency(symbol: '\$', decimalDigits: 2, locale: 'en_US')`)
  - Unrealized P&L (absolute + percentage) with green/red coloring: `AppTheme.profitGreen` for positive, `AppTheme.lossRed` for negative
  - Format P&L with sign prefix: `+₫2,500,000` or `-$150.00`
  - If `summary.exchangeRateUpdatedAt != null` and `isVnd` is showing cross-currency values, show `StalenessLabel.crossCurrencyLabel()`

**AllocationDonutChart (allocation_donut_chart.dart):**
- **StatefulWidget** (NOT HookConsumerWidget — touch state is local, per Research Pitfall 3)
- Takes `List<AllocationDto> allocations`, `double totalValue` (in selected currency), `bool isVnd`
- Uses `PieChart` from fl_chart with `centerSpaceRadius: 55` for donut hole
- Center: `Stack` with chart + centered `Column` showing total value text using the selected currency formatter
- `pieTouchData` with `touchCallback` updating `_touchedIndex` via `setState`
- Touched segment gets `radius: 65` (vs default `radius: 55`), `showTitle: false`
- Color mapping: Crypto -> `AppTheme.bitcoinOrange`, ETF -> `Color(0xFF42A5F5)` (blue), FixedDeposit -> `AppTheme.profitGreen`
- When a segment is touched, show a tooltip `Positioned` widget or `Badge` near the chart showing: asset type name, exact percentage, and value
- `sectionsSpace: 2` for gap between segments
- If allocations is empty, show empty state text "No assets yet"

**AssetTypeSection (asset_type_section.dart):**
- `StatelessWidget` taking `String title`, `List<PortfolioAssetResponse> assets` (for Crypto/ETF) OR `List<FixedDepositResponse> fixedDeposits` (for FD), `bool isVnd`, `double subtotalUsd`, `double subtotalVnd`
- Use `ExpansionTile` with `initiallyExpanded: true`
- Title: type name (e.g., "Crypto")
- Subtitle: subtotal in selected currency
- Trailing: asset count (e.g., "2 assets")
- Children: map to `AssetRow` widgets for tradeable assets, or `FixedDepositRow` widgets for fixed deposits
- Compute subtotals from the assets list in the parent screen, pass down

**AssetRow (asset_row.dart):**
- `StatelessWidget` taking `PortfolioAssetResponse asset` and `bool isVnd`
- `ListTile` or custom `Padding`+`Row` layout:
  - Leading: asset ticker in a small circle or just bold text
  - Title: asset name
  - Subtitle: quantity + average cost
  - Trailing column (right-aligned):
    - Current value in selected currency
    - Absolute P&L with sign and green/red color
    - Percentage P&L (e.g., "+12.5%") with green/red color
- Below the row: if `asset.isPriceStale`, show `StalenessLabel(priceUpdatedAt: asset.priceUpdatedAt, isPriceStale: asset.isPriceStale)`
- If showing cross-currency value (asset native currency differs from display currency), show `StalenessLabel.crossCurrencyLabel()`

**FixedDepositRow (fixed_deposit_row.dart):**
- `StatelessWidget` taking `FixedDepositResponse fd` and `bool isVnd`
- Show: bank name, principal, accrued value, days to maturity, projected maturity value
- Format VND values with `NumberFormat.currency(symbol: '₫', decimalDigits: 0)`
- If `daysToMaturity == 0`: show "Matured" badge in green
- Tap: `context.push('/portfolio/fixed-deposit/${fd.id}')` — route added in Plan 03
  </action>
  <verify>
- `cd TradingBot.Mobile && flutter analyze` passes
- All 6 widget files exist and have no analysis errors
- PortfolioScreen uses SliverAppBar with CurrencyToggle in actions
  </verify>
  <done>
- Portfolio screen loads data from portfolioPageDataProvider and renders full UI
- Summary card shows total value and P&L in selected currency with proper formatting
- Donut chart shows allocation by type with interactive segment highlighting and center value
- Expandable sections group assets by Crypto/ETF/Fixed Deposit with subtotals
- Asset rows show value, P&L (absolute + percentage) with green/red coloring
- Fixed deposit rows show accrued value and days to maturity
- Staleness indicators appear for stale prices and cross-currency conversions
- Currency toggle in SliverAppBar switches all values between VND and USD
  </done>
</task>

</tasks>

<verification>
- `cd TradingBot.Mobile && flutter analyze` passes with no errors
- Portfolio tab visible in NavigationBar and navigates to PortfolioScreen
- All widget files compile and reference correct providers
- DonutChart uses StatefulWidget with local _touchedIndex state (not HookConsumerWidget)
</verification>

<success_criteria>
1. 5th "Portfolio" tab in NavigationBar navigates to PortfolioScreen
2. VND/USD toggle in SliverAppBar switches all displayed values
3. Summary card shows total portfolio value and unrealized P&L with proper formatting and colors
4. Donut chart renders allocation by type; tapping a segment highlights it and shows tooltip
5. Crypto, ETF, and Fixed Deposit expandable sections with subtotals and individual asset/deposit rows
6. Staleness indicators appear below stale prices and cross-currency values
7. FAB for adding transactions is visible
</success_criteria>

<output>
After completion, create `.planning/phases/29-flutter-portfolio-ui/29-02-SUMMARY.md`
</output>
