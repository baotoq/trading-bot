---
phase: 03-smart-multipliers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/Models/DailyPrice.cs
  - TradingBot.ApiService/Models/Purchase.cs
  - TradingBot.ApiService/Infrastructure/Hyperliquid/HyperliquidClient.cs
  - TradingBot.ApiService/Infrastructure/Hyperliquid/Models/HyperliquidModels.cs
  - TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
  - TradingBot.ApiService/Infrastructure/Data/Migrations/<generated>
autonomous: true

must_haves:
  truths:
    - "DailyPrice entity stores OHLCV data with DateOnly partition key and decimal precision"
    - "HyperliquidClient can fetch historical daily candles via candleSnapshot endpoint"
    - "Purchase entity has multiplier metadata fields (MultiplierTier, DropPercentage, High30Day, Ma200Day)"
    - "DbContext configures DailyPrice with composite key (Date, Symbol) and proper precision"
    - "EF Core migration applies cleanly with dotnet ef database update"
  artifacts:
    - path: "TradingBot.ApiService/Models/DailyPrice.cs"
      provides: "DailyPrice entity with OHLCV fields"
      contains: "class DailyPrice"
    - path: "TradingBot.ApiService/Infrastructure/Hyperliquid/HyperliquidClient.cs"
      provides: "GetCandlesAsync method"
      contains: "GetCandlesAsync"
    - path: "TradingBot.ApiService/Infrastructure/Hyperliquid/Models/HyperliquidModels.cs"
      provides: "CandleResponse and CandleData models"
      contains: "CandleResponse"
  key_links:
    - from: "HyperliquidClient.GetCandlesAsync"
      to: "PostInfoAsync<List<CandleResponse>>"
      via: "candleSnapshot request"
      pattern: "candleSnapshot"
    - from: "TradingBotDbContext"
      to: "DailyPrice"
      via: "DbSet and OnModelCreating"
      pattern: "DbSet<DailyPrice>"
---

<objective>
Create the data foundation for smart multipliers: DailyPrice entity for storing historical OHLCV candle data, Hyperliquid candle API method, Purchase entity multiplier metadata fields, and database migration.

Purpose: All multiplier logic depends on having historical price data stored and queryable. The candle API method is the only way to get this data from Hyperliquid. Purchase metadata fields enable audit trail of multiplier decisions.

Output: DailyPrice entity, CandleResponse/CandleData models, HyperliquidClient.GetCandlesAsync, updated Purchase entity, updated DbContext, and EF Core migration.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-smart-multipliers/03-CONTEXT.md
@.planning/phases/03-smart-multipliers/03-RESEARCH.md
@TradingBot.ApiService/Models/Purchase.cs
@TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
@TradingBot.ApiService/BuildingBlocks/AuditedEntity.cs
@TradingBot.ApiService/Infrastructure/Hyperliquid/HyperliquidClient.cs
@TradingBot.ApiService/Infrastructure/Hyperliquid/Models/HyperliquidModels.cs
@TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DailyPrice entity and Hyperliquid candle models</name>
  <files>
    TradingBot.ApiService/Models/DailyPrice.cs
    TradingBot.ApiService/Infrastructure/Hyperliquid/Models/HyperliquidModels.cs
  </files>
  <action>
    **Create DailyPrice.cs** in `TradingBot.ApiService/Models/`:
    - Inherit from `AuditedEntity` (NOT BaseEntity — DailyPrice uses composite key Date+Symbol, not UUIDv7)
    - Properties: `DateOnly Date`, `string Symbol = "BTC"`, `decimal Open`, `decimal High`, `decimal Low`, `decimal Close`, `decimal Volume`, `DateTimeOffset Timestamp` (candle close time)
    - Namespace: `TradingBot.ApiService.Models`

    **Add to HyperliquidModels.cs** (append to existing file):

    CandleResponse class for raw Hyperliquid API JSON:
    - `[JsonPropertyName("t")] public long T` (open time ms)
    - `[JsonPropertyName("T")] public long CloseT` (close time ms)
    - `[JsonPropertyName("s")] public string S` (symbol)
    - `[JsonPropertyName("i")] public string I` (interval)
    - `[JsonPropertyName("o")] public string O` (open price as string)
    - `[JsonPropertyName("h")] public string H` (high price as string)
    - `[JsonPropertyName("l")] public string L` (low price as string)
    - `[JsonPropertyName("c")] public string C` (close price as string)
    - `[JsonPropertyName("v")] public string V` (volume as string)
    - `[JsonPropertyName("n")] public int N` (number of trades)

    CandleData class for parsed/typed candle data:
    - `DateOnly Date`, `string Symbol`, `decimal Open`, `decimal High`, `decimal Low`, `decimal Close`, `decimal Volume`, `DateTimeOffset Timestamp`
    - This is the intermediate type returned by GetCandlesAsync before mapping to DailyPrice entity
  </action>
  <verify>
    `dotnet build TradingBot.sln` compiles without errors.
  </verify>
  <done>
    DailyPrice entity exists with OHLCV fields and AuditedEntity base class. CandleResponse and CandleData models exist in HyperliquidModels.cs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GetCandlesAsync to HyperliquidClient, update Purchase entity, configure DbContext, and create migration</name>
  <files>
    TradingBot.ApiService/Infrastructure/Hyperliquid/HyperliquidClient.cs
    TradingBot.ApiService/Models/Purchase.cs
    TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
    TradingBot.ApiService/Infrastructure/Data/Migrations/<generated>
  </files>
  <action>
    **Add GetCandlesAsync to HyperliquidClient.cs:**
    - Signature: `public async Task<List<CandleData>> GetCandlesAsync(string symbol, DateTimeOffset startTime, DateTimeOffset endTime, CancellationToken ct = default)`
    - Build request: `new { type = "candleSnapshot", req = new { coin = symbol, interval = "1d", startTime = startTime.ToUnixTimeMilliseconds(), endTime = endTime.ToUnixTimeMilliseconds() } }`
    - Call `PostInfoAsync<List<CandleResponse>>(request, ct)`
    - Map each CandleResponse to CandleData: parse O/H/L/C/V with `decimal.Parse(value, CultureInfo.InvariantCulture)`, convert T (open time ms) to DateOnly via `DateOnly.FromDateTime(DateTimeOffset.FromUnixTimeMilliseconds(c.T).UtcDateTime)`, set Timestamp from T
    - Log: `_logger.LogInformation("Fetched {Count} candles for {Symbol} from {Start} to {End}", result.Count, symbol, startTime, endTime)`
    - Return the mapped list

    **Update Purchase.cs** - add multiplier metadata fields:
    - `public string? MultiplierTier { get; set; }` — tier description (e.g., ">= 10%")
    - `public decimal DropPercentage { get; set; }` — % drop from 30-day high
    - `public decimal High30Day { get; set; }` — 30-day high used for calculation
    - `public decimal Ma200Day { get; set; }` — 200-day SMA used for calculation
    - Keep existing `Multiplier` field (already exists at 1.0m default)

    **Update TradingBotDbContext.cs:**

    Add `public DbSet<DailyPrice> DailyPrices => Set<DailyPrice>();`

    Add DailyPrice configuration in OnModelCreating:
    - Composite key: `entity.HasKey(e => new { e.Date, e.Symbol })`
    - Index on Date: `entity.HasIndex(e => e.Date)`
    - Precision for Open, High, Low, Close: `HasPrecision(18, 8)`
    - Precision for Volume: `HasPrecision(18, 8)`
    - Symbol: `HasMaxLength(20)`

    Add Purchase new field configuration:
    - `MultiplierTier`: `HasMaxLength(50)`
    - `DropPercentage`: `HasPrecision(8, 4)` (percentage with decimals)
    - `High30Day`: `HasPrecision(18, 8)`
    - `Ma200Day`: `HasPrecision(18, 8)`

    **Create EF Core migration:**
    Run: `cd TradingBot.ApiService && dotnet ef migrations add AddDailyPriceAndPurchaseMultiplierMetadata`
    Verify migration file is generated and contains both DailyPrice table creation and Purchase column additions.
  </action>
  <verify>
    1. `dotnet build TradingBot.sln` compiles without errors.
    2. Migration file exists in `TradingBot.ApiService/Infrastructure/Data/Migrations/` and contains `CreateTable("DailyPrices")` and `AddColumn` for Purchase fields.
    3. `dotnet ef migrations list` in TradingBot.ApiService shows the new migration.
  </verify>
  <done>
    HyperliquidClient.GetCandlesAsync fetches and parses daily candles. Purchase entity has MultiplierTier, DropPercentage, High30Day, Ma200Day fields. TradingBotDbContext configures DailyPrice with composite key and proper decimal precision. EF Core migration generated.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` succeeds
2. DailyPrice entity has DateOnly Date, string Symbol, decimal OHLCV, DateTimeOffset Timestamp
3. CandleResponse uses JsonPropertyName attributes matching Hyperliquid API (t, T, s, i, o, h, l, c, v, n)
4. HyperliquidClient.GetCandlesAsync calls PostInfoAsync with candleSnapshot type
5. Purchase entity has MultiplierTier, DropPercentage, High30Day, Ma200Day
6. TradingBotDbContext has DbSet<DailyPrice> with composite key (Date, Symbol)
7. EF Core migration exists and includes both DailyPrice table and Purchase column additions
</verification>

<success_criteria>
- All new entities and models compile
- EF Core migration is generated and valid
- HyperliquidClient has GetCandlesAsync method using existing PostInfoAsync pattern
- Purchase entity is backward-compatible (new fields are nullable or have defaults)
- No existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/03-smart-multipliers/03-01-SUMMARY.md`
</output>
