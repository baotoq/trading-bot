---
phase: 08-api-endpoints-parameter-sweep
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - TradingBot.ApiService/Application/Services/Backtest/SweepRequest.cs
  - TradingBot.ApiService/Application/Services/Backtest/SweepResponse.cs
  - TradingBot.ApiService/Application/Services/Backtest/ParameterSweepService.cs
  - TradingBot.ApiService/Application/Services/Backtest/SweepPresets.cs
  - TradingBot.ApiService/Application/Services/Backtest/WalkForwardValidator.cs
  - TradingBot.ApiService/Endpoints/BacktestEndpoints.cs
  - TradingBot.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "POST /api/backtest/sweep accepts parameter ranges, generates combinations, runs backtests in parallel, and returns results ranked by user-chosen target"
    - "Sweep response includes summary metrics for all combinations and full purchase logs for top 5 only"
    - "Default optimization target is efficiency ratio; user can choose via rankBy field"
    - "Safety cap prevents runaway computation by limiting maximum parameter combinations (default 1000)"
    - "Sweep presets (conservative, full) provide ready-made parameter ranges"
    - "Walk-forward validation splits data into train/test periods when validate=true and flags parameter sets that degrade out-of-sample"
    - "All results include smart DCA vs fixed DCA comparison metrics"
  artifacts:
    - path: "TradingBot.ApiService/Application/Services/Backtest/SweepRequest.cs"
      provides: "Request DTO with parameter lists, rankBy, maxCombinations, validate flag, preset support"
      contains: "SweepRequest"
    - path: "TradingBot.ApiService/Application/Services/Backtest/SweepResponse.cs"
      provides: "Response DTO with ranked results, top N with full logs, walk-forward results"
      contains: "SweepResponse"
    - path: "TradingBot.ApiService/Application/Services/Backtest/ParameterSweepService.cs"
      provides: "Cartesian product generation, parallel execution, ranking logic"
      contains: "ParameterSweepService"
    - path: "TradingBot.ApiService/Application/Services/Backtest/SweepPresets.cs"
      provides: "Conservative and full preset definitions"
      contains: "SweepPresets"
    - path: "TradingBot.ApiService/Application/Services/Backtest/WalkForwardValidator.cs"
      provides: "Train/test split, degradation detection, overfitting warnings"
      contains: "WalkForwardValidator"
    - path: "TradingBot.ApiService/Endpoints/BacktestEndpoints.cs"
      provides: "POST /api/backtest/sweep endpoint"
      contains: "RunSweepAsync"
    - path: "TradingBot.ApiService/Program.cs"
      provides: "ParameterSweepService DI registration"
      contains: "ParameterSweepService"
  key_links:
    - from: "ParameterSweepService.cs"
      to: "BacktestSimulator.Run"
      via: "Task.WhenAll with batched parallel execution"
      pattern: "BacktestSimulator\\.Run"
    - from: "BacktestEndpoints.cs"
      to: "ParameterSweepService"
      via: "DI injection for sweep execution"
      pattern: "ParameterSweepService"
    - from: "WalkForwardValidator.cs"
      to: "BacktestSimulator.Run"
      via: "Train/test split and separate simulation runs"
      pattern: "BacktestSimulator\\.Run"
    - from: "BacktestEndpoints.cs"
      to: "SweepPresets"
      via: "Preset name resolution to SweepRequest"
      pattern: "SweepPresets"
---

<objective>
Create the parameter sweep endpoint (POST /api/backtest/sweep) with cartesian product combination generation, parallel backtest execution, result ranking by user-chosen metric, sweep presets, and optional walk-forward validation for overfitting detection.

Purpose: Enables users to explore parameter spaces and find optimal DCA strategies, with safety caps against combinatorial explosion and walk-forward validation to flag overfitting.
Output: Working POST /api/backtest/sweep endpoint with ParameterSweepService, SweepPresets, WalkForwardValidator, ranked results with top-5 full logs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-api-endpoints-parameter-sweep/08-CONTEXT.md
@.planning/phases/08-api-endpoints-parameter-sweep/08-RESEARCH.md
@.planning/phases/08-api-endpoints-parameter-sweep/08-01-SUMMARY.md
@TradingBot.ApiService/Application/Services/BacktestSimulator.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestConfig.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestResult.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestRequest.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestResponse.cs
@TradingBot.ApiService/Endpoints/BacktestEndpoints.cs
@TradingBot.ApiService/Configuration/DcaOptions.cs
@TradingBot.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sweep DTOs, presets, and ParameterSweepService with cartesian product and parallel execution</name>
  <files>
    TradingBot.ApiService/Application/Services/Backtest/SweepRequest.cs
    TradingBot.ApiService/Application/Services/Backtest/SweepResponse.cs
    TradingBot.ApiService/Application/Services/Backtest/SweepPresets.cs
    TradingBot.ApiService/Application/Services/Backtest/ParameterSweepService.cs
  </files>
  <action>
**SweepRequest.cs:**
Create a `SweepRequest` record in the Backtest namespace with:
- `DateOnly? StartDate` — backtest period start (default: last 2 years of available data)
- `DateOnly? EndDate` — backtest period end (default: latest available data)
- `string? Preset` — "conservative" or "full" (overrides parameter lists below; null = use explicit lists)
- `List<decimal>? BaseAmounts` — e.g. [10, 15, 20]
- `List<int>? HighLookbackDays` — e.g. [21, 30]
- `List<int>? BearMarketMaPeriods` — e.g. [200]
- `List<decimal>? BearBoosts` — e.g. [1.0, 1.5]
- `List<decimal>? MaxMultiplierCaps` — e.g. [3.0, 4.0]
- `List<TierSet>? TierSets` — list of tier configurations to sweep

Create a `TierSet` record: `record TierSet(List<MultiplierTierInput> Tiers)` (reuses MultiplierTierInput from Plan 01)

- `string RankBy` — default "efficiency"; options: "efficiency", "costBasis", "extraBtc", "returnPct"
- `int MaxCombinations` — default 1000 (safety cap); user can set up to 10000
- `bool Validate` — default false; enables walk-forward validation

**SweepResponse.cs:**
Create response DTOs:

`SweepResponse` record:
- `int TotalCombinations` — how many configs were generated
- `int ExecutedCombinations` — how many actually ran (may be capped)
- `string RankedBy` — which metric was used for ranking
- `DateOnly StartDate` / `DateOnly EndDate` — actual dates used
- `int TotalDays` — days in simulation
- `List<SweepResultEntry> Results` — all results (summary metrics only, NO purchase log)
- `List<SweepResultDetailEntry> TopResults` — top 5 with full purchase logs
- `WalkForwardSummary? WalkForward` — walk-forward results (null if validate=false)

`SweepResultEntry` record:
- `int Rank`
- `BacktestConfig Config` — the config used for this run
- `DcaMetrics SmartDca` — smart DCA metrics
- `DcaMetrics FixedDcaSameBase` — fixed baseline metrics
- `ComparisonMetrics Comparison` — comparison between smart and fixed
- `WalkForwardEntry? WalkForward` — per-result walk-forward data (null if validate=false)

`SweepResultDetailEntry` record: extends SweepResultEntry concept but adds:
- all fields from SweepResultEntry PLUS
- `IReadOnlyList<TierBreakdownEntry> TierBreakdown`
- `IReadOnlyList<PurchaseLogEntry> PurchaseLog`

`WalkForwardEntry` record:
- `decimal TrainReturnPercent`
- `decimal TestReturnPercent`
- `decimal ReturnDegradation` — test minus train (negative = degraded)
- `decimal TrainEfficiency`
- `decimal TestEfficiency`
- `decimal EfficiencyDegradation`
- `bool OverfitWarning` — true if performance degraded significantly

`WalkForwardSummary` record:
- `decimal TrainRatio` — e.g. 0.70
- `DateOnly TrainEnd` / `DateOnly TestStart` — split point
- `int OverfitCount` — how many configs flagged as overfit
- `int TotalValidated` — how many configs were validated

**SweepPresets.cs:**
Create a `SweepPresets` static class with:

`GetPreset(string name)` method returning `SweepRequest` (with only parameter lists filled):

Conservative preset (~24 combinations):
- BaseAmounts: [10, 15, 20]
- HighLookbackDays: [21, 30]
- BearMarketMaPeriods: [200]
- BearBoosts: [1.0, 1.5]
- MaxMultiplierCaps: [3.0, 4.0]
- TierSets: [standard 3-tier: (10%, 1.5x), (20%, 2.0x), (30%, 2.5x)]

Full preset (~2160 combinations):
- BaseAmounts: [10, 15, 20, 25, 30]
- HighLookbackDays: [14, 21, 30, 60]
- BearMarketMaPeriods: [100, 150, 200]
- BearBoosts: [1.0, 1.25, 1.5, 2.0]
- MaxMultiplierCaps: [3.0, 4.0, 5.0]
- TierSets: [3 different tier configurations as in research]

If name not recognized, throw `ArgumentException` with available preset names.

**ParameterSweepService.cs:**
Create a non-static class (registered as scoped) with constructor accepting `ILogger<ParameterSweepService>`.

`GenerateCombinations(SweepRequest request, BacktestConfig defaults)` method:
- If any parameter list is null/empty, use a single-element list from `defaults` (e.g., if BaseAmounts is null, use [defaults.BaseDailyAmount])
- Build cartesian product using chained LINQ SelectMany:
  - Start with BaseAmounts
  - Cross with HighLookbackDays
  - Cross with BearMarketMaPeriods
  - Cross with BearBoosts
  - Cross with MaxMultiplierCaps
  - Cross with TierSets (each TierSet maps to a List<MultiplierTierConfig>)
- Each combination produces a `BacktestConfig` record
- Return `IReadOnlyList<BacktestConfig>`

`ExecuteSweepAsync(IReadOnlyList<BacktestConfig> configs, IReadOnlyList<DailyPriceData> priceData, string rankBy, CancellationToken ct)` method:
- Execute backtests in parallel using Task.WhenAll with batching (MaxParallelism = Environment.ProcessorCount, minimum 4, maximum 16)
- Batch configs into chunks of MaxParallelism
- For each batch: `Task.WhenAll(batch.Select(config => Task.Run(() => BacktestSimulator.Run(config, priceData), ct)))`
- Check `ct.ThrowIfCancellationRequested()` between batches
- Collect all results as `(BacktestConfig config, BacktestResult result)` pairs
- Rank results using pattern match on rankBy string (case-insensitive):
  - "efficiency" → OrderByDescending by Comparison.EfficiencyRatio
  - "costbasis" → OrderBy SmartDca.AvgCostBasis (lower is better)
  - "extrabtc" → OrderByDescending by Comparison.ExtraBtcPercentMatchTotal
  - "returnpct" → OrderByDescending by SmartDca.ReturnPercent
  - Default/unknown → throw ArgumentException
- Assign Rank (1-based) to each result
- Build SweepResultEntry list (all results, summary metrics only — NO PurchaseLog, NO TierBreakdown)
- Build SweepResultDetailEntry list (top 5 only — WITH PurchaseLog and TierBreakdown)
- Log: "Sweep completed: {Count} combinations, ranked by {RankBy}"
- Return tuple of (List<SweepResultEntry>, List<SweepResultDetailEntry>)
  </action>
  <verify>
`dotnet build TradingBot.ApiService` succeeds with no errors. `dotnet test` passes all existing tests.
  </verify>
  <done>
SweepRequest/SweepResponse DTOs exist with all fields per locked decisions. SweepPresets provides "conservative" (~24 combos) and "full" (~2160 combos) presets. ParameterSweepService generates cartesian product from parameter lists, executes backtests in parallel with batching, and ranks results by user-chosen metric. Top 5 results include full purchase logs; all others include summary metrics only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WalkForwardValidator, add sweep endpoint to BacktestEndpoints, and wire DI</name>
  <files>
    TradingBot.ApiService/Application/Services/Backtest/WalkForwardValidator.cs
    TradingBot.ApiService/Endpoints/BacktestEndpoints.cs
    TradingBot.ApiService/Program.cs
  </files>
  <action>
**WalkForwardValidator.cs:**
Create a static class `WalkForwardValidator` in the Backtest namespace (pure function, no DI needed):

`Validate(BacktestConfig config, IReadOnlyList<DailyPriceData> fullData, decimal trainRatio = 0.70m)` method:
- Split fullData by trainRatio: `trainSize = (int)(fullData.Count * trainRatio)`
- `trainData = fullData.Take(trainSize).ToList()`
- `testData = fullData.Skip(trainSize).ToList()`
- Guard: if trainData or testData has < 30 days, return null (insufficient data for meaningful validation)
- Run `BacktestSimulator.Run(config, trainData)` for train period
- Run `BacktestSimulator.Run(config, testData)` for test period
- Calculate degradation:
  - `returnDegradation = testResult.SmartDca.ReturnPercent - trainResult.SmartDca.ReturnPercent`
  - `efficiencyDegradation = testResult.Comparison.EfficiencyRatio - trainResult.Comparison.EfficiencyRatio`
- Determine overfit warning: `overfitWarning = returnDegradation < -20m || efficiencyDegradation < -0.3m`
  - Threshold: 20 percentage points drop in return OR 0.3 drop in efficiency ratio
- Return `WalkForwardEntry` record with all metrics

`ValidateAll(IReadOnlyList<(BacktestConfig config, BacktestResult result)> results, IReadOnlyList<DailyPriceData> fullData, decimal trainRatio = 0.70m)` method:
- For each config, call Validate and collect WalkForwardEntry results
- Build WalkForwardSummary with:
  - TrainRatio
  - TrainEnd = fullData[trainSize - 1].Date
  - TestStart = fullData[trainSize].Date
  - OverfitCount = count of results with OverfitWarning=true
  - TotalValidated = count of non-null validation results
- Return `(List<WalkForwardEntry?> perResult, WalkForwardSummary summary)`
- NOTE: Walk-forward runs are sequential (each calls BacktestSimulator.Run twice), not parallel, to limit CPU usage since sweep already runs in parallel

**BacktestEndpoints.cs:**
Add to the existing MapBacktestEndpoints method:
- `group.MapPost("/sweep", RunSweepAsync)` (add to the existing route group)
- Also add `group.MapGet("/presets/{name}", GetPresetAsync)` for preset inspection

`RunSweepAsync` handler:
1. Accept `SweepRequest request` (from body), `TradingBotDbContext db`, `IOptionsMonitor<DcaOptions> dcaOptions`, `ParameterSweepService sweepService`, `ILogger<Program> logger`, `CancellationToken ct`
2. **Resolve preset if specified:**
   - If `request.Preset` is non-null: call `SweepPresets.GetPreset(request.Preset)` to get parameter lists, then merge into request (preset values fill in null parameter lists; explicit request values override preset)
   - Catch ArgumentException → return BadRequest with available preset names
3. **Build defaults from production DcaOptions** (same pattern as Plan 01's single backtest — build a BacktestConfig from DcaOptions.CurrentValue to use as fallback for missing parameter lists)
4. **Generate combinations:**
   - Call `sweepService.GenerateCombinations(mergedRequest, defaults)`
   - Count combinations
   - If count > request.MaxCombinations: return `Results.BadRequest(new { error = $"Parameter combination count ({count}) exceeds maximum ({request.MaxCombinations}). Reduce parameter ranges or increase maxCombinations.", count, max = request.MaxCombinations })`
   - Log: "Sweep requested with {Count} combinations, rankBy: {RankBy}, validate: {Validate}"
5. **Resolve date range:** Same logic as Plan 01's single backtest endpoint (query DailyPrices for min/max, default last 2 years, validate against available data)
6. **Fetch price data:** Same logic as Plan 01 (query DailyPrices, convert to DailyPriceData)
7. **Execute sweep:**
   - Call `sweepService.ExecuteSweepAsync(configs, priceData, request.RankBy, ct)`
8. **Optional walk-forward validation:**
   - If `request.Validate` is true: call `WalkForwardValidator.ValidateAll(...)` and attach WalkForwardEntry to each SweepResultEntry, include WalkForwardSummary in response
   - If false: WalkForward fields are null
9. **Build and return SweepResponse**

`GetPresetAsync` handler:
- Accept `string name`, `ILogger<Program> logger`
- Try `SweepPresets.GetPreset(name)`, catch ArgumentException → return NotFound
- Return the preset's SweepRequest (so users can inspect what parameters a preset uses)

**Program.cs:**
- Add `builder.Services.AddScoped<ParameterSweepService>();` in the DI section (after the historical data pipeline registrations)
- Add `using TradingBot.ApiService.Application.Services.Backtest;` if not already present
  </action>
  <verify>
`dotnet build TradingBot.ApiService` succeeds. `dotnet test` passes all existing 53 tests with no regressions.
  </verify>
  <done>
POST /api/backtest/sweep endpoint exists and accepts parameter ranges with preset support. ParameterSweepService generates cartesian product, enforces safety cap, runs backtests in parallel, and ranks results. WalkForwardValidator splits train/test, detects performance degradation, and flags overfitting. GET /api/backtest/presets/{name} returns preset details. All services registered in Program.cs DI. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` — zero errors
2. `dotnet test` — all 53 existing tests pass
3. All new files exist: SweepRequest.cs, SweepResponse.cs, SweepPresets.cs, ParameterSweepService.cs, WalkForwardValidator.cs
4. BacktestEndpoints.cs has POST /sweep and GET /presets/{name}
5. Program.cs has ParameterSweepService registered
6. SweepPresets.GetPreset("conservative") returns ~24 combinations
7. SweepPresets.GetPreset("full") returns ~2160 combinations
8. Sweep response includes summary metrics for all results and full purchase logs for top 5 only
9. Walk-forward validation is optional (validate flag), splits 70/30, flags degradation
</verification>

<success_criteria>
- POST /api/backtest/sweep accepts explicit parameter lists or preset name
- Cartesian product generates all valid combinations from parameter lists
- Safety cap (default 1000) prevents runaway computation; exceeding returns 400
- Results ranked by user-chosen metric (default: efficiency)
- All results include smart DCA vs fixed DCA comparison
- Top 5 results include full purchase logs; others include summary only
- Presets "conservative" (~24 combos) and "full" (~2160 combos) are available
- Walk-forward validation (validate=true) splits 70/30, detects degradation, flags overfitting per-result
- All existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-api-endpoints-parameter-sweep/08-02-SUMMARY.md`
</output>
