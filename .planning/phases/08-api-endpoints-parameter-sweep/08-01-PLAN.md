---
phase: 08-api-endpoints-parameter-sweep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/Application/Services/Backtest/BacktestRequest.cs
  - TradingBot.ApiService/Application/Services/Backtest/BacktestResponse.cs
  - TradingBot.ApiService/Endpoints/BacktestEndpoints.cs
  - TradingBot.ApiService/Program.cs
autonomous: true

must_haves:
  truths:
    - "POST /api/backtest accepts a strategy config and date range, returns structured JSON with all simulation metrics"
    - "Default date range is last 2 years of available data when user omits start/end"
    - "Strategy config defaults to current production DcaOptions when user omits fields"
    - "Response always includes full purchase log and fixed DCA comparison"
    - "Request with date range outside available data returns 400 Bad Request"
    - "Request with no historical data returns 400 Bad Request with helpful message"
  artifacts:
    - path: "TradingBot.ApiService/Application/Services/Backtest/BacktestRequest.cs"
      provides: "Request DTO with optional date range and strategy config fields"
      contains: "BacktestRequest"
    - path: "TradingBot.ApiService/Application/Services/Backtest/BacktestResponse.cs"
      provides: "Response DTO wrapping BacktestResult with config and date metadata"
      contains: "BacktestResponse"
    - path: "TradingBot.ApiService/Endpoints/BacktestEndpoints.cs"
      provides: "Minimal API endpoint for single backtest execution"
      contains: "MapBacktestEndpoints"
    - path: "TradingBot.ApiService/Program.cs"
      provides: "Endpoint registration"
      contains: "MapBacktestEndpoints"
  key_links:
    - from: "BacktestEndpoints.cs"
      to: "BacktestSimulator.Run"
      via: "Direct static method call with constructed BacktestConfig"
      pattern: "BacktestSimulator\\.Run"
    - from: "BacktestEndpoints.cs"
      to: "TradingBotDbContext.DailyPrices"
      via: "EF Core query to fetch price data for date range"
      pattern: "db\\.DailyPrices"
    - from: "BacktestEndpoints.cs"
      to: "IOptionsMonitor<DcaOptions>"
      via: "DI injection for production config defaults"
      pattern: "IOptionsMonitor.*DcaOptions"
---

<objective>
Create the single backtest API endpoint (POST /api/backtest) with request/response DTOs that accepts a strategy config and date range, fetches historical price data from the database, runs BacktestSimulator, and returns structured JSON with all simulation metrics.

Purpose: Enables users to run backtests via HTTP API against ingested historical data, using either custom parameters or production DCA defaults.
Output: Working POST /api/backtest endpoint with request validation, default handling, price data fetching, and full BacktestResult response.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-api-endpoints-parameter-sweep/08-CONTEXT.md
@.planning/phases/08-api-endpoints-parameter-sweep/08-RESEARCH.md
@TradingBot.ApiService/Application/Services/BacktestSimulator.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestConfig.cs
@TradingBot.ApiService/Application/Services/Backtest/BacktestResult.cs
@TradingBot.ApiService/Application/Services/Backtest/DailyPriceData.cs
@TradingBot.ApiService/Configuration/DcaOptions.cs
@TradingBot.ApiService/Endpoints/DataEndpoints.cs
@TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
@TradingBot.ApiService/Program.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create request/response DTOs for single backtest endpoint</name>
  <files>
    TradingBot.ApiService/Application/Services/Backtest/BacktestRequest.cs
    TradingBot.ApiService/Application/Services/Backtest/BacktestResponse.cs
  </files>
  <action>
Create two new files in the existing Backtest namespace:

**BacktestRequest.cs:**
Create a `BacktestRequest` record in `TradingBot.ApiService.Application.Services.Backtest` namespace with ALL fields nullable (they default to production DcaOptions when null):
- `DateOnly? StartDate` — start of backtest period (default: last 2 years of available data)
- `DateOnly? EndDate` — end of backtest period (default: latest available data)
- `decimal? BaseDailyAmount` — overrides DcaOptions.BaseDailyAmount
- `int? HighLookbackDays` — overrides DcaOptions.HighLookbackDays
- `int? BearMarketMaPeriod` — overrides DcaOptions.BearMarketMaPeriod
- `decimal? BearBoostFactor` — overrides DcaOptions.BearBoostFactor
- `decimal? MaxMultiplierCap` — overrides DcaOptions.MaxMultiplierCap
- `List<MultiplierTierInput>? Tiers` — overrides DcaOptions.MultiplierTiers

Create a `MultiplierTierInput` record with:
- `decimal DropPercentage`
- `decimal Multiplier`

**BacktestResponse.cs:**
Create a `BacktestResponse` record wrapping the simulation result with metadata:
- `BacktestConfig Config` — the resolved config that was actually used (after defaults applied)
- `DateOnly StartDate` — actual start date used
- `DateOnly EndDate` — actual end date used
- `int TotalDays` — number of days simulated
- `BacktestResult Result` — the full BacktestResult from BacktestSimulator

Use C# record types following the existing DTO pattern in the Backtest namespace. File-scoped namespace.
  </action>
  <verify>
`dotnet build TradingBot.ApiService` succeeds with no errors.
  </verify>
  <done>
BacktestRequest record exists with all nullable override fields. BacktestResponse record wraps BacktestResult with resolved config and date metadata. MultiplierTierInput record exists for tier overrides.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BacktestEndpoints with POST /api/backtest and wire into Program.cs</name>
  <files>
    TradingBot.ApiService/Endpoints/BacktestEndpoints.cs
    TradingBot.ApiService/Program.cs
  </files>
  <action>
**BacktestEndpoints.cs:**
Create `BacktestEndpoints` static class in `TradingBot.ApiService.Endpoints` namespace following the exact pattern of DataEndpoints.cs (MapGroup, static async handler methods):

`MapBacktestEndpoints(this WebApplication app)` extension method:
- Create route group at `/api/backtest`
- Map `POST /` to `RunBacktestAsync` handler

`RunBacktestAsync` handler:
1. Accept `BacktestRequest request` (from body), `TradingBotDbContext db`, `IOptionsMonitor<DcaOptions> dcaOptions`, `ILogger<Program> logger`, `CancellationToken ct`
2. **Resolve config defaults from production DcaOptions:**
   - Get current DcaOptions via `dcaOptions.CurrentValue`
   - For each nullable field in request: use request value if non-null, otherwise use production DcaOptions value
   - Convert tiers: if request.Tiers is non-null, map `MultiplierTierInput` to `MultiplierTierConfig`; otherwise convert from `DcaOptions.MultiplierTiers`
   - Build a `BacktestConfig` record with resolved values
3. **Resolve date range from available data:**
   - Query `db.DailyPrices.Where(p => p.Symbol == "BTC")` for min/max dates (similar pattern to DataEndpoints.GetStatusAsync)
   - If no data exists: return `Results.BadRequest(new { error = "No historical data available. Run POST /api/backtest/data/ingest first." })`
   - Default start: `maxDate.AddYears(-2)`, clamped to `minDate` if earlier
   - Default end: `maxDate`
   - If user-provided dates exceed available range: return `Results.BadRequest(new { error = $"Date range exceeds available data [{minDate}, {maxDate}]" })`
4. **Fetch price data:**
   - Query `db.DailyPrices.Where(p => p.Symbol == "BTC" && p.Date >= startDate && p.Date <= endDate).OrderBy(p => p.Date)`
   - Convert each `DailyPrice` entity to `DailyPriceData` record (Date, Open, High, Low, Close, Volume)
   - If no prices in range: return `Results.BadRequest(new { error = "No price data found for the specified date range" })`
5. **Run simulation:**
   - Call `BacktestSimulator.Run(config, priceData)`
   - Log: `"Backtest completed for {StartDate} to {EndDate}: {TotalDays} days, smart DCA return {ReturnPercent}%"`
6. **Return response:**
   - Return `Results.Ok(new BacktestResponse(config, startDate, endDate, priceData.Count, result))`

**Program.cs:**
- Add `app.MapBacktestEndpoints();` after the existing `app.MapDataEndpoints();` line
- No new DI registrations needed (BacktestSimulator is a static class, DcaOptions already registered)
  </action>
  <verify>
`dotnet build TradingBot.ApiService` succeeds. `dotnet test` passes all existing 53 tests with no regressions.
  </verify>
  <done>
POST /api/backtest endpoint exists, resolves config defaults from production DcaOptions, validates date range against available data, fetches DailyPrices, runs BacktestSimulator, and returns full BacktestResponse. Endpoint is mapped in Program.cs. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` — zero errors
2. `dotnet test` — all 53 existing tests pass
3. BacktestRequest.cs, BacktestResponse.cs, BacktestEndpoints.cs exist in correct directories
4. Program.cs includes `app.MapBacktestEndpoints()`
5. BacktestEndpoints handles: no data (400), out-of-range dates (400), default dates (last 2 years), default config (from DcaOptions), custom config (from request), and returns full BacktestResponse with metrics
</verification>

<success_criteria>
- POST /api/backtest accepts optional strategy config and optional date range
- Missing config fields default to production DcaOptions
- Missing date range defaults to last 2 years of available data
- Response includes resolved config, date metadata, and full BacktestResult (smart DCA, fixed DCA, comparison, tier breakdown, purchase log)
- Invalid date ranges return 400 Bad Request
- No historical data returns 400 Bad Request with helpful message
- All existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-api-endpoints-parameter-sweep/08-01-SUMMARY.md`
</output>
