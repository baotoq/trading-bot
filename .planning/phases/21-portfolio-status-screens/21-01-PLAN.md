---
phase: 21-portfolio-status-screens
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/Endpoints/DashboardDtos.cs
  - TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
  - TradingBot.Mobile/pubspec.yaml
  - TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart
  - TradingBot.Mobile/lib/features/home/data/models/status_response.dart
  - TradingBot.Mobile/lib/features/home/data/home_repository.dart
  - TradingBot.Mobile/lib/features/home/data/home_providers.dart
  - TradingBot.Mobile/lib/features/home/data/home_providers.g.dart
autonomous: true
requirements: [PORT-01, PORT-02, PORT-03, PORT-04, PORT-05]

must_haves:
  truths:
    - "Portfolio data (totalBtc, totalCost, P&L) is fetchable from the API and parsed into typed Dart models"
    - "Status data (health, nextBuyTime, lastPurchase with multiplier and dropPercentage) is fetchable and parsed"
    - "A Riverpod provider auto-refreshes portfolio+status data every 30 seconds"
    - "Pull-to-refresh triggers an immediate re-fetch of both portfolio and status data"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart"
      provides: "Dart model matching PortfolioResponse DTO"
    - path: "TradingBot.Mobile/lib/features/home/data/models/status_response.dart"
      provides: "Dart model matching LiveStatusResponse DTO (with multiplier + dropPercentage)"
    - path: "TradingBot.Mobile/lib/features/home/data/home_repository.dart"
      provides: "HomeRepository with fetchPortfolio() and fetchStatus() Dio calls"
    - path: "TradingBot.Mobile/lib/features/home/data/home_providers.dart"
      provides: "Riverpod providers with 30-second auto-refresh timer"
  key_links:
    - from: "TradingBot.Mobile/lib/features/home/data/home_repository.dart"
      to: "/api/dashboard/portfolio"
      via: "Dio GET request"
      pattern: "dio\\.get.*portfolio"
    - from: "TradingBot.Mobile/lib/features/home/data/home_repository.dart"
      to: "/api/dashboard/status"
      via: "Dio GET request"
      pattern: "dio\\.get.*status"
    - from: "TradingBot.ApiService/Endpoints/DashboardEndpoints.cs"
      to: "TradingBot.ApiService/Endpoints/DashboardDtos.cs"
      via: "LiveStatusResponse includes LastPurchaseMultiplier and LastPurchaseDropPercentage"
      pattern: "LastPurchaseMultiplier|LastPurchaseDropPercentage"
---

<objective>
Create the data layer for the home/portfolio screen: Dart DTO models matching the .NET API responses, a repository class for API calls, and Riverpod providers with 30-second auto-refresh. Also extend the backend LiveStatusResponse to include multiplier and drop percentage for the last-buy card.

Purpose: Establishes the data pipeline so the UI plan (21-02) can bind directly to providers without worrying about API calls, JSON parsing, or refresh logic.
Output: Dart models, repository, providers, and extended .NET DTO — all wired and ready for UI consumption.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-portfolio-status-screens/21-CONTEXT.md
@.planning/phases/20-flutter-project-setup-core-infrastructure/20-02-SUMMARY.md

Key files to reference:
@TradingBot.ApiService/Endpoints/DashboardDtos.cs
@TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
@TradingBot.Mobile/lib/core/api/api_client.dart
@TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LiveStatusResponse with multiplier and drop percentage, create Dart DTO models</name>
  <files>
    TradingBot.ApiService/Endpoints/DashboardDtos.cs
    TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
    TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart
    TradingBot.Mobile/lib/features/home/data/models/status_response.dart
  </files>
  <action>
**Backend changes:**

1. In `DashboardDtos.cs`, add two fields to `LiveStatusResponse`:
   - `Multiplier? LastPurchaseMultiplier` (nullable — null when no purchases)
   - `Percentage? LastPurchaseDropPercentage` (nullable — null when no purchases)

2. In `DashboardEndpoints.cs` `GetLiveStatusAsync`, populate these new fields from `lastPurchase`:
   - `LastPurchaseMultiplier: lastPurchase?.Multiplier`
   - `LastPurchaseDropPercentage: lastPurchase?.DropPercentage`

**Flutter DTO models:**

3. Create `portfolio_response.dart` with a `PortfolioResponse` class matching the .NET DTO:
   ```dart
   class PortfolioResponse {
     final double totalBtc;
     final double totalCost;
     final double? averageCostBasis;
     final double? currentPrice;
     final double? unrealizedPnl;
     final double? unrealizedPnlPercent;
     final int totalPurchaseCount;
     final String? firstPurchaseDate;  // ISO 8601 string
     final String? lastPurchaseDate;   // ISO 8601 string
     // constructor + fromJson factory
   }
   ```
   - Use `double` for all monetary/quantity fields (Vogen value objects serialize as raw numbers in JSON)
   - Use nullable `double?` for fields that can be null (currentPrice, pnl fields, averageCostBasis)
   - Implement `factory PortfolioResponse.fromJson(Map<String, dynamic> json)` using manual deserialization (no code generation dependency — keep it simple)

4. Create `status_response.dart` with a `StatusResponse` class matching the extended `LiveStatusResponse`:
   ```dart
   class StatusResponse {
     final String healthStatus;        // "Healthy", "Warning", "Error"
     final String? healthMessage;
     final String? nextBuyTime;        // ISO 8601 string
     final String? lastPurchaseTime;   // ISO 8601 string
     final double? lastPurchasePrice;
     final double? lastPurchaseBtc;
     final String? lastPurchaseTier;
     final double? lastPurchaseMultiplier;
     final double? lastPurchaseDropPercentage;
     // constructor + fromJson factory
   }
   ```
   - Parse dates as raw ISO 8601 strings; the UI layer will convert to DateTime when needed
   - All `fromJson` fields use camelCase keys (the .NET API serializes with `JsonNamingPolicy.CamelCase`)

Verify the .NET solution builds: `dotnet build TradingBot.slnx` from repo root.
Verify Dart models parse correctly: `dart analyze TradingBot.Mobile/lib/features/home/data/` passes with no errors.
  </action>
  <verify>
    `dotnet build TradingBot.slnx` succeeds with no errors.
    `cd TradingBot.Mobile && dart analyze lib/features/home/data/models/` reports "No issues found!"
  </verify>
  <done>
    LiveStatusResponse includes LastPurchaseMultiplier and LastPurchaseDropPercentage fields.
    PortfolioResponse and StatusResponse Dart classes exist with fromJson factories matching the .NET DTOs exactly.
    Both .NET build and Dart analyze pass cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HomeRepository and Riverpod providers with 30-second auto-refresh</name>
  <files>
    TradingBot.Mobile/pubspec.yaml
    TradingBot.Mobile/lib/features/home/data/home_repository.dart
    TradingBot.Mobile/lib/features/home/data/home_providers.dart
    TradingBot.Mobile/lib/features/home/data/home_providers.g.dart
    TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
    TradingBot.Mobile/lib/features/home/presentation/home_screen.g.dart
  </files>
  <action>
1. Add `timeago: ^3.7.0` to pubspec.yaml dependencies (for relative time formatting: "2 hours ago", "Yesterday"). Run `flutter pub get`.

2. Create `home_repository.dart`:
   ```dart
   class HomeRepository {
     HomeRepository(this._dio);
     final Dio _dio;

     Future<PortfolioResponse> fetchPortfolio() async {
       final response = await _dio.get('/api/dashboard/portfolio');
       return PortfolioResponse.fromJson(response.data as Map<String, dynamic>);
     }

     Future<StatusResponse> fetchStatus() async {
       final response = await _dio.get('/api/dashboard/status');
       return StatusResponse.fromJson(response.data as Map<String, dynamic>);
     }
   }
   ```
   - Import Dio from `package:dio/dio.dart`
   - Import both model classes
   - No error handling here — let DioException propagate to ApiKeyInterceptor which wraps it as ApiException

3. Create a `HomeData` record (or simple class) combining both responses:
   ```dart
   class HomeData {
     HomeData({required this.portfolio, required this.status});
     final PortfolioResponse portfolio;
     final StatusResponse status;
   }
   ```
   Place this in `home_providers.dart` (or a separate file if preferred, but co-locating with providers keeps it simple).

4. Create `home_providers.dart` with `@riverpod` annotation:
   ```dart
   @riverpod
   HomeRepository homeRepository(Ref ref) {
     return HomeRepository(ref.watch(dioProvider));
   }

   @riverpod
   Future<HomeData> homeData(Ref ref) async {
     // Fetch both in parallel
     final repo = ref.watch(homeRepositoryProvider);
     final results = await Future.wait([
       repo.fetchPortfolio(),
       repo.fetchStatus(),
     ]);

     // Auto-refresh every 30 seconds (silent, no animation per CONTEXT.md)
     final timer = Timer(const Duration(seconds: 30), () {
       ref.invalidateSelf();
     });
     ref.onDispose(timer.cancel);

     return HomeData(
       portfolio: results[0] as PortfolioResponse,
       status: results[1] as StatusResponse,
     );
   }
   ```
   - Import `dart:async` for Timer
   - Import `api_client.dart` for dioProvider
   - The 30-second timer uses `ref.invalidateSelf()` to trigger a silent re-fetch
   - `ref.onDispose(timer.cancel)` prevents timer leaks

5. Run `dart run build_runner build --delete-conflicting-outputs` from `TradingBot.Mobile/` to generate `.g.dart` files.

6. Update `home_screen.dart`:
   - Remove the old placeholder `homeData` provider (the `Future<String>` one)
   - Import the new `home_providers.dart` and use `homeDataProvider` from there
   - Keep the existing HookConsumerWidget pattern (ref.watch, ref.listen, switch on AsyncValue) — just change the type from `String` to `HomeData`
   - For now, display a simple placeholder text showing `portfolio.totalBtc` to prove the wiring works — Plan 02 will build the full UI
   - Delete `home_screen.g.dart` old generated file (build_runner will regenerate based on the provider now living in home_providers.dart)

7. Run `dart analyze` on the full lib directory to ensure no issues.
  </action>
  <verify>
    `cd TradingBot.Mobile && dart run build_runner build --delete-conflicting-outputs` generates home_providers.g.dart without errors.
    `cd TradingBot.Mobile && dart analyze lib/` reports "No issues found!"
    HomeScreen references homeDataProvider from home_providers.dart (not the old local placeholder).
  </verify>
  <done>
    HomeRepository fetches from /api/dashboard/portfolio and /api/dashboard/status via Dio.
    homeDataProvider combines both responses and auto-refreshes every 30 seconds via Timer + ref.invalidateSelf().
    HomeScreen is wired to the real provider (placeholder UI — full UI in Plan 02).
    timeago package is installed for relative date formatting.
    build_runner generates all .g.dart files cleanly.
    dart analyze passes with no issues on full lib/.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.slnx` — .NET solution builds without errors
2. `dotnet test` — all 62 existing tests pass (no test changes expected)
3. `cd TradingBot.Mobile && dart analyze lib/` — zero issues
4. `cd TradingBot.Mobile && dart run build_runner build --delete-conflicting-outputs` — generates cleanly
5. HomeScreen uses homeDataProvider from home_providers.dart with 30-second auto-refresh
6. LiveStatusResponse includes LastPurchaseMultiplier and LastPurchaseDropPercentage
</verification>

<success_criteria>
- Both .NET API and Flutter app compile/analyze cleanly
- Dart models match .NET DTOs field-for-field (PortfolioResponse: 9 fields, StatusResponse: 11 fields including 2 new ones)
- HomeRepository makes two Dio GET calls (/portfolio, /status)
- homeDataProvider fetches both in parallel and re-fetches every 30 seconds
- HomeScreen wired to real provider, displays at minimum the portfolio totalBtc value
- timeago package installed in pubspec.yaml
</success_criteria>

<output>
After completion, create `.planning/phases/21-portfolio-status-screens/21-01-SUMMARY.md`
</output>
