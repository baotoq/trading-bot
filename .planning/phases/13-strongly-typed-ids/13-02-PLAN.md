---
phase: 13-strongly-typed-ids
plan: 02
type: execute
wave: 2
depends_on:
  - "13-01"
files_modified:
  - TradingBot.ApiService/Models/Purchase.cs
  - TradingBot.ApiService/Models/IngestionJob.cs
  - TradingBot.ApiService/Models/DcaConfiguration.cs
  - TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
  - TradingBot.ApiService/Application/Events/PurchaseCompletedEvent.cs
  - TradingBot.ApiService/Application/Services/DcaExecutionService.cs
  - TradingBot.ApiService/Application/Services/ConfigurationService.cs
  - TradingBot.ApiService/Application/Services/HistoricalData/DataIngestionService.cs
  - TradingBot.ApiService/Application/Services/HistoricalData/DataIngestionBackgroundService.cs
  - TradingBot.ApiService/Application/Services/HistoricalData/IngestionJobQueue.cs
  - TradingBot.ApiService/Endpoints/DataEndpoints.cs
  - TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
  - TradingBot.ApiService/Application/Services/HistoricalData/Models/IngestResponse.cs
  - TradingBot.ApiService/Application/Services/HistoricalData/Models/JobStatusResponse.cs
  - TradingBot.ApiService/Application/Services/HistoricalData/Models/DataStatusResponse.cs
  - TradingBot.Dashboard/app/types/dashboard.ts
autonomous: true
requirements:
  - TS-01

must_haves:
  truths:
    - "Purchase entity uses PurchaseId instead of raw Guid for its Id property"
    - "IngestionJob entity uses IngestionJobId instead of raw Guid for its Id property"
    - "DcaConfiguration entity uses DcaConfigurationId with DcaConfigurationId.Singleton default"
    - "All service and handler method signatures use typed IDs throughout the call chain"
    - "IngestionJobQueue uses Channel<IngestionJobId> instead of Channel<Guid>"
    - "API endpoints bind typed IDs from route parameters via Vogen TryParse"
    - "JSON serialization of typed IDs produces plain GUID strings (dashboard unaffected)"
    - "All existing tests pass without changes"
    - "Dashboard TypeScript types use branded types for PurchaseId"
  artifacts:
    - path: "TradingBot.ApiService/Models/Purchase.cs"
      provides: "Purchase entity with PurchaseId typed ID"
      contains: "BaseEntity<PurchaseId>"
    - path: "TradingBot.ApiService/Models/IngestionJob.cs"
      provides: "IngestionJob entity with IngestionJobId typed ID"
      contains: "BaseEntity<IngestionJobId>"
    - path: "TradingBot.ApiService/Models/DcaConfiguration.cs"
      provides: "DcaConfiguration entity with DcaConfigurationId typed ID"
      contains: "BaseEntity<DcaConfigurationId>"
    - path: "TradingBot.ApiService/Application/Services/HistoricalData/IngestionJobQueue.cs"
      provides: "Job queue using typed IngestionJobId"
      contains: "Channel<IngestionJobId>"
    - path: "TradingBot.ApiService/Endpoints/DataEndpoints.cs"
      provides: "Endpoints with typed ID parameters"
      contains: "IngestionJobId jobId"
  key_links:
    - from: "TradingBot.ApiService/Models/Purchase.cs"
      to: "TradingBot.ApiService/Models/Ids/PurchaseId.cs"
      via: "BaseEntity<PurchaseId> inheritance"
      pattern: "BaseEntity<PurchaseId>"
    - from: "TradingBot.ApiService/Application/Services/DcaExecutionService.cs"
      to: "TradingBot.ApiService/Models/Ids/PurchaseId.cs"
      via: "Id = PurchaseId.New() at creation site"
      pattern: "PurchaseId.New\\(\\)"
    - from: "TradingBot.ApiService/Endpoints/DataEndpoints.cs"
      to: "TradingBot.ApiService/Models/Ids/IngestionJobId.cs"
      via: "Vogen TryParse for route parameter binding"
      pattern: "IngestionJobId jobId"
    - from: "TradingBot.ApiService/Application/Services/ConfigurationService.cs"
      to: "TradingBot.ApiService/Models/Ids/DcaConfigurationId.cs"
      via: "DcaConfigurationId.Singleton for singleton entity"
      pattern: "DcaConfigurationId.Singleton"
---

<objective>
Apply typed IDs to all entities (Purchase, IngestionJob, DcaConfiguration), update all callers (services, endpoints, events, queue, DTOs), and add branded TypeScript types to the dashboard.

Purpose: Complete the strongly-typed ID migration so that entity IDs are type-safe throughout the entire codebase -- impossible to pass a PurchaseId where an IngestionJobId is expected.
Output: All entities use typed IDs, all services/endpoints use typed IDs in signatures, dashboard types use branded types. Full solution builds, all tests pass, no schema changes.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-strongly-typed-ids/13-RESEARCH.md
@.planning/phases/13-strongly-typed-ids/13-01-SUMMARY.md

@TradingBot.ApiService/Models/Purchase.cs
@TradingBot.ApiService/Models/IngestionJob.cs
@TradingBot.ApiService/Models/DcaConfiguration.cs
@TradingBot.ApiService/Models/DailyPrice.cs
@TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
@TradingBot.ApiService/Application/Events/PurchaseCompletedEvent.cs
@TradingBot.ApiService/Application/Services/DcaExecutionService.cs
@TradingBot.ApiService/Application/Services/ConfigurationService.cs
@TradingBot.ApiService/Application/Services/HistoricalData/DataIngestionService.cs
@TradingBot.ApiService/Application/Services/HistoricalData/DataIngestionBackgroundService.cs
@TradingBot.ApiService/Application/Services/HistoricalData/IngestionJobQueue.cs
@TradingBot.ApiService/Endpoints/DataEndpoints.cs
@TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
@TradingBot.ApiService/Endpoints/DashboardDtos.cs
@TradingBot.ApiService/Application/Services/HistoricalData/Models/IngestResponse.cs
@TradingBot.ApiService/Application/Services/HistoricalData/Models/JobStatusResponse.cs
@TradingBot.ApiService/Application/Services/HistoricalData/Models/DataStatusResponse.cs
@TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
@TradingBot.Dashboard/app/types/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate entities to typed IDs and remove BaseEntity backward-compat alias</name>
  <files>
    TradingBot.ApiService/Models/Purchase.cs
    TradingBot.ApiService/Models/IngestionJob.cs
    TradingBot.ApiService/Models/DcaConfiguration.cs
    TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
  </files>
  <action>
    1. **Remove the non-generic BaseEntity alias** from `BuildingBlocks/BaseEntity.cs`:
       Delete the `public abstract class BaseEntity : BaseEntity<Guid>` class and its constructor. Only `BaseEntity<TId>` remains.

    2. **Update Purchase.cs**:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - Change `Purchase : BaseEntity` to `Purchase : BaseEntity<PurchaseId>`
       - No other property changes needed — Id is now PurchaseId via the generic base class

    3. **Update IngestionJob.cs**:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - Change `IngestionJob : AuditedEntity` to `IngestionJob : BaseEntity<IngestionJobId>`
       - Remove the explicit `public Guid Id { get; init; } = Guid.CreateVersion7();` line — Id is now inherited from BaseEntity<IngestionJobId>
       - The default value for Id will be set at creation sites using `IngestionJobId.New()`
       - Keep the `using TradingBot.ApiService.Application.Services.HistoricalData.Models;` import for IngestionJobStatus

    4. **Update DcaConfiguration.cs**:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - Change `DcaConfiguration : AuditedEntity` to `DcaConfiguration : BaseEntity<DcaConfigurationId>`
       - Remove the explicit `public Guid Id { get; init; } = Guid.Parse("00000000-0000-0000-0000-000000000001");` line
       - The default singleton ID will be set in the entity initializer or at creation sites using `DcaConfigurationId.Singleton`
       - To preserve the singleton default, add a default to the entity itself:
         ```csharp
         public class DcaConfiguration : BaseEntity<DcaConfigurationId>
         {
             // Override default to use singleton ID
             public new DcaConfigurationId Id { get; init; } = DcaConfigurationId.Singleton;
             ...
         }
         ```
         ALTERNATIVELY (cleaner): Let BaseEntity<TId> have `default!` and set Id at creation sites. Review which approach the creation sites in ConfigurationService.cs use. If they explicitly set Id, the simpler approach (no `new`) works. Check ConfigurationService — it sets `Id = Guid.Parse("00000000-...")` explicitly, so just use `BaseEntity<DcaConfigurationId>` with no override needed.

    5. **DailyPrice.cs**: NO changes. DailyPrice uses composite key (Date, Symbol), extends AuditedEntity directly, has no Guid Id column.

    NOTE: After this task, the project will have compile errors in callers (services, endpoints) that reference `Guid` where typed IDs are now expected. Task 2 fixes all callers.
  </action>
  <verify>
    Files saved correctly. Entity class signatures use typed IDs. (Full build will succeed after Task 2.)
  </verify>
  <done>
    Purchase inherits BaseEntity<PurchaseId>, IngestionJob inherits BaseEntity<IngestionJobId>, DcaConfiguration inherits BaseEntity<DcaConfigurationId>. Non-generic BaseEntity alias removed. DailyPrice unchanged (composite key).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all callers — services, endpoints, events, queue, DTOs, and dashboard types</name>
  <files>
    TradingBot.ApiService/Application/Events/PurchaseCompletedEvent.cs
    TradingBot.ApiService/Application/Services/DcaExecutionService.cs
    TradingBot.ApiService/Application/Services/ConfigurationService.cs
    TradingBot.ApiService/Application/Services/HistoricalData/DataIngestionService.cs
    TradingBot.ApiService/Application/Services/HistoricalData/DataIngestionBackgroundService.cs
    TradingBot.ApiService/Application/Services/HistoricalData/IngestionJobQueue.cs
    TradingBot.ApiService/Endpoints/DataEndpoints.cs
    TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
    TradingBot.ApiService/Endpoints/DashboardDtos.cs
    TradingBot.ApiService/Application/Services/HistoricalData/Models/IngestResponse.cs
    TradingBot.ApiService/Application/Services/HistoricalData/Models/JobStatusResponse.cs
    TradingBot.ApiService/Application/Services/HistoricalData/Models/DataStatusResponse.cs
    TradingBot.Dashboard/app/types/dashboard.ts
  </files>
  <action>
    **Events:**
    1. `PurchaseCompletedEvent.cs`: Change `Guid PurchaseId` to `PurchaseId PurchaseId` (using Models.Ids). Add `using TradingBot.ApiService.Models.Ids;`.

    **Services:**
    2. `DcaExecutionService.cs`:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - At the Purchase creation site (line ~135), add `Id = PurchaseId.New(),` to the object initializer. The old non-generic BaseEntity auto-generated the Id in constructor; now it must be explicit.
       - The `publisher.Publish(new PurchaseCompletedEvent(purchase.Id, ...))` call will work because `purchase.Id` is now `PurchaseId` matching the updated event type.

    3. `ConfigurationService.cs`:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - Change `Id = Guid.Parse("00000000-0000-0000-0000-000000000001")` to `Id = DcaConfigurationId.Singleton` (line ~53).

    4. `DataIngestionService.cs`:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - Change method signature: `RunIngestionAsync(Guid jobId, ...)` to `RunIngestionAsync(IngestionJobId jobId, ...)`
       - Change `db.IngestionJobs.FindAsync([jobId], ct)` to `db.IngestionJobs.FirstOrDefaultAsync(j => j.Id == jobId, ct)` — FindAsync with value-converted keys can have issues with key type matching; LINQ == works through the value converter.

    **Queue:**
    5. `IngestionJobQueue.cs`:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - Change `Channel<Guid>` to `Channel<IngestionJobId>`
       - Change `TryEnqueue(Guid jobId)` to `TryEnqueue(IngestionJobId jobId)`
       - Change `IAsyncEnumerable<Guid>` to `IAsyncEnumerable<IngestionJobId>`
       Per context decision: "service and handler method signatures use typed IDs throughout"

    6. `DataIngestionBackgroundService.cs`:
       - No code changes needed if IngestionJobQueue returns IAsyncEnumerable<IngestionJobId> and DataIngestionService accepts IngestionJobId. The `await foreach (var jobId in ...)` will infer IngestionJobId type. Verify implicit types compile correctly.

    **Endpoints:**
    7. `DataEndpoints.cs`:
       - Add `using TradingBot.ApiService.Models.Ids;`
       - `IngestAsync`: The `job.Id` is now IngestionJobId. Where it's passed to `jobQueue.TryEnqueue(job.Id)` — already matches since queue now takes IngestionJobId.
       - The `new IngestionJob { ... }` creation needs `Id = IngestionJobId.New()` added to the initializer (was auto-generated in old BaseEntity, now must be explicit since IngestionJob previously extended AuditedEntity with explicit Id).
       - `GetJobStatusAsync`: Change parameter from `Guid jobId` to `IngestionJobId jobId`. Change `db.IngestionJobs.FindAsync([jobId], ct)` to `db.IngestionJobs.FirstOrDefaultAsync(j => j.Id == jobId, ct)`.
       - Route constraint `{jobId:guid}` stays — Vogen's TryParse handles the binding. ASP.NET Core validates the string is a valid GUID via the constraint, then calls IngestionJobId.TryParse.
       - In IngestResponse and JobStatusResponse projections: `job.Id` is now IngestionJobId but these DTOs use Guid. Rely on implicit cast (CastOperator.Implicit configured). The implicit conversion TypedId -> Guid handles this transparently.

    8. `DashboardEndpoints.cs`:
       - The PurchaseDto projection `.Select(p => new PurchaseDto(Id: p.Id, ...))` — `p.Id` is now PurchaseId, but PurchaseDto.Id is Guid. Implicit cast handles it. No code change needed.
       - However, verify that EF Core LINQ translation handles the implicit cast in the Select projection. If it causes issues, explicitly cast: `Id: (Guid)p.Id` or use `.Value`. The implicit cast should work since Vogen generates an implicit operator.

    **Response DTOs (keep as Guid for API surface stability):**
    9. `IngestResponse.cs`: Keep `Guid JobId` — DTOs are API surface, not domain. Implicit cast from IngestionJobId to Guid handles the boundary.
    10. `JobStatusResponse.cs`: Keep `Guid JobId` — same reasoning.
    11. `DataStatusResponse.cs` / `IngestionJobSummary`: Keep `Guid JobId` — same reasoning.
    12. `DashboardDtos.cs`: Keep `PurchaseDto.Id` as `Guid` — same reasoning. The implicit cast from PurchaseId to Guid ensures projections work.

    **Dashboard TypeScript types:**
    13. `TradingBot.Dashboard/app/types/dashboard.ts`:
       - Add branded type for PurchaseId at the top of the file:
         ```typescript
         // Branded types for type-safe IDs (mirrors backend strongly-typed IDs)
         export type PurchaseId = string & { readonly __brand: 'PurchaseId' }
         ```
       - Change `PurchaseDto.id` from `string` to `PurchaseId`.
       - This is a TypeScript-only change for frontend type safety. The wire format (JSON) is unchanged — still plain GUID strings.

    **Backtest models**: NO changes. `PurchaseLogEntry`, `BacktestResult`, and other backtest DTOs in `Application/Services/Backtest/` are NOT EF entities. Per context decision: "Only EF Core-mapped entity properties get typed IDs — infrastructure tables (outbox messages, etc.) keep raw Guid." Backtest models are exempt.

    After all changes, run `dotnet build TradingBot.sln` and `dotnet test` to verify everything compiles and all 53 tests pass.
  </action>
  <verify>
    1. `dotnet build TradingBot.sln` — zero errors
    2. `dotnet test` — all 53 tests pass
    3. Grep for remaining `Guid` in entity files: Purchase.cs, IngestionJob.cs, DcaConfiguration.cs should have NO raw Guid for Id properties
    4. Grep for `Channel<Guid>` — should return zero results (replaced with Channel<IngestionJobId>)
    5. Dashboard types compile: `cd TradingBot.Dashboard && npx nuxi typecheck` (if available) or verify no TypeScript errors
  </verify>
  <done>
    All entity IDs use strongly-typed wrappers. All service/endpoint signatures use typed IDs. IngestionJobQueue uses Channel<IngestionJobId>. API DTOs keep Guid for wire stability with implicit cast at boundary. Dashboard TypeScript has branded PurchaseId type. Full solution builds, all tests pass, no schema changes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` — zero errors, zero warnings from typed ID migration
2. `dotnet test` — all 53 tests pass (no behavioral regression)
3. Entity ID types: Purchase.Id is PurchaseId, IngestionJob.Id is IngestionJobId, DcaConfiguration.Id is DcaConfigurationId
4. DailyPrice unchanged (composite key, no typed ID)
5. No `Guid.Parse("00000000-...")` in ConfigurationService — replaced with DcaConfigurationId.Singleton
6. No `Channel<Guid>` in IngestionJobQueue — replaced with Channel<IngestionJobId>
7. No `FindAsync([jobId], ct)` patterns — replaced with FirstOrDefaultAsync LINQ
8. API endpoints still return plain GUID strings in JSON (no dashboard breakage)
9. Dashboard TypeScript PurchaseDto.id uses branded PurchaseId type
</verification>

<success_criteria>
- All entities use strongly-typed ID wrappers (PurchaseId, IngestionJobId, DcaConfigurationId) instead of raw Guid
- EF Core persists and loads entities with typed IDs without schema changes (Guid columns unchanged in database)
- All API endpoints serialize/deserialize typed IDs as plain GUIDs in JSON responses (dashboard unaffected)
- All existing tests pass with typed IDs (no behavioral regression)
- Service and handler method signatures use typed IDs throughout the call chain
- IngestionJobQueue uses Channel<IngestionJobId>
- Dashboard TypeScript uses branded PurchaseId type
</success_criteria>

<output>
After completion, create `.planning/phases/13-strongly-typed-ids/13-02-SUMMARY.md`
</output>
