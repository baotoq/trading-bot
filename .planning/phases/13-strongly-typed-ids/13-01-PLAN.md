---
phase: 13-strongly-typed-ids
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/TradingBot.ApiService.csproj
  - TradingBot.ApiService/Models/Ids/VogenGlobalConfig.cs
  - TradingBot.ApiService/Models/Ids/PurchaseId.cs
  - TradingBot.ApiService/Models/Ids/IngestionJobId.cs
  - TradingBot.ApiService/Models/Ids/DcaConfigurationId.cs
  - TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
  - TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
autonomous: true
requirements:
  - TS-01

must_haves:
  truths:
    - "Vogen 8.0.4 is installed and source generator produces typed ID structs at build time"
    - "PurchaseId, IngestionJobId, and DcaConfigurationId exist as readonly partial structs with UUIDv7 New() factories"
    - "DcaConfigurationId has a static Singleton field matching the DB check constraint GUID"
    - "BaseEntity<TId> is generic and all existing code that referenced BaseEntity still compiles"
    - "EF Core converters are registered globally via ConfigureConventions"
    - "Solution builds without errors"
  artifacts:
    - path: "TradingBot.ApiService/Models/Ids/VogenGlobalConfig.cs"
      provides: "Assembly-level Vogen defaults (Guid underlying, EfCore + STJ converters, implicit cast)"
      contains: "VogenDefaults"
    - path: "TradingBot.ApiService/Models/Ids/PurchaseId.cs"
      provides: "Strongly-typed Purchase ID wrapper"
      contains: "readonly partial struct PurchaseId"
    - path: "TradingBot.ApiService/Models/Ids/IngestionJobId.cs"
      provides: "Strongly-typed IngestionJob ID wrapper"
      contains: "readonly partial struct IngestionJobId"
    - path: "TradingBot.ApiService/Models/Ids/DcaConfigurationId.cs"
      provides: "Strongly-typed DcaConfiguration ID wrapper with Singleton"
      contains: "DcaConfigurationId.Singleton"
    - path: "TradingBot.ApiService/BuildingBlocks/BaseEntity.cs"
      provides: "Generic base entity with typed ID"
      contains: "BaseEntity<TId>"
    - path: "TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs"
      provides: "Global EF Core value converter registration"
      contains: "ConfigureConventions"
  key_links:
    - from: "TradingBot.ApiService/Models/Ids/VogenGlobalConfig.cs"
      to: "All ID types"
      via: "Assembly-level VogenDefaults attribute"
      pattern: "VogenDefaults.*Conversions.EfCoreValueConverter"
    - from: "TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs"
      to: "All ID types"
      via: "ConfigureConventions RegisterAllInEfCoreConverters"
      pattern: "RegisterAllIn.*EfCoreConverters"
---

<objective>
Install Vogen 8.0.4, define all strongly-typed ID types (PurchaseId, IngestionJobId, DcaConfigurationId), refactor BaseEntity to generic BaseEntity<TId>, and register EF Core value converters globally.

Purpose: Establish the typed ID infrastructure so Plan 02 can apply typed IDs to all entities and callers without breaking intermediate compilation.
Output: Three typed ID structs, generic BaseEntity<TId>, and EF Core converter registration. Solution compiles. No entities changed yet.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-strongly-typed-ids/13-RESEARCH.md

@TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
@TradingBot.ApiService/BuildingBlocks/AuditedEntity.cs
@TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
@TradingBot.ApiService/Models/Purchase.cs
@TradingBot.ApiService/Models/IngestionJob.cs
@TradingBot.ApiService/Models/DcaConfiguration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vogen and define typed ID structs with global config</name>
  <files>
    TradingBot.ApiService/TradingBot.ApiService.csproj
    TradingBot.ApiService/Models/Ids/VogenGlobalConfig.cs
    TradingBot.ApiService/Models/Ids/PurchaseId.cs
    TradingBot.ApiService/Models/Ids/IngestionJobId.cs
    TradingBot.ApiService/Models/Ids/DcaConfigurationId.cs
  </files>
  <action>
    1. Install Vogen 8.0.4:
       `dotnet add TradingBot.ApiService/TradingBot.ApiService.csproj package Vogen --version 8.0.4`

    2. Create `Models/Ids/` directory and add `VogenGlobalConfig.cs` with assembly-level defaults:
       ```csharp
       using Vogen;
       [assembly: VogenDefaults(
           underlyingType: typeof(Guid),
           conversions: Conversions.EfCoreValueConverter | Conversions.SystemTextJson,
           castOperator: CastOperator.Implicit)]
       ```
       This configures all typed IDs to: use Guid as underlying type, generate EF Core and STJ converters, and support implicit casting both directions (Guid to TypedId and TypedId to Guid) per user decision.

    3. Create `PurchaseId.cs`:
       ```csharp
       using Vogen;
       namespace TradingBot.ApiService.Models.Ids;
       [ValueObject<Guid>]
       public readonly partial struct PurchaseId
       {
           public static PurchaseId New() => From(Guid.CreateVersion7());
       }
       ```

    4. Create `IngestionJobId.cs` with same pattern (New() using CreateVersion7).

    5. Create `DcaConfigurationId.cs` with New() AND a static Singleton field:
       ```csharp
       public static readonly DcaConfigurationId Singleton =
           From(Guid.Parse("00000000-0000-0000-0000-000000000001"));
       ```
       This preserves the singleton pattern from DcaConfiguration entity.

    NOTE: DailyPriceId is NOT created. DailyPrice uses a composite key (DateOnly Date, string Symbol) with no Guid column. Creating a typed ID for it would require adding a new Guid column, violating the "schema unchanged" constraint. The entity's identity is already captured by its composite key.

    Do NOT use `Customizations.AddFactoryMethodForGuids` in VogenDefaults — it generates `FromNewGuid()` which uses `Guid.NewGuid()` (v4, random). Our hand-written `New()` uses `Guid.CreateVersion7()` (v7, time-ordered) which is required for B-tree index friendliness.
  </action>
  <verify>
    `dotnet build TradingBot.ApiService/TradingBot.ApiService.csproj` succeeds.
    Verify Vogen source generator ran: check that the project compiles with the [ValueObject] attribute recognized (no CS0246 errors).
  </verify>
  <done>
    Three typed ID structs exist (PurchaseId, IngestionJobId, DcaConfigurationId), each with a New() factory using UUIDv7. DcaConfigurationId has a Singleton field. VogenDefaults configures implicit cast + EfCore + STJ converters globally. No DailyPriceId (composite key exception documented).
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor BaseEntity to generic and register EF Core converters</name>
  <files>
    TradingBot.ApiService/BuildingBlocks/BaseEntity.cs
    TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
  </files>
  <action>
    1. Refactor `BuildingBlocks/BaseEntity.cs`:
       - Change `BaseEntity` to `BaseEntity<TId>`
       - Change `public Guid Id { get; init; }` to `public TId Id { get; init; } = default!;`
       - Remove the constructor that sets `Id = Guid.CreateVersion7(CreatedAt)` — with generic TId, the base class cannot auto-generate the ID. Each entity creation site will set Id explicitly via `TypedId.New()`. This is already the pattern used by IngestionJob and DcaConfiguration.
       - Keep inheriting from `AuditedEntity` (unchanged).
       - Result:
         ```csharp
         namespace TradingBot.ApiService.BuildingBlocks;
         public abstract class BaseEntity<TId> : AuditedEntity
         {
             public TId Id { get; init; } = default!;
         }
         ```

    2. Add `ConfigureConventions` override to `TradingBotDbContext`:
       - Add this method override BEFORE the existing `OnModelCreating`:
         ```csharp
         protected override void ConfigureConventions(ModelConfigurationBuilder configurationBuilder)
         {
             base.ConfigureConventions(configurationBuilder);
             configurationBuilder.RegisterAllInEfCoreConverters();
         }
         ```
       - This registers Vogen's generated EfCoreValueConverter + EfCoreValueComparer for all typed IDs globally. No per-property registration needed.
       - The method name `RegisterAllInEfCoreConverters` is generated by Vogen for .NET 8+ projects using assembly-attribute approach.

    IMPORTANT: After this task, existing entity classes (Purchase, IngestionJob, DcaConfiguration) still reference the old non-generic BaseEntity or AuditedEntity. The project must still compile — the old BaseEntity class is being replaced with the generic version. Existing entities that inherit from `BaseEntity` will get a compile error. This is expected and will be fixed in Plan 02. However, to ensure THIS plan leaves the codebase compiling, keep a non-generic `BaseEntity` alias:
       ```csharp
       // Backward-compatible alias — removed in Plan 02 when entities switch to BaseEntity<TId>
       public abstract class BaseEntity : BaseEntity<Guid>
       {
           public BaseEntity()
           {
               Id = Guid.CreateVersion7(CreatedAt);
           }
       }
       ```
    This ensures Purchase (which inherits BaseEntity) still compiles. Plan 02 will remove this alias when all entities switch to BaseEntity<TId>.
  </action>
  <verify>
    `dotnet build TradingBot.sln` succeeds (entire solution, not just ApiService).
    `dotnet test` — all 53 existing tests pass (no behavioral regression).
  </verify>
  <done>
    BaseEntity<TId> is generic with typed Id property. Non-generic BaseEntity alias exists for backward compatibility. TradingBotDbContext registers Vogen EF Core converters globally via ConfigureConventions. Full solution builds. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` — entire solution compiles
2. `dotnet test` — all 53 tests pass
3. Three ID types exist in Models/Ids/ with correct patterns
4. BaseEntity<TId> is generic; non-generic BaseEntity alias still present for backward compat
5. TradingBotDbContext has ConfigureConventions override with Vogen registration
</verification>

<success_criteria>
- Vogen 8.0.4 installed and source-generating typed ID structs
- PurchaseId, IngestionJobId, DcaConfigurationId defined with UUIDv7 New() factory
- DcaConfigurationId.Singleton matches "00000000-0000-0000-0000-000000000001"
- BaseEntity<TId> is generic; backward-compatible BaseEntity alias keeps existing code compiling
- EF Core converters registered globally via ConfigureConventions
- Full solution builds, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-strongly-typed-ids/13-01-SUMMARY.md`
</output>
