---
phase: 35-chart-redesign
plan: 02
type: execute
wave: 2
depends_on:
  - "35-01"
files_modified:
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart
  - TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
autonomous: true
requirements:
  - CHART-04
  - SCRN-02

must_haves:
  truths:
    - "Touching the chart displays a frosted glass tooltip with rounded corners showing the date and locale-formatted price"
    - "Releasing touch or dragging away dismisses the tooltip"
    - "The tooltip renders as a GlassCard (BackdropFilter frosted glass), not a flat colored rectangle"
    - "The Chart tab displays the premium chart with gradient glow fill, animated draw-in, glow markers, and glass tooltip as a cohesive screen"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart"
      provides: "GlassCard-based tooltip overlay widget positioned above touch point"
      contains: "GlassChartTooltip"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      provides: "Updated chart with custom touch handling and tooltip state"
      contains: "touchedSpot"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart"
      provides: "Chart screen layout updated for Stack-based tooltip overlay"
      contains: "Stack"
  key_links:
    - from: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      to: "TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart"
      via: "tooltip overlay rendered in Stack"
      pattern: "GlassChartTooltip"
    - from: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      to: "TradingBot.Mobile/lib/core/widgets/glass_card.dart"
      via: "GlassCard used for tooltip rendering"
      pattern: "GlassCard"
---

<objective>
Add a frosted glass tooltip overlay to the chart and finalize the ChartScreen layout for the complete premium chart experience.

Purpose: CHART-04 requires the chart tooltip to use a frosted glass style instead of the existing flat dark rectangle. SCRN-02 is the composite requirement that the chart screen displays the full premium visualization (gradient glow chart + glass tooltip + animated draw-in). fl_chart's built-in tooltip only accepts a `Color` via `getTooltipColor` — it cannot host a `BackdropFilter` widget tree. The solution is the custom overlay pattern: disable built-in tooltip rendering (but keep the indicator line), track the touched spot in state, and overlay a `GlassCard`-positioned tooltip on top of the chart via `Stack`.

Output: New `glass_chart_tooltip.dart` widget, updated `price_line_chart.dart` with custom touch handling and Stack overlay, and updated `chart_screen.dart` layout.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-chart-redesign/35-RESEARCH.md
@.planning/phases/35-chart-redesign/35-01-SUMMARY.md

@TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
@TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
@TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/core/widgets/glass_card.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlassChartTooltip widget and integrate custom touch handling into PriceLineChart</name>
  <files>
    TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart
    TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
  </files>
  <action>
**Part A: Create `glass_chart_tooltip.dart`**

Create a new `GlassChartTooltip` StatelessWidget that renders a positioned glass tooltip:

```dart
class GlassChartTooltip extends StatelessWidget {
  const GlassChartTooltip({
    required this.date,
    required this.price,
    required this.horizontalPosition,
    required this.chartWidth,
    super.key,
  });

  final String date;       // formatted date string
  final double price;      // raw price value
  final double horizontalPosition;  // x position as fraction 0.0-1.0
  final double chartWidth; // chart container width in pixels
}
```

The `build` method should:
1. Format price using `NumberFormat.currency(symbol: '\$', decimalDigits: 0)`.
2. Calculate tooltip left position: `horizontalPosition * chartWidth`. Clamp the tooltip so it stays within the chart width (e.g., clamp between 8 and chartWidth - tooltipWidth - 8, where tooltipWidth is ~120).
3. Return a `Positioned` widget with `top: 8` and `left: clampedLeft`.
4. Child is a `GlassCard` (stationary variant, default) with:
   - `padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8)`
   - `borderRadius: 12`
   - Child is a `Column(mainAxisSize: MainAxisSize.min, crossAxisAlignment: CrossAxisAlignment.start)` containing:
     - `Text(date)` with `Colors.white70, fontSize: 11`
     - `Text(formattedPrice)` with `AppTheme.moneyStyle.copyWith(color: Colors.white, fontSize: 14, fontWeight: FontWeight.bold)`

Import `GlassCard`, `AppTheme`, and `intl` for `NumberFormat`.

**Part B: Update `price_line_chart.dart` with custom touch handling**

The PriceLineChart (already a HookConsumerWidget from plan 01) needs these changes:

1. **Add a new callback parameter** to PriceLineChart:
   ```dart
   final ValueChanged<TouchedChartSpot?>? onSpotTouched;
   ```
   Where `TouchedChartSpot` is a small data class defined in the same file (or in a shared location):
   ```dart
   class TouchedChartSpot {
     const TouchedChartSpot({
       required this.date,
       required this.price,
       required this.xFraction,
     });
     final String date;
     final double price;
     final double xFraction; // x position as fraction of total data range (0.0 to 1.0)
   }
   ```

2. **Update `LineTouchData`** in the existing chart configuration:
   - Keep `handleBuiltInTouches: true` (this preserves the vertical indicator line).
   - Set `getTooltipItems: (_) => [null]` to suppress the built-in tooltip text while keeping the indicator.
   - Add a `touchCallback`:
     ```dart
     touchCallback: (FlTouchEvent event, LineTouchResponse? response) {
       if (event is FlTapUpEvent || event is FlPanEndEvent || event is FlLongPressEnd) {
         onSpotTouched?.call(null);
         return;
       }
       if (response?.lineBarSpots != null && response!.lineBarSpots!.isNotEmpty) {
         final spot = response.lineBarSpots!.firstWhere(
           (s) => s.barIndex == 0,
           orElse: () => response.lineBarSpots!.first,
         );
         final xIndex = spot.x.toInt();
         final dateLabel = xIndex < dateLabels.length ? dateLabels[xIndex] : '';
         final totalPoints = data.prices.length;
         final xFraction = totalPoints > 1 ? spot.x / (totalPoints - 1) : 0.5;
         onSpotTouched?.call(TouchedChartSpot(
           date: dateLabel,
           price: spot.y,
           xFraction: xFraction,
         ));
       }
     },
     ```
   - Style the indicator line to be a subtle white vertical line via `getTouchedSpotIndicator`:
     ```dart
     getTouchedSpotIndicator: (barData, spotIndexes) {
       return spotIndexes.map((index) {
         return TouchedSpotIndicatorData(
           const FlLine(color: Colors.white38, strokeWidth: 1),
           FlDotData(show: false),
         );
       }).toList();
     },
     ```

3. **Remove the old `getTooltipColor`** and `getTooltipItems` from `LineTouchTooltipData` since we no longer need the built-in tooltip.

**Part C: Update PriceLineChart to include Stack with tooltip overlay**

Instead of having the chart's Stack externally in ChartScreen (which would require passing layout dimensions around), make PriceLineChart itself return a `LayoutBuilder` + `Stack`:

1. Wrap the existing `AspectRatio > Padding > LineChart` widget in a `Stack`.
2. Add a `useState<TouchedChartSpot?>(null)` in the build method for `touchedSpot`.
3. Wire `onSpotTouched` to update `touchedSpot.value`.
4. Actually, since PriceLineChart IS a HookConsumerWidget, manage the touch state internally:
   - Add `final touchedSpot = useState<TouchedChartSpot?>(null);` in build.
   - Wire the `touchCallback` to update `touchedSpot.value` directly (no callback parameter needed).
   - Wrap the result in `LayoutBuilder` to get the chart width.
   - Return:
     ```dart
     LayoutBuilder(builder: (context, constraints) {
       return Stack(
         clipBehavior: Clip.none,
         children: [
           AspectRatio(
             aspectRatio: 1.6,
             child: Padding(
               padding: const EdgeInsets.only(right: 8, top: 8),
               child: LineChart(...),
             ),
           ),
           if (touchedSpot.value != null)
             GlassChartTooltip(
               date: touchedSpot.value!.date,
               price: touchedSpot.value!.price,
               horizontalPosition: touchedSpot.value!.xFraction,
               chartWidth: constraints.maxWidth,
             ),
         ],
       );
     });
     ```

This approach keeps the tooltip positioning self-contained within PriceLineChart and avoids leaking chart internals to ChartScreen.

Remove the `TouchedChartSpot` class and `onSpotTouched` callback — manage it all internally via `useState`.

Import `glass_chart_tooltip.dart`.

IMPORTANT: Use `withAlpha(int)` not `withOpacity(float)` per project decision. Keep the `_tierColor` static method, the `_xInterval` method, and all axis/grid configuration unchanged.
  </action>
  <verify>Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && dart analyze lib/features/chart/` — no errors.</verify>
  <done>GlassChartTooltip widget exists with GlassCard rendering. PriceLineChart manages touch state internally via useState, suppresses built-in tooltip, keeps indicator line, and overlays GlassChartTooltip via Stack+LayoutBuilder. Touch up/pan end dismisses the tooltip.</done>
</task>

<task type="auto">
  <name>Task 2: Update ChartScreen layout for premium chart integration</name>
  <files>TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart</files>
  <action>
The ChartScreen currently wraps PriceLineChart in `SingleChildScrollView > Padding`. Since PriceLineChart now returns a `LayoutBuilder > Stack` with `AspectRatio` internally, the ChartScreen needs minor layout adjustments:

1. **Remove the `SingleChildScrollView` wrapper** around PriceLineChart. The chart with its `AspectRatio` and `Stack` overlay should sit directly inside the `Expanded` widget. The `SingleChildScrollView` was needed when the chart was a bare widget, but now the `Stack` with `Clip.none` needs to render without scroll clipping to allow the tooltip to overflow if needed.

   Replace:
   ```dart
   AsyncData(:final value) => SingleChildScrollView(
       physics: const AlwaysScrollableScrollPhysics(),
       child: Padding(
         padding: const EdgeInsets.symmetric(horizontal: 8),
         child: PriceLineChart(
           data: value,
           timeframe: selectedTimeframe.value,
         ),
       ),
     ),
   ```
   With:
   ```dart
   AsyncData(:final value) => Padding(
       padding: const EdgeInsets.symmetric(horizontal: 8),
       child: PriceLineChart(
         data: value,
         timeframe: selectedTimeframe.value,
       ),
     ),
   ```

2. **Apply the same change** to the `AsyncError() when cachedValue != null` branch.

3. **Keep the `RefreshIndicator`** wrapping the `Column` for pull-to-refresh support. Since RefreshIndicator needs a scrollable child, wrap the `Column` in a `ListView` instead:
   - Change `Column` to use a `CustomScrollView` with `SliverToBoxAdapter` children, OR
   - Simpler: Wrap the `Column` content in a `SingleChildScrollView` at the Column level and use `Expanded` with `shrinkWrap` for the chart.

   Actually, the simplest approach that preserves RefreshIndicator: Keep the current structure but replace `SingleChildScrollView` with a plain `Align(alignment: Alignment.topCenter)` wrapper. The chart's `AspectRatio` gives it a fixed height, so no scrolling is needed. For RefreshIndicator to work, use `physics: const AlwaysScrollableScrollPhysics()` on the outer `Column` or wrap in a `ListView`:

   The cleanest approach:
   ```dart
   body: RefreshIndicator(
     onRefresh: () => ref.refresh(
       chartDataProvider(timeframe: selectedTimeframe.value).future,
     ),
     child: ListView(
       physics: const AlwaysScrollableScrollPhysics(),
       children: [
         Padding(
           padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
           child: TimeframeSelector(...),
         ),
         switch (chartData) {
           AsyncData(:final value) => Padding(
             padding: const EdgeInsets.symmetric(horizontal: 8),
             child: PriceLineChart(
               data: value,
               timeframe: selectedTimeframe.value,
             ),
           ),
           AsyncError() when cachedValue != null => Padding(
             padding: const EdgeInsets.symmetric(horizontal: 8),
             child: PriceLineChart(
               data: cachedValue,
               timeframe: selectedTimeframe.value,
             ),
           ),
           AsyncError() => RetryWidget(
             onRetry: () => ref.invalidate(
               chartDataProvider(timeframe: selectedTimeframe.value),
             ),
           ),
           _ => _buildLoadingSkeleton(),
         },
       ],
     ),
   ),
   ```

   This replaces `Column` + `Expanded` with `ListView` which is inherently scrollable (needed for RefreshIndicator) and allows the chart's `AspectRatio` to determine its own height without needing `Expanded`.

4. **No changes to skeleton** — the loading skeleton stays the same.

5. **No changes to AppBar, error handling, or snackbar logic** — those remain identical.
  </action>
  <verify>Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && dart analyze lib/features/chart/` — no errors. Verify the ChartScreen uses `ListView` with `AlwaysScrollableScrollPhysics` and does not wrap PriceLineChart in `SingleChildScrollView`.</verify>
  <done>ChartScreen uses ListView layout that allows PriceLineChart's internal Stack+tooltip to render without scroll clipping. RefreshIndicator still works for pull-to-refresh. Chart fills its natural AspectRatio height within the scrollable list.</done>
</task>

</tasks>

<verification>
1. `cd TradingBot.Mobile && dart analyze lib/features/chart/` — no errors.
2. Confirm `glass_chart_tooltip.dart` exists with `GlassCard` usage and `NumberFormat.currency` formatting.
3. Confirm `price_line_chart.dart` has `useState<TouchedChartSpot?>`, `touchCallback`, suppressed built-in tooltip items, and `GlassChartTooltip` in Stack.
4. Confirm `chart_screen.dart` uses `ListView` (not `Column` + `Expanded`), no `SingleChildScrollView` wrapping PriceLineChart.
5. Confirm no `withOpacity` calls in any modified file.
6. Confirm indicator line still shows on touch (via `getTouchedSpotIndicator`).
</verification>

<success_criteria>
- Touching the chart shows a frosted glass tooltip with date and formatted price
- Releasing touch dismisses the tooltip
- The tooltip is a GlassCard with BackdropFilter blur (not a flat colored rectangle)
- Tooltip stays within chart bounds (clamped horizontally)
- Vertical indicator line still appears on touch
- Pull-to-refresh still works on ChartScreen
- All existing chart features preserved (gradient, draw-in, glow dots from Plan 01)
- `dart analyze` clean across all chart files
</success_criteria>

<output>
After completion, create `.planning/phases/35-chart-redesign/35-02-SUMMARY.md`
</output>
