---
phase: 35-chart-redesign
plan: 02
type: execute
wave: 2
depends_on:
  - "35-01"
files_modified:
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
  - TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
autonomous: true
requirements:
  - CHART-04
  - SCRN-02

must_haves:
  truths:
    - "Touching the chart displays a frosted glass tooltip with the date and locale-formatted price"
    - "The glass tooltip has rounded corners and uses GlassCard (stationary variant) for frosted blur"
    - "The tooltip disappears when the user lifts their finger or pans away from the chart"
    - "A vertical indicator line appears at the touched x position"
    - "The Chart screen layout is premium-styled with the glass tooltip overlaid above the chart"
    - "The ChartScreen uses an Expanded chart area (not AspectRatio) for better tooltip positioning"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart"
      provides: "Frosted glass tooltip overlay widget"
      contains: "class GlassChartTooltip"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      provides: "Chart with custom touch handling for glass tooltip"
      contains: "handleBuiltInTouches"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart"
      provides: "Premium chart screen layout with Stack for tooltip overlay"
      contains: "Stack"
  key_links:
    - from: "price_line_chart.dart"
      to: "glass_chart_tooltip.dart"
      via: "GlassChartTooltip widget rendered in Stack overlay"
      pattern: "GlassChartTooltip\\("
    - from: "price_line_chart.dart"
      to: "glass_card.dart"
      via: "GlassCard used inside GlassChartTooltip for frosted surface"
      pattern: "GlassCard\\("
    - from: "chart_screen.dart"
      to: "price_line_chart.dart"
      via: "Expanded layout replacing AspectRatio for proper Stack overlay"
      pattern: "Expanded"
---

<objective>
Implement the frosted glass chart tooltip and update ChartScreen layout to deliver a premium chart experience with proper glass overlay positioning.

Purpose: Completes the chart redesign by adding the glass tooltip (CHART-04) and establishing the premium ChartScreen layout (SCRN-02). The custom overlay pattern replaces fl_chart's built-in tooltip which only supports flat colors, enabling a true BackdropFilter frosted glass appearance.

Output: New GlassChartTooltip widget, updated PriceLineChart with custom touch handling, and premium ChartScreen layout.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-chart-redesign/35-RESEARCH.md
@.planning/phases/35-chart-redesign/35-01-SUMMARY.md

@TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
@TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
@TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
@TradingBot.Mobile/lib/core/widgets/glass_card.dart
@TradingBot.Mobile/lib/app/theme.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlassChartTooltip and add custom touch handling to PriceLineChart</name>
  <files>
    TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart
    TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
  </files>
  <action>
**1. Create `glass_chart_tooltip.dart`:**

Create `TradingBot.Mobile/lib/features/chart/presentation/widgets/glass_chart_tooltip.dart` as a stateless widget.

```dart
class GlassChartTooltip extends StatelessWidget {
  const GlassChartTooltip({
    required this.date,
    required this.price,
    super.key,
  });

  final String date;
  final String price;
```

Implementation:
- Renders a `GlassCard` (default stationary variant for frosted blur) with:
  - `padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8)`
  - `borderRadius: 12`
- Child is a `Column(mainAxisSize: MainAxisSize.min, crossAxisAlignment: CrossAxisAlignment.start)` with:
  - Date text: `TextStyle(color: Colors.white70, fontSize: 11)`
  - Price text: Uses `AppTheme.moneyStyle.copyWith(color: Colors.white, fontSize: 14, fontWeight: FontWeight.bold)`
- The widget itself does NOT handle positioning -- it is placed inside a `Positioned` by the parent `Stack` in PriceLineChart.

**2. Modify PriceLineChart to expose tooltip state and wrap chart in Stack:**

The key architectural change: PriceLineChart must now expose the touched spot as state and render a `Stack` with the `LineChart` and the glass tooltip overlay.

Add a `touchedSpot` state via `useState<LineBarSpot?>(null)` in the build method.

**3. Replace built-in tooltip with custom touch handling:**

Replace the existing `lineTouchData` section. Use the approach from 35-RESEARCH.md Pattern 3 (Pitfall 4 solution):

- Keep `handleBuiltInTouches: true` to preserve the vertical indicator line
- Set `getTooltipItems: (touchedSpots) => touchedSpots.map((_) => null).toList()` to hide the built-in tooltip text (returns null for each item, suppressing the tooltip rectangle)
- Add `touchCallback` to track the touched spot for the custom overlay:

```dart
touchCallback: (FlTouchEvent event, LineTouchResponse? response) {
  if (event is FlTapUpEvent || event is FlPanEndEvent || event is FlLongPressEnd) {
    touchedSpot.value = null;
    return;
  }
  if (response?.lineBarSpots != null && response!.lineBarSpots!.isNotEmpty) {
    final spot = response.lineBarSpots!
        .where((s) => s.barIndex == 0)
        .firstOrNull;
    touchedSpot.value = spot;
  }
},
```

This keeps the vertical indicator line (from `handleBuiltInTouches: true`) while suppressing the built-in tooltip text and tracking touch position for the custom glass overlay.

**4. Configure touch indicator styling:**

Add `getTouchedSpotIndicator` to style the vertical indicator line:

```dart
getTouchedSpotIndicator: (barData, spotIndexes) {
  return spotIndexes.map((index) {
    return TouchedSpotIndicatorData(
      const FlLine(
        color: Colors.white38,
        strokeWidth: 1,
        dashArray: [4, 4],
      ),
      FlDotData(show: false), // Don't show extra dot on indicator
    );
  }).toList();
},
```

**5. Wrap the LineChart in a Stack with the glass tooltip:**

Replace the direct `LineChart(...)` return with:

```dart
return Stack(
  clipBehavior: Clip.none,
  children: [
    // Existing AspectRatio > Padding > LineChart (preserved from Plan 01)
    AspectRatio(
      aspectRatio: 1.6,
      child: Padding(
        padding: const EdgeInsets.only(right: 8, top: 8),
        child: LineChart(lineChartData),
      ),
    ),
    // Glass tooltip overlay
    if (touchedSpot.value != null)
      _buildTooltipOverlay(context, touchedSpot.value!, dateLabels),
  ],
);
```

**6. Implement `_buildTooltipOverlay` method:**

```dart
Widget _buildTooltipOverlay(BuildContext context, LineBarSpot spot, List<String> dateLabels) {
  final xIndex = spot.x.toInt();
  final dateStr = xIndex < dateLabels.length ? dateLabels[xIndex] : '';
  String formattedDate = dateStr;
  try {
    final date = DateTime.parse(dateStr);
    formattedDate = DateFormat('MMM d, yyyy').format(date);
  } catch (_) {}

  final priceFormat = NumberFormat.currency(symbol: '\$', decimalDigits: 0);

  return Positioned(
    top: 0,
    left: 16,
    right: 16,
    child: Center(
      child: GlassChartTooltip(
        date: formattedDate,
        price: priceFormat.format(spot.y),
      ),
    ),
  );
}
```

Positioning approach: The tooltip is anchored at `top: 0` of the Stack (above the chart area) and centered horizontally. This avoids the complex pixel-position calculation from 35-RESEARCH.md Open Question #1, using a simple centered approach that works reliably. The tooltip sits above the chart content area.

Import the new file: `import 'glass_chart_tooltip.dart';`
Import GlassCard if not already: `import '../../../../core/widgets/glass_card.dart';`
  </action>
  <verify>
Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze lib/features/chart/presentation/widgets/` -- zero errors.

Verify:
- `glass_chart_tooltip.dart` exists with `GlassChartTooltip` widget using `GlassCard`
- `price_line_chart.dart` contains `useState<LineBarSpot?>(null)`
- `price_line_chart.dart` contains `touchCallback`
- `price_line_chart.dart` contains `Stack` wrapping the chart
- `price_line_chart.dart` contains `GlassChartTooltip` in the overlay
- Built-in tooltip items suppressed via null returns
- Indicator line styled with dashed white line
  </verify>
  <done>
GlassChartTooltip renders a frosted glass surface with date and formatted price. PriceLineChart tracks touch state via useState, suppresses built-in tooltip text while keeping the vertical indicator line, and renders the glass tooltip in a Stack overlay positioned above the chart. Touch-up/pan-end dismisses the tooltip.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ChartScreen layout for premium chart display</name>
  <files>
    TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
  </files>
  <action>
**1. Update ChartScreen layout to accommodate the new premium chart:**

The ChartScreen currently wraps PriceLineChart in `SingleChildScrollView > Padding`. For the glass tooltip overlay to work correctly (Stack needs non-scrolling parent), adjust the layout:

- Remove the `SingleChildScrollView` wrapper around `PriceLineChart` in both the `AsyncData` and stale-cache branches
- Replace with a direct `Padding` wrapper since the chart uses `AspectRatio` (which has intrinsic size) inside a `Column > Expanded`
- The `Expanded` widget (already present) gives the chart area flexible space

Updated layout for the data branches:

```dart
AsyncData(:final value) => Padding(
  padding: const EdgeInsets.symmetric(horizontal: 8),
  child: PriceLineChart(
    data: value,
    timeframe: selectedTimeframe.value,
  ),
),
```

Apply same change to the `AsyncError() when cachedValue != null` branch.

**2. Keep RefreshIndicator working:**

Since we removed `SingleChildScrollView`, the `RefreshIndicator` needs a scrollable child to function. The simplest fix: wrap the entire `Column` body in a `SingleChildScrollView` at the top level (replacing the per-branch scrollview), OR convert the body to a `ListView`:

Preferred approach: Move `RefreshIndicator` to wrap a `SingleChildScrollView` around the full column content, but keep `PriceLineChart` outside the inner scroll (since Stack + overflow needs stable layout). Alternatively, use `RefreshIndicator` with `notificationPredicate: (_) => true` on a non-scrollable widget, which is an antipattern.

Simplest correct approach: Keep `SingleChildScrollView` but add `physics: const AlwaysScrollableScrollPhysics()` at the outer level and let the inner content be non-scrolling:

```dart
body: RefreshIndicator(
  onRefresh: () => ref.refresh(
    chartDataProvider(timeframe: selectedTimeframe.value).future,
  ),
  child: SingleChildScrollView(
    physics: const AlwaysScrollableScrollPhysics(),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Timeframe selector
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          child: TimeframeSelector(
            selected: selectedTimeframe.value,
            onChanged: (tf) => selectedTimeframe.value = tf,
          ),
        ),
        // Chart area
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 8),
          child: switch (chartData) {
            AsyncData(:final value) => PriceLineChart(
                data: value,
                timeframe: selectedTimeframe.value,
              ),
            AsyncError() when cachedValue != null => PriceLineChart(
                data: cachedValue,
                timeframe: selectedTimeframe.value,
              ),
            AsyncError() => RetryWidget(
                onRetry: () => ref.invalidate(
                  chartDataProvider(timeframe: selectedTimeframe.value),
                ),
              ),
            _ => _buildLoadingSkeleton(),
          },
        ),
      ],
    ),
  ),
),
```

This removes the `Expanded` + inner `SingleChildScrollView` nesting, making the layout simpler. The chart with `AspectRatio(1.6)` has intrinsic height, so it works inside a `SingleChildScrollView > Column` without `Expanded`.

**3. Remove the Scaffold AppBar title and style it as premium:**

Update the AppBar to use a more premium look:

```dart
appBar: AppBar(
  title: const Text('Price Chart'),
  backgroundColor: Colors.transparent,
  elevation: 0,
),
```

The transparent background lets AmbientBackground orbs show through the app bar area.

**4. Verify the loading skeleton still works:**

The `_buildLoadingSkeleton()` method should work unchanged since it was already inside a scroll context. Verify the skeleton is still visible when data is loading.
  </action>
  <verify>
Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze` -- zero errors across entire project.

Verify:
- `chart_screen.dart` does not nest `SingleChildScrollView` inside `Expanded` (simplified layout)
- `chart_screen.dart` keeps `RefreshIndicator` functional with pull-to-refresh
- `chart_screen.dart` has transparent AppBar background
- PriceLineChart is rendered without extra SingleChildScrollView wrapper
- Loading skeleton and retry widget paths still work
  </verify>
  <done>
ChartScreen layout simplified to SingleChildScrollView > Column with PriceLineChart directly inside (no nested scroll views). Pull-to-refresh works via outer RefreshIndicator. AppBar has transparent background for AmbientBackground visibility. Glass tooltip from PriceLineChart's internal Stack overlays correctly without clipping. Premium chart screen layout complete (SCRN-02).
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with zero errors across entire project
2. `glass_chart_tooltip.dart` exists with GlassCard-based frosted tooltip
3. Touching chart shows glass tooltip with date and formatted price
4. Tooltip disappears on finger lift / pan away
5. Vertical dashed indicator line appears at touch position
6. ChartScreen has simplified layout without nested scroll views
7. Pull-to-refresh still works
8. AppBar is transparent for AmbientBackground visibility
9. Loading skeleton renders correctly
10. No `withOpacity` calls in any new/modified code
</verification>

<success_criteria>
- Glass tooltip with frosted blur surface appears on chart touch (CHART-04)
- Tooltip shows locale-formatted date and price with rounded corners
- Vertical indicator line visible at touch position
- ChartScreen layout is premium with transparent AppBar and simplified structure (SCRN-02)
- Pull-to-refresh and loading states still function
- All accessibility guards (reduce motion, reduce transparency) respected via GlassCard
</success_criteria>

<output>
After completion, create `.planning/phases/35-chart-redesign/35-02-SUMMARY.md`
</output>
