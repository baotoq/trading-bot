---
phase: 35-chart-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
autonomous: true
requirements:
  - CHART-01
  - CHART-02
  - CHART-03

must_haves:
  truths:
    - "The price line chart shows an orange-to-transparent gradient fill area beneath the line that appears more vivid/glowing than the previous subtle fill"
    - "On first entry to the Chart tab each session, the chart line draws in from left to right over ~1 second with easeInOut curve"
    - "Switching away from Chart tab and back does NOT re-trigger the draw-in animation"
    - "Purchase marker dots display a radial glow halo distinct from the solid inner dot"
    - "Purchase dots are hidden during draw-in animation and appear only when animation completes"
    - "When Reduce Motion is enabled, the chart renders fully immediately with no draw-in animation"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart"
      provides: "FlDotPainter subclass with radial gradient glow halo"
      contains: "class GlowDotPainter extends FlDotPainter"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      provides: "Upgraded HookConsumerWidget with draw-in animation and enhanced gradient"
      contains: "class PriceLineChart extends HookConsumerWidget"
  key_links:
    - from: "price_line_chart.dart"
      to: "glow_dot_painter.dart"
      via: "GlowDotPainter import in getDotPainter callback"
      pattern: "GlowDotPainter\\("
    - from: "price_line_chart.dart"
      to: "glass_card.dart"
      via: "GlassCard.shouldReduceMotion for animation gate"
      pattern: "GlassCard\\.shouldReduceMotion"
---

<objective>
Create the GlowDotPainter for purchase marker glow halos, and upgrade PriceLineChart from StatelessWidget to HookConsumerWidget with left-to-right draw-in animation and enhanced gradient glow fill.

Purpose: Delivers the core chart visual upgrades (CHART-01 gradient, CHART-02 draw-in, CHART-03 glow dots) that transform the price chart from a basic fl_chart rendering into a premium visualization.

Output: Two Dart files -- a new GlowDotPainter widget and an upgraded PriceLineChart with animation.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-chart-redesign/35-RESEARCH.md

@TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
@TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
@TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
@TradingBot.Mobile/lib/core/widgets/glass_card.dart
@TradingBot.Mobile/lib/app/theme.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlowDotPainter and upgrade PriceLineChart with draw-in animation and gradient</name>
  <files>
    TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart
    TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
  </files>
  <action>
**1. Create `glow_dot_painter.dart`:**

Create a new file `TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart` implementing a custom `FlDotPainter` subclass.

```dart
class GlowDotPainter extends FlDotPainter {
  const GlowDotPainter({
    required this.color,
    this.radius = 5.0,
    this.glowColor,
    this.strokeColor = Colors.white,
  });

  final Color color;
  final Color? glowColor;
  final double radius;
  final Color strokeColor;
```

Implementation details:
- `draw()` method paints TWO layers on the Canvas:
  1. Outer glow halo at `radius * 2.5` using `RadialGradient.createShader(Rect.fromCircle(...))` with colors `[effectiveGlowColor.withAlpha(153), effectiveGlowColor.withAlpha(0)]` and stops `[0.0, 1.0]`
  2. Inner solid circle at `radius` with `color` fill, plus a `strokeColor` stroke at 1.5 width
- `glowColor` defaults to `color` if null (via `effectiveGlowColor = glowColor ?? color`)
- Override `mainColor` to return `color`
- Override `getSize()` to return `Size(radius * 2.5 * 2, radius * 2.5 * 2)` (full glow halo extent)
- Override `hitTest()` using `(touched - center).distance <= radius + extraThreshold`
- Use `withAlpha(int)` everywhere (NOT `withOpacity`) per project convention

**2. Upgrade `price_line_chart.dart` from StatelessWidget to HookConsumerWidget:**

Change `class PriceLineChart extends StatelessWidget` to `class PriceLineChart extends HookConsumerWidget`.

Add required imports:
- `import 'package:flutter_hooks/flutter_hooks.dart';`
- `import 'package:hooks_riverpod/hooks_riverpod.dart';`
- `import '../../../../core/widgets/glass_card.dart';`
- `import 'glow_dot_painter.dart';`
- `import 'dart:math' show max;`

Change `build(BuildContext context)` to `build(BuildContext context, WidgetRef ref)`.

**3. Add draw-in animation logic inside build():**

```dart
final hasAnimated = useRef(false);
final controller = useAnimationController(
  duration: const Duration(milliseconds: 1000),
);
final animation = useAnimation(
  CurvedAnimation(parent: controller, curve: Curves.easeInOut),
);

useEffect(() {
  if (!hasAnimated.value && !GlassCard.shouldReduceMotion(context)) {
    hasAnimated.value = true;
    controller.forward();
  } else if (!hasAnimated.value) {
    // Reduce motion: skip animation, mark as animated
    hasAnimated.value = true;
    controller.value = 1.0;
  } else {
    // Already animated on a previous build (tab revisit) -- show full chart
    controller.value = 1.0;
  }
  return null;
}, [data]);
```

Key detail: `useRef<bool>(false)` as `hasAnimated` guard ensures the draw-in fires ONLY once per session (not on every tab revisit). This is the `_hasAnimated` guard pattern documented in STATE.md.

**4. Slice priceSpots for draw-in:**

```dart
final totalSpots = priceSpots.length;
final visibleCount = controller.isCompleted || GlassCard.shouldReduceMotion(context)
    ? totalSpots
    : max(1, (animation * totalSpots).round());
final visiblePriceSpots = priceSpots.sublist(0, visibleCount);
```

Pass `visiblePriceSpots` (not `priceSpots`) to the first `LineChartBarData`. Also set:
- `clipData: const FlClipData.all()` on `LineChartData` to prevent overdraw
- `maxX: visiblePriceSpots.last.x` to constrain the visible x-axis range during animation

**5. Hide purchase dots during draw-in animation:**

Set the second `LineChartBarData` (purchase markers) to `show: controller.isCompleted` on `FlDotData`. This hides all purchase dots until the draw-in completes, avoiding the pitfall of dots floating in empty space during animation.

```dart
dotData: FlDotData(
  show: purchaseSpots.isNotEmpty && controller.isCompleted,
  // ... rest unchanged
),
```

**6. Replace FlDotCirclePainter with GlowDotPainter in getDotPainter:**

Change:
```dart
getDotPainter: (spot, _, __, ___) => FlDotCirclePainter(
  radius: 5,
  color: _tierColor(purchasesByIndex[spot.x.toInt()]?.tier ?? 'Base'),
  strokeWidth: 1.5,
  strokeColor: Colors.white,
),
```

To:
```dart
getDotPainter: (spot, _, __, ___) => GlowDotPainter(
  radius: 5,
  color: _tierColor(purchasesByIndex[spot.x.toInt()]?.tier ?? 'Base'),
  glowColor: AppTheme.bitcoinOrange,
  strokeColor: Colors.white,
),
```

**7. Enhance gradient fill for "glow" appearance (CHART-01):**

Update `belowBarData` to use a more vivid multi-stop gradient:

```dart
belowBarData: BarAreaData(
  show: true,
  gradient: LinearGradient(
    colors: [
      AppTheme.bitcoinOrange.withAlpha(77),  // ~0.30 opacity at top (was 51/0.20)
      AppTheme.bitcoinOrange.withAlpha(26),  // ~0.10 in middle for glow persistence
      AppTheme.bitcoinOrange.withAlpha(0),   // transparent at bottom
    ],
    stops: const [0.0, 0.5, 1.0],
    begin: Alignment.topCenter,
    end: Alignment.bottomCenter,
  ),
),
```

This increases the top alpha from 51 (~0.20) to 77 (~0.30) and adds a middle stop at 0.5 with alpha 26 (~0.10) for a more visible gradient glow feel.

**8. Keep all existing functionality intact:**

Preserve all existing features:
- `_xInterval()` method unchanged
- `_tierColor()` static method unchanged
- `extraLinesData` (average cost basis dashed line) unchanged
- `titlesData` (x-axis and y-axis labels) unchanged
- `gridData` and `borderData` unchanged
- Touch tooltip data (`lineTouchData`) unchanged for now (Plan 02 will replace it)

Keep the `AspectRatio` wrapper for now -- Plan 02 will modify the layout.
  </action>
  <verify>
Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze lib/features/chart/presentation/widgets/glow_dot_painter.dart lib/features/chart/presentation/widgets/price_line_chart.dart` -- zero errors.

Verify file structure:
- `glow_dot_painter.dart` exists with `class GlowDotPainter extends FlDotPainter`
- `price_line_chart.dart` has `class PriceLineChart extends HookConsumerWidget`
- `price_line_chart.dart` imports `glow_dot_painter.dart` and `glass_card.dart`
- `price_line_chart.dart` contains `useAnimationController`, `useRef`, `hasAnimated`
- `price_line_chart.dart` contains `clipData: const FlClipData.all()`
- No `withOpacity` calls exist (only `withAlpha`)
  </verify>
  <done>
GlowDotPainter renders a two-layer radial glow halo + solid dot. PriceLineChart is a HookConsumerWidget with: (1) left-to-right draw-in animation gated by hasAnimated + shouldReduceMotion, (2) enhanced orange-to-transparent gradient fill with increased alpha, (3) purchase dots hidden during animation and using GlowDotPainter when visible. No withOpacity calls. All existing chart features preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ChartScreen to pass WidgetRef and verify integration</name>
  <files>
    TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
  </files>
  <action>
Since PriceLineChart changed from `StatelessWidget` to `HookConsumerWidget`, it no longer takes a plain `BuildContext` -- it receives `(BuildContext, WidgetRef)` in its `build()` method. However, PriceLineChart is instantiated as a child widget in ChartScreen, not directly called. The parent passes it via constructor as before: `PriceLineChart(data: value, timeframe: selectedTimeframe.value)`. Since HookConsumerWidget renders through `HookConsumerWidget.build()` which is called by the framework, no change to ChartScreen's instantiation call is needed.

**Verify the integration compiles correctly:**

1. Confirm `ChartScreen` still instantiates `PriceLineChart(data: value, timeframe: selectedTimeframe.value)` without changes
2. Run full `flutter analyze` on the chart feature to confirm no type errors from the StatelessWidget-to-HookConsumerWidget conversion
3. Run `flutter analyze` on the entire `lib/` directory to catch any transitive import issues

**If any issues surface from the conversion**, fix them:
- If `const PriceLineChart(...)` constructors exist, remove `const` since HookConsumerWidget may not support const constructors
- Verify the import paths are correct for the new `glow_dot_painter.dart` file
  </action>
  <verify>
Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze` -- zero errors across entire project.

Verify ChartScreen still references PriceLineChart correctly by checking that `chart_screen.dart` compiles without modification, or that only minimal fixes (like removing `const` from PriceLineChart constructor calls) were needed.
  </verify>
  <done>
ChartScreen correctly integrates the upgraded PriceLineChart HookConsumerWidget. Full project analysis passes with zero errors. The chart feature is ready for Plan 02 (glass tooltip overlay).
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with zero errors
2. `glow_dot_painter.dart` exists with GlowDotPainter implementing FlDotPainter
3. `price_line_chart.dart` is a HookConsumerWidget with draw-in animation
4. No `withOpacity` calls in any new/modified code (only `withAlpha`)
5. `useRef(false)` guard prevents re-animation on tab revisit
6. `GlassCard.shouldReduceMotion` gates the animation
7. Purchase dots use GlowDotPainter and are hidden during draw-in
8. Gradient fill uses multi-stop LinearGradient with increased alpha
</verification>

<success_criteria>
- GlowDotPainter draws radial glow halo + solid dot for purchase markers (CHART-03)
- PriceLineChart draws in from left to right on first tab entry (CHART-02)
- Gradient fill beneath price line is visually enhanced with orange-to-transparent gradient (CHART-01)
- Draw-in respects Reduce Motion accessibility setting
- No animation replay on tab revisit
- Full project compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-chart-redesign/35-01-SUMMARY.md`
</output>
