---
phase: 35-chart-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart
autonomous: true
requirements:
  - CHART-01
  - CHART-02
  - CHART-03

must_haves:
  truths:
    - "The chart line has a visible orange-to-transparent gradient fill beneath it that looks like a glow, not the previous flat semi-transparent fill"
    - "On first entry to the Chart tab, the line draws in from left to right over ~1 second; on subsequent tab revisits the chart appears fully drawn instantly"
    - "Purchase marker dots have an orange radial glow halo around them, distinctly larger than the dot itself"
    - "With Reduce Motion enabled, the chart appears fully drawn immediately with no animation"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      provides: "HookConsumerWidget with draw-in animation, enhanced gradient fill, and glow dot integration"
      contains: "HookConsumerWidget"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart"
      provides: "Custom FlDotPainter subclass with radial gradient glow halo"
      contains: "GlowDotPainter extends FlDotPainter"
  key_links:
    - from: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      to: "TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart"
      via: "import and usage in getDotPainter callback"
      pattern: "GlowDotPainter"
    - from: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      to: "GlassCard.shouldReduceMotion"
      via: "motion gate before controller.forward()"
      pattern: "shouldReduceMotion"
---

<objective>
Upgrade the PriceLineChart to a premium visualization with gradient glow fill, animated left-to-right draw-in, and glowing purchase markers.

Purpose: Transform the existing basic chart into the premium design specified by CHART-01 (gradient glow fill), CHART-02 (draw-in animation), and CHART-03 (glow marker dots). These are all internal chart rendering changes that do not alter the chart's external API or layout.

Output: Updated `price_line_chart.dart` converted to HookConsumerWidget with draw-in animation, enhanced gradient, and a new `glow_dot_painter.dart` file implementing the custom FlDotPainter for radial glow markers.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-chart-redesign/35-RESEARCH.md

@TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
@TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
@TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/core/widgets/glass_card.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlowDotPainter custom FlDotPainter subclass</name>
  <files>TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart</files>
  <action>
Create a new file `glow_dot_painter.dart` implementing `GlowDotPainter extends FlDotPainter`.

The painter draws a two-layer dot:
1. **Outer glow halo** — `RadialGradient` shader from `glowColor.withAlpha(153)` (center) to `glowColor.withAlpha(0)` (edge) at 2.5x the dot radius. Use `RadialGradient.createShader(Rect.fromCircle(...))` and `canvas.drawCircle()`.
2. **Inner solid dot** — solid `color` fill at the normal `radius`.
3. **Stroke border** — white stroke at 1.5 width around the dot.

Constructor parameters:
- `required Color color` — the dot fill color (tier color)
- `double radius = 5.0` — the dot radius
- `Color? glowColor` — defaults to `color` if not provided
- `Color strokeColor = Colors.white` — stroke color

Override all 4 required FlDotPainter members:
- `Color get mainColor => color`
- `void draw(Canvas canvas, FlSpot spot, Offset offsetInCanvas)` — draws halo + dot + stroke
- `Size getSize(FlSpot spot) => Size(radius * 2.5 * 2, radius * 2.5 * 2)` — accounts for halo
- `bool hitTest(FlSpot spot, Offset touched, Offset center, double extraThreshold)` — distance check against `radius + extraThreshold`

IMPORTANT: Use `withAlpha(int)` not `withOpacity(float)` per project decision. Import `dart:ui` for `RadialGradient` if needed. Import `fl_chart` for `FlDotPainter` and `FlSpot`.
  </action>
  <verify>Run `dart analyze TradingBot.Mobile/lib/features/chart/presentation/widgets/glow_dot_painter.dart` — no errors.</verify>
  <done>GlowDotPainter file exists, compiles, and implements all 4 FlDotPainter abstract members with a two-layer radial gradient glow + solid dot + stroke border rendering.</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade PriceLineChart to HookConsumerWidget with draw-in animation and enhanced gradient</name>
  <files>TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart</files>
  <action>
Convert `PriceLineChart` from `StatelessWidget` to `HookConsumerWidget`. This requires changing the class declaration and the `build` method signature to include `WidgetRef ref`. Update imports to include `flutter_hooks` and `hooks_riverpod`.

**Draw-in animation (CHART-02):**
1. Add `useAnimationController(duration: const Duration(milliseconds: 1000))` in `build()`.
2. Add `useAnimation(CurvedAnimation(parent: controller, curve: Curves.easeInOut))` to get the animation value.
3. Add `useRef<bool>(false)` as the `hasAnimated` guard.
4. Add a `useEffect` that:
   - If `!hasAnimated.value && !GlassCard.shouldReduceMotion(context)` → set `hasAnimated.value = true` and call `controller.forward()`.
   - Otherwise → set `controller.value = 1.0` (show full chart immediately for reduce-motion or revisits).
   - Dependency: `[data]` (data object reference).
5. Compute `visibleCount`: if `GlassCard.shouldReduceMotion(context)` → `totalSpots`, else `max(1, (animation * totalSpots).round())`.
6. Slice `priceSpots` to `data.prices.asMap().entries.take(visibleCount)`.
7. Add `clipData: const FlClipData.all()` to `LineChartData`.
8. Set `maxX: max(0, visibleCount - 1).toDouble()` on `LineChartData` so the chart viewport matches the visible data.

**Purchase dot visibility during draw-in:**
Hide the purchase dots line entirely until the animation is complete. On the purchase `LineChartBarData`, set:
- `dotData: FlDotData(show: purchaseSpots.isNotEmpty && controller.isCompleted)` — dots only visible after draw-in finishes.
This avoids the pitfall of dots appearing at wrong positions mid-animation.

**Gradient glow fill (CHART-01):**
Update the `belowBarData` on the main price line:
- Change the top color from `AppTheme.bitcoinOrange.withAlpha(51)` to `AppTheme.bitcoinOrange.withAlpha(77)` (~0.30 opacity) for a more prominent "glow" feel.
- Keep `Colors.transparent` as the bottom color.
- Keep `begin: Alignment.topCenter, end: Alignment.bottomCenter`.

**Glow dot painter (CHART-03):**
Replace `FlDotCirclePainter` in the purchase dots `getDotPainter` callback with `GlowDotPainter`:
```dart
getDotPainter: (spot, _, __, ___) => GlowDotPainter(
  radius: 5,
  color: _tierColor(
    purchasesByIndex[spot.x.toInt()]?.tier ?? 'Base',
  ),
  glowColor: AppTheme.bitcoinOrange,
),
```
Import `glow_dot_painter.dart`.

**Imports to add:**
- `import 'package:flutter_hooks/flutter_hooks.dart';`
- `import 'package:hooks_riverpod/hooks_riverpod.dart';`
- `import 'dart:math';` (for `max`)
- `import '../../../../core/widgets/glass_card.dart';` (for `shouldReduceMotion`)
- `import 'glow_dot_painter.dart';`

**Retain all existing functionality:** x-axis labels, y-axis labels, grid, border, touch tooltip, average cost line, tier color mapping. The only changes are: class type, gradient alpha, dot painter, draw-in animation, and clipData/maxX.
  </action>
  <verify>Run `dart analyze TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart` — no errors. Verify the class extends `HookConsumerWidget` and uses `useAnimationController`.</verify>
  <done>PriceLineChart is a HookConsumerWidget with: (1) enhanced gradient fill at alpha 77, (2) left-to-right draw-in animation gated by hasAnimated + shouldReduceMotion, (3) GlowDotPainter for purchase markers, (4) clipData + maxX for correct draw-in rendering, (5) purchase dots hidden until animation completes.</done>
</task>

</tasks>

<verification>
1. `cd TradingBot.Mobile && dart analyze lib/features/chart/` — no errors or warnings in chart feature files.
2. Confirm `glow_dot_painter.dart` exists with `GlowDotPainter extends FlDotPainter`.
3. Confirm `price_line_chart.dart` extends `HookConsumerWidget`, has `useAnimationController`, has `GlassCard.shouldReduceMotion` check, uses `GlowDotPainter`, and has `clipData: FlClipData.all()`.
4. Confirm gradient fill uses `withAlpha(77)` (not `withAlpha(51)` or `withOpacity`).
5. Confirm no `withOpacity` calls anywhere in new/modified code.
</verification>

<success_criteria>
- GlowDotPainter compiles and draws radial gradient halo + solid dot + stroke
- PriceLineChart draws in from left to right on first tab entry (~1s easeInOut)
- Draw-in does NOT re-fire on tab revisit (hasAnimated guard)
- Reduce Motion skips animation entirely (chart appears instantly)
- Purchase dots only appear after draw-in completes
- Gradient fill is visually more prominent than before (alpha 77 vs 51)
- All existing chart features retained (tooltip, axis labels, avg cost line)
- `dart analyze` clean
</success_criteria>

<output>
After completion, create `.planning/phases/35-chart-redesign/35-01-SUMMARY.md`
</output>
