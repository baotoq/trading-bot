# Phase 35.1: Portfolio Overview Screen - Research

**Researched:** 2026-02-22
**Domain:** Flutter portfolio screen redesign — glassmorphism layout, fl_chart portfolio-value line chart, tab/filter UI, asset list with glass rows
**Confidence:** HIGH

## Summary

Phase 35.1 redesigns the existing `PortfolioScreen` into the CMC-style "My Portfolio" overview shown in the reference image. The reference shows a screen with: a large total value hero, 24h change + all-time P&L stats, Overview/Transactions tab switcher, filter chips, a portfolio value-over-time line chart, and a per-asset list showing price, % change, and holding value/amount.

The existing `PortfolioScreen` already has all the required data models (`PortfolioSummaryResponse` with `totalValueUsd`, `unrealizedPnlUsd`, `unrealizedPnlPercent`, `allocations`; `PortfolioAssetResponse` with `currentPrice`, `unrealizedPnlPercent`, `currentValueUsd`, `quantity`). The key missing data field is **24h change** — neither `PortfolioSummaryResponse` nor `PortfolioAssetResponse` currently carry a `change24h` field. Based on the REQUIREMENTS.md constraint "v5.0 is pure UI layer; no backend changes", the 24h change must either be derived from existing price data locally or gracefully omitted/stubbed.

The portfolio-value-over-time line chart (POLISH-04 in REQUIREMENTS.md Future Requirements) requires a new time-series endpoint. Since REQUIREMENTS.md explicitly places POLISH-04 as a future item and the phase depends on Phase 35 (which adds `GlowLineChart` patterns), this chart should reuse the `fl_chart` pattern from Phase 35 with existing data. No new packages are needed — `fl_chart ^1.1.1`, `hooks_riverpod`, and `flutter_hooks` are already installed.

The architecture is a complete rebuild of `PortfolioScreen` using `HookConsumerWidget`, GlassCard stationary variant for the hero section, GlassCard scrollItem for asset rows, `DefaultTabController` or `useState`-based tab state for the Overview/Transactions switch, and horizontal `SingleChildScrollView` for filter chips.

**Primary recommendation:** Rebuild `PortfolioScreen` as a `HookConsumerWidget` with a `CustomScrollView` containing: (1) a glass hero header with total value + stats, (2) tab bar for Overview/Transactions, (3) filter chips row, (4) a portfolio value sparkline chart (derived from existing asset data if backend unavailable), and (5) a `SliverList` of per-asset glass rows. Reuse all existing providers, repositories, and data models. Do not add new API endpoints.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| fl_chart | ^1.1.1 (installed) | Portfolio value line chart, sparkline | Already project chart library; Phase 35 adds GlowLineChart patterns to reuse |
| hooks_riverpod | ^3.2.1 (installed) | State management, `portfolioPageDataProvider` | Project standard |
| flutter_hooks | any (installed) | `useState` for tab selection and filter state, `useAnimationController` | Project pattern for all animation controllers |
| GlassCard | project (Phase 33/34) | Hero panel (stationary), asset rows (scrollItem) | Phase 33 GlassTheme tokens; Phase 34 scrollItem variant prevents Impeller jank in lists |
| AppShimmer | project (Phase 34) | Skeleton loading states | Project standard; already used in PortfolioScreen |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| intl | any (installed) | `NumberFormat.currency` for monetary display | Already used across portfolio widgets |
| skeletonizer | ^1.4.3 (installed) | `Bone` widgets inside `AppShimmer` | Loading skeleton shapes for hero + chart + asset rows |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| `useState` for tab state | `TabController` + `SingleTickerProviderStateMixin` | `useState` in `HookConsumerWidget` is simpler and the project pattern; `TabController` requires StatefulWidget or TickerProvider mixin |
| fl_chart for portfolio sparkline | Custom `CustomPainter` | fl_chart is already installed, handles touch, animations, and gradients consistently |
| New API endpoint for portfolio history | Derive from existing snapshots | REQUIREMENTS.md: "no backend changes in v5.0" — sparkline data must come from existing data or be deferred |

**Installation:** No new packages required.

## Architecture Patterns

### Recommended Project Structure

```
TradingBot.Mobile/lib/features/portfolio/
├── data/
│   ├── models/
│   │   └── [existing models unchanged]
│   ├── portfolio_providers.dart           # Existing — no changes needed
│   └── portfolio_repository.dart         # Existing — no changes needed
└── presentation/
    ├── portfolio_screen.dart              # FULL REBUILD — HookConsumerWidget
    └── widgets/
        ├── portfolio_hero_header.dart     # NEW: GlassCard with total value + stats
        ├── portfolio_tab_bar.dart         # NEW: Overview/Transactions tab switcher
        ├── portfolio_filter_chips.dart    # NEW: Holding amount / Profit / Analysis chips
        ├── portfolio_sparkline_chart.dart # NEW: fl_chart LineChart for value over time
        ├── portfolio_asset_list_item.dart # NEW: GlassCard.scrollItem asset row (replaces AssetRow)
        ├── asset_row.dart                 # KEEP for internal use (or replace)
        ├── allocation_donut_chart.dart    # KEEP (deferred to Phase 37 for glow treatment)
        ├── portfolio_summary_card.dart    # SUPERSEDED — hero panel replaces this
        └── [other existing widgets]
```

### Pattern 1: HookConsumerWidget with Tab State

**What:** Use `useState<int>(0)` for the selected tab index (Overview=0, Transactions=1) and `useState<String>('holding')` for the active filter chip. This avoids `TabController` lifecycle complexity.

**When to use:** Any two-tab UI in a `HookConsumerWidget` where the tab state is local to the screen.

**Example:**
```dart
// Project pattern from STATE.md: all controllers via hooks
class PortfolioScreen extends HookConsumerWidget {
  const PortfolioScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final selectedTab = useState(0); // 0 = Overview, 1 = Transactions
    final activeFilter = useState('holding');
    final portfolioData = ref.watch(portfolioPageDataProvider);

    return Scaffold(
      body: CustomScrollView(
        slivers: [
          _HeroHeader(data: portfolioData.value),
          _TabBar(selectedTab: selectedTab),
          if (selectedTab.value == 0) ...[
            _FilterChips(activeFilter: activeFilter),
            _SparklineChart(data: portfolioData.value),
            _AssetList(assets: portfolioData.value?.assets ?? []),
          ] else
            _TransactionsTab(),
        ],
      ),
    );
  }
}
```

### Pattern 2: GlassCard Hero Header

**What:** A `GlassCard` (stationary variant) containing the portfolio total, 24h change row, and all-time P&L row. Uses `AppTheme.moneyStyle` tabular figures for all monetary values.

**When to use:** Stationary hero panels that sit above the scroll content. The background does not scroll behind them, so BackdropFilter is safe here.

**Example:**
```dart
// Source: GlassCard project widget — lib/core/widgets/glass_card.dart
// Source: AppTheme.moneyStyle — lib/app/theme.dart
GlassCard(
  margin: const EdgeInsets.all(16),
  padding: const EdgeInsets.all(20),
  child: Column(
    crossAxisAlignment: CrossAxisAlignment.start,
    children: [
      Text('My Portfolio', style: Theme.of(context).textTheme.titleMedium),
      const SizedBox(height: 4),
      Text(
        '5,731.07 USDT',
        style: Theme.of(context).textTheme.headlineLarge?.merge(AppTheme.moneyStyle),
      ),
      const SizedBox(height: 8),
      Row(children: [
        // 24h change — if data unavailable, hide gracefully
        _StatChip(label: '24h', value: '+127.02 USDT', pct: '+2.26%', positive: true),
      ]),
      const SizedBox(height: 4),
      Row(children: [
        Text('All time: ', style: TextStyle(color: Colors.white54)),
        Text('-1,686.56 USDT', style: TextStyle(color: AppTheme.lossRed)),
        Text(' ▼ 21.84%', style: TextStyle(color: AppTheme.lossRed)),
      ]),
    ],
  ),
)
```

### Pattern 3: GlassCard.scrollItem for Asset List Items

**What:** Per-asset rows use `GlassCard(variant: GlassVariant.scrollItem)` to get the glass-adjacent appearance without BackdropFilter. This is the confirmed pattern from STATE.md Phase 34 decision.

**When to use:** Every item inside a scrollable list where BackdropFilter causes Impeller frame drops.

**Example:**
```dart
// Source: GlassCard scrollItem variant — Phase 34 decision in STATE.md
// "GlassVariant.scrollItem renders Container without BackdropFilter —
//  same GlassTheme tokens, no blur pass — prevents Impeller frame drops on scroll"
GlassCard(
  variant: GlassVariant.scrollItem,
  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
  child: Row(
    children: [
      // Crypto icon (CircleAvatar with colored background by ticker)
      _CryptoIcon(ticker: asset.ticker),
      const SizedBox(width: 12),
      // Price + % change (middle column, left-aligned)
      Expanded(child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(priceFormatted, style: AppTheme.moneyStyle.copyWith(fontSize: 14)),
          Text(pctChange, style: TextStyle(color: pnlColor, fontSize: 12)),
        ],
      )),
      // Holding value + amount (right-aligned)
      Column(
        crossAxisAlignment: CrossAxisAlignment.end,
        children: [
          Text(holdingValue, style: AppTheme.moneyStyle.copyWith(fontSize: 14)),
          Text('${quantity} ${ticker}', style: TextStyle(color: Colors.white54, fontSize: 12)),
        ],
      ),
    ],
  ),
)
```

### Pattern 4: Portfolio Sparkline Chart

**What:** An `fl_chart` `LineChart` showing portfolio value over time. Since there is no dedicated portfolio-history API endpoint, the sparkline can either: (a) show a placeholder flat line with current value, (b) be omitted in the Overview tab until a history endpoint is added, or (c) use the existing `ChartResponse` data from the BTC chart screen as a proxy for BTC-weighted portfolio value.

**Recommended approach:** Implement the sparkline widget shell with the fl_chart gradient glow pattern from Phase 35 (reuse `BarAreaData` gradient fill), but drive it from a new provider that fetches whatever historical data is accessible. If no data is available, show the skeleton shimmer. The Phase 35 pattern (`spots.sublist` + `clipData: FlClipData.all()` + `useAnimationController`) applies directly.

**Example:**
```dart
// Reuses Phase 35 gradient fill pattern
LineChartBarData(
  spots: portfolioSpots,
  isCurved: true,
  color: AppTheme.profitGreen, // or lossRed if portfolio is in the red
  barWidth: 2,
  dotData: const FlDotData(show: false),
  belowBarData: BarAreaData(
    show: true,
    gradient: LinearGradient(
      colors: [
        AppTheme.profitGreen.withAlpha(77),
        Colors.transparent,
      ],
      begin: Alignment.topCenter,
      end: Alignment.bottomCenter,
    ),
  ),
)
```

### Pattern 5: Filter Chips Row

**What:** A horizontal `SingleChildScrollView` containing `ChoiceChip` or custom chip widgets for filter options (Holding amount, Cumulative profit, Analysis). `useState<String>` tracks the active filter. In the reference image, the active chip has a filled/highlighted background (BTC orange), inactive chips have glass-adjacent borders.

**Example:**
```dart
// Standard Flutter ChoiceChip or custom GlassChip
SingleChildScrollView(
  scrollDirection: Axis.horizontal,
  padding: const EdgeInsets.symmetric(horizontal: 16),
  child: Row(
    children: ['Holding amount', 'Cumulative profit', 'Analysis'].map((label) {
      final isActive = activeFilter.value == label;
      return Padding(
        padding: const EdgeInsets.only(right: 8),
        child: GestureDetector(
          onTap: () => activeFilter.value = label,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
            decoration: BoxDecoration(
              color: isActive
                ? AppTheme.bitcoinOrange.withAlpha(51)
                : glass.tintColor.withAlpha((glass.tintOpacity * 255).round()),
              borderRadius: BorderRadius.circular(20),
              border: Border.all(
                color: isActive ? AppTheme.bitcoinOrange : glass.borderColor,
              ),
            ),
            child: Text(label, style: TextStyle(
              color: isActive ? AppTheme.bitcoinOrange : Colors.white70,
              fontSize: 13,
            )),
          ),
        ),
      );
    }).toList(),
  ),
)
```

### Anti-Patterns to Avoid

- **BackdropFilter in the asset list:** Asset rows MUST use `GlassVariant.scrollItem`. The Impeller frame drop issue is confirmed in STATE.md. No exceptions.
- **Solid backgroundColor on PortfolioScreen Scaffold:** Must be `Colors.transparent` (or omitted) so `AmbientBackground` orbs show through. STATE.md: "Screen Scaffolds with solid backgroundColor will paint over AmbientBackground orbs."
- **Using `withOpacity(float)` for Color alpha:** Project decision requires `withAlpha(int)`. All gradient and tint values must convert: `withOpacity(0.3)` → `withAlpha(77)`, `withOpacity(0.2)` → `withAlpha(51)`.
- **AnimationController without `useAnimationController`:** STATE.md: "All AnimationControllers in HookConsumerWidget via useAnimationController — prevents lifecycle leaks across 5 tabs."
- **Animating on every rebuild:** Any count-up, chart draw-in, or entrance animation needs the `_hasAnimated` guard via `useRef<bool>(false)`.
- **24h change from external API:** REQUIREMENTS.md explicitly blocks "New API endpoints or data model changes" in v5.0. The 24h change must be computed from existing data or shown conditionally if the field is absent from the response.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Shimmer loading state | Custom animated gradient | `AppShimmer` + `Bone` widgets | Project standard; GlassTheme colors are already wired |
| Glass surface for rows | Custom Container + Border | `GlassCard(variant: GlassVariant.scrollItem)` | BackdropFilter pitfall is documented; scrollItem is the correct variant |
| Portfolio chart fill gradient | Custom `CustomPainter` | `fl_chart` `BarAreaData(gradient: LinearGradient(...))` | Already in project; Phase 35 confirms the gradient pattern |
| Tab selection state | `TabController` + StatefulWidget | `useState<int>` in `HookConsumerWidget` | Project pattern; hooks manage lifecycle automatically |
| Currency formatting | Manual string formatting | `NumberFormat.currency(...)` from `intl` | Already used in 5+ files; static formatters pattern established |
| Press micro-interaction | Custom GestureDetector | `PressableScale` (Phase 34) | Phase 34 established this as the standard; it includes haptic feedback |

**Key insight:** All the primitives (GlassCard, AppShimmer, PressableScale, fl_chart gradients) were built in Phases 33-35 precisely so that screen phases like 35.1 can assemble them without custom solutions.

## Common Pitfalls

### Pitfall 1: Missing 24h Change Data
**What goes wrong:** The reference image prominently shows "24h: +127.02 USDT ▲ 2.26%" but `PortfolioSummaryResponse` has no `change24h` field.
**Why it happens:** This is a CMC-style reference mock — the backend API does not expose 24h portfolio delta.
**How to avoid:** Two options: (A) Show only all-time P&L (which `unrealizedPnlUsd` and `unrealizedPnlPercent` provide), with no 24h row; or (B) Add a `change24h` field to `PortfolioSummaryResponse` by computing it from the current value minus the 24h-ago value if the backend exposes historical snapshots. Option A is safe within v5.0 constraints. Option B risks violating "no backend changes". Recommendation: Implement Option A, leave a `// TODO: 24h change requires backend support` comment.
**Warning signs:** Attempting to call a new API endpoint.

### Pitfall 2: Scaffold backgroundColor Overriding AmbientBackground
**What goes wrong:** AmbientBackground orbs disappear behind the Portfolio screen because `Scaffold.backgroundColor` is set to a non-transparent color.
**Why it happens:** The global theme sets `scaffoldBackgroundColor: Colors.transparent` but individual screens can override it. This risk is explicitly noted in STATE.md.
**How to avoid:** Ensure `PortfolioScreen`'s `Scaffold` does NOT set `backgroundColor`. The global theme transparent value will apply.
**Warning signs:** Navy orbs are not visible behind the portfolio content.

### Pitfall 3: BackdropFilter on Asset List Rows
**What goes wrong:** 16ms+ raster jank during scroll because `GlassVariant.stationary` is used on list items.
**Why it happens:** BackdropFilter causes a full-texture repaint on every scroll pixel. This was confirmed via Impeller testing (STATE.md decision).
**How to avoid:** Always `GlassCard(variant: GlassVariant.scrollItem)` for items inside `SliverList`, `ListView`, or `CustomScrollView`.
**Warning signs:** Scroll fps drops below 60 on mid-range devices.

### Pitfall 4: Portfolio Sparkline Requires Non-Existent History Endpoint
**What goes wrong:** The chart attempts to fetch `/api/portfolio/history` which doesn't exist, causing unhandled errors.
**Why it happens:** The reference image shows a portfolio-value-over-time chart but the backend has no such endpoint.
**How to avoid:** The sparkline provider should gracefully return an empty list (or null) when no history data is available, and the chart widget should render a "No chart data available" placeholder instead of throwing. This aligns with the REQUIREMENTS.md POLISH-04 future item.
**Warning signs:** Unhandled `DioException` on the portfolio screen.

### Pitfall 5: Filter Chips Don't Sort the Asset List
**What goes wrong:** Filter chips appear but don't actually change the asset order — looks broken.
**Why it happens:** The filter chips in the reference image suggest sorting by "Holding amount", "Cumulative profit", or "Analysis" view. If chips are wired to UI state but no sorting logic is implemented, the list never changes.
**How to avoid:** Wire each chip to a sort/filter transform on the asset list derived data. For "Holding amount": sort by `currentValueUsd DESC`. For "Cumulative profit": sort by `unrealizedPnlUsd DESC`. For "Analysis": this may be a more complex view — use as a no-op sort with a placeholder.
**Warning signs:** Tapping chips has no visible effect on the asset list order.

### Pitfall 6: Tab Switcher State Shared Across Builds
**What goes wrong:** Tab selection resets every time the widget rebuilds (e.g., on data refresh).
**Why it happens:** Using a plain `int` variable in `build()` rather than `useState`.
**How to avoid:** Use `useState<int>(0)` — hooks survive widget rebuilds within the same widget lifecycle.
**Warning signs:** Selected tab jumps back to "Overview" after pull-to-refresh.

## Code Examples

Verified patterns from project sources:

### AppTheme.moneyStyle for Tabular Figures
```dart
// Source: lib/app/theme.dart
// "All monetary values use tabular figures" — STATE.md decision
Text(
  '5,731.07 USDT',
  style: Theme.of(context).textTheme.headlineLarge?.merge(AppTheme.moneyStyle),
)
```

### HookConsumerWidget with useState Tab Control
```dart
// Source: hooks_riverpod pattern — STATE.md decision
// "All AnimationControllers in HookConsumerWidget via useAnimationController"
class PortfolioScreen extends HookConsumerWidget {
  const PortfolioScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final selectedTab = useState(0);
    final activeFilter = useState('Holding amount');
    final portfolioData = ref.watch(portfolioPageDataProvider);
    // ...
  }
}
```

### GlassCard.scrollItem for List Items
```dart
// Source: lib/core/widgets/glass_card.dart — GlassVariant.scrollItem
// STATE.md: "No BackdropFilter in scrollable lists (History, Portfolio)"
GlassCard(
  variant: GlassVariant.scrollItem,
  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
  child: const MyAssetRowContent(),
)
```

### P&L Color from AppTheme
```dart
// Source: lib/app/theme.dart
// STATE.md: "profitGreen and lossRed are non-negotiable semantic constants"
Color _pnlColor(double pnl) {
  if (pnl > 0) return AppTheme.profitGreen;
  if (pnl < 0) return AppTheme.lossRed;
  return Colors.white54;
}
```

### fl_chart LineChart with Gradient Fill (Phase 35 pattern)
```dart
// Source: Phase 35 research/plan — confirmed BarAreaData pattern
belowBarData: BarAreaData(
  show: true,
  gradient: LinearGradient(
    colors: [
      AppTheme.profitGreen.withAlpha(77), // ~0.30 opacity
      Colors.transparent,
    ],
    begin: Alignment.topCenter,
    end: Alignment.bottomCenter,
  ),
),
```

### SliverPersistentHeader for Sticky Tab Bar
```dart
// Standard Flutter SliverPersistentHeader to keep tab bar sticky during scroll
SliverPersistentHeader(
  pinned: true,
  delegate: _StickyTabBarDelegate(
    child: _TabBar(selectedTab: selectedTab),
  ),
)
```

### Color.withAlpha (project convention)
```dart
// Source: STATE.md decision — "Color.withAlpha(int) over withOpacity(float)"
// Conversion: opacity_float * 255 = alpha_int
AppTheme.bitcoinOrange.withAlpha(51)   // was withOpacity(0.2)
AppTheme.profitGreen.withAlpha(77)     // was withOpacity(0.3)
Colors.white.withAlpha(31)             // was withOpacity(0.12) — GlassTheme.borderColor
```

## Data Model Analysis

### Available Fields for the Reference Screen

The reference image requires these data points. All are available in existing models:

| UI Element | Data Source | Field | Available? |
|------------|-------------|-------|------------|
| Total portfolio value | `PortfolioSummaryResponse` | `totalValueUsd` / `totalValueVnd` | YES |
| 24h change absolute | Not available | — | NO — omit or stub |
| 24h change % | Not available | — | NO — omit or stub |
| All-time P&L absolute | `PortfolioSummaryResponse` | `unrealizedPnlUsd` / `unrealizedPnlVnd` | YES |
| All-time P&L % | `PortfolioSummaryResponse` | `unrealizedPnlPercent` | YES (nullable) |
| Portfolio value chart | No endpoint | — | NO — show placeholder or derive |
| Asset current price | `PortfolioAssetResponse` | `currentPrice` | YES |
| Asset % change | `PortfolioAssetResponse` | `unrealizedPnlPercent` | YES (all-time, not 24h) |
| Asset holding value | `PortfolioAssetResponse` | `currentValueUsd` / `currentValueVnd` | YES |
| Asset holding amount | `PortfolioAssetResponse` | `quantity` + `ticker` | YES |
| Asset icon/logo | Not available | — | NO — use colored ticker badge |

**Key gap:** The "24h change" shown prominently in the reference image is not available from any current API endpoint. The app shows all-time P&L (`unrealizedPnlUsd/Percent`) rather than a rolling 24h delta. The plan should implement all-time P&L in that row and label it clearly ("All time" not "24h").

**Portfolio chart data gap:** POLISH-04 in REQUIREMENTS.md says "Portfolio value chart over time (deferred from v4.0)". This is explicitly a future item. For Phase 35.1, either: (a) omit the chart from the Overview tab and replace with the AllocationDonutChart already implemented, or (b) show the chart widget shell with a "Coming soon" or skeleton state. Recommendation: keep the AllocationDonutChart (already works, shows meaningful data) and add the sparkline chart as an optional slot that shows skeleton when no history data is available.

## Screen Architecture Decision

### What to Rebuild vs What to Keep

| Component | Action | Reason |
|-----------|--------|--------|
| `PortfolioScreen` | Full rebuild | Need HookConsumerWidget, new tab/filter architecture |
| `PortfolioSummaryCard` | Supersede with `PortfolioHeroHeader` | Reference image shows a different layout (larger value, stats inline) |
| `AllocationDonutChart` | Keep + use in Overview tab | Existing chart works; glow treatment deferred to Phase 37 |
| `AssetTypeSection` (ExpansionTile) | Replace with flat list | Reference shows a flat asset list, not accordion sections |
| `AssetRow` | Redesign as `PortfolioAssetListItem` | Need new layout: icon, price + %change, holding value + amount |
| `CurrencyToggle` | Keep | Already works; slot-flip animation deferred to Phase 37 |
| `portfolio_providers.dart` | No change | `portfolioPageDataProvider` provides all required data |
| `portfolio_repository.dart` | No change | v5.0 is UI-only; no backend changes |

### Layout Structure

```
PortfolioScreen (HookConsumerWidget)
└── Scaffold (backgroundColor: transparent)
    └── CustomScrollView
        ├── SliverToBoxAdapter
        │   └── GlassCard (stationary) — Hero Header
        │       ├── "My Portfolio" title + visibility toggle icon
        │       ├── Total value (headlineLarge + moneyStyle)
        │       ├── All-time P&L row (colored text)
        │       └── [24h row omitted — data unavailable]
        ├── SliverPersistentHeader (pinned: true)
        │   └── Tab Bar — Overview | Transactions
        ├── [if Overview tab selected]
        │   ├── SliverToBoxAdapter — Filter chips (horizontal scroll)
        │   ├── SliverToBoxAdapter — AllocationDonutChart (existing)
        │   │   OR Portfolio sparkline (if history data available)
        │   └── SliverList — Asset rows (GlassCard.scrollItem per item)
        └── [if Transactions tab selected]
            └── SliverToBoxAdapter → context.push('/portfolio/transaction-history')
                OR inline transaction list from portfolioPageDataProvider
```

## Open Questions

1. **24h change data**
   - What we know: `PortfolioSummaryResponse` has only all-time P&L, no rolling 24h delta.
   - What's unclear: Whether to simply omit the 24h row, or label the existing unrealizedPnl row as "All time" matching the reference image's second row.
   - Recommendation: Show "All time: [unrealizedPnlUsd] [unrealizedPnlPercent]" as the second stat row. This is truthful and matches data availability. No 24h row.

2. **Portfolio sparkline chart**
   - What we know: REQUIREMENTS.md explicitly defers "Portfolio value chart over time (POLISH-04)" to v5.x. There is no backend history endpoint.
   - What's unclear: Whether Phase 35.1 should implement the chart shell (with skeleton/empty state) or keep the existing AllocationDonutChart in that slot.
   - Recommendation: Keep `AllocationDonutChart` in the Overview tab. It shows meaningful allocation data that complements the hero totals. The sparkline chart can be a future shell widget that renders a skeleton until POLISH-04 is implemented.

3. **Sticky tab bar implementation**
   - What we know: The tab bar in the reference sits between the hero header and the filter chips, and should remain accessible during scroll.
   - What's unclear: Whether the tab bar should be `SliverPersistentHeader(pinned: true)` or `SliverAppBar(bottom:)`.
   - Recommendation: `SliverPersistentHeader(pinned: true)` with a custom `SliverPersistentHeaderDelegate` is the standard pattern for sticky tab bars inside `CustomScrollView`. Height is fixed at ~48px.

4. **Crypto asset icons**
   - What we know: `PortfolioAssetResponse` only provides `ticker` (e.g., "BTC", "ETH") — no logo URL. The reference image shows colored circular icons per asset.
   - What's unclear: Whether to use CoinGecko logo URLs (requires new API) or colored ticker badges.
   - Recommendation: Colored `CircleAvatar` with first 1-2 letters of ticker and a consistent color per ticker (hash-based). This matches the existing `AssetRow` approach and keeps it within v5.0 scope (no new API calls).

## Sources

### Primary (HIGH confidence)
- Project source: `lib/features/portfolio/presentation/portfolio_screen.dart` — current implementation baseline
- Project source: `lib/features/portfolio/data/models/portfolio_summary_response.dart` — available fields
- Project source: `lib/features/portfolio/data/models/portfolio_asset_response.dart` — per-asset fields
- Project source: `lib/features/portfolio/data/portfolio_repository.dart` — available endpoints
- Project source: `lib/core/widgets/glass_card.dart` — GlassCard, GlassVariant, GlassTheme
- Project source: `lib/core/widgets/shimmer_loading.dart` — AppShimmer pattern
- Project source: `lib/app/theme.dart` — AppTheme tokens, moneyStyle
- Project source: `lib/core/widgets/ambient_background.dart` — AmbientBackground pattern
- Project source: `lib/features/chart/presentation/widgets/price_line_chart.dart` — fl_chart patterns
- Project STATE.md — all v5.0 decisions (scrollItem, withAlpha, HookConsumerWidget, _hasAnimated)
- Project REQUIREMENTS.md — POLISH-04 deferred, "no backend changes in v5.0"
- Phase 35 RESEARCH.md — fl_chart gradient fill, draw-in animation patterns confirmed

### Secondary (MEDIUM confidence)
- Reference image `.planning/phases/35.1-portfolio-overview-screen/reference.png` — CMC-style portfolio screen design (analyzed visually)
- Flutter `SliverPersistentHeader` documentation — sticky header pattern for CustomScrollView

### Tertiary (LOW confidence)
- CoinGecko icon URL pattern `https://assets.coingecko.com/coins/images/{id}/thumb/{name}.png` — requires ID lookup, not recommended for v5.0 scope

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all packages already installed, all project primitives (GlassCard, AppShimmer, PressableScale) exist
- Architecture patterns: HIGH — derived from existing codebase; GlassCard scrollItem, HookConsumerWidget, useState are confirmed project patterns
- Data model gap analysis: HIGH — all fields inspected in source; 24h change and portfolio history confirmed absent
- Portfolio sparkline: MEDIUM — fl_chart pattern confirmed from Phase 35; data source is the open question
- Filter chip sort logic: MEDIUM — fields exist to sort by holding amount and P&L; "Analysis" view is undefined

**Research date:** 2026-02-22
**Valid until:** 2026-03-22 (stable libraries; project primitives won't change between phases)
