---
phase: 35.1-portfolio-overview-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_hero_header.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_tab_bar.dart
  - TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_filter_chips.dart
autonomous: true
requirements: [PORT-UI-01, PORT-UI-02]

must_haves:
  truths:
    - "Portfolio screen shows total value in a glass hero header with all-time P&L stats"
    - "Portfolio screen has Overview and Transactions tab switcher that persists across rebuilds"
    - "Filter chips row appears below the tab bar with Holding amount, Cumulative profit, and Analysis options"
    - "Tab bar stays pinned at top during scroll via SliverPersistentHeader"
    - "Switching tabs shows different content (Overview vs Transactions placeholder)"
    - "AmbientBackground orbs are visible behind portfolio content"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      provides: "Rebuilt PortfolioScreen as HookConsumerWidget with CustomScrollView layout"
      contains: "HookConsumerWidget"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_hero_header.dart"
      provides: "Glass hero header with total value and all-time P&L"
      contains: "GlassCard"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_tab_bar.dart"
      provides: "Overview/Transactions tab switcher"
      contains: "SliverPersistentHeaderDelegate"
    - path: "TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_filter_chips.dart"
      provides: "Horizontal filter chip row with active state"
      contains: "SingleChildScrollView"
  key_links:
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      to: "portfolio_hero_header.dart"
      via: "SliverToBoxAdapter composing hero header"
      pattern: "PortfolioHeroHeader"
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      to: "portfolio_tab_bar.dart"
      via: "SliverPersistentHeader with pinned tab bar"
      pattern: "SliverPersistentHeader.*pinned.*true"
    - from: "TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart"
      to: "portfolioPageDataProvider"
      via: "ref.watch for data"
      pattern: "ref\\.watch\\(portfolioPageDataProvider\\)"
---

<objective>
Rebuild PortfolioScreen as a HookConsumerWidget with glass hero header, sticky tab bar, and filter chips -- the structural shell of the CMC-style portfolio overview.

Purpose: Transforms the flat Card/ExpansionTile portfolio screen into a premium glassmorphism layout with hero balance section, tab switcher, and filter infrastructure. This is the structural prerequisite for the asset list redesign in Plan 02.

Output: Rebuilt portfolio_screen.dart, new portfolio_hero_header.dart, portfolio_tab_bar.dart, portfolio_filter_chips.dart widgets.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35.1-portfolio-overview-screen/35.1-RESEARCH.md
@.planning/phases/35.1-portfolio-overview-screen/reference.png
@TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
@TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_summary_card.dart
@TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart
@TradingBot.Mobile/lib/features/portfolio/data/models/portfolio_summary_response.dart
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/core/widgets/glass_card.dart
@TradingBot.Mobile/lib/core/widgets/shimmer_loading.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hero header, tab bar, and filter chips widgets</name>
  <files>
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_hero_header.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_tab_bar.dart
    TradingBot.Mobile/lib/features/portfolio/presentation/widgets/portfolio_filter_chips.dart
  </files>
  <action>
Create three new widget files:

**portfolio_hero_header.dart** — `PortfolioHeroHeader` StatelessWidget:
- Takes `PortfolioSummaryResponse summary`, `bool isVnd` as required params.
- Wraps content in `GlassCard` (default stationary variant) with `margin: EdgeInsets.all(16)` and `padding: EdgeInsets.all(20)`.
- Layout as Column (crossAxisAlignment: start):
  1. Row: "My Portfolio" title (titleMedium) + Spacer + CurrencyToggle widget
  2. SizedBox(height: 4)
  3. Total value text — headlineLarge merged with AppTheme.moneyStyle, fontWeight bold. Use `_formatValue(summary.totalValueUsd, summary.totalValueVnd)` helper. Include static NumberFormat instances (same pattern as PortfolioSummaryCard: _vndFormatter and _usdFormatter).
  4. SizedBox(height: 12)
  5. All-time P&L row — Row with: Text("All time: ", white54), formatted P&L absolute value in profitGreen/lossRed color, SizedBox(width: 6), percentage in same color with up/down arrow icon (Icons.arrow_drop_up/arrow_drop_down). Use `_pnlColor(double)` helper returning AppTheme.profitGreen for >0, AppTheme.lossRed for <0, Colors.white54 for 0. Show unrealizedPnlPercent only if non-null.
  6. If isVnd and exchangeRateUpdatedAt != null, show StalenessLabel.crossCurrencyLabel() below.
- No 24h change row (data unavailable per research). Add `// TODO: 24h change requires backend support (not available in PortfolioSummaryResponse)` comment.
- Use `Color.withAlpha(int)` NOT `withOpacity(float)`.

**portfolio_tab_bar.dart** — Two parts:
1. `PortfolioTabBar` StatelessWidget: Takes `ValueNotifier<int> selectedTab`. Renders a Container with the glass-adjacent background (use GlassTheme tintColor.withAlpha) and a Row of two tab buttons ("Overview" at index 0, "Transactions" at index 1). Active tab: AppTheme.bitcoinOrange text + bottom border indicator. Inactive tab: Colors.white54 text. Each tab is an Expanded GestureDetector that sets selectedTab.value on tap. Container has padding symmetric horizontal 16, vertical 0. Height ~44.
2. `_StickyTabBarDelegate` extending SliverPersistentHeaderDelegate: wraps PortfolioTabBar with fixed minExtent = maxExtent = 44. Build returns a Material widget (color: transparent for AmbientBackground to show through) containing the tab bar.

**portfolio_filter_chips.dart** — `PortfolioFilterChips` StatelessWidget:
- Takes `ValueNotifier<String> activeFilter`.
- Static list of filter labels: `['Holding amount', 'Cumulative profit', 'Analysis']`.
- SingleChildScrollView horizontal with padding horizontal 16, vertical 8.
- Row of chip widgets. Each chip: GestureDetector wrapping Container with BoxDecoration. Active chip: `AppTheme.bitcoinOrange.withAlpha(51)` background, `AppTheme.bitcoinOrange` border, bitcoinOrange text. Inactive chip: GlassTheme tintColor.withAlpha tinted background, GlassTheme borderColor border, Colors.white70 text. BorderRadius.circular(20). Padding symmetric horizontal 14, vertical 8. Font size 13. Margin-right 8 between chips via Padding(right: 8).
  </action>
  <verify>
Run `dart analyze TradingBot.Mobile` — no errors in the three new files.
  </verify>
  <done>
Three widget files exist with correct imports, GlassCard usage, AppTheme.moneyStyle for monetary values, and withAlpha (not withOpacity) for all color alpha operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild PortfolioScreen with CustomScrollView layout</name>
  <files>
    TradingBot.Mobile/lib/features/portfolio/presentation/portfolio_screen.dart
  </files>
  <action>
Full rebuild of PortfolioScreen — keep it as HookConsumerWidget (already is one):

**State hooks:**
- `final selectedTab = useState(0);` — 0 = Overview, 1 = Transactions
- `final activeFilter = useState('Holding amount');` — default filter
- Keep existing: `ref.watch(portfolioPageDataProvider)`, `ref.watch(currencyPreferenceProvider)`, `ref.listen` for error snackbar.

**Scaffold:** No backgroundColor set (global transparent applies so AmbientBackground shows through). Keep the FloatingActionButton for add-transaction.

**Body:** `RefreshIndicator` wrapping `CustomScrollView`:
- `SliverAppBar`: title "Portfolio", floating: false, pinned: false, elevation: 0, backgroundColor: Colors.transparent (remove old actions — CurrencyToggle moves into hero header).
- AsyncValue switch (same pattern as before):
  - `AsyncData` / `AsyncError with cached` → `_buildContent(...)`
  - `AsyncError` no cache → SliverFillRemaining with RetryWidget
  - Loading → SliverToBoxAdapter with `_buildLoadingSkeleton()` (will be updated in Plan 02)

**_buildContent method** — returns a `List<Widget>` of slivers (not SliverList.list anymore, since we need SliverPersistentHeader). Change `_buildContent` to return `List<Widget>` and spread in the slivers list.

Sliver order:
1. `SliverToBoxAdapter(child: PortfolioHeroHeader(summary: data.summary, isVnd: isVnd))`
2. `SliverPersistentHeader(pinned: true, delegate: StickyTabBarDelegate(child: PortfolioTabBar(selectedTab: selectedTab)))` — import _StickyTabBarDelegate from portfolio_tab_bar.dart (make it public as `StickyTabBarDelegate`).
3. If selectedTab.value == 0 (Overview):
   a. `SliverToBoxAdapter(child: PortfolioFilterChips(activeFilter: activeFilter))`
   b. `SliverToBoxAdapter(child: AllocationDonutChart(...))` — keep the existing donut chart (existing data, works now; glow treatment deferred to Phase 37 per research).
   c. `SliverToBoxAdapter` with a Padding + Row for "Assets" section header with asset count.
   d. `SliverList.builder` for asset rows — flat list of ALL assets (crypto + ETF combined), no longer grouped by ExpansionTile. Sort by the active filter: "Holding amount" → sort by currentValueUsd DESC, "Cumulative profit" → sort by unrealizedPnlUsd DESC, "Analysis" → sort by unrealizedPnlPercent DESC (nulls last). Each row is the existing `AssetRow` widget for now (Plan 02 replaces with glass rows).
   e. If fixedDeposits.isNotEmpty, SliverToBoxAdapter with Divider + "Fixed Deposits" header, then SliverList for fixed deposit rows.
   f. SliverToBoxAdapter for "View Transaction History" text button (existing).
   g. SliverToBoxAdapter with SizedBox(height: 80) for FAB space.
4. If selectedTab.value == 1 (Transactions):
   a. `SliverFillRemaining` wrapping a Center with TextButton "View Full Transaction History" that does `context.push('/portfolio/transaction-history')`. This defers the inline transactions list to a future phase.

**Imports:** Add imports for the three new widget files. Remove import for `AssetTypeSection` (no longer used in the screen, but keep the file for now — it may still be referenced elsewhere). Remove the `PortfolioSummaryCard` import (superseded by hero header).

**Key conventions:**
- Scaffold has NO backgroundColor (transparent via theme).
- AllocationDonutChart stays as-is, receiving same params.
- CurrencyToggle widget moved INTO the PortfolioHeroHeader (remove from SliverAppBar actions).
- Keep the `_sumField` helper if needed, but the flat list approach means we no longer compute per-type subtotals in this screen.
  </action>
  <verify>
Run `dart analyze TradingBot.Mobile` — no errors. The app should compile and the portfolio tab should show the hero header, tab bar, filter chips, donut chart, and flat asset list.
  </verify>
  <done>
PortfolioScreen rebuilt with: (1) GlassCard hero header showing total value + all-time P&L, (2) pinned tab bar for Overview/Transactions, (3) horizontal filter chips that sort the flat asset list, (4) AllocationDonutChart preserved, (5) flat SliverList of assets replacing ExpansionTile groups. AmbientBackground orbs visible behind content. Tab selection and filter state survive rebuilds via useState hooks.
  </done>
</task>

</tasks>

<verification>
1. Run `dart analyze TradingBot.Mobile` — zero errors, zero warnings from new/modified files
2. Visual check: Hero header displays total value with tabular figures and all-time P&L colored green/red
3. Visual check: Tab bar pins at top during scroll, switching between Overview and Transactions works
4. Visual check: Filter chips highlight active chip in orange, tapping a different chip changes sort order of asset list
5. Visual check: AmbientBackground navy orbs visible behind the portfolio content (no solid background)
6. Visual check: FloatingActionButton still present and navigates to add-transaction screen
</verification>

<success_criteria>
- PortfolioScreen is a HookConsumerWidget with CustomScrollView layout
- Hero header uses GlassCard (stationary) with total value and all-time P&L
- Tab bar uses SliverPersistentHeader(pinned: true) and persists selection via useState
- Filter chips sort the flat asset list by holding amount, cumulative profit, or analysis
- No BackdropFilter in scrollable list areas
- No solid backgroundColor on Scaffold
- All monetary values use AppTheme.moneyStyle tabular figures
- All alpha values use withAlpha(int), not withOpacity(float)
</success_criteria>

<output>
After completion, create `.planning/phases/35.1-portfolio-overview-screen/35.1-01-SUMMARY.md`
</output>
