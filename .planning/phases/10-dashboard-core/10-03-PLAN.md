---
phase: 10-dashboard-core
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - TradingBot.Dashboard/app/components/dashboard/StatCard.vue
  - TradingBot.Dashboard/app/components/dashboard/PortfolioStats.vue
  - TradingBot.Dashboard/app/components/dashboard/PriceChart.vue
  - TradingBot.Dashboard/app/components/dashboard/LiveStatus.vue
  - TradingBot.Dashboard/app/components/dashboard/PurchaseCard.vue
  - TradingBot.Dashboard/app/components/dashboard/PurchaseHistory.vue
  - TradingBot.Dashboard/app/app.vue
  - TradingBot.Dashboard/app/plugins/chartjs.client.ts
autonomous: true

must_haves:
  truths:
    - "User sees horizontal row of stat cards showing Total BTC, Total Cost, Average Cost Basis, Current Price, and Unrealized P&L"
    - "P&L card shows both percentage and USD amount with green/red coloring based on profit/loss"
    - "User sees line chart of BTC price history with green B badges at purchase points and dashed average cost basis line"
    - "User can select timeframe presets: 7D, 1M, 3M, 6M, 1Y, All"
    - "User sees live status section with digital countdown timer ticking every second, health badge, and last action summary"
    - "User sees connection status indicator dot (green/yellow/red)"
    - "User sees purchase history as stacked cards with date, price, amount, BTC quantity, and color-coded multiplier tier badge"
    - "User can scroll down to auto-load more purchase cards via infinite scroll"
    - "User can filter purchases by date range"
    - "Page layout flows top-to-bottom: stat cards, price chart, live status, purchase history"
  artifacts:
    - path: "TradingBot.Dashboard/app/components/dashboard/PortfolioStats.vue"
      provides: "Horizontal row of portfolio stat cards"
      contains: "StatCard|totalBtc|totalCost|averageCostBasis|currentPrice|unrealizedPnl"
    - path: "TradingBot.Dashboard/app/components/dashboard/PriceChart.vue"
      provides: "Line chart with purchase markers and average cost basis line"
      contains: "Chart|annotationPlugin|purchase|avgLine"
    - path: "TradingBot.Dashboard/app/components/dashboard/LiveStatus.vue"
      provides: "Bot health status, countdown timer, connection indicator"
      contains: "useCountdownTimer|healthStatus|nextBuyTime|remaining"
    - path: "TradingBot.Dashboard/app/components/dashboard/PurchaseHistory.vue"
      provides: "Infinite scroll purchase card list with date filter"
      contains: "usePurchaseHistory|PurchaseCard|useInfiniteScroll|loadMore"
    - path: "TradingBot.Dashboard/app/app.vue"
      provides: "Main dashboard page assembling all sections"
      contains: "PortfolioStats|PriceChart|LiveStatus|PurchaseHistory"
  key_links:
    - from: "TradingBot.Dashboard/app/app.vue"
      to: "useDashboard composable"
      via: "composable import in setup"
      pattern: "useDashboard"
    - from: "TradingBot.Dashboard/app/components/dashboard/PriceChart.vue"
      to: "Chart.js with annotation plugin"
      via: "vue-chartjs Line component"
      pattern: "chartjs-plugin-annotation|Line"
    - from: "TradingBot.Dashboard/app/components/dashboard/PurchaseHistory.vue"
      to: "usePurchaseHistory composable"
      via: "composable import with infinite scroll"
      pattern: "usePurchaseHistory|useInfiniteScroll"
    - from: "TradingBot.Dashboard/app/components/dashboard/LiveStatus.vue"
      to: "useCountdownTimer composable"
      via: "composable import with status data"
      pattern: "useCountdownTimer"
---

<objective>
Build all Vue dashboard components and assemble the main page: portfolio stat cards, price chart with purchase markers, live bot status with countdown, and infinite-scroll purchase history cards.

Purpose: This is the user-facing layer — transforms API data into the visual dashboard the user interacts with. All layout and interaction decisions from CONTEXT.md are implemented here.

Output: Complete single-page dashboard with six components, one Chart.js plugin, and the assembled app.vue page.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-dashboard-core/10-CONTEXT.md
@.planning/phases/10-dashboard-core/10-RESEARCH.md
@.planning/phases/10-dashboard-core/10-01-SUMMARY.md
@.planning/phases/10-dashboard-core/10-02-SUMMARY.md

Key existing code:
@TradingBot.Dashboard/app/app.vue (current placeholder — will be replaced)
@TradingBot.Dashboard/app/composables/useDashboard.ts (from plan 10-02)
@TradingBot.Dashboard/app/composables/usePurchaseHistory.ts (from plan 10-02)
@TradingBot.Dashboard/app/composables/useCountdownTimer.ts (from plan 10-02)
@TradingBot.Dashboard/app/types/dashboard.ts (from plan 10-02)
@TradingBot.Dashboard/nuxt.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Chart.js plugin and all dashboard components</name>
  <files>
    TradingBot.Dashboard/app/plugins/chartjs.client.ts
    TradingBot.Dashboard/app/components/dashboard/StatCard.vue
    TradingBot.Dashboard/app/components/dashboard/PortfolioStats.vue
    TradingBot.Dashboard/app/components/dashboard/PriceChart.vue
    TradingBot.Dashboard/app/components/dashboard/LiveStatus.vue
    TradingBot.Dashboard/app/components/dashboard/PurchaseCard.vue
    TradingBot.Dashboard/app/components/dashboard/PurchaseHistory.vue
  </files>
  <action>
**Chart.js Plugin** (`app/plugins/chartjs.client.ts`) — Client-only plugin (`.client.ts` suffix):
- Register Chart.js components: CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, Filler
- Register chartjs-plugin-annotation
- Use `Chart.register(...)` from chart.js

**StatCard.vue** — Reusable stat card:
- Props: `title: string`, `value: string`, `subtitle?: string`, `valueClass?: string` (for P&L coloring)
- Use Nuxt UI `UCard` component
- Display title in header area (small, muted text), value as large bold text, subtitle as small muted text below value
- Support loading skeleton when value is empty/undefined — show `USkeleton` in place of value

**PortfolioStats.vue** — Horizontal stat card row:
- Props: portfolio data from `useDashboard` composable (receive as prop, don't call composable here)
- Props: `portfolio: PortfolioResponse | null`, `pending: boolean`
- Render 5 StatCards in a responsive grid: `grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4`
- Cards:
  1. Total BTC — value formatted to 8 decimal places (e.g., "0.05234100")
  2. Total Cost — value formatted as USD with $ prefix and 2 decimals (e.g., "$5,234.00")
  3. Avg Cost Basis — value formatted as USD (e.g., "$97,500.00")
  4. Current Price — value formatted as USD (e.g., "$101,200.00"), make this card visually distinct with a subtle blue left border per Claude's discretion
  5. Unrealized P&L — show both percentage and USD (e.g., "+3.8% / +$198.52"). Apply `text-green-500` for positive, `text-red-500` for negative via valueClass prop
- When pending: show loading skeletons in all cards

**PriceChart.vue** — Line chart with purchase markers:
- Props: none (fetches own chart data)
- State: `selectedTimeframe: Ref<ChartTimeframe>` default '1M'
- Fetch chart data: `useFetch<PriceChartResponse>('/api/dashboard/chart', { query: { timeframe: selectedTimeframe }, server: false, lazy: true, watch: [selectedTimeframe] })`
- Render timeframe buttons as a row of `UButton` (size sm, variant soft/solid for selected) for: 7D, 1M, 3M, 6M, 1Y, All
- Wrap chart in `<ClientOnly>` to avoid SSR hydration issues
- Use vue-chartjs `Line` component (not raw Chart.js) for proper Vue lifecycle cleanup
- Chart configuration:
  - Type: line, responsive: true, maintainAspectRatio: false
  - Dataset: BTC Price line — borderColor: 'rgb(59, 130, 246)' (blue-500), tension: 0.1, pointRadius: 0, borderWidth: 2
  - X axis: labels from prices[].date
  - Y axis: beginAtZero false
  - Annotation plugin config:
    - Average cost basis: type 'line', horizontal dashed line at averageCostBasis value, borderColor 'rgba(239, 68, 68, 0.6)' (red), borderDash [6, 6], borderWidth 2, label with content 'Avg Cost Basis'
    - Purchase markers: for each purchase in response, type 'label', xValue = purchase date, yValue = purchase price, content = ['B'], backgroundColor = 'rgb(34, 197, 94)' (green-500), color = 'white', font = { size: 10, weight: 'bold' }, borderRadius = 4, padding = { top: 2, bottom: 2, left: 4, right: 4 }
  - Tooltip: display price on hover formatted as USD
- Set chart container height: `h-[400px]`
- Show `USkeleton` with same height while loading
- When data is null/empty, show an empty state message: "No price data available. Historical data may need to be ingested."

**LiveStatus.vue** — Bot status section:
- Props: `status: LiveStatusResponse | null`, `pending: boolean`
- Use `useCountdownTimer(nextBuyTime)` composable where nextBuyTime is computed from status.nextBuyTime
- Layout: horizontal flex row with 3 sections separated by vertical dividers, wrapped in a `UCard`
  1. **Health Status**: `UBadge` with dynamic color — "Healthy" = green, "Warning" = yellow/amber, "Error" = red. Below the badge show healthMessage text
  2. **Next Buy**: Show "Next buy in:" label, then the countdown remaining time in large monospace font (e.g., "4h 23m 15s"). Use `font-mono text-2xl font-bold` for the time
  3. **Last Action**: Show "Last buy: Xh ago at $XX,XXX" computed from lastPurchaseTime and lastPurchasePrice. If no last purchase, show "No purchases yet"
- Connection status: small colored dot (w-2 h-2 rounded-full) in top-right corner of the card. Green if status loaded successfully, red if error state. Use inline-block with absolute positioning or flex layout
- Show skeleton loading state while pending

**PurchaseCard.vue** — Single purchase card:
- Props: `purchase: PurchaseDto`
- Use `UCard` component with compact layout
- Layout: horizontal flex with responsive stacking on mobile
  - Left side: Date (formatted as "Feb 13, 2026 14:30 UTC" using date-fns `format`), multiplier tier as `UBadge` with tier-specific colors:
    - "Base" = gray
    - "Tier1" or contains "1" = blue
    - "Tier2" or contains "2" = purple
    - "Tier3" or contains "3" = orange
    - (else) = green
  - Right side: Price (formatted as USD), Cost (formatted as USD), BTC quantity (8 decimal places)
- Compact spacing, no unnecessary padding

**PurchaseHistory.vue** — Infinite scroll container:
- Props: none (uses usePurchaseHistory composable internally)
- Call `usePurchaseHistory()` to get purchases, loading, hasMore, loadMore, startDate, endDate, resetAndLoad
- Date range filter section at top: two native HTML date inputs (`<input type="date">`) for start and end date. On change, update startDate/endDate refs and call resetAndLoad. Simple styled with Tailwind.
- Render purchases as a vertical list of `PurchaseCard` components with `v-for` and `:key="purchase.id"`
- At bottom of list, add a sentinel div for infinite scroll trigger. Use `useInfiniteScroll` from @vueuse/core targeting a ref on the scrollable container (or window) to call `loadMore` when near bottom (distance: 200)
- Show a loading spinner (UIcon or simple div with animation) below cards when `loading` is true
- When `!hasMore && purchases.length > 0`, show "All purchases loaded" text
- When `purchases.length === 0 && !loading`, show empty state: "No purchases found" message
- Call `loadMore` on mount (onMounted) to fetch initial data
  </action>
  <verify>
Run `npx nuxi prepare` to verify TypeScript compilation. Verify all component files exist under `app/components/dashboard/`. Verify `chartjs.client.ts` plugin exists. Verify PriceChart uses `<ClientOnly>` wrapper. Verify PurchaseHistory uses `useInfiniteScroll` from @vueuse/core.
  </verify>
  <done>
Six Vue components created: StatCard (reusable), PortfolioStats (5 stat cards in grid), PriceChart (line chart with markers and annotations), LiveStatus (health badge, countdown timer, last action), PurchaseCard (single purchase display), PurchaseHistory (infinite scroll container with date filter). Chart.js client plugin registered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Assemble main dashboard page in app.vue</name>
  <files>
    TradingBot.Dashboard/app/app.vue
  </files>
  <action>
Replace the placeholder `app/app.vue` with the complete dashboard page. The page is a single scrollable layout following the user's specified flow: stat cards -> price chart -> live status -> purchase history.

```vue
<template>
  <UApp>
    <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
      <!-- Header -->
      <header class="border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
              BTC Smart DCA Dashboard
            </h1>
            <!-- Connection status dot -->
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-500 dark:text-gray-400">
                {{ connectionLabel }}
              </span>
              <span
                class="w-2.5 h-2.5 rounded-full"
                :class="connectionDotClass"
              />
            </div>
          </div>
        </div>
      </header>

      <!-- Main content -->
      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        <!-- Section 1: Portfolio Stats -->
        <DashboardPortfolioStats
          :portfolio="portfolio"
          :pending="portfolioPending"
        />

        <!-- Section 2: Price Chart -->
        <DashboardPriceChart />

        <!-- Section 3: Live Status -->
        <DashboardLiveStatus
          :status="status"
          :pending="statusPending"
        />

        <!-- Section 4: Purchase History -->
        <DashboardPurchaseHistory />
      </main>
    </div>
  </UApp>
</template>

<script setup lang="ts">
const { portfolio, status, portfolioPending, statusPending, portfolioError, statusError } = useDashboard()

// Connection status derived from data fetch state
const connectionState = computed(() => {
  if (portfolioError.value || statusError.value) return 'disconnected'
  if (portfolioPending.value && !portfolio.value) return 'connecting'
  return 'connected'
})

const connectionDotClass = computed(() => ({
  'bg-green-500': connectionState.value === 'connected',
  'bg-yellow-500 animate-pulse': connectionState.value === 'connecting',
  'bg-red-500': connectionState.value === 'disconnected'
}))

const connectionLabel = computed(() => ({
  connected: 'Connected',
  connecting: 'Connecting...',
  disconnected: 'Disconnected'
}[connectionState.value]))
</script>
```

Key implementation notes:
- Use `useDashboard()` composable at the page level to get portfolio and status data
- Pass portfolio data as props to PortfolioStats and LiveStatus
- PriceChart and PurchaseHistory manage their own data internally (self-contained)
- Connection status is derived from error/pending states of the data fetches
- Use Nuxt auto-import for components (DashboardPortfolioStats auto-resolves to components/dashboard/PortfolioStats.vue)
- Responsive layout with max-w-7xl container, padding scales with breakpoints
- Dark mode support throughout (bg-gray-50/bg-gray-900 pattern)
  </action>
  <verify>
Run `npx nuxi prepare` to verify TypeScript compilation. Verify `app.vue` contains DashboardPortfolioStats, DashboardPriceChart, DashboardLiveStatus, DashboardPurchaseHistory components in the correct top-to-bottom order. Verify useDashboard composable is called in setup script.
  </verify>
  <done>
Main dashboard page assembles all four sections in the user-specified order (stat cards -> chart -> live status -> purchase history). Connection status indicator in header shows green/yellow/red based on API connectivity. Responsive layout with dark mode support.
  </done>
</task>

</tasks>

<verification>
1. `npx nuxi prepare` succeeds without TypeScript errors
2. `app/app.vue` renders all four sections in correct order: PortfolioStats, PriceChart, LiveStatus, PurchaseHistory
3. PortfolioStats shows 5 cards in horizontal grid with responsive breakpoints
4. PriceChart uses vue-chartjs Line component wrapped in ClientOnly
5. PriceChart has 6 timeframe buttons: 7D, 1M, 3M, 6M, 1Y, All
6. PriceChart shows green "B" badges for purchases and dashed red line for average cost basis
7. LiveStatus shows health badge, countdown timer with monospace font, and last action summary
8. PurchaseHistory uses useInfiniteScroll from @vueuse/core
9. PurchaseCard shows color-coded multiplier tier badges
10. Connection status dot in header is green/yellow/red based on state
11. All components use Nuxt UI primitives (UCard, UBadge, UButton, USkeleton)
</verification>

<success_criteria>
Complete visual dashboard is functional: stat cards display portfolio metrics with P&L coloring, price chart renders with purchase markers and cost basis line, live status shows ticking countdown and health badge, purchase history infinite-scrolls with date filtering, and connection status is visible. All components follow user's locked decisions from CONTEXT.md (card layout not table, line chart not candlestick, green B badges, card-based purchase list, date range filter only).
</success_criteria>

<output>
After completion, create `.planning/phases/10-dashboard-core/10-03-SUMMARY.md`
</output>
