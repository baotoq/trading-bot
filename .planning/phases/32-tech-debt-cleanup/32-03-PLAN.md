---
phase: 32-tech-debt-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - tests/TradingBot.ApiService.Tests/TradingBot.ApiService.Tests.csproj
  - tests/TradingBot.ApiService.Tests/Endpoints/CustomWebApplicationFactory.cs
  - tests/TradingBot.ApiService.Tests/Endpoints/PortfolioEndpointsTests.cs
  - tests/TradingBot.ApiService.Tests/Endpoints/FixedDepositEndpointsTests.cs
autonomous: true
requirements: []

must_haves:
  truths:
    - "Integration tests exist for portfolio summary GET endpoint returning correct totals with mocked price providers"
    - "Integration tests exist for asset transaction POST endpoint creating transactions and returning 201"
    - "Integration tests exist for fixed deposit GET/POST/PUT/DELETE endpoints with full CRUD cycle"
  artifacts:
    - path: "tests/TradingBot.ApiService.Tests/Endpoints/CustomWebApplicationFactory.cs"
      provides: "WebApplicationFactory subclass with Testcontainers PostgreSQL and mocked external services"
      min_lines: 40
    - path: "tests/TradingBot.ApiService.Tests/Endpoints/PortfolioEndpointsTests.cs"
      provides: "Integration tests for portfolio summary GET and transaction POST"
      min_lines: 80
    - path: "tests/TradingBot.ApiService.Tests/Endpoints/FixedDepositEndpointsTests.cs"
      provides: "Integration tests for fixed deposit CRUD endpoints"
      min_lines: 80
  key_links:
    - from: "tests/TradingBot.ApiService.Tests/Endpoints/CustomWebApplicationFactory.cs"
      to: "TradingBot.ApiService/Program.cs"
      via: "WebApplicationFactory<Program> with Testcontainers PostgreSQL replacing default DB"
      pattern: "WebApplicationFactory<Program>"
    - from: "tests/TradingBot.ApiService.Tests/Endpoints/PortfolioEndpointsTests.cs"
      to: "TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs"
      via: "HTTP GET /api/portfolio/summary and POST /api/portfolio/assets/{id}/transactions"
      pattern: "/api/portfolio"
    - from: "tests/TradingBot.ApiService.Tests/Endpoints/FixedDepositEndpointsTests.cs"
      to: "TradingBot.ApiService/Endpoints/FixedDepositEndpoints.cs"
      via: "HTTP GET/POST/PUT/DELETE /api/portfolio/fixed-deposits"
      pattern: "/api/portfolio/fixed-deposits"
---

<objective>
Add integration tests for portfolio summary, transaction, and fixed deposit endpoints using WebApplicationFactory with Testcontainers PostgreSQL.

Purpose: Closes Phase 32 success criterion #2 — 'Integration tests exist for portfolio summary, transaction, and fixed deposit endpoints'.
Output: CustomWebApplicationFactory shared fixture, PortfolioEndpointsTests.cs, FixedDepositEndpointsTests.cs.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@TradingBot.ApiService/Program.cs
@TradingBot.ApiService/Endpoints/PortfolioEndpoints.cs
@TradingBot.ApiService/Endpoints/FixedDepositEndpoints.cs
@TradingBot.ApiService/Endpoints/FixedDepositDtos.cs
@TradingBot.ApiService/Endpoints/DashboardEndpoints.cs (for ApiKeyEndpointFilter)
@TradingBot.ApiService/Infrastructure/Data/TradingBotDbContext.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/Crypto/ICryptoPriceProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/Etf/IEtfPriceProvider.cs
@TradingBot.ApiService/Infrastructure/PriceFeeds/ExchangeRate/IExchangeRateProvider.cs
@tests/TradingBot.ApiService.Tests/TradingBot.ApiService.Tests.csproj
@tests/TradingBot.ApiService.Tests/Application/Specifications/PostgresFixture.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CustomWebApplicationFactory and endpoint integration tests</name>
  <files>
    tests/TradingBot.ApiService.Tests/TradingBot.ApiService.Tests.csproj
    tests/TradingBot.ApiService.Tests/Endpoints/CustomWebApplicationFactory.cs
    tests/TradingBot.ApiService.Tests/Endpoints/PortfolioEndpointsTests.cs
    tests/TradingBot.ApiService.Tests/Endpoints/FixedDepositEndpointsTests.cs
  </files>
  <action>
    **Step 1: Add Microsoft.AspNetCore.Mvc.Testing package.**

    Add to the test .csproj:
    ```xml
    <PackageReference Include="Microsoft.AspNetCore.Mvc.Testing" Version="10.0.0" />
    ```

    **Step 2: Create CustomWebApplicationFactory.**

    Create `tests/TradingBot.ApiService.Tests/Endpoints/CustomWebApplicationFactory.cs`:

    - Subclass `WebApplicationFactory<Program>` and implement `IAsyncLifetime`.
    - Spin up a Testcontainers PostgreSqlContainer (reuse the same pattern from `PostgresFixture.cs`: `new PostgreSqlBuilder("postgres:16").WithDatabase("tradingbot_test")...`).
    - Override `ConfigureWebHost` to:
      1. Remove the existing `DbContextOptions<TradingBotDbContext>` registration.
      2. Add `services.AddDbContext<TradingBotDbContext>(opts => opts.UseNpgsql(container.GetConnectionString()))`.
      3. Register NSubstitute mocks for `ICryptoPriceProvider`, `IEtfPriceProvider`, and `IExchangeRateProvider` as singletons (replacing real implementations). These mocks return predictable prices: crypto BTC = $95000, ETF = 20000 VND, exchange rate = 25000 VND/USD.
      4. Set `configuration["Dashboard:ApiKey"] = "test-api-key"` so the ApiKeyEndpointFilter passes.
      5. Remove or replace any Dapr-related services that would fail without a sidecar (e.g., `IMessageBroker`). Use `services.Remove` for Dapr registrations, or register a NSubstitute mock for `IMessageBroker`.
      6. Remove background services that would interfere (any `IHostedService` registrations from DI that hit external APIs). Use `services.RemoveAll<IHostedService>()` to be safe, or selectively remove the ones that cause issues.
    - In `InitializeAsync`: start the container, then create a scope, get `TradingBotDbContext`, and run `await db.Database.MigrateAsync()`.
    - In `DisposeAsync`: stop the container.
    - Expose the mocks as public properties so test classes can configure return values:
      ```csharp
      public ICryptoPriceProvider CryptoMock { get; } = Substitute.For<ICryptoPriceProvider>();
      public IEtfPriceProvider EtfMock { get; } = Substitute.For<IEtfPriceProvider>();
      public IExchangeRateProvider ExchangeRateMock { get; } = Substitute.For<IExchangeRateProvider>();
      ```

    Use the `ICollectionFixture<CustomWebApplicationFactory>` xUnit pattern so the container is shared across all endpoint test classes (started once per test run). Define a collection:
    ```csharp
    [CollectionDefinition("Endpoints")]
    public class EndpointsCollection : ICollectionFixture<CustomWebApplicationFactory>;
    ```

    **Step 3: Create PortfolioEndpointsTests.**

    Create `tests/TradingBot.ApiService.Tests/Endpoints/PortfolioEndpointsTests.cs`:

    - Annotate with `[Collection("Endpoints")]`.
    - Inject `CustomWebApplicationFactory` via constructor.
    - Create `HttpClient` via `factory.CreateClient()`. Add `x-api-key: test-api-key` default header.
    - Set up mocks in constructor (or per-test):
      - `factory.ExchangeRateMock.GetUsdToVndRateAsync(Arg.Any<CancellationToken>()).Returns(PriceFeedResult.Fresh(25000m, DateTime.UtcNow, "VND"))`.
      - `factory.CryptoMock.GetPriceAsync("bitcoin", Arg.Any<CancellationToken>()).Returns(PriceFeedResult.Fresh(95000m, DateTime.UtcNow, "USD"))`.

    Tests:
    1. `GetSummary_EmptyPortfolio_ReturnsOkWithZeroTotals` — GET `/api/portfolio/summary`, assert 200 OK, parse JSON, assert TotalValueUsd = 0 and TotalValueVnd = 0.
    2. `CreateAsset_ValidRequest_ReturnsCreated` — POST `/api/portfolio/assets` with `{ name: "Bitcoin", ticker: "BTC", assetType: "Crypto", nativeCurrency: "USD" }`, assert 201 Created, parse response and assert ticker = "BTC".
    3. `CreateTransaction_ValidRequest_ReturnsCreated` — First create an asset (POST), then POST `/api/portfolio/assets/{id}/transactions` with `{ date: "2025-01-01", quantity: 0.1, pricePerUnit: 95000, currency: "USD", type: "Buy" }`, assert 201.
    4. `GetSummary_WithAssetAndTransaction_ReturnsNonZeroTotals` — Create asset + transaction, then GET `/api/portfolio/summary`, assert TotalValueUsd > 0.

    Important: Each test should clean up created data to avoid cross-test interference. Use a helper method that truncates the PortfolioAssets and AssetTransactions tables via a scoped DbContext from `factory.Services.CreateScope()`, OR use unique tickers per test to avoid conflicts.

    **Step 4: Create FixedDepositEndpointsTests.**

    Create `tests/TradingBot.ApiService.Tests/Endpoints/FixedDepositEndpointsTests.cs`:

    - Annotate with `[Collection("Endpoints")]`.
    - Same factory injection and client setup.

    Tests:
    1. `GetAll_Empty_ReturnsEmptyList` — GET `/api/portfolio/fixed-deposits`, assert 200 OK, parse JSON array, assert empty.
    2. `Create_ValidRequest_ReturnsCreated` — POST with `{ bankName: "Test Bank", principal: 100000000, annualInterestRate: 0.06, startDate: "2025-01-01", maturityDate: "2026-01-01", compoundingFrequency: "Monthly" }`, assert 201, parse response and verify bankName = "Test Bank".
    3. `GetById_ExistingDeposit_ReturnsOk` — Create a deposit, then GET `/{id}`, assert 200 and correct data.
    4. `Update_ExistingDeposit_ReturnsOk` — Create a deposit, then PUT `/{id}` with updated bankName, assert 200 and verify updated bankName in response.
    5. `Delete_ExistingDeposit_ReturnsNoContent` — Create a deposit, then DELETE `/{id}`, assert 204. Verify GET `/{id}` returns 404.
    6. `Create_InvalidCompoundingFrequency_ReturnsBadRequest` — POST with bad compounding frequency, assert 400.

    For JSON serialization in test requests, use `JsonContent.Create(requestObject)` or `StringContent` with `application/json`. For parsing responses, use `response.Content.ReadFromJsonAsync<T>()` with `System.Net.Http.Json`.

    Clean up fixed deposits between tests with a helper that truncates the FixedDeposits table via scoped DbContext.
  </action>
  <verify>
    Run `dotnet build TradingBot.slnx` — compiles without errors.
    Run `dotnet test tests/TradingBot.ApiService.Tests/ --filter "FullyQualifiedName~EndpointsTests"` — all integration tests pass.
    Run `dotnet test` — full suite passes (no regressions).
  </verify>
  <done>
    CustomWebApplicationFactory exists with Testcontainers PostgreSQL, mocked price providers, and API key config. PortfolioEndpointsTests has at least 4 tests covering summary GET and transaction POST. FixedDepositEndpointsTests has at least 6 tests covering full CRUD cycle. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.slnx` — solution compiles without errors
2. `dotnet test tests/TradingBot.ApiService.Tests/ --filter "FullyQualifiedName~EndpointsTests"` — all endpoint integration tests pass
3. `dotnet test` — full test suite passes
4. Verify CustomWebApplicationFactory.cs uses Testcontainers PostgreSQL and mocks external services
5. Verify PortfolioEndpointsTests.cs tests portfolio summary GET and transaction creation POST
6. Verify FixedDepositEndpointsTests.cs tests GET/POST/PUT/DELETE for fixed deposits
</verification>

<success_criteria>
- CustomWebApplicationFactory with Testcontainers PostgreSQL and mocked price providers exists
- At least 4 integration tests for portfolio endpoints (summary + transaction)
- At least 6 integration tests for fixed deposit endpoints (full CRUD)
- All integration tests pass with `dotnet test`
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/32-tech-debt-cleanup/32-03-SUMMARY.md`
</output>
