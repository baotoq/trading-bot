---
phase: 16-result-pattern
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.ApiService/TradingBot.ApiService.csproj
  - TradingBot.ApiService/Models/DcaConfigurationErrors.cs
  - TradingBot.ApiService/Models/DcaConfiguration.cs
  - TradingBot.ApiService/BuildingBlocks/ErrorOrExtensions.cs
autonomous: true
requirements: [EH-01, EH-02]

must_haves:
  truths:
    - "DcaConfiguration behavior methods return ErrorOr<Updated> instead of throwing exceptions for validation failures"
    - "Fine-grained error codes exist for each distinct failure reason (InvalidScheduleHour, InvalidScheduleMinute, TiersNotAscending, etc.)"
    - "A shared ToHttpResult() extension maps ErrorOr error types to RFC 7807 Problem Details HTTP responses"
  artifacts:
    - path: "TradingBot.ApiService/Models/DcaConfigurationErrors.cs"
      provides: "Fine-grained error definitions for DcaConfiguration aggregate"
      contains: "InvalidScheduleHour"
    - path: "TradingBot.ApiService/BuildingBlocks/ErrorOrExtensions.cs"
      provides: "ToHttpResult() extension method mapping ErrorOr to HTTP status codes"
      contains: "ToHttpResult"
    - path: "TradingBot.ApiService/Models/DcaConfiguration.cs"
      provides: "Behavior methods returning ErrorOr<Updated> instead of throwing"
      contains: "ErrorOr<Updated>"
  key_links:
    - from: "TradingBot.ApiService/Models/DcaConfiguration.cs"
      to: "TradingBot.ApiService/Models/DcaConfigurationErrors.cs"
      via: "Error references in behavior methods"
      pattern: "DcaConfigurationErrors\\."
    - from: "TradingBot.ApiService/BuildingBlocks/ErrorOrExtensions.cs"
      to: "ErrorOr library"
      via: "Extension method on ErrorOr<T>"
      pattern: "ErrorOr<"
---

<objective>
Install ErrorOr package, define fine-grained domain errors for DcaConfiguration, convert aggregate behavior methods from throwing exceptions to returning ErrorOr<Updated>, and create shared ToHttpResult() extension for endpoint mapping.

Purpose: Establish the ErrorOr foundation -- package, error definitions, aggregate method signatures, and HTTP mapping utility -- so Plan 02 can wire services and endpoints.
Output: ErrorOr installed, DcaConfiguration behavior methods return ErrorOr<Updated>, DcaConfigurationErrors.cs with fine-grained codes, ToHttpResult() extension ready for endpoints.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-result-pattern/16-CONTEXT.md
@.planning/phases/15-rich-aggregate-roots/15-02-SUMMARY.md
@TradingBot.ApiService/Models/DcaConfiguration.cs
@TradingBot.ApiService/TradingBot.ApiService.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ErrorOr package and create DcaConfiguration error definitions</name>
  <files>
    TradingBot.ApiService/TradingBot.ApiService.csproj
    TradingBot.ApiService/Models/DcaConfigurationErrors.cs
  </files>
  <action>
1. Add ErrorOr NuGet package to TradingBot.ApiService.csproj:
   ```bash
   cd TradingBot.ApiService && dotnet add package ErrorOr
   ```

2. Create `TradingBot.ApiService/Models/DcaConfigurationErrors.cs` with fine-grained error definitions using ErrorOr's built-in Error.Validation() factory. Per locked decision: errors live next to their aggregate, short error codes without aggregate prefix, code + human-readable message only.

   Define these errors (one per distinct failure reason in the current throwing code):
   - `InvalidScheduleHour` -- Error.Validation("InvalidScheduleHour", "Hour must be between 0 and 23")
   - `InvalidScheduleMinute` -- Error.Validation("InvalidScheduleMinute", "Minute must be between 0 and 59")
   - `TiersNotAscending` -- Error.Validation("TiersNotAscending", "Tiers must be ordered by ascending drop percentage")
   - `TierMultiplierOutOfRange` -- Error.Validation("TierMultiplierOutOfRange", "Tier multipliers must be between 0 (exclusive) and 20 (inclusive)")
   - `TierDropPercentageDuplicate` -- Error.Validation("TierDropPercentageDuplicate", "Tier drop percentages must be unique")
   - `InvalidMaPeriod` -- Error.Validation("InvalidMaPeriod", "MA period must be greater than 0")
   - `InvalidHighLookbackDays` -- Error.Validation("InvalidHighLookbackDays", "High lookback days must be greater than 0")

   Pattern: static class with static readonly Error fields.

   ```csharp
   using ErrorOr;

   namespace TradingBot.ApiService.Models;

   public static class DcaConfigurationErrors
   {
       public static readonly Error InvalidScheduleHour = Error.Validation(
           "InvalidScheduleHour", "Hour must be between 0 and 23");
       // ... etc
   }
   ```
  </action>
  <verify>
    `dotnet build TradingBot.sln` compiles with 0 errors. DcaConfigurationErrors.cs exists with all 7 error definitions.
  </verify>
  <done>
    ErrorOr package installed. DcaConfigurationErrors.cs contains 7 fine-grained validation errors matching every throw site in DcaConfiguration behavior methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert DcaConfiguration behavior methods to ErrorOr and create ToHttpResult extension</name>
  <files>
    TradingBot.ApiService/Models/DcaConfiguration.cs
    TradingBot.ApiService/BuildingBlocks/ErrorOrExtensions.cs
  </files>
  <action>
1. Update `TradingBot.ApiService/Models/DcaConfiguration.cs`:

   a. Add `using ErrorOr;` import.

   b. Change behavior methods that currently throw to return `ErrorOr&lt;Updated&gt;` (ErrorOr's built-in `Updated` type for void-returning success operations):

   - `UpdateSchedule(int hour, int minute)` -> `ErrorOr&lt;Updated&gt;`:
     Replace `throw new ArgumentException(...)` with `return DcaConfigurationErrors.InvalidScheduleHour;` / `return DcaConfigurationErrors.InvalidScheduleMinute;`
     On success: set fields, set UpdatedAt, AddDomainEvent, `return Result.Updated;`

   - `UpdateTiers(List&lt;MultiplierTierData&gt; tiers)` -> `ErrorOr&lt;Updated&gt;`:
     Replace throws in ValidateTiers with returning errors.
     On success: set field, set UpdatedAt, AddDomainEvent, `return Result.Updated;`

   - `UpdateBearMarket(int maPeriod, Multiplier boostFactor)` -> `ErrorOr&lt;Updated&gt;`:
     Replace throw with `return DcaConfigurationErrors.InvalidMaPeriod;`
     On success: set fields, set UpdatedAt, AddDomainEvent, `return Result.Updated;`

   - `UpdateSettings(int highLookbackDays, bool dryRun, Multiplier maxMultiplierCap)` -> `ErrorOr&lt;Updated&gt;`:
     Replace throw with `return DcaConfigurationErrors.InvalidHighLookbackDays;`
     On success: set fields, set UpdatedAt, AddDomainEvent, `return Result.Updated;`

   - `UpdateDailyAmount(UsdAmount amount)` -> keep as `void` (no validation, value object guarantees validity).

   c. Change `ValidateSchedule` from `private static void` to `private static List&lt;Error&gt;?` that returns null on success or a list of errors on failure. Or simpler: inline the validation into each method since they're small. Use whichever approach is cleaner.

   d. Change `ValidateTiers` similarly. The `Create()` factory method still calls these validators -- per locked decision, factory methods stay as-is (they throw). So keep a SEPARATE throwing validation path for Create() if needed. **Approach**: Keep ValidateSchedule/ValidateTiers as throwing (used by Create) and add non-throwing ErrorOr validation inline in behavior methods. OR change Create() to also use the ErrorOr-returning validators but then throw on error (defense wrapper). Choose the approach that avoids duplication: refactor validators to return `ErrorOr<Updated>`, use them in behavior methods directly, and have Create() call them and throw if error (`.Value` or `ThrowIfError()` pattern -- since factory stays throwing per locked decision).

   Best approach: Refactor validators to return `List&lt;Error&gt;` (empty = success). Behavior methods check and return errors. Create() calls same validators and throws `ArgumentException` if any errors (preserving existing behavior).

   ```csharp
   private static List<Error> ValidateScheduleErrors(int hour, int minute)
   {
       var errors = new List<Error>();
       if (hour < 0 || hour > 23) errors.Add(DcaConfigurationErrors.InvalidScheduleHour);
       if (minute < 0 || minute > 59) errors.Add(DcaConfigurationErrors.InvalidScheduleMinute);
       return errors;
   }
   ```

2. Create `TradingBot.ApiService/BuildingBlocks/ErrorOrExtensions.cs`:

   Shared extension method mapping ErrorOr error types to HTTP status codes using RFC 7807 Problem Details. Per locked decision: use TypedResults.Problem().

   ```csharp
   using ErrorOr;

   namespace TradingBot.ApiService.BuildingBlocks;

   public static class ErrorOrExtensions
   {
       public static IResult ToHttpResult<T>(this ErrorOr<T> errorOr)
       {
           if (!errorOr.IsError)
           {
               return errorOr.Value switch
               {
                   Updated => Results.NoContent(),
                   _ => Results.Ok(errorOr.Value)
               };
           }

           var firstError = errorOr.FirstError;

           return firstError.Type switch
           {
               ErrorType.Validation => Results.Problem(
                   statusCode: 400,
                   title: "Validation Error",
                   detail: firstError.Description,
                   extensions: errorOr.Errors.Count > 1
                       ? new Dictionary<string, object?>
                       {
                           ["errors"] = errorOr.Errors.Select(e => new { code = e.Code, message = e.Description }).ToList()
                       }
                       : new Dictionary<string, object?>
                       {
                           ["errors"] = new[] { new { code = firstError.Code, message = firstError.Description } }
                       }),
               ErrorType.NotFound => Results.Problem(
                   statusCode: 404,
                   title: "Not Found",
                   detail: firstError.Description),
               ErrorType.Conflict => Results.Problem(
                   statusCode: 409,
                   title: "Conflict",
                   detail: firstError.Description),
               _ => Results.Problem(
                   statusCode: 500,
                   title: "Internal Error",
                   detail: firstError.Description)
           };
       }
   }
   ```

3. Ensure `dotnet build TradingBot.sln` compiles. There WILL be compile errors in ConfigurationService.cs because it calls behavior methods that now return ErrorOr instead of void -- these are fixed in Plan 02.

   **Important**: The build may fail at this point due to callers not handling ErrorOr returns. This is expected and addressed in Plan 02. Verify the aggregate and extension files themselves are correct by checking for no syntax errors in the modified files.
  </action>
  <verify>
    Files exist and are syntactically correct. `dotnet build TradingBot.sln` may have caller-site errors in ConfigurationService -- that is expected and resolved in Plan 02. Verify DcaConfiguration.cs has `ErrorOr&lt;Updated&gt;` return types on UpdateSchedule, UpdateTiers, UpdateBearMarket, UpdateSettings. Verify ErrorOrExtensions.cs exists with ToHttpResult method.
  </verify>
  <done>
    DcaConfiguration behavior methods return ErrorOr&lt;Updated&gt; with fine-grained error codes. ToHttpResult() extension maps error types to RFC 7807 Problem Details. Create() factory still throws (per locked decision). Solution may not fully compile until Plan 02 updates callers.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build TradingBot.sln` -- may have caller errors (ConfigurationService) expected for Plan 02
2. DcaConfigurationErrors.cs has 7 fine-grained error definitions
3. DcaConfiguration behavior methods (UpdateSchedule, UpdateTiers, UpdateBearMarket, UpdateSettings) return ErrorOr<Updated>
4. DcaConfiguration.Create() still throws on invalid input (factory method unchanged per decision)
5. ErrorOrExtensions.cs ToHttpResult() handles Validation->400, NotFound->404, Conflict->409
</verification>

<success_criteria>
- ErrorOr NuGet package installed and referenced
- DcaConfigurationErrors.cs contains fine-grained errors matching each validation throw
- DcaConfiguration behavior methods return ErrorOr<Updated> instead of throwing
- ToHttpResult() extension ready for endpoint consumption in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/16-result-pattern/16-01-SUMMARY.md`
</output>
