---
phase: 36-home-screen-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/home_hero_balance_card.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/home_mini_donut_card.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/home_recent_activity_card.dart
  - TradingBot.Mobile/lib/features/home/presentation/widgets/home_quick_actions_card.dart
autonomous: true
requirements: [SCRN-01, ANIM-02, ANIM-03]

must_haves:
  truths:
    - "Home tab displays a hero balance card with total portfolio value in a GlassCard"
    - "Home tab displays a mini allocation donut chart in a GlassCard"
    - "Home tab displays the last 3 purchase activity items in a GlassCard"
    - "Home tab displays quick action buttons (View Bot, View Chart, History) in a GlassCard"
    - "On first opening the Home tab after app launch, the 4 glass cards cascade in with staggered entrance (50ms offset per card)"
    - "The hero balance value animates from zero to the actual value on first load (count-up effect)"
    - "On tab revisit, cards appear instantly without re-animating"
    - "With Reduce Motion enabled, all animations are skipped and content appears instantly"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      provides: "Redesigned HomeScreen with 4 GlassCard sections, stagger controller, and count-up balance"
      contains: "useAnimationController"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/home_hero_balance_card.dart"
      provides: "Hero balance GlassCard with TweenAnimationBuilder count-up"
      contains: "TweenAnimationBuilder"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/home_mini_donut_card.dart"
      provides: "Mini allocation donut chart in GlassCard"
      contains: "PieChart"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/home_recent_activity_card.dart"
      provides: "Last 3 purchases in GlassCard"
      contains: "PurchaseListItem"
    - path: "TradingBot.Mobile/lib/features/home/presentation/widgets/home_quick_actions_card.dart"
      provides: "Quick action navigation buttons in GlassCard"
      contains: "GlassCard"
  key_links:
    - from: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      to: "homeDataProvider"
      via: "ref.watch(homeDataProvider)"
      pattern: "ref\\.watch\\(homeDataProvider\\)"
    - from: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      to: "portfolioPageDataProvider"
      via: "ref.watch for allocation data"
      pattern: "ref\\.watch\\(portfolioPageDataProvider\\)"
    - from: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      to: "purchaseHistoryProvider"
      via: "ref.watch for recent purchases"
      pattern: "purchaseHistoryProvider"
---

<objective>
Redesign the Home tab as a premium glassmorphism dashboard with 4 glass card sections: hero balance (with count-up animation), mini allocation donut, recent purchase activity, and quick action buttons. Cards cascade in with staggered entrance animation on first load.

Purpose: Transform the Home tab from a plain text layout into a polished dashboard overview that matches the premium glassmorphism design system established in Phases 33-34.

Output: Redesigned HomeScreen with 4 new widget files, staggered entrance animation, and count-up balance effect.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-home-screen-redesign/36-RESEARCH.md

Key existing files to reference:
@TradingBot.Mobile/lib/features/home/presentation/home_screen.dart (current — being replaced)
@TradingBot.Mobile/lib/features/home/data/home_providers.dart (HomeData model)
@TradingBot.Mobile/lib/features/portfolio/data/portfolio_providers.dart (portfolioPageDataProvider for allocations)
@TradingBot.Mobile/lib/features/portfolio/presentation/widgets/allocation_donut_chart.dart (PieChart reference)
@TradingBot.Mobile/lib/features/history/presentation/widgets/purchase_list_item.dart (PurchaseListItem widget)
@TradingBot.Mobile/lib/features/history/data/purchase_history_providers.dart (purchaseHistoryProvider)
@TradingBot.Mobile/lib/core/widgets/glass_card.dart (GlassCard, GlassVariant, shouldReduceMotion)
@TradingBot.Mobile/lib/core/widgets/shimmer_loading.dart (AppShimmer, Bone)
@TradingBot.Mobile/lib/app/theme.dart (AppTheme, moneyStyle, profitGreen, lossRed, bitcoinOrange)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 4 home dashboard card widgets</name>
  <files>
    TradingBot.Mobile/lib/features/home/presentation/widgets/home_hero_balance_card.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/home_mini_donut_card.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/home_recent_activity_card.dart
    TradingBot.Mobile/lib/features/home/presentation/widgets/home_quick_actions_card.dart
  </files>
  <action>
    Create 4 new StatelessWidget files in the home widgets directory:

    **1. HomeHeroBalanceCard** (`home_hero_balance_card.dart`):
    - Takes `portfolioValue` (double), `pnlAbsolute` (double), `pnlPercentage` (double), `shouldAnimate` (bool) as constructor params.
    - Wraps content in a `GlassCard` (stationary variant, default) with `margin: EdgeInsets.symmetric(horizontal: 16, vertical: 8)` and `padding: EdgeInsets.all(20)`.
    - Displays "Portfolio Value" label in `textTheme.bodySmall` with `Colors.white70`.
    - Hero balance uses `TweenAnimationBuilder<double>`:
      - `tween: Tween<double>(begin: shouldAnimate ? 0.0 : portfolioValue, end: portfolioValue)` — prevents re-animation on refresh per Pitfall 1 from RESEARCH.md.
      - `duration: Duration(milliseconds: 1200)`, `curve: Curves.easeOut`.
      - Builder formats value with `NumberFormat.currency(symbol: '\$', decimalDigits: 2)`.
      - Text style: `textTheme.headlineMedium?.copyWith(fontWeight: FontWeight.bold, color: Colors.white).merge(AppTheme.moneyStyle)`.
    - Below the balance, show P&L row: absolute value formatted as currency + percentage in parentheses. Color: `AppTheme.profitGreen` if positive, `AppTheme.lossRed` if negative. Use `Icon(Icons.arrow_drop_up)` or `Icons.arrow_drop_down` next to P&L text.
    - Below P&L, show `HealthBadge` if healthStatus/healthMessage are passed (optional params, null by default). Import from existing `widgets/health_badge.dart`.

    **2. HomeMiniDonutCard** (`home_mini_donut_card.dart`):
    - Takes `allocations` (List of allocation objects from PortfolioSummaryResponse) and `isVnd` (bool) as constructor params.
    - Wraps content in `GlassCard` with same margin pattern.
    - Shows "Allocation" title in `textTheme.titleSmall` with `Colors.white`.
    - Renders `PieChart` from `fl_chart` inside a `SizedBox(height: 140)`:
      - `centerSpaceRadius: 40`, `centerSpaceColor: Colors.transparent`, `sectionsSpace: 2`.
      - Map allocations to `PieChartSectionData(value: a.percentage, color: _colorForType(a.assetType), radius: 45, showTitle: false)`.
      - Use the same color mapping as the existing `AllocationDonutChart` widget.
    - Below the chart, show a compact row of allocation labels: asset type name + percentage, wrapped in a `Wrap` widget with 8px spacing.
    - If allocations is empty, show a centered "No allocations" text in `Colors.white38`.

    **3. HomeRecentActivityCard** (`home_recent_activity_card.dart`):
    - Takes `purchases` (List of PurchaseDto, max 3 items) as constructor param.
    - Wraps content in `GlassCard` with same margin pattern.
    - Shows "Recent Purchases" title in `textTheme.titleSmall`.
    - Renders up to 3 `PurchaseListItem` widgets in a `Column` (NOT a ListView — static column is BackdropFilter-safe per project constraint).
    - If purchases is empty, show "No purchases yet" in `Colors.white38`.
    - Add `SizedBox(height: 8)` between items.

    **4. HomeQuickActionsCard** (`home_quick_actions_card.dart`):
    - Takes a `void Function(String)` callback `onActionTap` as constructor param.
    - Wraps content in `GlassCard` with same margin pattern.
    - Shows "Quick Actions" title in `textTheme.titleSmall`.
    - Renders a `Row` of 3 action buttons: "View Bot" (icon: `Icons.smart_toy_outlined`), "Chart" (icon: `Icons.show_chart`), "History" (icon: `Icons.history`).
    - Each button is a `Column` with `Icon` + `Text` wrapped in an `InkWell` or `GestureDetector` calling `onActionTap` with the action key ("bot-detail", "chart", "history").
    - Style: icon size 28, color `AppTheme.bitcoinOrange`, text size 12, color `Colors.white70`. Use `Expanded` for equal spacing in the `Row`.

    All widgets: import `AppTheme` from `../../../../app/theme.dart`, import `GlassCard` from `../../../../core/widgets/glass_card.dart`.
  </action>
  <verify>
    Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze lib/features/home/presentation/widgets/home_hero_balance_card.dart lib/features/home/presentation/widgets/home_mini_donut_card.dart lib/features/home/presentation/widgets/home_recent_activity_card.dart lib/features/home/presentation/widgets/home_quick_actions_card.dart` — zero errors.
  </verify>
  <done>
    4 new widget files exist in `lib/features/home/presentation/widgets/`, all pass static analysis. HomeHeroBalanceCard contains TweenAnimationBuilder for count-up. HomeMiniDonutCard contains PieChart. HomeRecentActivityCard contains PurchaseListItem column. HomeQuickActionsCard contains 3 action buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild HomeScreen with staggered glass card dashboard layout</name>
  <files>
    TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
  </files>
  <action>
    Rewrite `home_screen.dart` as a `HookConsumerWidget` (it already is, but needs hooks added):

    **Imports to add:**
    - `package:flutter_hooks/flutter_hooks.dart`
    - `package:trading_bot_app/features/portfolio/data/portfolio_providers.dart` (portfolioPageDataProvider)
    - `package:trading_bot_app/features/history/data/purchase_history_providers.dart` (purchaseHistoryProvider)
    - The 4 new widget files created in Task 1.
    - Keep existing imports for `glass_card.dart`, `shimmer_loading.dart`, `home_providers.dart`, `error_snackbar.dart`, `retry_widget.dart`, `api_exception.dart`.
    - Remove import for `countdown_text.dart` (no longer used on home).

    **Build method structure:**

    1. Watch 3 providers:
       ```dart
       final homeData = ref.watch(homeDataProvider);
       final portfolioData = ref.watch(portfolioPageDataProvider);
       final purchaseHistory = ref.watch(purchaseHistoryProvider);
       ```

    2. Keep existing error snackbar listener for `homeDataProvider`.

    3. **Stagger animation setup** (ANIM-03):
       - `final hasAnimated = useRef(false);`
       - `final controller = useAnimationController(duration: const Duration(milliseconds: 450));` — 300ms per card + 3 * 50ms stagger = 450ms total.
       - `final reduceMotion = GlassCard.shouldReduceMotion(context);`
       - `useEffect` with `[reduceMotion]` deps:
         ```dart
         useEffect(() {
           if (!hasAnimated.value) {
             hasAnimated.value = true;
             if (reduceMotion) {
               controller.value = 1.0;
             } else {
               controller.forward();
             }
           }
           return null;
         }, [reduceMotion]);
         ```

    4. **shouldAnimate flag** for count-up (ANIM-02):
       ```dart
       final shouldAnimateCountUp = useRef(true);
       // After first build with data, set to false
       ```
       Check: `final animateCountUp = shouldAnimateCountUp.value && !reduceMotion;`
       When data arrives: `if (shouldAnimateCountUp.value && homeData.hasValue) shouldAnimateCountUp.value = false;`
       — This ensures count-up fires only on first load and never replays on refresh.

    5. **Card entrance helper** (private function in file):
       ```dart
       Animation<double> _cardEntrance(AnimationController ctrl, int index) {
         const staggerMs = 50.0;
         const animMs = 300.0;
         const totalMs = animMs + staggerMs * 3; // 450ms
         final start = (index * staggerMs) / totalMs;
         final end = ((index * staggerMs + animMs) / totalMs).clamp(0.0, 1.0);
         return CurvedAnimation(
           parent: ctrl,
           curve: Interval(start, end, curve: Curves.easeOut),
         );
       }
       ```

    6. **Animated card wrapper** (private function):
       ```dart
       Widget _animatedCard(AnimationController ctrl, int index, Widget card) {
         return AnimatedBuilder(
           animation: ctrl,
           builder: (context, child) {
             final anim = _cardEntrance(ctrl, index);
             return FadeTransition(
               opacity: anim,
               child: SlideTransition(
                 position: Tween<Offset>(
                   begin: const Offset(0, 0.06),
                   end: Offset.zero,
                 ).animate(anim),
                 child: child,
               ),
             );
           },
           child: card,
         );
       }
       ```

    7. **Scaffold body** — same `RefreshIndicator` + `CustomScrollView` pattern as current:
       - `SliverAppBar` with transparent background (AmbientBackground orbs visible), title 'Home', floating+snap, no HealthBadge in app bar (moved to hero card).
       - Content: 4 animated glass cards in a `SliverList.list`:
         ```dart
         _animatedCard(controller, 0, HomeHeroBalanceCard(...)),
         _animatedCard(controller, 1, HomeMiniDonutCard(...)),
         _animatedCard(controller, 2, HomeRecentActivityCard(...)),
         _animatedCard(controller, 3, HomeQuickActionsCard(...)),
         ```
       - Pass data from the 3 providers. For portfolioData, extract allocations from `.value?.summary?.allocations ?? []`. For purchaseHistory, take first 3 items: `.value?.take(3).toList() ?? []`.
       - Quick actions `onActionTap` handler:
         - "bot-detail" -> `context.push('/home/bot-detail')`
         - "chart" -> `StatefulNavigationShell.of(context).goBranch(1)` (Chart tab index)
         - "history" -> `StatefulNavigationShell.of(context).goBranch(2)` (History tab index)

    8. **Loading skeleton** — update `_buildLoadingSkeleton()` to show 4 skeleton GlassCard shapes matching the new layout (hero balance card skeleton, donut placeholder, 3 activity row skeletons, action buttons skeleton). Use `AppShimmer` + `GlassCard` with `Bone` widgets inside each.

    9. **Error state** — keep `RetryWidget` as-is for full error. For stale data (error + cached), show cached data (same pattern as current).

    **Key project conventions to follow:**
    - `HookConsumerWidget` (not StatefulWidget)
    - `useAnimationController` (not manual AnimationController)
    - `useRef(false)` as `_hasAnimated` guard
    - `GlassCard.shouldReduceMotion(context)` checked in build, passed to useEffect deps
    - `Color.withAlpha(int)` not `withOpacity(float)`
    - No `backgroundColor` on Scaffold (global transparent theme)
    - SliverAppBar `backgroundColor: Colors.transparent` for AmbientBackground orbs
  </action>
  <verify>
    Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze lib/features/home/presentation/home_screen.dart` — zero errors. Verify file contains `useAnimationController`, `useRef`, `TweenAnimationBuilder` (via HomeHeroBalanceCard), `_cardEntrance`, `_animatedCard`, `GlassCard.shouldReduceMotion`.
  </verify>
  <done>
    HomeScreen rebuilt with 4 GlassCard dashboard sections. Staggered entrance animation (450ms controller, 50ms per-card offset via Interval) fires on first mount only. Count-up balance animates from 0 to actual value on first data load. Reduce Motion skips all animations (snaps to final state). Loading skeleton matches new layout. Error handling preserved.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter analyze` — zero errors across all home feature files.
2. All 4 new widget files exist under `lib/features/home/presentation/widgets/`.
3. `home_screen.dart` imports and uses all 4 new widget files.
4. `home_screen.dart` contains `useAnimationController` for stagger and `GlassCard.shouldReduceMotion` for accessibility.
5. `home_hero_balance_card.dart` contains `TweenAnimationBuilder<double>` with `begin: shouldAnimate ? 0.0 : portfolioValue` pattern.
6. `home_mini_donut_card.dart` contains `PieChart` from `fl_chart`.
7. `home_recent_activity_card.dart` uses `PurchaseListItem` in a `Column` (not ListView).
</verification>

<success_criteria>
- Home tab shows 4 glass card sections: hero balance, mini donut, recent activity, quick actions
- Glass cards cascade in with staggered 50ms offset on first app launch
- Hero balance counts up from 0 to actual value on first load
- Tab revisit shows cards instantly (no re-animation)
- Reduce Motion setting skips all animations
- All files pass flutter analyze with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/36-home-screen-redesign/36-01-SUMMARY.md`
</output>
