---
phase: 22-price-chart-purchase-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - TradingBot.Mobile/pubspec.yaml
  - TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
  - TradingBot.Mobile/lib/features/chart/data/chart_repository.dart
  - TradingBot.Mobile/lib/features/chart/data/chart_providers.dart
  - TradingBot.Mobile/lib/features/chart/data/chart_providers.g.dart
  - TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/timeframe_selector.dart
  - TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
autonomous: true
requirements:
  - CHART-01
  - CHART-02
  - CHART-03
  - CHART-04

must_haves:
  truths:
    - "User can switch between 7D, 1M, 3M, 6M, 1Y, and All timeframes on the price chart and the chart re-renders with the selected timeframe's data"
    - "Purchase markers appear on the chart as colored dots at the correct date and purchase price, with color varying by multiplier tier"
    - "A dashed average cost basis horizontal line is visible on the chart when the user has purchases"
    - "Touching the chart shows a tooltip with the date and price at the touched point"
  artifacts:
    - path: "TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart"
      provides: "ChartResponse, PricePointDto, PurchaseMarkerDto Dart models matching backend DTOs"
      contains: "ChartResponse"
    - path: "TradingBot.Mobile/lib/features/chart/data/chart_repository.dart"
      provides: "ChartRepository with fetchChart(timeframe) calling /api/dashboard/chart"
      contains: "fetchChart"
    - path: "TradingBot.Mobile/lib/features/chart/data/chart_providers.dart"
      provides: "chartRepositoryProvider and chartDataProvider(@riverpod) parameterized by timeframe"
      contains: "chartData"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      provides: "fl_chart LineChart with price line, purchase markers, avg cost dashed line, touch tooltip"
      contains: "LineChart"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/widgets/timeframe_selector.dart"
      provides: "Segmented row of 6 timeframe buttons (7D/1M/3M/6M/1Y/All)"
      contains: "TimeframeSelector"
    - path: "TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart"
      provides: "ChartScreen assembling timeframe selector + price chart with pull-to-refresh"
      contains: "ChartScreen"
  key_links:
    - from: "TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart"
      to: "chartDataProvider"
      via: "ref.watch(chartDataProvider(timeframe: selectedTimeframe))"
      pattern: "chartDataProvider"
    - from: "TradingBot.Mobile/lib/features/chart/data/chart_providers.dart"
      to: "/api/dashboard/chart"
      via: "ChartRepository.fetchChart"
      pattern: "fetchChart"
    - from: "TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart"
      to: "fl_chart LineChart"
      via: "lineBarsData with two LineChartBarData entries"
      pattern: "LineChartBarData"
---

<objective>
Implement the price chart screen with fl_chart, including 6 timeframe options, tier-colored purchase markers, average cost basis dashed line, and touch tooltips.

Purpose: Allow users to visually explore BTC price history with their DCA purchases overlaid, fulfilling the primary chart visualization requirements.
Output: Fully functional chart screen with data layer (models, repository, providers) and presentation layer (chart widget, timeframe selector, assembled screen).
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-price-chart-purchase-history/22-RESEARCH.md

@TradingBot.Mobile/lib/features/home/data/home_providers.dart
@TradingBot.Mobile/lib/features/home/data/home_repository.dart
@TradingBot.Mobile/lib/features/home/data/models/portfolio_response.dart
@TradingBot.Mobile/lib/app/theme.dart
@TradingBot.Mobile/lib/core/api/api_client.dart
@TradingBot.ApiService/Endpoints/DashboardDtos.cs
@TradingBot.ApiService/Endpoints/DashboardEndpoints.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chart data layer (models, repository, providers) and add fl_chart dependency</name>
  <files>
    TradingBot.Mobile/pubspec.yaml
    TradingBot.Mobile/lib/features/chart/data/models/chart_response.dart
    TradingBot.Mobile/lib/features/chart/data/chart_repository.dart
    TradingBot.Mobile/lib/features/chart/data/chart_providers.dart
  </files>
  <action>
1. Add `fl_chart: ^1.1.1` to pubspec.yaml dependencies. Run `flutter pub get` from TradingBot.Mobile/.

2. Create `chart_response.dart` with manual fromJson (matching Phase 21 pattern — no json_serializable):
   - `ChartResponse` with fields: `List<PricePointDto> prices`, `List<PurchaseMarkerDto> purchases`, `double? averageCostBasis`. The `averageCostBasis` is nullable (null when no purchases). Use `(json['averageCostBasis'] as num?)?.toDouble()` for parsing.
   - `PricePointDto` with fields: `String date`, `double price`. Parse price: `(json['price'] as num).toDouble()`.
   - `PurchaseMarkerDto` with fields: `String date`, `double price`, `double btcAmount`, `String tier`. Parse price/btcAmount same pattern.
   - All classes have `factory fromJson(Map<String, dynamic> json)` constructors.

3. Create `chart_repository.dart`:
   - `ChartRepository` taking `Dio _dio` in constructor (same pattern as HomeRepository).
   - Method: `Future<ChartResponse> fetchChart(String timeframe)` — calls `_dio.get('/api/dashboard/chart', queryParameters: {'timeframe': timeframe})`, returns `ChartResponse.fromJson(response.data)`.

4. Create `chart_providers.dart`:
   - Add `part 'chart_providers.g.dart';` directive.
   - Import `Ref` from `riverpod_annotation`, `dioProvider` from core api_client, `ChartRepository`, `ChartResponse`.
   - `@riverpod ChartRepository chartRepository(Ref ref)` — returns `ChartRepository(ref.watch(dioProvider))`.
   - `@riverpod Future<ChartResponse> chartData(Ref ref, {String timeframe = '1M'})` — calls `ref.watch(chartRepositoryProvider).fetchChart(timeframe)`. No auto-refresh timer (chart data is historical; pull-to-refresh only).

5. Run `dart run build_runner build --delete-conflicting-outputs` from TradingBot.Mobile/ to generate `chart_providers.g.dart`.
  </action>
  <verify>
    Run `dart run build_runner build --delete-conflicting-outputs` from TradingBot.Mobile/ — must complete with no errors. Run `dart analyze lib/features/chart/` — zero errors.
  </verify>
  <done>
    ChartResponse, PricePointDto, PurchaseMarkerDto models exist with fromJson. ChartRepository calls /api/dashboard/chart?timeframe=X. chartRepositoryProvider and chartDataProvider generated and lint-clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Chart UI (timeframe selector, fl_chart line chart with markers, tooltip, assembled ChartScreen)</name>
  <files>
    TradingBot.Mobile/lib/features/chart/presentation/widgets/timeframe_selector.dart
    TradingBot.Mobile/lib/features/chart/presentation/widgets/price_line_chart.dart
    TradingBot.Mobile/lib/features/chart/presentation/chart_screen.dart
  </files>
  <action>
1. Create `timeframe_selector.dart`:
   - `TimeframeSelector` StatelessWidget taking `String selected` and `ValueChanged<String> onChanged`.
   - Renders a horizontal `Row` of 6 `ChoiceChip` or `FilterChip` widgets for timeframes: `['7D', '1M', '3M', '6M', '1Y', 'All']`.
   - Selected chip uses `AppTheme.bitcoinOrange` as selectedColor. Wrap in `SingleChildScrollView(scrollDirection: Axis.horizontal)` for overflow safety.
   - Use `const` where possible.

2. Create `price_line_chart.dart`:
   - `PriceLineChart` StatelessWidget taking `ChartResponse data` and `String timeframe`.
   - **x-axis coordinate system**: Use day index (0, 1, 2, ...) as x-values. Store `dateLabels = data.prices.map((p) => p.date).toList()` for tooltip/axis label mapping.
   - **Price line spots**: `priceSpots = data.prices.asMap().entries.map((e) => FlSpot(e.key.toDouble(), e.value.price)).toList()`.
   - **Purchase marker preparation**: Build a `Map<int, PurchaseMarkerDto> purchasesByIndex` mapping day index to purchase by matching `purchase.date` against `dateLabels`. Build `purchaseDayIndexSet = purchasesByIndex.keys.toSet()`. Build `purchaseSpots` list: for each entry in `purchasesByIndex`, create `FlSpot(index.toDouble(), purchase.price)`.
   - **Tier color function**: `Color _tierColor(String tier)` using switch expression: `'2x' => Colors.amber`, `'3x' => Colors.orange`, `'4x' || _ when tier.contains('4') => AppTheme.lossRed`, `_ => AppTheme.bitcoinOrange` (Base/1x).
   - **LineChart widget** with `LineChartData`:
     a. `lineBarsData`: Two entries:
        - First: Main price line — `isCurved: true`, `color: AppTheme.bitcoinOrange`, `barWidth: 2`, `dotData: FlDotData(show: false)`, `belowBarData: BarAreaData(show: true, gradient: LinearGradient from bitcoinOrange.withAlpha(51) to transparent, topCenter to bottomCenter)`.
        - Second: Purchase markers — use `purchaseSpots` as spots (NOT priceSpots), `barWidth: 0`, `color: Colors.transparent`, `dotData: FlDotData(show: true, checkToShowDot: (spot, _) => true` (all spots in this bar are purchases), `getDotPainter: (spot, _, __, ___) => FlDotCirclePainter(radius: 5, color: _tierColor(purchasesByIndex[/* find matching index */]?.tier ?? 'Base'), strokeWidth: 1.5, strokeColor: Colors.white))`. Note: since purchaseSpots only contains purchase points, `checkToShowDot` can return `true` for all.
     b. `extraLinesData`: If `data.averageCostBasis != null`, add `HorizontalLine(y: data.averageCostBasis!, color: Colors.white54, strokeWidth: 1, dashArray: [6, 4], label: HorizontalLineLabel(show: true, labelResolver: (_) => 'Avg \$${data.averageCostBasis!.toStringAsFixed(0)}', style: TextStyle(color: Colors.white54, fontSize: 10)))`.
     c. `lineTouchData`: `LineTouchData(handleBuiltInTouches: true, touchTooltipData: LineTouchTooltipData(getTooltipColor: (_) => const Color(0xFF2C2C2C), getTooltipItems: (touchedSpots) { ... }))`. In getTooltipItems: find the spot from bar index 0 (price line), format as `'$dateLabel\n\$$formattedPrice'` using `NumberFormat.currency(symbol: '\$', decimalDigits: 0)` from intl. Return null for bar index 1 items to suppress duplicate tooltip rows. Use `.whereType<LineTooltipItem>().toList()` to filter nulls.
     d. `titlesData`: Bottom x-axis: `SideTitles(showTitles: true, interval: _xInterval(timeframe), getTitlesWidget: ...)`. Interval by timeframe: 7D=1, 1M=7, 3M=14, 6M=30, 1Y=60, All=180. Format label as shortened date (e.g., 'Jan 15'). Left y-axis: `SideTitles(showTitles: true, reservedSize: 50, getTitlesWidget: ...)` formatting as '$XX.Xk'. Right/top: hidden.
     e. `gridData`: subtle grid — `FlGridData(show: true, drawVerticalLine: false, horizontalInterval: auto, getDrawingHorizontalLine: (_) => FlLine(color: Colors.white10, strokeWidth: 0.5))`.
     f. `borderData`: `FlBorderData(show: false)`.
   - Wrap `LineChart` in a `SizedBox(height: 280)` or `AspectRatio(aspectRatio: 1.6)` for consistent chart height.

3. Update `chart_screen.dart` (replace existing placeholder):
   - Make it a `HookConsumerWidget` (use `useState<String>('1M')` for selected timeframe).
   - Watch `chartDataProvider(timeframe: selectedTimeframe.value)`.
   - Extract `cachedValue` before switch (Phase 20 pattern for stale cache).
   - Layout: `Scaffold` with body as `RefreshIndicator(onRefresh: () => ref.refresh(chartDataProvider(timeframe: selectedTimeframe.value).future))` wrapping a `Column`:
     - `TimeframeSelector(selected: selectedTimeframe.value, onChanged: (tf) => selectedTimeframe.value = tf)` with horizontal padding.
     - `Expanded(child: ...)` containing `AsyncValue.when` switch:
       - `AsyncData`: `PriceLineChart(data: chartData, timeframe: selectedTimeframe.value)` with horizontal padding.
       - `AsyncLoading` (no cached): `Center(child: CircularProgressIndicator())`.
       - `AsyncError` (no cached): `RetryWidget(onRetry: () => ref.invalidate(chartDataProvider(timeframe: selectedTimeframe.value)))`.
     - When cached data exists during loading/error, show chart with stale data and use `ref.listen` to trigger snackbar on error.
   - Import `flutter_hooks` and `hooks_riverpod`.
  </action>
  <verify>
    Run `dart analyze lib/features/chart/` from TradingBot.Mobile/ — zero errors. Run `flutter build ios --no-codesign --dart-define=API_BASE_URL=http://localhost --dart-define=API_KEY=test` — must compile without errors (verifies fl_chart integration compiles).
  </verify>
  <done>
    ChartScreen shows a timeframe selector with 6 options, switching timeframes re-fetches chart data via provider. PriceLineChart renders BTC price as orange curved line with gradient fill, purchase markers as tier-colored dots at their actual prices, a dashed avg cost line, and touch tooltip with date/price. Pull-to-refresh reloads data.
  </done>
</task>

</tasks>

<verification>
1. `dart analyze lib/features/chart/` — zero errors, zero warnings.
2. `flutter build ios --no-codesign --dart-define=API_BASE_URL=http://localhost --dart-define=API_KEY=test` — compiles clean.
3. `dart run build_runner build --delete-conflicting-outputs` — generates chart_providers.g.dart without conflicts.
4. Chart screen is reachable via the existing /chart route in go_router (already wired in Phase 20).
</verification>

<success_criteria>
- fl_chart ^1.1.1 added to pubspec.yaml and resolves
- ChartResponse model matches backend PriceChartResponse DTO fields
- ChartRepository calls /api/dashboard/chart?timeframe=X
- chartDataProvider is @riverpod-generated, parameterized by timeframe string
- TimeframeSelector renders 6 selectable timeframe buttons
- PriceLineChart renders price line, purchase marker dots (tier-colored), avg cost dashed line, touch tooltip
- ChartScreen wires timeframe selector to provider, uses AsyncValue switch with stale cache pattern
- All dart analyze passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-price-chart-purchase-history/22-01-SUMMARY.md`
</output>
