---
phase: 20-flutter-project-setup-core-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 20-01
files_modified:
  - TradingBot.Mobile/lib/core/api/config.dart
  - TradingBot.Mobile/lib/core/api/api_client.dart
  - TradingBot.Mobile/lib/core/api/api_exception.dart
  - TradingBot.Mobile/lib/core/widgets/error_snackbar.dart
  - TradingBot.Mobile/lib/core/widgets/retry_widget.dart
  - TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
autonomous: true
requirements:
  - APP-01
  - APP-02
  - APP-03
  - APP-06

must_haves:
  truths:
    - "API key is injected at build time via --dart-define and sent as x-api-key header on every request"
    - "API base URL is injected at build time via --dart-define and used as Dio baseUrl"
    - "When API returns 401 or 403, a snackbar shows 'Authentication failed' and user stays on current screen"
    - "When API is unreachable or returns a network error, a snackbar shows the error and cached data remains visible"
    - "When app cold-starts with no cached data and API fails, a centered 'Could not load data' message with Retry button is shown"
  artifacts:
    - path: "TradingBot.Mobile/lib/core/api/config.dart"
      provides: "Build-time const kApiBaseUrl and kApiKey"
      contains: "String.fromEnvironment"
    - path: "TradingBot.Mobile/lib/core/api/api_client.dart"
      provides: "Dio singleton with ApiKeyInterceptor and error interceptor"
      contains: "ApiKeyInterceptor"
    - path: "TradingBot.Mobile/lib/core/api/api_exception.dart"
      provides: "Typed exception classes for auth and network errors"
      contains: "AuthenticationException"
    - path: "TradingBot.Mobile/lib/core/widgets/error_snackbar.dart"
      provides: "showErrorSnackbar and showAuthErrorSnackbar helpers"
      contains: "showErrorSnackbar"
    - path: "TradingBot.Mobile/lib/core/widgets/retry_widget.dart"
      provides: "RetryWidget with 'Could not load data' message and Retry button"
      contains: "RetryWidget"
  key_links:
    - from: "TradingBot.Mobile/lib/core/api/api_client.dart"
      to: "TradingBot.Mobile/lib/core/api/config.dart"
      via: "kApiBaseUrl used as Dio baseUrl, kApiKey used in interceptor header"
      pattern: "kApiBaseUrl|kApiKey"
    - from: "TradingBot.Mobile/lib/core/api/api_client.dart"
      to: "TradingBot.Mobile/lib/core/api/api_exception.dart"
      via: "Interceptor wraps DioException with AuthenticationException or NetworkException"
      pattern: "AuthenticationException|NetworkException"
    - from: "TradingBot.Mobile/lib/features/home/presentation/home_screen.dart"
      to: "TradingBot.Mobile/lib/core/widgets/error_snackbar.dart"
      via: "ref.listen triggers showErrorSnackbar on provider error"
      pattern: "showErrorSnackbar|showAuthErrorSnackbar"
---

<objective>
Create the Dio HTTP client with build-time API key injection, auth/network error interceptors, and shared error presentation widgets (snackbar helper, RetryWidget). Wire up a demonstration of the error handling pattern in the Home screen.

Purpose: Establishes the API communication layer that all feature screens use. After this plan, any Dio request automatically carries the x-api-key header, auth failures show "Authentication failed" snackbar, network errors show error snackbar with cached data visible, and cold-start failures show a Retry button.

Output: Complete HTTP client infrastructure with interceptors, typed exceptions, error presentation widgets, and a wired-up Home screen demonstrating the pattern.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-flutter-project-setup-core-infrastructure/20-RESEARCH.md
@.planning/phases/20-flutter-project-setup-core-infrastructure/20-CONTEXT.md
@.planning/phases/20-flutter-project-setup-core-infrastructure/20-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build-time config, Dio API client with interceptors, and typed exceptions</name>
  <files>
    TradingBot.Mobile/lib/core/api/config.dart
    TradingBot.Mobile/lib/core/api/api_exception.dart
    TradingBot.Mobile/lib/core/api/api_client.dart
  </files>
  <action>
    **1. Create `lib/core/api/config.dart`** — Build-time configuration constants:
    ```dart
    /// Build-time configuration injected via --dart-define.
    /// Usage: flutter run --dart-define=API_BASE_URL=http://192.168.1.100:5000 --dart-define=API_KEY=your-key
    const String kApiBaseUrl = String.fromEnvironment(
      'API_BASE_URL',
      defaultValue: 'http://localhost:5000',
    );

    const String kApiKey = String.fromEnvironment(
      'API_KEY',
      defaultValue: '',
    );
    ```
    - CRITICAL: Both MUST be `const` — `String.fromEnvironment` is a compile-time constant. Non-const returns defaultValue always.

    **2. Create `lib/core/api/api_exception.dart`** — Typed exception hierarchy:
    - `sealed class ApiException implements Exception` with `final String message` and `toString()` override
    - `class AuthenticationException extends ApiException` — constructor takes optional message, defaults to `'Authentication failed'`
    - `class NetworkException extends ApiException` — constructor takes optional message, defaults to `'Network error'`
    - `class ServerException extends ApiException` — constructor takes `int statusCode` and optional message, defaults to `'Server error ($statusCode)'`

    **3. Create `lib/core/api/api_client.dart`** — Dio setup with interceptors:
    - `class ApiKeyInterceptor extends Interceptor`:
      - `onRequest`: adds `options.headers['x-api-key'] = kApiKey;` then `handler.next(options)`
      - `onError`: checks `err.response?.statusCode`:
        - If 401 or 403: wraps error as `DioException` with `error: AuthenticationException()`, calls `handler.next(wrappedError)`
        - If 500+: wraps as `DioException` with `error: ServerException(statusCode)`, calls `handler.next(wrappedError)`
        - If `err.type == DioExceptionType.connectionTimeout || err.type == DioExceptionType.connectionError || err.type == DioExceptionType.unknown`: wraps as `DioException` with `error: NetworkException(err.message ?? 'Network error')`, calls `handler.next(wrappedError)`
        - Otherwise: `handler.next(err)` (pass through)
    - `Dio createDio()` factory function:
      - `BaseOptions(baseUrl: kApiBaseUrl, connectTimeout: Duration(seconds: 10), receiveTimeout: Duration(seconds: 30))`
      - `dio.interceptors.add(ApiKeyInterceptor())`
      - Returns configured Dio instance
    - Create a Riverpod provider using `@riverpod` annotation:
      ```dart
      @riverpod
      Dio dio(Ref ref) {
        return createDio();
      }
      ```
    - Run `dart run build_runner build --delete-conflicting-outputs` after creating this file to generate the `api_client.g.dart` provider file.
  </action>
  <verify>
    Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && dart run build_runner build --delete-conflicting-outputs` — exits 0, generates `api_client.g.dart`.
    Run `dart analyze lib/core/` — no errors.
    Verify `grep -r 'x-api-key' lib/core/api/api_client.dart` confirms header injection.
    Verify `grep -r 'const String kApiBaseUrl' lib/core/api/config.dart` confirms const declaration.
  </verify>
  <done>
    Build-time config constants created with const String.fromEnvironment. Dio client configured with 10s connect / 30s receive timeouts. ApiKeyInterceptor injects x-api-key header on every request. Error interceptor wraps 401/403 as AuthenticationException, 500+ as ServerException, network errors as NetworkException. Riverpod dioProvider generated via build_runner.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create error presentation widgets and wire up Home screen demonstration</name>
  <files>
    TradingBot.Mobile/lib/core/widgets/error_snackbar.dart
    TradingBot.Mobile/lib/core/widgets/retry_widget.dart
    TradingBot.Mobile/lib/features/home/presentation/home_screen.dart
  </files>
  <action>
    **1. Create `lib/core/widgets/error_snackbar.dart`** — Snackbar helpers:
    - `void showErrorSnackbar(BuildContext context, String message)`:
      - Calls `ScaffoldMessenger.of(context)..hideCurrentSnackBar()..showSnackBar(...)`
      - SnackBar: `content: Text(message)`, `behavior: SnackBarBehavior.floating`, `backgroundColor: Colors.red.shade800`, `duration: Duration(seconds: 4)`
    - `void showAuthErrorSnackbar(BuildContext context)`:
      - Calls `showErrorSnackbar(context, 'Authentication failed')`
      - Per locked decision: "Auth failures (401/403) show a snackbar warning 'Authentication failed'"
    - Keep it simple — no custom widgets, just standard SnackBar with floating behavior (already set as global default in theme, but explicit here for standalone usage)

    **2. Create `lib/core/widgets/retry_widget.dart`** — Cold-start failure widget:
    - `class RetryWidget extends StatelessWidget` taking `VoidCallback onRetry` as required parameter
    - Build returns `Center` child with `Column(mainAxisAlignment: MainAxisAlignment.center)`:
      - `Icon(CupertinoIcons.wifi_slash, size: 48, color: Colors.grey)` — network error visual
      - `SizedBox(height: 16)`
      - `Text('Could not load data', style: Theme.of(context).textTheme.titleMedium)` — per locked decision
      - `SizedBox(height: 16)`
      - `FilledButton.icon(onPressed: onRetry, icon: Icon(CupertinoIcons.refresh), label: Text('Retry'))` — uses Bitcoin orange via theme's FilledButton default
    - Import `package:flutter/cupertino.dart` for CupertinoIcons

    **3. Update `lib/features/home/presentation/home_screen.dart`** — Wire up error handling pattern:
    - Add a placeholder `@riverpod` provider to demonstrate the full error → snackbar → retry flow:
      ```dart
      @riverpod
      Future<String> homeData(Ref ref) async {
        // Placeholder — Phase 21 replaces with real portfolio data
        // This demonstrates the Riverpod async pattern for error handling
        await Future.delayed(const Duration(milliseconds: 500));
        return 'Home';
      }
      ```
    - Change `HomeScreen` to use `HookConsumerWidget`:
      - Watch `homeDataProvider` via `ref.watch(homeDataProvider)`
      - Add `ref.listen(homeDataProvider, ...)` in build method:
        ```dart
        ref.listen(homeDataProvider, (previous, next) {
          if (next.hasError && !next.isLoading) {
            if (next.error is AuthenticationException) {
              showAuthErrorSnackbar(context);
            } else {
              showErrorSnackbar(context, 'Could not load data');
            }
          }
        });
        ```
      - Render using pattern matching on AsyncValue:
        ```dart
        RefreshIndicator(
          onRefresh: () => ref.refresh(homeDataProvider.future),
          child: CustomScrollView(
            slivers: [
              SliverFillRemaining(
                child: switch (homeData) {
                  AsyncData(:final value) => Center(child: Text(value, style: ...)),
                  AsyncError() when homeData.valueOrNull != null =>
                    Center(child: Text(homeData.valueOrNull!, style: ...)),
                  AsyncError() => RetryWidget(onRetry: () => ref.invalidate(homeDataProvider)),
                  _ => const Center(child: CircularProgressIndicator()),
                },
              ),
            ],
          ),
        )
        ```
      - This demonstrates ALL 3 error scenarios:
        - Error with cached data → shows cached data + snackbar (via ref.listen)
        - Error with no cached data → shows RetryWidget ("Could not load data" + Retry button)
        - Auth error → shows "Authentication failed" snackbar (via ref.listen)
    - Run `dart run build_runner build --delete-conflicting-outputs` to generate both `api_client.g.dart` and `home_screen.g.dart`.
  </action>
  <verify>
    Run `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && dart run build_runner build --delete-conflicting-outputs` — exits 0, generates .g.dart files.
    Run `dart analyze` — no errors across entire lib/ directory.
    Verify `grep -r 'showAuthErrorSnackbar' lib/features/home/` confirms auth error snackbar is wired.
    Verify `grep -r 'RetryWidget' lib/features/home/` confirms retry widget is wired.
    Verify `grep -r 'ref.refresh.*homeDataProvider.future' lib/features/home/` confirms pull-to-refresh pattern.
  </verify>
  <done>
    Error snackbar helper shows floating SnackBar for generic errors and "Authentication failed" for auth errors. RetryWidget displays centered "Could not load data" with Retry button for cold-start failures. Home screen demonstrates the complete Riverpod async error handling pattern: ref.listen for snackbar triggers, AsyncValue pattern matching for cached data / retry / loading states, and RefreshIndicator with ref.refresh(provider.future) for pull-to-refresh.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/baotoq/Work/trading-bot/TradingBot.Mobile && flutter pub get` — exits 0
2. `dart run build_runner build --delete-conflicting-outputs` — exits 0, generates .g.dart files
3. `dart analyze` — no errors across entire project
4. `grep -r 'x-api-key' lib/` — confirms API key header injection in api_client.dart
5. `grep -r 'const String kApiBaseUrl' lib/` — confirms const build-time config
6. `grep -r 'AuthenticationException' lib/` — appears in api_exception.dart, api_client.dart, and home_screen.dart
7. `grep -r 'RetryWidget' lib/` — appears in retry_widget.dart and home_screen.dart
8. `grep -r 'ref.refresh' lib/` — appears in home_screen.dart pull-to-refresh
</verification>

<success_criteria>
- Build-time config: kApiBaseUrl and kApiKey are const String.fromEnvironment declarations
- Every Dio request carries x-api-key header automatically
- 401/403 responses wrapped as AuthenticationException and surface "Authentication failed" snackbar
- Network errors wrapped as NetworkException and surface error snackbar
- Cold-start with no data + API failure shows RetryWidget with "Could not load data" + Retry button
- Pull-to-refresh on Home tab triggers ref.refresh(homeDataProvider.future)
- Cached data remains visible when re-fetch errors (AsyncValue preserves previous value)
- dart analyze passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-flutter-project-setup-core-infrastructure/20-02-SUMMARY.md`
</output>
