---
phase: 11-backtest-visualization
plan: 04
type: execute
wave: 4
depends_on: ["11-02", "11-03"]
files_modified:
  - TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue
  - TradingBot.Dashboard/app/composables/useBacktestComparison.ts
  - TradingBot.Dashboard/app/pages/backtest.vue
autonomous: true

must_haves:
  truths:
    - "User runs separate backtests that accumulate in a comparison panel"
    - "Compared backtests displayed as overlaid curves on one chart with different colors + metrics table below"
    - "Maximum 3 backtests comparable at once"
    - "Comparison state persists in browser session storage — survives refresh but not tab close"
  artifacts:
    - path: "TradingBot.Dashboard/app/composables/useBacktestComparison.ts"
      provides: "Composable with useSessionStorage for comparison state management"
      min_lines: 30
    - path: "TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue"
      provides: "Comparison panel with overlaid curves and metrics table"
      min_lines: 100
    - path: "TradingBot.Dashboard/app/pages/backtest.vue"
      provides: "Backtest page with comparison panel and Add to Compare button"
  key_links:
    - from: "TradingBot.Dashboard/app/composables/useBacktestComparison.ts"
      to: "sessionStorage"
      via: "useSessionStorage from @vueuse/core"
      pattern: "useSessionStorage"
    - from: "TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue"
      to: "useBacktestComparison"
      via: "composable import"
      pattern: "useBacktestComparison"
    - from: "TradingBot.Dashboard/app/pages/backtest.vue"
      to: "BacktestComparison"
      via: "component in comparison section"
      pattern: "BacktestComparison"
---

<objective>
Build the comparison panel allowing users to compare up to 3 backtest configurations side-by-side with overlaid equity curves and metrics table.

Purpose: Enable users to visually compare different backtest configurations by accumulating results from separate backtest runs into a persistent comparison panel with overlaid charts and metrics.
Output: Working comparison panel with session storage persistence, overlaid curves, metrics table, and "Add to Compare" button integrated into the backtest page.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backtest-visualization/11-RESEARCH.md
@.planning/phases/11-backtest-visualization/11-02-SUMMARY.md
@.planning/phases/11-backtest-visualization/11-03-SUMMARY.md

@TradingBot.Dashboard/app/pages/backtest.vue
@TradingBot.Dashboard/app/components/backtest/BacktestChart.vue
@TradingBot.Dashboard/app/components/backtest/BacktestMetrics.vue
@TradingBot.Dashboard/app/types/backtest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useBacktestComparison composable and BacktestComparison component</name>
  <files>
    TradingBot.Dashboard/app/composables/useBacktestComparison.ts
    TradingBot.Dashboard/app/components/backtest/BacktestComparison.vue
  </files>
  <action>
    **useBacktestComparison.ts:**

    Create composable using VueUse `useSessionStorage` for comparison state persistence.

    Per locked decisions:
    - Maximum 3 backtests comparable at once
    - Comparison state persists in browser session storage — survives refresh but not tab close
    - User runs separate backtests that accumulate (not checkbox selection from sweep)

    Interface `ComparisonEntry`:
    - id: string (crypto.randomUUID())
    - label: string (auto-generated: e.g., "Base $10, 30d lookback" or just "#1", "#2", "#3")
    - config: BacktestConfig
    - metrics: DcaMetrics (smartDca metrics)
    - comparison: ComparisonMetrics
    - purchaseLog: PurchaseLogEntry[] — needed for chart overlay
    - color: string (assigned from palette)

    IMPORTANT (from research pitfall #4): Do NOT store full purchaseLog in session storage (can be 50KB+ per backtest, hits 5MB quota). Instead:
    - Store only summary data (config, metrics, comparison) in session storage
    - Store purchaseLog in a separate in-memory Map<string, PurchaseLogEntry[]> (not persisted)
    - When comparison entries are loaded from session storage on refresh, show metrics table but display "Re-run to see chart" message instead of chart
    - This avoids QuotaExceededError while still persisting comparison state

    State:
    - `comparedBacktests` = useSessionStorage<ComparisonEntrySummary[]>('backtest-comparison', [])
    - `purchaseLogCache` = ref<Map<string, PurchaseLogEntry[]>>(new Map())

    Color palette: ['rgb(59, 130, 246)', 'rgb(34, 197, 94)', 'rgb(168, 85, 247)'] (blue, green, purple)

    Functions:
    - `addToComparison(result: BacktestResponse, label?: string)`: Add entry, assign next color. If already 3, show warning (don't auto-remove — let user explicitly remove). Store purchaseLog in memory cache.
    - `removeFromComparison(id: string)`: Remove entry by id, clean up purchaseLog cache
    - `clearComparison()`: Remove all entries
    - `canAdd`: computed boolean (comparedBacktests.length < 3)
    - `hasChartData(id: string)`: Check if purchaseLog is in memory cache

    **BacktestComparison.vue:**

    Per locked decisions:
    - Compared backtests displayed as overlaid curves on one chart with different colors + metrics table below

    Structure:
    - UCard with header showing "Comparison (N/3)" count and "Clear All" button (red soft variant)
    - Empty state when no backtests added: "Run backtests and add to comparison to see side-by-side results"

    When entries exist:
    1. **Overlaid equity curve chart:**
       - vue-chartjs Line chart (similar to BacktestChart but multi-config)
       - Each comparison entry = one dataset with its assigned color
       - Y-axis: portfolio value (USD) — simpler for comparison (single axis, no toggle needed for comparison)
       - BTC price as secondary y-axis reference (use first entry's purchaseLog for price data)
       - If purchaseLog not available for some entries (session storage reload), show only entries with cached data
       - If no entries have chart data, show message "Re-run backtests to view comparison chart"
       - Height: 400px
       - Legend: show entry labels with colors

    2. **Metrics comparison table:**
       - HTML table (not UTable — simpler for fixed row layout)
       - Rows: Total BTC, Avg Cost Basis, Return %, Efficiency Ratio, Max Drawdown, Total Invested
       - Columns: Metric label | Entry 1 | Entry 2 | Entry 3 (dynamic based on count)
       - Column headers colored with entry color and show entry label
       - Each column header has a remove button (i-lucide-x, ghost variant, xs size)
       - Highlight best value in each row (bold or different color) — lowest cost basis, highest BTC, highest return, etc.

    3. **Config summary per entry:**
       - Small collapsible section showing config parameters for each compared backtest
       - Show: base amount, lookback days, bear boost, tiers summary
  </action>
  <verify>
    - useBacktestComparison.ts exports addToComparison, removeFromComparison, clearComparison, comparedBacktests, canAdd
    - Uses useSessionStorage for persistence (summary data only, not purchaseLog)
    - BacktestComparison.vue renders overlaid chart with up to 3 datasets
    - Metrics table shows side-by-side comparison with best values highlighted
    - Maximum 3 entries enforced
  </verify>
  <done>
    Comparison composable manages up to 3 backtest entries with session storage persistence (summary only, purchaseLog in memory). BacktestComparison component shows overlaid equity curves with different colors and side-by-side metrics table with best values highlighted and per-entry remove buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire comparison into backtest page with Add to Compare button</name>
  <files>
    TradingBot.Dashboard/app/pages/backtest.vue
  </files>
  <action>
    Update `app/pages/backtest.vue` to integrate the comparison panel.

    **Add to Compare button:**
    - In the Single Backtest tab: Add "Add to Compare" UButton next to the result section
      - Appears only when a backtest result exists
      - Disabled when comparison is full (3 entries) — show tooltip "Maximum 3 comparisons"
      - Icon: i-lucide-plus, variant: soft
      - On click: call addToComparison with current backtestResult
      - Show brief success toast or visual feedback (e.g., button text changes to "Added!" for 1 second)

    - In the Sweep tab detail panel: Add same "Add to Compare" button next to the sweep detail view
      - Same behavior as single tab

    **Comparison panel placement:**
    - Add BacktestComparison component at the bottom of the page, BELOW the tab content
    - Always visible regardless of which tab is active (comparison is cross-tab)
    - Separated from tab content by a horizontal divider or extra spacing
    - Only rendered when at least 1 comparison entry exists (v-if="comparedBacktests.length > 0")

    **State integration:**
    - Import useBacktestComparison composable in backtest.vue
    - Wire addToComparison to both single and sweep "Add to Compare" buttons
    - Pass comparison state to BacktestComparison component

    **Auto-label generation:**
    - For single backtest: "Base $X, Yd lookback" (e.g., "Base $10, 30d lookback")
    - For sweep detail: "Sweep #N: Base $X" where N is the sweep result rank

    **Edge cases:**
    - If comparison entries exist from session storage on page load, render comparison panel (metrics table visible, chart may show "re-run" message)
    - Prevent adding duplicate configs (compare by config values, not reference)
  </action>
  <verify>
    - "Add to Compare" button appears in single backtest results
    - "Add to Compare" button appears in sweep detail view
    - Button disabled when 3 entries in comparison
    - BacktestComparison panel appears at bottom of page when entries exist
    - Comparison persists across page refresh (metrics table visible)
    - Adding 4th entry is prevented with visual feedback
  </verify>
  <done>
    "Add to Compare" buttons in both single and sweep tabs allow accumulating backtest results into comparison panel. Comparison panel at page bottom shows overlaid curves and metrics table. State persists in session storage. Maximum 3 entries enforced with disabled state.
  </done>
</task>

</tasks>

<verification>
1. Run a backtest in Single tab — "Add to Compare" button appears
2. Click "Add to Compare" — comparison panel appears at bottom with 1 entry
3. Modify parameters and run another backtest — click "Add to Compare" — 2 entries in comparison
4. Run a third — add to comparison — 3 entries, button now disabled
5. Comparison chart shows 3 overlaid curves in blue, green, purple
6. Metrics table shows side-by-side values with best highlighted
7. Remove one entry via X button — comparison updates to 2 entries
8. "Clear All" removes all entries — comparison panel hides
9. Refresh page — comparison summary persists (metrics visible), chart shows "re-run" message
10. Switch to Sweep tab, click a row, click "Add to Compare" — adds to same comparison panel
</verification>

<success_criteria>
- User can add backtest results to comparison from both single and sweep tabs
- Maximum 3 entries enforced with visual feedback
- Overlaid equity curves display with distinct colors per entry
- Metrics table shows side-by-side comparison with best values highlighted
- Comparison state persists in session storage across page refresh
- Individual and bulk removal of comparison entries works
</success_criteria>

<output>
After completion, create `.planning/phases/11-backtest-visualization/11-04-SUMMARY.md`
</output>
