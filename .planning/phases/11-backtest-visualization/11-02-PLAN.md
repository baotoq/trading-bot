---
phase: 11-backtest-visualization
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - TradingBot.Dashboard/app/components/backtest/BacktestForm.vue
  - TradingBot.Dashboard/app/components/backtest/BacktestChart.vue
  - TradingBot.Dashboard/app/components/backtest/BacktestMetrics.vue
  - TradingBot.Dashboard/app/pages/backtest.vue
autonomous: true

must_haves:
  truths:
    - "User can configure backtest parameters (date range, base amount, multiplier tiers) from dashboard form"
    - "User can trigger backtest execution and see progress indicator while backtest runs"
    - "User can view equity curve chart comparing smart DCA vs fixed DCA strategies over time"
    - "User can see backtest metrics table showing cost basis, total BTC, efficiency ratio, and max drawdown"
    - "Y-axis is toggleable between portfolio value (USD) and BTC accumulated"
    - "BTC price shown as background reference line on secondary (right) Y-axis"
    - "Purchase points marked on curve with dots colored by multiplier tier"
  artifacts:
    - path: "TradingBot.Dashboard/app/components/backtest/BacktestForm.vue"
      provides: "Backtest parameter configuration form with date presets, editable tiers, progress bar"
      min_lines: 100
    - path: "TradingBot.Dashboard/app/components/backtest/BacktestChart.vue"
      provides: "Equity curve chart with dual y-axes, toggle, and purchase markers"
      min_lines: 80
    - path: "TradingBot.Dashboard/app/components/backtest/BacktestMetrics.vue"
      provides: "KPI cards for efficiency ratio, total BTC, cost basis, drawdown"
      min_lines: 40
    - path: "TradingBot.Dashboard/app/pages/backtest.vue"
      provides: "Backtest page layout with form, chart, and metrics"
      min_lines: 30
  key_links:
    - from: "TradingBot.Dashboard/app/components/backtest/BacktestForm.vue"
      to: "useBacktest composable"
      via: "emits backtestComplete event with BacktestResponse"
      pattern: "emit.*backtestComplete"
    - from: "TradingBot.Dashboard/app/components/backtest/BacktestChart.vue"
      to: "BacktestResponse.result.purchaseLog"
      via: "props receiving BacktestResult"
      pattern: "defineProps.*BacktestResult"
    - from: "TradingBot.Dashboard/app/pages/backtest.vue"
      to: "BacktestForm, BacktestChart, BacktestMetrics"
      via: "component imports and data flow"
      pattern: "BacktestForm|BacktestChart|BacktestMetrics"
---

<objective>
Build the single-backtest flow: parameter form, equity curve chart, and metrics display.

Purpose: Enable users to configure and run a single backtest, then visualize the equity curve comparing smart DCA vs fixed DCA with purchase markers and KPI summary cards.
Output: Working backtest page at /backtest with form, chart (dual y-axes, toggleable), and metrics cards.
</objective>

<execution_context>
@/Users/baotoq/.claude/get-shit-done/workflows/execute-plan.md
@/Users/baotoq/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-backtest-visualization/11-RESEARCH.md
@.planning/phases/11-backtest-visualization/11-01-SUMMARY.md

@TradingBot.Dashboard/app/components/dashboard/PriceChart.vue
@TradingBot.Dashboard/app/app.vue
@TradingBot.Dashboard/app/types/backtest.ts
@TradingBot.Dashboard/app/composables/useBacktest.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BacktestForm component with date presets, parameter inputs, editable tiers, and progress bar</name>
  <files>
    TradingBot.Dashboard/app/components/backtest/BacktestForm.vue
  </files>
  <action>
    Create `app/components/backtest/BacktestForm.vue` with full parameter configuration form.

    **Form structure (per locked decisions):**

    1. **Date Range Section:**
       - Quick preset buttons: 1Y, 2Y, 3Y, Max (using UButton group with solid/soft variant toggle)
       - Custom date picker via UPopover + UCalendar with range mode and 2-month view
       - Display selected range as text below buttons (formatted with date-fns)
       - Default to 1Y preset on mount
       - "Max" should set start to CalendarDate(2013, 1, 1)

    2. **Parameter Inputs (2-column grid):**
       - Base Daily Amount (UInput type="number")
       - High Lookback Days (UInput type="number")
       - Bear Market MA Period (UInput type="number")
       - Bear Boost Factor (UInput type="number" step="0.1")
       - Max Multiplier Cap (UInput type="number" step="0.1")
       - All disabled while backtest is running

    3. **Multiplier Tiers Section (per locked decision: editable per backtest):**
       - List of tier rows, each with Drop % and Multiplier inputs side-by-side
       - "Add Tier" button to add new tier row
       - "Remove" button (icon: i-lucide-x) on each tier row
       - Tiers are reactive refs, pre-filled from config

    4. **Progress bar (per locked decision: progress bar, not spinner):**
       - UProgress component shown while `isRunning` is true
       - Simulated progress: advances 0-90% during execution, jumps to 100% on complete

    5. **Submit button:**
       - UButton "Run Backtest" with loading state
       - Disabled when no date range selected
       - Block width

    **Props/emits:**
    - Props: `config` (DcaConfigResponse | null) for pre-filling defaults
    - Emits: `backtestComplete` with BacktestResponse payload

    **Pre-fill behavior (per locked decision: pre-filled with current live DCA config):**
    - On mount or when config prop changes, populate all form fields from config
    - If config is null, use sensible defaults (baseDailyAmount: 10, highLookbackDays: 30, etc.)

    **API call:**
    - Use `$fetch('/api/backtest/run', { method: 'POST', body: request })` directly
    - Build BacktestRequest from form state, converting CalendarDate to string format "YYYY-MM-DD"
    - Handle errors: set error message, clear isRunning

    **Color palette (discretion):**
    - Use Nuxt UI default primary color for buttons
    - Standard gray for disabled states
  </action>
  <verify>
    - Component file exists at app/components/backtest/BacktestForm.vue
    - Contains UButton preset buttons, UCalendar for custom range, UInput for parameters, UProgress for progress
    - Emits backtestComplete event
    - Multiplier tiers are editable (add/remove rows)
  </verify>
  <done>
    BacktestForm renders with date presets (1Y/2Y/3Y/Max + custom picker), parameter inputs pre-filled from live config, editable multiplier tiers, progress bar during execution, and emits backtest results on completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BacktestChart, BacktestMetrics components and backtest page</name>
  <files>
    TradingBot.Dashboard/app/components/backtest/BacktestChart.vue
    TradingBot.Dashboard/app/components/backtest/BacktestMetrics.vue
    TradingBot.Dashboard/app/pages/backtest.vue
  </files>
  <action>
    **BacktestChart.vue:**

    Create equity curve chart using vue-chartjs Line component (following pattern from PriceChart.vue).

    Per locked decisions:
    - Smart DCA vs fixed DCA equity curves overlaid with different colors
    - Y-axis toggleable between portfolio value (USD) and BTC accumulated — toggle button at chart top-right
    - BTC price shown as background reference line on secondary (right) Y-axis
    - Purchase points marked on the curve — dots colored by multiplier tier

    Implementation:
    - Props: `result` (BacktestResult | null), `yAxisMode` ('usd' | 'btc') with default 'usd'
    - Register Chart.js components: CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, annotationPlugin
    - Wrap in `<ClientOnly>` (required for Chart.js SSR safety, following PriceChart.vue pattern)
    - 3 datasets:
      1. Smart DCA (blue: rgb(59, 130, 246)) — maps purchaseLog to smartCumulativeUsd or smartCumulativeBtc based on yAxisMode, yAxisID: 'y'
      2. Fixed DCA (gray: rgb(156, 163, 175)) — maps to fixedSameBaseCumulativeUsd or fixedSameBaseCumulativeBtc, yAxisID: 'y'
      3. BTC Price (amber dashed: rgba(251, 191, 36, 0.3)) — maps to price, yAxisID: 'y1', borderDash: [5, 5]
    - Dual y-axes: left axis for portfolio/BTC, right axis for BTC price with `grid: { drawOnChartArea: false }`
    - Y-axis tick formatters: USD gets `$` prefix with toLocaleString, BTC gets toFixed(4) suffix
    - Purchase markers via chartjs-plugin-annotation:
      - Filter purchaseLog entries where smartMultiplier > 1 (only multiplied purchases, not every day)
      - Each marker: type 'label', content ['●'], backgroundColor from tier color map, borderRadius 50
      - Tier colors: Base=gray(156,163,175), Tier1=green(34,197,94), Tier2=blue(59,130,246), Tier3=purple(168,85,247), BearBoost=red(239,68,68)
      - Font size scaled by multiplier: min(8 + multiplier * 2, 16)
    - Interaction mode: 'index', intersect: false for crosshair tooltip
    - pointRadius: 0 for all line datasets (clean lines)
    - Height: 500px container
    - Y-axis toggle: UButton group at top-right of chart card (USD | BTC)

    **BacktestMetrics.vue:**

    Per locked decisions:
    - Summary KPI cards at top (efficiency ratio is hero metric — most visually prominent)
    - Display: total BTC, cost basis, efficiency ratio, max drawdown

    Implementation:
    - Props: `result` (BacktestResult | null)
    - Layout: grid of 4 stat cards (similar to DashboardStatCard pattern but simpler)
    - Cards:
      1. **Efficiency Ratio** (hero): Large text, primary color, ComparisonMetrics.efficiencyRatio formatted to 2 decimals, with "x" suffix. Description: "Smart DCA vs Fixed DCA efficiency"
      2. **Total BTC**: smartDca.totalBtc formatted to 6 decimals. Subtitle: vs fixedDcaSameBase.totalBtc
      3. **Avg Cost Basis**: smartDca.avgCostBasis formatted as USD. Subtitle: delta vs fixed (comparison.costBasisDeltaSameBase)
      4. **Max Drawdown**: smartDca.maxDrawdown formatted as percentage. Color: red if > 20%, amber if > 10%, green otherwise
    - Additional row below: Return %, Total Invested, Portfolio Value, Extra BTC %
    - Use UCard for each metric with consistent styling

    **backtest.vue page:**

    Create `app/pages/backtest.vue` as the main backtest page.

    Layout:
    - Header with "Backtest" title and link back to dashboard (UButton with i-lucide-arrow-left icon linking to "/")
    - Two-column layout on large screens: form on left (1/3 width), results on right (2/3 width)
    - On small screens: stacked vertically (form on top, results below)
    - Results section shows BacktestMetrics above BacktestChart when result exists
    - Empty state message when no backtest has been run yet: "Configure parameters and run a backtest to see results"

    State management:
    - Use useBacktest composable to get config
    - Local ref for backtestResult (set from form's backtestComplete event)
    - Local ref for yAxisMode toggle
    - Pass config to BacktestForm, result to BacktestChart and BacktestMetrics

    Also add navigation link to backtest page from main app.vue header (UButton "Backtest" with i-lucide-bar-chart-2 icon, variant="soft", linking to "/backtest").
  </action>
  <verify>
    - BacktestChart.vue renders dual y-axis chart with 3 datasets and purchase markers
    - BacktestMetrics.vue shows 4+ KPI cards with efficiency ratio as hero
    - backtest.vue page exists at /backtest with form + results layout
    - Chart has USD/BTC toggle for y-axis
    - Navigation link exists in app.vue header
  </verify>
  <done>
    Backtest page at /backtest shows parameter form on left, and on form submission displays equity curve chart (smart DCA vs fixed DCA with BTC price overlay, purchase markers, toggleable y-axis) and KPI metrics cards (efficiency ratio hero, total BTC, cost basis, drawdown). Navigation from main dashboard via header link.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /backtest — page loads with form and empty results placeholder
2. Form pre-fills with live DCA config values from backend
3. Select date preset (1Y) and click Run Backtest — progress bar advances, results appear
4. Chart shows smart DCA (blue) and fixed DCA (gray) equity curves with BTC price (amber dashed) on right y-axis
5. Purchase markers appear as colored dots on the smart DCA curve
6. Click USD/BTC toggle — y-axis and data switch between portfolio value and BTC accumulated
7. Metrics cards show efficiency ratio prominently, plus total BTC, cost basis, drawdown
8. Navigation link from main dashboard header links to /backtest
</verification>

<success_criteria>
- User can configure date range (presets + custom), base amount, lookback days, and editable multiplier tiers
- User sees progress bar during backtest execution
- Chart displays smart DCA vs fixed DCA equity curves with BTC price reference line
- Y-axis toggles between USD portfolio value and BTC accumulated
- Purchase markers colored by multiplier tier appear on chart
- KPI cards display efficiency ratio (hero), total BTC, cost basis, and max drawdown
</success_criteria>

<output>
After completion, create `.planning/phases/11-backtest-visualization/11-02-SUMMARY.md`
</output>
